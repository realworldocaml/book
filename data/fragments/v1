((idm181617374752
  ((file variants.html)
   (html
    "<blockquote>Variants are most problematic exactly where you take full\n      advantage of their power; in particular, when you take advantage of the\n      ability of polymorphic variant types to overlap in the tags they\n      support. This ties into OCaml's support for subtyping. As we'll discuss\n      further when we cover objects in <a href=\"objects.html\">ChapterÂ 11, <i>Objects</i></a>, subtyping\n      brings in a lot of complexity, and most of the time, that's complexity\n      you want to avoid.<a name=\"idm181617373536\"></a><a name=\"idm181617372928\"></a></blockquote>")))
 (idm181617375920
  ((file variants.html)
   (html
    "<blockquote>Probably the safest and most common use case for polymorphic\n      variants is where ordinary variants would be sufficient but are\n      syntactically too heavyweight. For example, you often want to create a\n      variant type for encoding the inputs or outputs to a function, where\n      it's not worth declaring a separate type for it. Polymorphic variants\n      are very useful here, and as long as there are type annotations that\n      constrain these to have explicit, exact types, this tends to work\n      well.</blockquote>")))
 (idm181617376496
  ((file variants.html)
   (html
    "<blockquote>All that said, polymorphic variants are still a useful and\n      powerful feature, but it's worth understanding their limitations and how\n      to use them sensibly and modestly.</blockquote>")))
 (idm181617377536
  ((file variants.html)
   (html
    "<blockquote>This isn't a huge effect, but polymorphic variants are\n            somewhat heavier than regular variants, and OCaml can't generate\n            code for matching on polymorphic variants that is quite as\n            efficient as what it generated for regular variants.</blockquote>")))
 (idm181617379280
  ((file variants.html)
   (html
    "<blockquote>Polymorphic variants are type-safe, but the typing\n            discipline that they impose is, by dint of its flexibility, less\n            likely to catch bugs in your program.</blockquote>")))
 (idm181617381360
  ((file variants.html)
   (html
    "<blockquote>As we've seen, the typing rules for polymorphic variants are\n            a lot more complicated than they are for regular variants. This\n            means that heavy use of polymorphic variants can leave you\n            scratching your head trying to figure out why a given piece of\n            code did or didn't compile. It can also lead to absurdly long and\n            hard to decode error messages. Indeed, concision at the value\n            level is often balanced out by more verbosity at the type\n            level.</blockquote>")))
 (idm181617383120
  ((file variants.html)
   (html
    "<blockquote>In reality, regular variants are the more pragmatic choice most of\n      the time. That's because the flexibility of polymorphic variants comes\n      at a price. Here are some of the downsides:</blockquote>")))
 (idm181617386624
  ((file variants.html)
   (html
    "<blockquote>At first glance, polymorphic variants look like a strict\n      improvement over ordinary variants. You can do everything that ordinary\n      variants can do, plus it's more flexible and more concise. What's not to\n      like?<a name=\"idm181617386128\"></a><a name=\"idm181617384560\"></a></blockquote>")))
 (idm181617388128
  ((file variants.html)
   (html
    "<blockquote>This is useful when you want to narrow down to a type whose\n      definition is long, and you don't want the verbosity of writing the tags\n      down explicitly in the match.</blockquote>")))
 (idm181617392384
  ((file variants.html)
   (html
    "<blockquote>Once we have type definitions at our disposal, we can revisit the\n      question of how we write the pattern match that narrows the type. In\n      particular, we can explicitly use the type name as part of the pattern\n      match, by prefixing it with a <code>#</code>:</blockquote>")))
 (idm181617400144
  ((file variants.html)
   (html
    "<blockquote>In particular, the compiler will complain that the <code>`Grey</code> case is unused:</blockquote>")))
 (idm181617404256
  ((file variants.html)
   (html
    "<blockquote>If we add an explicit type annotation to the code itself (rather\n      than just in the <code>mli</code>), then the\n      compiler has enough information to warn us:</blockquote>")))
 (idm181617409152
  ((file variants.html)
   (html
    "<blockquote>In the preceding code, we did something funny to the definition of\n      <code>extended_color_to_int</code> that underlines\n      some of the downsides of polymorphic variants. In particular, we added\n      some special-case handling for the color gray, rather than using\n      <code>color_to_int</code>. Unfortunately, we\n      misspelled <code>Gray</code> as <code>Grey</code>. This is exactly the kind of error that\n      the compiler would catch with ordinary variants, but with polymorphic\n      variants, this compiles without issue. All that happened was that the\n      compiler inferred a wider type for <code>extended_color_to_int</code>, which happens to be\n      compatible with the narrower type that was listed in the <code>mli</code>.</blockquote>")))
 (idm181617414032
  ((file variants.html)
   (html
    "<blockquote>Here, <code>extended_color</code> is defined\n      as an explicit extension of <code>color</code>.\n      Also, notice that we defined all of these types as exact variants. We\n      can implement this library as follows:</blockquote>")))
 (idm181617419376
  ((file variants.html)
   (html
    "<blockquote>Let's consider how we might turn our code into a proper library\n      with an implementation in an <code>ml</code> file\n      and an interface in a separate <code>mli</code>,\n      as we saw in <a href=\"files-modules-and-programs.html\">ChapterÂ 4, <i>Files, Modules, and Programs</i></a>. Let's start\n      with the <code>mli</code>:</blockquote>")))
 (idm181617420080
  ((file variants.html)
   (html
    "<blockquote>With ordinary variants, such a typo would have been caught as an\n        unknown tag. As a general matter, one should be wary about mixing\n        catch-all cases and polymorphic variants.</blockquote>")))
 (idm181617426768
  ((file variants.html)
   (html
    "<blockquote>Catch-all cases are error-prone even with ordinary variants, but\n        they are especially so with polymorphic variants. That's because you\n        have no way of bounding what tags your function might have to deal\n        with. Such code is particularly vulnerable to typos. For instance, if\n        code that uses <code>is_positive_permissive</code> passes in <code>Float</code> misspelled as <code>Floot</code>, the erroneous code will compile\n        without complaint:</blockquote>")))
 (idm181617443760
  ((file variants.html)
   (html
    "<blockquote>As we saw with the definition of <code>is_positive</code>, a <code>match</code>\n        statement can lead to the inference of an upper bound on a variant\n        type, limiting the possible tags to those that can be handled by the\n        match. If we add a catch-all case to our <code>match</code>\n        statement, we end up with a type with a lower bound:<a name=\"idm181617441728\"></a><a name=\"idm181617440416\"></a><a name=\"idm181617439520\"></a></blockquote>")))
 (idm181617461392
  ((file variants.html)
   (html
    "<blockquote>The preceding code is more delicately balanced than one might\n      imagine. In particular, if we use a catch-all case instead of an\n      explicit enumeration of the cases, the type is no longer narrowed, and\n      so compilation fails:</blockquote>")))
 (idm181617482656
  ((file variants.html)
   (html
    "<blockquote>Now we can try writing <code>extended_color_to_int</code>. The key issue with this\n      code is that <code>extended_color_to_int</code>\n      needs to invoke <code>color_to_int</code> with a\n      narrower type, i.e., one that includes fewer tags. Written properly,\n      this narrowing can be done via a pattern match. In particular, in the\n      following code, the type of the variable <code>color</code> includes only the tags <code>`Basic</code>, <code>`RGB</code>, and <code>`Gray</code>, and not <code>`RGBA</code>:</blockquote>")))
 (idm181617506064
  ((file variants.html)
   (html
    "<blockquote>What we want to do is to share tags between two different variant\n      types, and polymorphic variants let us do this in a natural way. First,\n      let's rewrite <code>basic_color_to_int</code> and\n      <code>color_to_int</code> using polymorphic\n      variants. The translation here is pretty straightforward:</blockquote>")))
 (idm181617508640
  ((file variants.html)
   (html
    "<blockquote>The code looks reasonable enough, but it leads to a type error\n      because <code>extended_color</code> and <code>color</code> are in the compiler's view distinct and\n      unrelated types. The compiler doesn't, for example, recognize any\n      equality between the <code>Basic</code> tag in the\n      two types.</blockquote>")))
 (idm181617518000
  ((file variants.html)
   (html
    "<blockquote>We want to write a function <code>extended_color_to_int</code>, that works like\n      <code>color_to_int</code> for all of the old kinds\n      of colors, with new logic only for handling colors that include an alpha\n      channel. One might try to write such a function as follows.</blockquote>")))
 (idm181617530240
  ((file variants.html)
   (html
    "<blockquote>To see how to use polymorphic variants in practice, we'll return\n      to terminal colors. Imagine that we have a new terminal type that adds\n      yet more colors, say, by adding an alpha channel so you can specify\n      translucent colors. We could model this extended set of colors as\n      follows, using an ordinary variant:<a name=\"idm181617529648\"></a></blockquote>")))
 (idm181617535008
  ((file variants.html)
   (html
    "<blockquote>Here, the inferred type states that the tags can be no more than\n    <code>`Float</code>, <code>`Int</code>, and <code>`Not_a_number</code>, and must contain at least\n    <code>`Float</code> and <code>`Int</code>. As you can already start to see,\n    polymorphic variants can lead to fairly complex inferred types.</blockquote>")))
 (idm181617549488
  ((file variants.html)
   (html
    "<blockquote>Perhaps surprisingly, we can also create polymorphic variant types\n    that have different upper and lower bounds. Note that <code>Ok</code> and <code>Error</code>\n    in the following example come from the <code>Result.t</code> type from Core:<a name=\"idm181617547152\"></a></blockquote>")))
 (idm181617555808
  ((file variants.html)
   (html
    "<blockquote>We can think of these <code>&lt;</code> and\n    <code>&gt;</code> markers as indications of upper\n    and lower bounds on the tags involved. If the same set of tags are both an\n    upper and a lower bound, we end up with an <span><em>exact</em></span>\n    polymorphic variant type, which has neither marker. For example:</blockquote>")))
 (idm181617558880
  ((file variants.html)
   (html
    "<blockquote>The <code>&lt;</code> is there because\n    <code>is_positive</code> has no way of dealing with\n    values that have tags other than <code>`Float of\n    float</code> or <code>`Int of int</code>.</blockquote>")))
 (idm181617566128
  ((file variants.html)
   (html
    "<blockquote>OCaml will in some cases infer a variant type with <code>&lt;</code>, to indicate &quot;these tags or less,&quot; as in\n    the following example:</blockquote>")))
 (idm181617570176
  ((file variants.html)
   (html
    "<blockquote>The <code>&gt;</code> at the beginning of the\n    variant types above is critical because it marks the types as being open\n    to combination with other variant types. We can read the type <code>[&gt; `Int of string | `Float of float]</code> as\n    describing a variant whose tags include <code>`Int of\n    string</code> and <code>`Float of float</code>,\n    but may include more tags as well. In other words, you can roughly\n    translate <code>&gt;</code> to mean: &quot;these tags or\n    more.&quot;</blockquote>")))
 (idm181617579248
  ((file variants.html)
   (html
    "<blockquote>The type system will complain if it sees incompatible uses of the\n    same tag:</blockquote>")))
 (idm181617582560
  ((file variants.html)
   (html
    "<blockquote>As you can see, polymorphic variant types are inferred\n    automatically, and when we combine variants with different tags, the\n    compiler infers a new type that knows about all of those tags. Note that\n    in the preceding example, the tag name (e.g., <code>`Int</code>) matches the type name (<code>int</code>). This is a common convention in\n    OCaml.<a name=\"idm181617580704\"></a></blockquote>")))
 (idm181617593536
  ((file variants.html)
   (html
    "<blockquote>Syntactically, polymorphic variants are distinguished from ordinary\n    variants by the leading backtick. And unlike ordinary variants,\n    polymorphic variants can be used without an explicit type\n    declaration:</blockquote>")))
 (idm181617597456
  ((file variants.html)
   (html
    "<blockquote>In addition to the ordinary variants we've seen so far, OCaml also\n    supports so-called <span><em>polymorphic variants</em></span>. As we'll\n    see, polymorphic variants are more flexible and syntactically more\n    lightweight than ordinary variants, but that extra power comes at a\n    cost.<a name=\"idm181617596512\"></a><a name=\"VARTYPpoly\"></a></blockquote>")))
 (idm181617599056
  ((file variants.html)
   (html
    "<blockquote>More generally, using variants to build recursive data structures is\n    a common technique, and shows up everywhere from designing little\n    languages to building complex data structures.</blockquote>")))
 (idm181617600528
  ((file variants.html)
   (html
    "<blockquote>The example of a Boolean expression language is more than a toy.\n    There's a module very much in this spirit in Core called <code>Blang</code> (short for &quot;Boolean language&quot;), and it\n    gets a lot of practical use in a variety of applications. The\n    simplification algorithm in particular is useful when you want to use it\n    to specialize the evaluation of expressions for which the evaluation of\n    some of the base predicates is already known.</blockquote>")))
 (idm181617607600
  ((file variants.html)
   (html
    "<blockquote>We can of course fix this by simply adding an explicit case for\n    double negation:</blockquote>")))
 (idm181617614992
  ((file variants.html)
   (html
    "<blockquote>It fails to remove the double negation, and it's easy to see why.\n    The <code>not_</code> function has a catch-all case,\n    so it ignores everything but the one case it explicitly considers, that of\n    the negation of a constant. Catch-all cases are generally a bad idea, and\n    if we make the code more explicit, we see that the missing of the double\n    negation is more obvious:</blockquote>")))
 (idm181617620160
  ((file variants.html)
   (html
    "<blockquote>There are some simplifications it misses, however. In particular,\n    see what happens if we add a double negation in:</blockquote>")))
 (idm181617623232
  ((file variants.html)
   (html
    "<blockquote>Here, it correctly converted the <code>Or</code> branch to <code>Const\n    true</code> and then eliminated the <code>And</code> entirely, since the <code>And</code> then had only one nontrivial\n    component.</blockquote>")))
 (idm181617628304
  ((file variants.html)
   (html
    "<blockquote>We can apply this to a Boolean expression and see how good a job it\n    does at simplifying it:</blockquote>")))
 (idm181617636272
  ((file variants.html)
   (html
    "<blockquote>We can now write a simplification routine that is based on the\n    preceding functions.</blockquote>")))
 (idm181617654976
  ((file variants.html)
   (html
    "<blockquote>Another useful operation on expressions is simplification. The\n    following is a set of simplifying construction functions that mirror the\n    tags of an <code>expr</code>:</blockquote>")))
 (idm181617656560
  ((file variants.html)
   (html
    "<blockquote>The structure of the code is pretty straightforwardâ\128\148we're just\n    pattern matching over the structure of the data, doing the appropriate\n    calculation based on which tag we see. To use this evaluator on a concrete\n    example, we just need to write the <code>base_eval</code> function, which is capable of\n    evaluating a base predicate.</blockquote>")))
 (idm181617667408
  ((file variants.html)
   (html
    "<blockquote>Being able to construct such expressions isn't enough; we also need\n    to be able to evaluate them. Here's a function for doing just that:</blockquote>")))
 (idm181617679664
  ((file variants.html)
   (html
    "<blockquote>Using the preceding code, we can construct a simple expression with\n    <code>mail_predicate</code> as its base\n    predicate:</blockquote>")))
 (idm181617688384
  ((file variants.html)
   (html
    "<blockquote>The <code>Base</code> tag is what allows you\n    to tie the <code>expr</code> to your application, by\n    letting you specify an element of some base predicate type, whose truth or\n    falsehood is determined by your application. If you were writing a filter\n    language for an email processor, your base predicates might specify the\n    tests you would run against an email, as in the following example:</blockquote>")))
 (idm181617692768
  ((file variants.html)
   (html
    "<blockquote>The purpose of each tag is pretty straightforward. <code>And</code>, <code>Or</code>, and\n    <code>Not</code> are the basic operators for\n    building up Boolean expressions, and <code>Const</code> lets you enter the constants <code>true</code> and <code>false</code>.</blockquote>")))
 (idm181617697248
  ((file variants.html)
   (html
    "<blockquote>Note that the definition of the type <code>expr</code> is recursive, meaning that a <code>expr</code> may contain other <code>expr</code>s. Also, <code>expr</code> is parameterized by a polymorphic type\n    <code>'a</code> which is used for specifying the\n    type of the value that goes under the <code>Base</code> tag.</blockquote>")))
 (idm181617709344
  ((file variants.html)
   (html
    "<blockquote>An expression in this language will be defined by the variant\n    <code>expr</code>, with one tag for each kind of\n    expression we want to support:</blockquote>")))
 (idm181617713856
  ((file variants.html)
   (html
    "<blockquote>Another common application of variants is to represent tree-like\n    recursive data structures. We'll show how this can be done by walking\n    through the design of a simple Boolean expression language. Such a\n    language can be useful anywhere you need to specify filters, which are\n    used in everything from packet analyzers to mail clients.<a name=\"idm181617713248\"></a><a name=\"idm181617712336\"></a><a name=\"idm181617711040\"></a></blockquote>")))
 (idm181617719184
  ((file variants.html)
   (html
    "<blockquote>And it's explicit at the type level that <code>handle_log_entry</code> sees only <code>Log_entry</code> messages, <code>handle_logon</code> sees only <code>Logon</code> messages, etc.<a name=\"idm181617716288\"></a><a name=\"idm181617715680\"></a></blockquote>")))
 (idm181617728352
  ((file variants.html)
   (html
    "<blockquote>In addition, this design allows us to essentially downcast to the\n    specific message type once we know what it is and then dispatch code to\n    handle just that message type. In particular, while we use the type\n    <code>Common.t * details</code> to represent an\n    arbitrary message, we can use <code>Common.t *\n    Logon.t</code> to represent a logon message. Thus, if we had functions\n    for handling individual message types, we could write a dispatch function\n    as follows:</blockquote>")))
 (idm181617729456
  ((file variants.html)
   (html
    "<blockquote>As you can see, the code for extracting the session ID has been\n    replaced with the simple expression <code>common.Common.session_id</code>.</blockquote>")))
 (idm181617747488
  ((file variants.html)
   (html
    "<blockquote>A full message can then be represented as a pair of a <code>Common.t</code> and a <code>details</code>. Using this, we can rewrite our\n    preceding example as follows:</blockquote>")))
 (idm181617754528
  ((file variants.html)
   (html
    "<blockquote>Separately, we need a record that contains the fields that are\n    common across all messages:</blockquote>")))
 (idm181617763408
  ((file variants.html)
   (html
    "<blockquote>We can then define a variant type that combines these types:</blockquote>")))
 (idm181617777184
  ((file variants.html)
   (html
    "<blockquote>We can improve the code by refactoring our types to explicitly\n    reflect the information that's shared between the different messages. The\n    first step is to cut down the definitions of each per-message record to\n    contain just the information unique to that record:</blockquote>")))
 (idm181617778640
  ((file variants.html)
   (html
    "<blockquote>There's one awkward part of the preceding code, which is the logic\n    that determines the session ID. The code is somewhat repetitive,\n    contemplating each of the possible message types (including the <code>Logon</code> case, which isn't actually possible at\n    that point in the code) and extracting the session ID in each case. This\n    per-message-type handling seems unnecessary, since the session ID works\n    the same way for all of the message types.</blockquote>")))
 (idm181617798016
  ((file variants.html)
   (html "<blockquote>Here's the concrete code:</blockquote>")))
 (idm181617798736
  ((file variants.html)
   (html
    "<blockquote>The set of messages so far that are associated with the\n        user</blockquote>")))
 (idm181617799600
  ((file variants.html)
   (html
    "<blockquote>The set of session identifiers for the user that have been seen\n        thus far</blockquote>")))
 (idm181617801520
  ((file variants.html)
   (html
    "<blockquote>You can increase the precision of your types by using variants to\n    represent differences between types, and records to represent shared\n    structure. Consider the following function that takes a list of <code>client_message</code>s and returns all messages\n    generated by a given user. The code in question is implemented by folding\n    over the list of messages, where the accumulator is a pair of:</blockquote>")))
 (idm181617806880
  ((file variants.html)
   (html
    "<blockquote>A <code>client_message</code> is a <code>Logon</code> <span><em>or</em></span> a <code>Heartbeat</code> <span><em>or</em></span> a <code>Log_entry</code>. If we want to write code that\n    processes messages generically, rather than code specialized to a fixed\n    message type, we need something like <code>client_message</code> to act as one overarching type\n    for the different possible messages. We can then match on the <code>client_message</code> to determine the type of the\n    particular message being dealt with.</blockquote>")))
 (idm181617819888
  ((file variants.html)
   (html
    "<blockquote>This record type combines multiple pieces of data into one value. In particular, a single\n        <code>Log_entry.t</code> has a <code>session_id</code>\n<span><em>and</em></span> a <code>time</code>\n<span><em>and</em></span> an <code>important</code> flag\n        <span><em>and</em></span> a <code>message</code>. More generally, you\n      can think of record types as conjunctions. Variants, on the other hand, are disjunctions,\n      letting you represent multiple possibilities, as in the following example:</blockquote>")))
 (idm181617835984
  ((file variants.html)
   (html
    "<blockquote>Algebraic data types gain much of their power from the ability to\n    construct layered combinations of sums and products. Let's see what we can\n    achieve with this by revisiting the logging server types that were\n    described in <a href=\"records.html\">ChapterÂ 5, <i>Records</i></a>. We'll start by reminding\n    ourselves of the definition of <code>Log_entry.t</code>:</blockquote>")))
 (idm181617845792
  ((file variants.html)
   (html
    "<blockquote>The term <span><em>algebraic data types</em></span> is often used to\n    describe a collection of types that includes variants, records, and\n    tuples. Algebraic data types act as a peculiarly useful and powerful\n    language for describing data. At the heart of their utility is the fact\n    that they combine two different kinds of types: <span><em>product\n    types</em></span>, like tuples and records, which combine multiple\n    different types together and are mathematically similar to Cartesian\n    products; and <span><em>sum types</em></span>, like variants, which let you\n    combine multiple different possibilities into one type, and are\n    mathematically similar to disjoint unions.<a name=\"RECvartyp\"></a><a name=\"idm181617841888\"></a><a name=\"idm181617840992\"></a><a name=\"idm181617840096\"></a><a name=\"idm181617838800\"></a><a name=\"VARTYPrec\"></a></blockquote>")))
 (idm181617848192
  ((file variants.html)
   (html
    "<blockquote>But because the catch-all case encompasses all possibilities, the\n    type system will no longer warn us that we have missed the new <code>Bold</code> case when we change the type to include it.\n    We can get this check back by avoiding the catch-all case, and instead\n    being explicit about the tags that are ignored.</blockquote>")))
 (idm181617859184
  ((file variants.html)
   (html
    "<blockquote>Here's an example that illustrates how catch-all cases interact with\n    exhaustion checks. Imagine we wanted a version of <code>color_to_int</code> that works on older terminals by\n    rendering the first 16 colors (the eight <code>basic_color</code>s in regular and bold) in the normal\n    way, but renders everything else as white. We might have written the\n    function as follows:<a name=\"idm181617857344\"></a></blockquote>")))
 (idm181617859968
  ((file variants.html)
   (html
    "<blockquote>As we've seen, the type errors identified the things that needed to\n    be fixed to complete the refactoring of the code. This is fantastically\n    useful, but for it to work well and reliably, you need to write your code\n    in a way that maximizes the compiler's chances of helping you find the\n    bugs. To this end, a useful rule of thumb is to avoid catch-all cases in\n    pattern matches.</blockquote>")))
 (idm181617867440
  ((file variants.html)
   (html
    "<blockquote>Fixing this now leads us to the correct implementation:</blockquote>")))
 (idm181617878208
  ((file variants.html)
   (html
    "<blockquote>Here, the compiler is complaining that the <code>Basic</code> tag is used with the wrong number of\n    arguments. If we fix that, however, the compiler flag will flag a second\n    problem, which is that we haven't handled the new <code>Bold</code> tag:</blockquote>")))
 (idm181617890960
  ((file variants.html)
   (html
    "<blockquote>We've essentially broken out the <code>Basic</code> case into two cases, <code>Basic</code> and <code>Bold</code>, and <code>Basic</code> has changed from having two arguments to\n    one. <code>color_to_int</code> as we wrote it still\n    expects the old structure of the variant, and if we try to compile that\n    same code again, the compiler will notice the discrepancy:</blockquote>")))
 (idm181617901936
  ((file variants.html)
   (html
    "<blockquote>Consider what would happen if we were to change the definition of\n    <code>color</code> to the following:</blockquote>")))
 (idm181617908272
  ((file variants.html)
   (html
    "<blockquote>OCaml's type system can act as a refactoring tool, warning you of\n    places where your code needs to be updated to match an interface change.\n    This is particularly valuable in the context of variants.<a name=\"idm181617907808\"></a><a name=\"idm181617906496\"></a><a name=\"idm181617905184\"></a><a name=\"idm181617904272\"></a><a name=\"idm181617903376\"></a></blockquote>")))
 (idm181617915600
  ((file variants.html)
   (html
    "<blockquote>Now, we can print text using the full set of available colors:</blockquote>")))
 (idm181617923728
  ((file variants.html)
   (html
    "<blockquote>Once again, we'll use pattern matching to convert a color to a\n  corresponding integer. But in this case, the pattern matching does more than\n  separate out the different cases; it also allows us to extract the data\n  associated with each tag:</blockquote>")))
 (idm181617936672
  ((file variants.html)
   (html
    "<blockquote>We'll also represent this more complicated color space as a variant,\n  but this time, the different tags will have arguments that describe the data\n  available in each case. Note that variants can have multiple arguments,\n  which are separated by <code>*</code>s:</blockquote>")))
 (idm181617937344
  ((file variants.html)
   (html "<blockquote>A 24-level grayscale ramp</blockquote>")))
 (idm181617938208
  ((file variants.html)
   (html
    "<blockquote>A 6â\128\133Ã\151â\128\1336â\128\133Ã\151â\128\1336 RGB color cube</blockquote>")))
 (idm181617939040
  ((file variants.html)
   (html
    "<blockquote>The eight basic colors, in regular and bold versions</blockquote>")))
 (idm181617957360
  ((file variants.html)
   (html
    "<blockquote>In this example, the cases of the variant are simple tags with no\n  associated data. This is substantively the same as the enumerations found in\n  languages like C and Java. But as we'll see, variants can do considerably\n  more than represent a simple enumeration. As it happens, an enumeration\n  isn't enough to effectively describe the full set of colors that a modern\n  terminal can display. Many terminals, including the venerable <code>xterm</code>, support 256 different colors, broken up\n  into the following groups:</blockquote>")))
 (idm181617957808
  ((file variants.html)
   (html
    "<blockquote>On most terminals, that word &quot;Blue&quot; will be rendered in blue.</blockquote>")))
 (idm181617964368
  ((file variants.html)
   (html
    "<blockquote>Using the preceding function, we can generate escape codes to change\n  the color of a given string displayed in a terminal:</blockquote>")))
 (idm181617972784
  ((file variants.html)
   (html
    "<blockquote>The following function uses pattern matching to convert a <code>basic_color</code> to a corresponding integer. The\n  exhaustiveness checking on pattern matches means that the compiler will warn\n  us if we miss a color:</blockquote>")))
 (idm181617986672
  ((file variants.html)
   (html
    "<blockquote>Let's consider a concrete example of how variants can be useful.\n  Almost all terminals support a set of eight basic colors, and we can\n  represent those colors using a variant. Each color is declared as a simple\n  tag, with pipes used to separate the different cases. Note that variant tags\n  must be capitalized:</blockquote>")))
 (idm181617987232
  ((file variants.html)
   (html
    "<blockquote>Each row essentially represents a case of the variant. Each case has an associated tag and\n    may optionally have a sequence of fields, where each field has a specified type.</blockquote>")))
 (idm181617994112
  ((file variants.html)
   (html
    "<blockquote>The basic syntax of a variant type declaration is as\n  follows:<a name=\"idm181617993792\"></a></blockquote>")))
 (idm181617997728
  ((file variants.html)
   (html
    "<blockquote>Variant types are one of the most useful features of OCaml and also\n  one of the most unusual. They let you represent data that may take on\n  multiple different forms, where each form is marked by an explicit tag. As\n  we'll see, when combined with pattern matching, variants give you a powerful\n  way of representing complex data and of organizing the case-analysis on that\n  information.<a name=\"idm181617997072\"></a><a name=\"DTvar\"></a></blockquote>")))
 (idm181619624288
  ((file variables-and-functions.html)
   (html
    "<blockquote>As you can see, OCaml's support for labeled and optional\n        arguments is not without its complexities. But don't let these\n        complexities obscure the usefulness of these features. Labels and\n        optional arguments are very effective tools for making your APIs both\n        more convenient and safer, and it's worth the effort of learning how\n        to use them effectively.<a name=\"idm181619623632\"></a><a name=\"idm181619623024\"></a></blockquote>")))
 (idm181619630000
  ((file variables-and-functions.html)
   (html
    "<blockquote>And indeed, when we provide the two positional arguments, the\n        <code>sep</code> argument is not erased, instead\n        returning a function that expects the <code>sep</code> argument to be provided:</blockquote>")))
 (idm181619636000
  ((file variables-and-functions.html)
   (html
    "<blockquote>An optional argument that doesn't have any following positional\n        arguments can't be erased at all, which leads to a compiler\n        warning:</blockquote>")))
 (idm181619640608
  ((file variables-and-functions.html)
   (html
    "<blockquote>However, if all arguments to a function are presented at once,\n        then erasure of optional arguments isn't applied until all of the\n        arguments are passed in. This preserves our ability to pass in\n        optional arguments anywhere on the argument list. Thus, we can\n        write:</blockquote>")))
 (idm181619648672
  ((file variables-and-functions.html)
   (html
    "<blockquote>then application of the first argument would not cause the\n        optional argument to be erased.</blockquote>")))
 (idm181619655136
  ((file variables-and-functions.html)
   (html
    "<blockquote>The rule is: an optional argument is erased as soon as the first\n        positional (i.e., neither labeled nor optional) argument defined\n        <span><em>after</em></span> the optional argument is passed in. That\n        explains the behavior of <code>prepend_pound</code>. But if we had instead defined\n        <code>concat</code> with the optional argument\n        in the second position:</blockquote>")))
 (idm181619655584
  ((file variables-and-functions.html)
   (html
    "<blockquote>So when does OCaml decide to erase an optional argument?</blockquote>")))
 (idm181619662576
  ((file variables-and-functions.html)
   (html
    "<blockquote>The optional argument <code>?sep</code>\n        has now disappeared, or been <span><em>erased</em></span>. Indeed, if\n        we try to pass in that optional argument now, it will be\n        rejected:</blockquote>")))
 (idm181619668832
  ((file variables-and-functions.html)
   (html
    "<blockquote>But what happens if we partially apply just the first\n        argument?</blockquote>")))
 (idm181619675136
  ((file variables-and-functions.html)
   (html
    "<blockquote>Optional arguments can be tricky to think about in the presence\n        of partial application. We can of course partially apply the optional\n        argument itself:</blockquote>")))
 (idm181619689600
  ((file variables-and-functions.html)
   (html
    "<blockquote>As suggested by the error message, we can get OCaml to accept\n        the fact that <code>f</code> is used with\n        different argument orders if we provide explicit type information.\n        Thus, the following code compiles without error, due to the type\n        annotation on <code>f</code>:<a name=\"idm181619687808\"></a></blockquote>")))
 (idm181619702000
  ((file variables-and-functions.html)
   (html
    "<blockquote>Note that these heuristics might at different points in the\n        source suggest different types. Here's a version of <code>numeric_deriv</code> where different invocations of\n        <code>f</code> list the arguments in different\n        orders:</blockquote>")))
 (idm181619702656
  ((file variables-and-functions.html)
   (html
    "<blockquote>Since there are multiple plausible types to choose from, OCaml\n        needs some heuristic for choosing between them. The heuristic the\n        compiler uses is to prefer labels to options and to choose the order\n        of arguments that shows up in the source code.</blockquote>")))
 (idm181619706960
  ((file variables-and-functions.html)
   (html
    "<blockquote>Even worse, it would be perfectly consistent for <code>f</code> to take an optional argument instead of a\n        labeled one, which could lead to this type signature for <code>numeric_deriv</code>:</blockquote>")))
 (idm181619709616
  ((file variables-and-functions.html)
   (html
    "<blockquote>In principle, it's not obvious how the order of the arguments to\n        <code>f</code> should be chosen. Since labeled\n        arguments can be passed in arbitrary order, it seems like it could as\n        well be <code>y:float -&gt; x:float -&gt;\n        float</code> as it is <code>x:float -&gt;\n        y:float -&gt; float</code>.</blockquote>")))
 (idm181619731856
  ((file variables-and-functions.html)
   (html
    "<blockquote>One subtle aspect of labeled and optional arguments is how they\n        are inferred by the type system. Consider the following example for\n        computing numerical derivatives of a function of two real variables.\n        The function takes an argument <code>delta</code>, which determines the scale at which\n        to compute the derivative; values <code>x</code>\n        and <code>y</code>, which determine at which\n        point to compute the derivative; and the function <code>f</code>, whose derivative is being computed. The\n        function <code>f</code> itself takes two labeled\n        arguments, <code>x</code> and <code>y</code>. Note that you can use an apostrophe as\n        part of a variable name, so <code>x'</code> and\n        <code>y'</code> are just ordinary\n        variables:<a name=\"idm181619725152\"></a><a name=\"idm181619723840\"></a><a name=\"idm181619722928\"></a><a name=\"idm181619721632\"></a></blockquote>")))
 (idm181619736048
  ((file variables-and-functions.html)
   (html
    "<blockquote>Now, if someone calls <code>uppercase_concat</code> without an argument, an\n        explicit <code>None</code> will be passed to\n        <code>concat</code>, leaving <code>concat</code> to decide what the default behavior\n        should be.</blockquote>")))
 (idm181619742560
  ((file variables-and-functions.html)
   (html
    "<blockquote>Instead, we can have <code>uppercase_concat</code> simply pass through the\n        optional argument to <code>concat</code> using\n        the <code>?</code> syntax:</blockquote>")))
 (idm181619744480
  ((file variables-and-functions.html)
   (html
    "<blockquote>In the way we've written it, we've been forced to separately\n        make the decision as to what the default separator is. Thus, if we\n        later change <code>concat</code>'s default\n        behavior, we'll need to remember to change <code>uppercase_concat</code> to match it.</blockquote>")))
 (idm181619754208
  ((file variables-and-functions.html)
   (html
    "<blockquote>One use case for this is when you want to define a wrapper\n        function that mimics the optional arguments of the function it's\n        wrapping. For example, imagine we wanted to create a function called\n        <code>uppercase_concat</code>, which is the same\n        as <code>concat</code> except that it converts\n        the first string that it's passed to uppercase. We could write the\n        function as follows:</blockquote>")))
 (idm181619761760
  ((file variables-and-functions.html)
   (html
    "<blockquote>And the following two lines are equivalent ways of calling\n        <code>concat</code> without specifying <code>sep</code>:</blockquote>")))
 (idm181619773152
  ((file variables-and-functions.html)
   (html
    "<blockquote>But sometimes, passing in <code>Some</code> or <code>None</code> explicitly is exactly what you want.\n        OCaml lets you do this by using <code>?</code>\n        instead of <code>~</code> to mark the argument.\n        Thus, the following two lines are equivalent ways of specifying the\n        <code>sep</code> argument to\n        <code>concat</code>:<a name=\"idm181619769040\"></a></blockquote>")))
 (idm181619776288
  ((file variables-and-functions.html)
   (html
    "<blockquote>Under the covers, a function with an optional argument receives\n        <code>None</code> when the caller doesn't\n        provide the argument, and <code>Some</code> when\n        it does. But the <code>Some</code> and <code>None</code> are normally not explicitly passed in\n        by the caller.</blockquote>")))
 (idm181619780080
  ((file variables-and-functions.html)
   (html
    "<blockquote>This means that rarely used functions should not have optional arguments. A good rule of\n        thumb is to avoid optional arguments for functions internal to a module,\n          <span><em>i.e.</em></span>, functions that are not included in the module's interface, or\n          <code>mli</code> file. We'll learn more about <code>mli</code>s in <a href=\"files-modules-and-programs.html\">ChapterÂ 4, <i>Files, Modules, and Programs</i></a>.</blockquote>")))
 (idm181619780784
  ((file variables-and-functions.html)
   (html
    "<blockquote>The downside is that the caller may be unaware that there is a\n      choice to be made, and so may unknowingly (and wrongly) pick the default\n      behavior. Optional arguments really only make sense when the extra\n      concision of omitting the argument outweighs the corresponding loss of\n      explicitness.</blockquote>")))
 (idm181619781584
  ((file variables-and-functions.html)
   (html
    "<blockquote>Optional arguments are very useful, but they're also easy to abuse. The key advantage of\n        optional arguments is that they let you write functions with multiple arguments that users\n        can ignore most of the time, only worrying about them when they specifically want to invoke\n        those options. They also allow you to extend an API with new functionality without changing\n        existing code.</blockquote>")))
 (idm181619787040
  ((file variables-and-functions.html)
   (html
    "<blockquote>The preceding example needed a bit of boilerplate to choose a\n      default separator when none was provided. This is a common enough\n      pattern that there's an explicit syntax for providing a default value,\n      which allows us to write <code>concat</code> more\n      concisely:</blockquote>")))
 (idm181619792704
  ((file variables-and-functions.html)
   (html
    "<blockquote>Here, <code>?</code> is used in the\n      definition of the function to mark <code>sep</code> as optional. And while the caller can pass\n      a value of type <code>string</code> for <code>sep</code>, internally to the function, <code>sep</code> is seen as a <code>string option</code>, with <code>None</code> appearing when <code>sep</code> is not provided by the caller.</blockquote>")))
 (idm181619803616
  ((file variables-and-functions.html)
   (html
    "<blockquote>Here's an example of a string concatenation function with an\n      optional separator. This function uses the <code>^</code> operator for pairwise string\n      concatenation:</blockquote>")))
 (idm181619807360
  ((file variables-and-functions.html)
   (html
    "<blockquote>An optional argument is like a labeled argument that the caller\n      can choose whether or not to provide. Optional arguments are passed in\n      using the same syntax as labeled arguments, and, like labeled arguments,\n      can be provided in any order.<a name=\"ARGopt\"></a><a name=\"FNCopt\"></a></blockquote>")))
 (idm181619809088
  ((file variables-and-functions.html)
   (html
    "<blockquote>As a result, when passing labeled functions as arguments, you\n        need to take care to be consistent in your ordering of labeled\n        arguments.</blockquote>")))
 (idm181619816000
  ((file variables-and-functions.html)
   (html
    "<blockquote>But, it works smoothly with the original <code>apply_to_tuple</code>:</blockquote>")))
 (idm181619822480
  ((file variables-and-functions.html)
   (html
    "<blockquote>we'll find that it can't be passed in to <code>apply_to_tuple_2</code>.</blockquote>")))
 (idm181619826928
  ((file variables-and-functions.html)
   (html
    "<blockquote>It turns out this order matters. In particular, if we define a\n        function that has a different order</blockquote>")))
 (idm181619834272
  ((file variables-and-functions.html)
   (html
    "<blockquote>Here, the definition of <code>apply_to_tuple</code> sets up the expectation that\n        its first argument is a function with two labeled arguments, <code>first</code> and <code>second</code>, listed in that order. We could have\n        defined <code>apply_to_tuple</code> differently\n        to change the order in which the labeled arguments were listed:</blockquote>")))
 (idm181619841824
  ((file variables-and-functions.html)
   (html
    "<blockquote>One surprising gotcha with labeled arguments is that while order doesn't matter when\n          calling a function with labeled arguments, it does matter in a higher-order context,\n            <span><em>e.g.</em></span>, when passing a function with labeled arguments to another\n          function. Here's an example:<a name=\"idm181619840848\"></a><a name=\"idm181619839920\"></a></blockquote>")))
 (idm181619843760
  ((file variables-and-functions.html)
   (html
    "<blockquote>This requires that we put the function argument first. In\n          other cases, you want to put the function argument second. One\n          common reason is readability. In particular, a multiline function\n          passed as an argument to another function is easiest to read when it\n          is the final argument to that function.</blockquote>")))
 (idm181619854272
  ((file variables-and-functions.html)
   (html
    "<blockquote>When you want flexibility on the order in which arguments are\n          passed. Consider a function like <code>List.iter</code>, which takes two arguments: a\n          function and a list of elements to call that function on. A common\n          pattern is to partially apply <code>List.iter</code> by giving it just the function,\n          as in the following example from earlier in the chapter:</blockquote>")))
 (idm181619855856
  ((file variables-and-functions.html)
   (html
    "<blockquote>This improves the readability of both the signature and of\n          client code that makes use of <code>substring</code> and makes it harder to\n          accidentally swap the position and the length.</blockquote>")))
 (idm181619859264
  ((file variables-and-functions.html)
   (html
    "<blockquote>Here, the two <code>ints</code> are the starting position and length of the\n            substring to extract, respectively. We can make this fact more obvious from the\n            signature by adding labeled:</blockquote>")))
 (idm181619862096
  ((file variables-and-functions.html)
   (html
    "<blockquote>When defining functions that have multiple arguments that\n          might get confused with each other. This is most at issue when the\n          arguments are of the same type. For example, consider this signature\n          for a function that extracts a substring:</blockquote>")))
 (idm181619863072
  ((file variables-and-functions.html)
   (html
    "<blockquote>Choosing label names well is especially important for Boolean\n          values, since it's often easy to get confused about whether a value\n          being true is meant to enable or disable a given feature.</blockquote>")))
 (idm181619866112
  ((file variables-and-functions.html)
   (html
    "<blockquote>The signature makes it hard to divine the meaning of those two\n          arguments. but with labeled arguments, we can make the intent\n          immediately clear:</blockquote>")))
 (idm181619869152
  ((file variables-and-functions.html)
   (html
    "<blockquote>When the meaning of a particular argument is unclear from the\n          type alone. Consider a function for creating a hash table whose\n          first argument is the initial size of the array backing the hash\n          table, and the second is a Boolean flag, which indicates whether\n          that array will ever shrink when elements are removed:</blockquote>")))
 (idm181619872304
  ((file variables-and-functions.html)
   (html
    "<blockquote>When defining a function with lots of arguments. Beyond a\n          certain number, arguments are easier to remember by name than by\n          position.<a name=\"idm181619871888\"></a><a name=\"idm181619870576\"></a></blockquote>")))
 (idm181619873264
  ((file variables-and-functions.html)
   (html
    "<blockquote>Labeled arguments are useful in a few different cases:</blockquote>")))
 (idm181619882672
  ((file variables-and-functions.html)
   (html
    "<blockquote>OCaml also supports <span><em>label punning</em></span>, meaning\n      that you get to drop the text after the <code>:</code> if the name of the label and the name of the\n      variable being used are the same. We were actually already using label\n      punning when defining <code>ratio</code>. The\n      following shows how punning can be used when invoking a\n      function:<a name=\"idm181619880400\"></a><a name=\"idm181619879504\"></a></blockquote>")))
 (idm181619888864
  ((file variables-and-functions.html)
   (html
    "<blockquote>We can then provide a labeled argument using a similar convention.\n      As you can see, the arguments can be provided in any order:</blockquote>")))
 (idm181619898496
  ((file variables-and-functions.html)
   (html
    "<blockquote>Up until now, the functions we've defined have specified their arguments positionally,\n          <span><em>i.e.</em></span>, by the order in which the arguments are passed to the function.\n        OCaml also supports labeled arguments, which let you identify a function argument by name.\n        Indeed, we've already encountered functions from Core like <code>List.map</code> that use labeled arguments. Labeled arguments are marked by a leading\n        tilde, and a label (followed by a colon) is put in front of the variable to be labeled.\n        Here's an example:<a name=\"idm181619896640\"></a><a name=\"idm181619895728\"></a><a name=\"idm181619894416\"></a></blockquote>")))
 (idm181619902080
  ((file variables-and-functions.html)
   (html
    "<blockquote>Also, note the use of partial application to generate the function\n      passed to <code>List.map</code>. In other words,\n      <code>some_or_default 100</code> is a function\n      that was created by feeding just the first argument to <code>some_or_default</code>.</blockquote>")))
 (idm181619912224
  ((file variables-and-functions.html)
   (html
    "<blockquote>We can also combine the different styles of function declaration\n      together, as in the following example, where we declare a two-argument\n      (curried) function with a pattern match on the second argument:</blockquote>")))
 (idm181619919936
  ((file variables-and-functions.html)
   (html
    "<blockquote>This is equivalent to combining an ordinary function definition\n      with a <code>match</code>:</blockquote>")))
 (idm181619933120
  ((file variables-and-functions.html)
   (html
    "<blockquote>Another way to define a function is using the <code>function</code> keyword. Instead of having syntactic\n      support for declaring multiargument (curried) functions, <code>function</code> has built-in pattern matching. Here's\n      an example:<a name=\"idm181619931360\"></a><a name=\"idm181619930064\"></a><a name=\"idm181619929152\"></a></blockquote>")))
 (idm181619935376
  ((file variables-and-functions.html)
   (html
    "<blockquote>The type error aside, this example highlights the importance of\n      choosing the operator you use with care, particularly with respect to\n      associativity.<a name=\"idm181619934944\"></a></blockquote>")))
 (idm181619938640
  ((file variables-and-functions.html)
   (html
    "<blockquote>The type error is a little bewildering at first glance. What's\n      going on is that, because <code>^&gt;</code> is\n      right associative, the operator is trying to feed the value <code>List.dedup ~compare:String.compare</code> to the\n      function <code>List.iter ~f:print_endline</code>.\n      But <code>List.iter ~f:print_endline</code>\n      expects a list of strings as its input, not a function.</blockquote>")))
 (idm181619952032
  ((file variables-and-functions.html)
   (html
    "<blockquote>But <code>|&gt;</code> only works in the intended way because it\n        is left-associative. Let's see what happens if we try using a right-associative operator,\n        like (^&gt;):</blockquote>")))
 (idm181619953136
  ((file variables-and-functions.html)
   (html
    "<blockquote>It is this later form that we're using in the preceding <code>|&gt;</code> pipeline.</blockquote>")))
 (idm181619957616
  ((file variables-and-functions.html)
   (html
    "<blockquote>Or, we can pass it just the function argument, leaving us with a\n      function for printing out a list of strings:</blockquote>")))
 (idm181619965648
  ((file variables-and-functions.html)
   (html
    "<blockquote>An important part of what's happening here is partial application.\n      For example, <code>List.iter</code> normally takes\n      two arguments: a function to be called on each element of the list, and\n      the list to iterate over. We can call <code>List.iter</code> with all its arguments:<a name=\"idm181619963840\"></a></blockquote>")))
 (idm181619975264
  ((file variables-and-functions.html)
   (html
    "<blockquote>Note that we can do this without <code>|&gt;</code>, but the result is a bit more\n      verbose:</blockquote>")))
 (idm181619992240
  ((file variables-and-functions.html)
   (html
    "<blockquote>It's not quite obvious at first what the purpose of this operator\n      is: it just takes a value and a function and applies the function to the\n      value. Despite that bland-sounding description, it has the useful role\n      of a sequencing operator, similar in spirit to using the pipe character\n      in the UNIX shell. Consider, for example, the following code for\n      printing out the unique elements of your <code>PATH</code>. Note that <code>List.dedup</code> that follows removes duplicates\n      from a list by sorting the list using the provided comparison\n      function:<a name=\"idm181619990176\"></a><a name=\"idm181619988864\"></a><a name=\"idm181619987952\"></a><a name=\"idm181619987056\"></a></blockquote>")))
 (idm181619996912
  ((file variables-and-functions.html)
   (html
    "<blockquote>Here's an example of a very useful operator from the standard\n      library whose behavior depends critically on the precedence rules\n      described previously:</blockquote>")))
 (idm181619997296
  ((file variables-and-functions.html)
   (html "<blockquote>which obviously doesn't make sense.</blockquote>")))
 (idm181620003072
  ((file variables-and-functions.html)
   (html
    "<blockquote>Here, OCaml is interpreting the second expression as equivalent\n      to:</blockquote>")))
 (idm181620018064
  ((file variables-and-functions.html)
   (html
    "<blockquote>There's one important special case: <code>-</code> and <code>-.</code>,\n      which are the integer and floating-point subtraction operators, and can\n      act as both prefix operators (for negation) and infix operators (for\n      subtraction). So, both <code>-x</code> and\n      <code>x - y</code> are meaningful expressions.\n      Another thing to remember about negation is that it has lower precedence\n      than function application, which means that if you want to pass a\n      negative value, you need to wrap it in parentheses, as you can see in\n      this code:<a name=\"idm181620014704\"></a><a name=\"idm181620013392\"></a><a name=\"idm181620012080\"></a><a name=\"idm181620011168\"></a></blockquote>")))
 (idm181620083536
  ((file variables-and-functions.html)
   (html
    "<blockquote>The syntactic role of an operator is typically determined by its\n      first character or two, though there are a few exceptions. <a href=\"variables-and-functions.html#table2_1\">TableÂ 2.1, â\128\156Precedence and associativityâ\128\157</a> breaks the different operators and other syntactic\n      forms into groups from highest to lowest precedence, explaining how each\n      behaves syntactically. We write <code>!</code>...\n      to indicate the class of operators beginning with <code>!</code>.</blockquote>")))
 (idm181620089392
  ((file variables-and-functions.html)
   (html
    "<blockquote>What's going on is that <code>(***)</code>\n      isn't interpreted as an operator at all; it's read as a comment! To get\n      this to work properly, we need to put spaces around any operator that\n      begins or ends with <code>*</code>:</blockquote>")))
 (idm181620095792
  ((file variables-and-functions.html)
   (html
    "<blockquote>Note that you have to be careful when dealing with operators\n      containing <code>*</code>. Consider the following\n      example:</blockquote>")))
 (idm181620102592
  ((file variables-and-functions.html)
   (html
    "<blockquote>We can define (or redefine) the meaning of an operator. Here's an\n      example of a simple vector-addition operator on <code>int</code>\n      pairs:</blockquote>")))
 (idm181620104672
  ((file variables-and-functions.html)
   (html
    "<blockquote><code>or</code> is one of a handful of predetermined\n      strings, including <code>mod</code>, the modulus\n      operator, and <code>lsl</code>, for &quot;logical shift\n      left,&quot; a bit-shifting operation.</blockquote>")))
 (idm181620107376
  ((file variables-and-functions.html)
   (html
    "<blockquote>A function is treated syntactically as an operator if the name of\n      that function is chosen from one of a specialized set of identifiers.\n      This set includes identifiers that are sequences of characters from the\n      following set:</blockquote>")))
 (idm181620109152
  ((file variables-and-functions.html)
   (html
    "<blockquote>In the second expression, we've partially applied <code>(+)</code> to create a function that increments its\n      single argument by <code>3</code>.</blockquote>")))
 (idm181620116160
  ((file variables-and-functions.html)
   (html
    "<blockquote>You might not have thought of the second example as an ordinary\n      function, but it very much is. Infix operators like <code>+</code> really only differ syntactically from other\n      functions. In fact, if we put parentheses around an infix operator, you\n      can use it as an ordinary prefix function:</blockquote>")))
 (idm181620127008
  ((file variables-and-functions.html)
   (html
    "<blockquote>So far, we've seen examples of functions used in both prefix and\n      infix style:<a name=\"idm181620126656\"></a><a name=\"idm181620125344\"></a><a name=\"idm181620124448\"></a><a name=\"FNCprf\"></a></blockquote>")))
 (idm181620128608
  ((file variables-and-functions.html)
   (html
    "<blockquote>In addition, having a nonrecursive form makes it easier to create\n      a new definition that extends and supersedes an existing one by\n      shadowing it.</blockquote>")))
 (idm181620130336
  ((file variables-and-functions.html)
   (html
    "<blockquote>But this decision has some good effects. For one thing, recursive\n      (and especially mutually recursive) definitions are harder to reason\n      about than nonrecursive ones. It's therefore useful that, in the absence\n      of an explicit <code>rec</code>, you can assume\n      that a <code>let</code> binding is nonrecursive, and so can only\n      build upon previous bindings.</blockquote>")))
 (idm181620133728
  ((file variables-and-functions.html)
   (html
    "<blockquote>OCaml distinguishes between nonrecursive definitions (using\n      <code>let</code>) and recursive definitions (using\n      <code>let rec</code>) largely for technical\n      reasons: the type-inference algorithm needs to know when a set of\n      function definitions are mutually recursive, and for reasons that don't\n      apply to a pure language like Haskell, these have to be marked\n      explicitly by the programmer.<a name=\"idm181620131792\"></a></blockquote>")))
 (idm181620146560
  ((file variables-and-functions.html)
   (html
    "<blockquote>We can also define multiple mutually recursive values by using\n      <code>let rec</code> combined with the <code>and</code> keyword. Here's a (gratuitously\n      inefficient) example:</blockquote>")))
 (idm181620151088
  ((file variables-and-functions.html)
   (html
    "<blockquote>Note that in the code, the pattern <code>| [] |\n      [_]</code> is what's called an <span><em>or-pattern</em></span>, which\n      is a disjunction of two patterns, meaning that it will be considered a\n      match if either pattern matches. In this case, <code>[]</code> matches the empty list, and <code>[_]</code> matches any single element list. The\n      <code>_</code> is there so we don't have to put an\n      explicit name on that single element.<a name=\"idm181620147584\"></a></blockquote>")))
 (idm181620162320
  ((file variables-and-functions.html)
   (html
    "<blockquote>In order to define a recursive function, you need to mark the\n      <code>let</code> binding as recursive with the <code>rec</code> keyword, as shown in this function for\n      finding the first sequentially repeated element in a list:<a name=\"idm181620160832\"></a></blockquote>")))
 (idm181620167952
  ((file variables-and-functions.html)
   (html
    "<blockquote>A function is <span><em>recursive</em></span> if it refers to\n      itself in its definition. Recursion is important in any programming\n      language, but is particularly important in functional languages, because\n      it is the way that you build looping constructs. (As will be discussed\n      in more detail in <a href=\"imperative-programming-1.html\">ChapterÂ 8, <i>Imperative Programming</i></a>, OCaml\n      also supports imperative looping constructs like <code>for</code> and <code>while</code>, but these are only useful when using\n      OCaml's imperative features.)<a name=\"idm181620165072\"></a><a name=\"idm181620163760\"></a></blockquote>")))
 (idm181620169568
  ((file variables-and-functions.html)
   (html
    "<blockquote>There are small trade-offs between these two approaches, but most\n      of the time, one should stick to currying, since it's the default style\n      in the OCaml world.</blockquote>")))
 (idm181620170240
  ((file variables-and-functions.html)
   (html
    "<blockquote>OCaml handles this calling convention efficiently as well. In\n      particular it does not generally have to allocate a tuple just for the\n      purpose of sending arguments to a tuple-style function. You can't,\n      however, use partial application for this style of function.</blockquote>")))
 (idm181620176544
  ((file variables-and-functions.html)
   (html
    "<blockquote>Currying is not the only way of writing a multiargument function\n      in OCaml. It's also possible to use the different parts of a tuple as\n      different arguments. So, we could write:</blockquote>")))
 (idm181620177200
  ((file variables-and-functions.html)
   (html
    "<blockquote>You might worry that curried functions are terribly expensive, but\n      this is not the case. In OCaml, there is no penalty for calling a\n      curried function with all of its arguments. (Partial application,\n      unsurprisingly, does have a small extra cost.)</blockquote>")))
 (idm181620184304
  ((file variables-and-functions.html)
   (html
    "<blockquote>Note that the <code>fun</code> keyword\n      supports its own syntax for currying, so the following definition of\n      <code>abs_diff</code> is equivalent to the\n      previous one.<a name=\"idm181620182624\"></a></blockquote>")))
 (idm181620186128
  ((file variables-and-functions.html)
   (html
    "<blockquote>The practice of applying some of the arguments of a curried\n      function to get a new function is called <span><em>partial\n      application</em></span>.<a name=\"idm181620185344\"></a></blockquote>")))
 (idm181620195552
  ((file variables-and-functions.html)
   (html
    "<blockquote>Currying is more than just a theoretical curiosity. You can make\n      use of currying to specialize a function by feeding in some of the\n      arguments. Here's an example where we create a specialized version of\n      <code>abs_diff</code> that measures the distance\n      of a given number from <code>3</code>:</blockquote>")))
 (idm181620196048
  ((file variables-and-functions.html)
   (html
    "<blockquote>The parentheses don't change the meaning of the signature, but\n      they make it easier to see the currying.</blockquote>")))
 (idm181620203248
  ((file variables-and-functions.html)
   (html
    "<blockquote>This style of function is called a <span><em>curried</em></span>\n      function. (Currying is named after Haskell Curry, a logician who had a\n      significant impact on the design and theory of programming languages.)\n      The key to interpreting the type signature of a curried function is the\n      observation that <code>-&gt;</code> is\n      right-associative. The type signature of <code>abs_diff</code> can therefore be parenthesized as\n      follows:<a name=\"idm181620200864\"></a><a name=\"idm181620199952\"></a></blockquote>")))
 (idm181620206528
  ((file variables-and-functions.html)
   (html
    "<blockquote>This rewrite makes it explicit that <code>abs_diff</code> is actually a function of one\n      argument that returns another function of one argument, which itself\n      returns the final result. Because the functions are nested, the inner\n      expression <code>abs (x - y)</code> has access to\n      both <code>x</code>, which was bound by the outer\n      function application, and <code>y</code>, which\n      was bound by the inner one.</blockquote>")))
 (idm181620213680
  ((file variables-and-functions.html)
   (html
    "<blockquote>You may find the type signature of <code>abs_diff</code> with all of its arrows a little hard\n      to parse. To understand what's going on, let's rewrite <code>abs_diff</code> in an equivalent form, using the\n      <code>fun</code> keyword:</blockquote>")))
 (idm181620223440
  ((file variables-and-functions.html)
   (html
    "<blockquote>OCaml of course also supports multiargument functions, such\n      as:<a name=\"idm181620223104\"></a><a name=\"idm181620221792\"></a><a name=\"idm181620220880\"></a></blockquote>")))
 (idm181620225664
  ((file variables-and-functions.html)
   (html
    "<blockquote>This connection is important, and will come up more when\n        programming in a monadic style, as we'll see in <a href=\"concurrent-programming-with-async.html\">ChapterÂ 18, <i>Concurrent Programming with Async</i></a>.</blockquote>")))
 (idm181620233696
  ((file variables-and-functions.html)
   (html
    "<blockquote>Functions and <code>let</code> bindings have a lot to do\n        with each other. In some sense, you can think of the parameter of a\n        function as a variable being bound to the value passed by the caller.\n        Indeed, the following two expressions are nearly equivalent:<a name=\"idm181620232784\"></a></blockquote>")))
 (idm181620234896
  ((file variables-and-functions.html)
   (html
    "<blockquote>This is the most common and convenient way to declare a function, but syntactic niceties\n        aside, the two styles of function definition are equivalent.</blockquote>")))
 (idm181620240048
  ((file variables-and-functions.html)
   (html
    "<blockquote>Defining named functions is so common that there is some syntactic\n      sugar for it. Thus, the following definition of <code>plusone</code> is equivalent to the previous\n      definition:</blockquote>")))
 (idm181620246960
  ((file variables-and-functions.html)
   (html
    "<blockquote>The key thing to understand is that functions are ordinary values\n      in OCaml, and you can do everything with them that you'd do with an\n      ordinary value, including passing them to and returning them from other\n      functions and storing them in data structures. We even name functions in\n      the same way that we name other values, by using a\n      <code>let</code> binding:</blockquote>")))
 (idm181620251024
  ((file variables-and-functions.html)
   (html
    "<blockquote>It's worth stopping for a moment to puzzle this example out, since this kind of\n        higher-order use of functions can be a bit obscure at first. Notice that <code>(fun g -&gt; g 5)</code> is a function that takes a function as an\n        argument, and then applies that function to the number <code>5</code>.\n        The invocation of <code>List.map</code> applies <code>(fun g -&gt; g 5)</code> to the elements of the <code>increments</code> list (which are themselves functions) and returns the\n        list containing the results of these function applications.</blockquote>")))
 (idm181620257456
  ((file variables-and-functions.html)
   (html
    "<blockquote>You can even stuff them into a data structure:</blockquote>")))
 (idm181620262560
  ((file variables-and-functions.html)
   (html
    "<blockquote>Or pass it to another function. Passing functions to iteration\n      functions like <code>List.map</code> is probably\n      the most common use case for anonymous functions:</blockquote>")))
 (idm181620267024
  ((file variables-and-functions.html)
   (html
    "<blockquote>Anonymous functions operate in much the same way as named\n      functions. For example, we can apply an anonymous function to an\n      argument:</blockquote>")))
 (idm181620276224
  ((file variables-and-functions.html)
   (html
    "<blockquote>We'll start by looking at the most basic style of function declaration in OCaml: the\n          <span><em>anonymous function</em></span>. An anonymous function is a function that is\n        declared without being named. These can be declared using the <code>fun</code> keyword, as shown here:<a name=\"idm181620274672\"></a><a name=\"idm181620273360\"></a><a name=\"idm181620272448\"></a></blockquote>")))
 (idm181620277952
  ((file variables-and-functions.html)
   (html
    "<blockquote>Given that OCaml is a functional language, it's no surprise that\n    functions are important and pervasive. Indeed, functions have come up in\n    almost every example we've done so far. This section will go into more\n    depth, explaining the details of how OCaml's functions work. As you'll\n    see, functions in OCaml differ in a variety of ways from what you'll find\n    in most mainstream languages.</blockquote>")))
 (idm181620281392
  ((file variables-and-functions.html)
   (html
    "<blockquote>Note that this is our first use of <code>assert</code>, which is useful for marking cases that\n      should be impossible. We'll discuss <code>assert</code> in more detail in <a href=\"error-handling.html\">ChapterÂ 7, <i>Error Handling</i></a>.</blockquote>")))
 (idm181620290000
  ((file variables-and-functions.html)
   (html
    "<blockquote>This case can't really come up in practice, because <code>String.split</code> always returns a list with at\n      least one element. But the compiler doesn't know this, and so it emits\n      the warning. It's generally better to use a <code>match</code>\n      statement to handle such cases explicitly:</blockquote>")))
 (idm181620301552
  ((file variables-and-functions.html)
   (html
    "<blockquote>Using a pattern in a <code>let</code> binding makes the most sense for a pattern\n        that is <span><em>irrefutable</em></span>, <span><em>i.e.</em></span>, where any value of the\n        type in question is guaranteed to match the pattern. Tuple and record patterns are\n        irrefutable, but list patterns are not. Consider the following code that implements a\n        function for upper casing the first element of a comma-separated list:<a name=\"idm181620299712\"></a></blockquote>")))
 (idm181620304096
  ((file variables-and-functions.html)
   (html
    "<blockquote>Here, <code>(ints,strings)</code> is a\n      pattern, and the <code>let</code> binding assigns\n      values to both of the identifiers that show up in that pattern. A\n      pattern is essentially a description of the shape of a data structure,\n      where some components are identifiers to be bound. As we saw in <a href=\"a-guided-tour.html#tuples-lists-options-and-pattern-matching\">the section called â\128\156Tuples, Lists, Options, and Pattern Matchingâ\128\157</a>, OCaml has\n      patterns for a variety of different data types.</blockquote>")))
 (idm181620314960
  ((file variables-and-functions.html)
   (html
    "<blockquote>Another useful feature of <code>let</code> bindings is that\n      they support the use of <span><em>patterns</em></span> on the lefthand\n      side. Consider the following code, which uses <code>List.unzip</code>, a function for converting a list\n      of pairs into a pair of lists:<a name=\"idm181620313024\"></a><a name=\"idm181620311488\"></a><a name=\"idm181620310176\"></a></blockquote>")))
 (idm181620316592
  ((file variables-and-functions.html)
   (html
    "<blockquote>The same is true in a functional language. A function can be\n      applied to different inputs, and thus its variables will take on\n      different values, even without mutation.</blockquote>")))
 (idm181620319952
  ((file variables-and-functions.html)
   (html
    "<blockquote>The answer to this is that variables in OCaml (and generally in functional languages)\n        are really more like variables in an equation than a variable in an imperative language. If\n        you think about the mathematical identity <code>x(y + z) = xy +\n          xz</code>, there's no notion of mutating the variables <code>x</code>, <code>y</code>, and <code>z</code>. They vary in the sense that you can instantiate this equation with different\n        numbers for those variables, and it still holds.</blockquote>")))
 (idm181620321856
  ((file variables-and-functions.html)
   (html
    "<blockquote>One source of confusion for people new to OCaml is the fact that\n      variables are immutable. This seems pretty surprising even on linguistic\n      terms. Isn't the whole point of a variable that it can vary?<a name=\"idm181620321376\"></a></blockquote>")))
 (idm181620323984
  ((file variables-and-functions.html)
   (html
    "<blockquote>In OCaml, <code>let</code> bindings are immutable. There are\n    many kinds of mutable values in OCaml, which we'll discuss in <a href=\"imperative-programming-1.html\">ChapterÂ 8, <i>Imperative Programming</i></a>, but there are no mutable\n    variables.</blockquote>")))
 (idm181620331088
  ((file variables-and-functions.html)
   (html
    "<blockquote>Here, we redefined <code>pi</code> to be zero after the definition\n      of <code>area_of_circle</code>. You might think that this would mean\n      that the result of the computation would now be zero, but in fact, the behavior of the\n      function is unchanged. That's because the original definition of <code>pi</code> wasn't changed; it was just shadowed, which means that any subsequent\n      reference to <code>pi</code> would see the new definition of <code>pi</code> as <code>0</code>, but earlier references would be\n      unchanged. But there is no later use of <code>pi</code>, so the binding\n      of <code>pi</code> to <code>0.</code> made no\n      difference. This explains the warning produced by the toplevel telling us that there is an\n      unused definition of <code>pi</code>.</blockquote>")))
 (idm181620341344
  ((file variables-and-functions.html)
   (html
    "<blockquote>It's important not to confuse a sequence of <code>let</code>\n    bindings with the modification of a mutable variable. For example,\n    consider how <code>area_of_ring</code> would work if\n    we had instead written this purposefully confusing bit of code:</blockquote>")))
 (idm181620353744
  ((file variables-and-functions.html)
   (html
    "<blockquote>One common idiom is to use a series of nested <code>let</code>/<code>in</code>\n    expressions to build up the components of a larger computation. Thus, we\n    might write:<a name=\"idm181620352096\"></a><a name=\"idm181620350800\"></a></blockquote>")))
 (idm181620360880
  ((file variables-and-functions.html)
   (html
    "<blockquote>This time, in the inner scope we called the list of strings <code>languages</code> instead of <code>language_list</code>, thus hiding the original\n    definition of <code>languages</code>. But once the\n    definition of <code>dashed_languages</code> is\n    complete, the inner scope has closed and the original definition of\n    languages reappears:</blockquote>")))
 (idm181620372848
  ((file variables-and-functions.html)
   (html
    "<blockquote>A <code>let</code> binding in an inner scope can\n    <span><em>shadow</em></span>, or hide, the definition from an outer scope.\n    So, for example, we could have written the <code>dashed_languages</code> example as follows:<a name=\"idm181620370976\"></a><a name=\"idm181620369680\"></a></blockquote>")))
 (idm181620379264
  ((file variables-and-functions.html)
   (html
    "<blockquote>Note that the scope of <code>language_list</code> is just the expression <code>String.concat ~sep:&quot;-&quot; language_list</code> and is not\n    available at the toplevel, as we can see if we try to access it\n    now:</blockquote>")))
 (idm181620390720
  ((file variables-and-functions.html)
   (html
    "<blockquote>This first evaluates <span><em><code>expr1</code></em></span> and\n      then evaluates <span><em><code>expr2</code></em></span> with\n          <span><em><code>variable</code></em></span> bound to whatever value\n      was produced by the evaluation of <span><em><code>expr1</code></em></span>. Here's how it looks in practice:</blockquote>")))
 (idm181620395072
  ((file variables-and-functions.html)
   (html
    "<blockquote><code>let</code> can also be used to create a\n    variable binding whose scope is limited to a particular expression, using\n    the following syntax:</blockquote>")))
 (idm181620402768
  ((file variables-and-functions.html)
   (html "<blockquote>Here's a simple example:</blockquote>")))
 (idm181620408368
  ((file variables-and-functions.html)
   (html
    "<blockquote>Every variable binding has a <span><em>scope</em></span>, which is\n    the portion of the code that can refer to that binding. When using\n    <span><strong>utop</strong></span>, the scope of a top-level\n    <code>let</code> binding is everything that follows it in the\n    session. When it shows up in a module, the scope is the remainder of that\n    module.<a name=\"idm181620406384\"></a><a name=\"idm181620405088\"></a><a name=\"idm181620403792\"></a></blockquote>")))
 (idm181620409792
  ((file variables-and-functions.html)
   (html
    "<blockquote>As we'll see when we get to the module system in <a href=\"files-modules-and-programs.html\">ChapterÂ 4, <i>Files, Modules, and Programs</i></a>, this same syntax is used for <code>let</code>\n      bindings at the top level of a module.</blockquote>")))
 (idm181620418720
  ((file variables-and-functions.html)
   (html
    "<blockquote>At its simplest, a variable is an identifier whose meaning is bound\n    to a particular value. In OCaml these bindings are often introduced using\n    the <code>let</code> keyword. We can type a\n    so-called <span><em>top-level</em></span> <code>let</code> binding with the following syntax. Note that\n    variable names must start with a lowercase letter or an\n    underscore:<a name=\"idm181620416480\"></a><a name=\"idm181620415184\"></a><a name=\"idm181620414272\"></a></blockquote>")))
 (idm181620420320
  ((file variables-and-functions.html)
   (html
    "<blockquote>Don't be discouraged if you find yourself overwhelmed by some of the details, especially\n    toward the end of the chapter. The concepts here are important, but if they don't connect for\n    you on your first read, you should return to this chapter after you've gotten a better sense for\n    the rest of the language.</blockquote>")))
 (idm181620421152
  ((file variables-and-functions.html)
   (html
    "<blockquote>Variables and functions are fundamental ideas that show up in virtually all programming\n    languages. OCaml has a different take on these concepts than most languages you're likely to\n    have encountered, so this chapter will cover OCaml's approach to variables and functions in some\n    detail, starting with the basics of how to define a variable, and ending with the intricacies of\n    functions with labeled and optional arguments.</blockquote>")))
 (idm181609582864
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>The finalizer can use all features of OCaml, including assignments that make the value\n      reachable again and thus prevent it from being garbage-collected. It can also loop forever,\n      which will cause other finalizers to be interleaved with it.</blockquote>")))
 (idm181609586176
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>After a garbage collection determines that a heap block <code>b</code> is unreachable, it removes from the set of\n    finalizers all the functions associated with <code>b</code>, and serially applies each of those functions\n    to <code>b</code>. Thus, every finalizer function\n    attached to <code>b</code> will run at most once.\n    However, program termination will not cause all the finalizers to be run\n    before the runtime exits.</blockquote>")))
 (idm181609588288
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>The GC calls the finalization functions in the order of the deallocation. If several\n      values become unreachable during the same GC cycle, the finalization functions will be called\n      in the reverse order of the corresponding calls to <code>add_finalizer</code>. Each call to <code>add_finalizer</code> adds\n      to the set of functions, which are run when the value becomes unreachable. You can have many\n      finalizers all pointing to the same heap block if you wish.</blockquote>")))
 (idm181609599440
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>Building and running this should show the following output:</blockquote>")))
 (idm181609602512
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>Let's explore this with a small example that finalizes values of\n    different types, some of which are heap-allocated and others which are\n    compile-time constants:</blockquote>")))
 (idm181609605776
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>Core provides a <code>Heap_block</code> module\n    that dynamically checks if a given value is suitable for finalizing. This\n    block is then passed to Async's <code>Gc.add_finalizer</code> function that schedules the\n    finalizer safely with respect to all the other concurrent program\n    threads.<a name=\"idm181609603952\"></a></blockquote>")))
 (idm181609606800
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>For this reason, attach finalizers only to values that you are explicitly sure are\n        heap-allocated and aren't immutable. A common use is to attach them to file descriptors to\n        ensure they are closed. However, the finalizer normally shouldn't be the primary way of\n        closing the file descriptor, since it depends on the GC running in order to collect the\n        value. For a busy system, you can easily run out of a scarce resource such as file\n        descriptors before the GC catches up.</blockquote>")))
 (idm181609608944
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>Some constant values can be heap-allocated but never deallocated during the lifetime of\n        the program, for example, a list of integer constants. <code>Heap_block</code> explicitly checks to see if the value is in the major or minor heap,\n        and rejects most constant values. Compiler optimizations may also duplicate some immutable\n        values such as floating-point values in arrays. These may be finalized while another <span>duplicate</span> copy is being used by the program.</blockquote>")))
 (idm181609610416
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>Various values cannot have finalizers attached since they aren't heap-allocated. Some\n        examples of values that are not heap-allocated are integers, constant constructors,\n        Booleans, the empty array, the empty list, and the unit value. The exact list of what is\n        heap-allocated or not is implementation-dependent, which is why Core provides the <code>Heap_block</code> module to explicitly check before attaching the\n        finalizer.</blockquote>")))
 (idm181609616416
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>OCaml's automatic memory management guarantees that a value will eventually be freed when\n      it's no longer in use, either via the GC sweeping it or the program terminating. It's\n      sometimes useful to run extra code just before a value is freed by the GC, for example, to\n      check that a file descriptor has been closed, or that a log message is recorded.<a name=\"idm181609616160\"></a><a name=\"idm181609614112\"></a><a name=\"idm181609612544\"></a></blockquote>")))
 (idm181609620336
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>The <code>-no-compactions</code> and <code>-stabilize-gc</code> options can help force a situation where your application has\n          fragmented memory. This can simulate the behavior of a long-running application without\n          you having to actually wait that long to re-create the behavior in a performance unit\n            test.<a name=\"idm181609618480\"></a></blockquote>")))
 (idm181609659696
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>The only way to know for sure is to benchmark your program under real-world scenarios\n          using <code>Core_bench</code> and experiment with the trade-offs.\n          The command-line benchmark binaries have a number of useful options that affect garbage\n          collection behavior:</blockquote>")))
 (idm181609660608
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>There is a stark space/time trade-off here. The mutable version takes significantly\n          longer to complete than the immutable one but allocates many fewer minor-heap words than\n          the immutable version. Minor allocation in OCaml is very fast, and so it is often better\n          to use immutable data structures in preference to the more conventional mutable versions.\n          On the other hand, if you only rarely mutate a value, it can be faster to take the\n          write-barrier hit and not allocate at all.</blockquote>")))
 (idm181609671728
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>This program defines a type <code>t1</code> that is mutable and <code>t2</code> that is immutable. The benchmark loop\n        iterates over both fields and increments a counter. Compile and\n        execute this with some extra options to show the amount of garbage\n        collection occurring:</blockquote>")))
 (idm181609675328
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>Let's see this for ourselves with a simple test program. You'll\n        need to install the Core benchmarking suite via <code>opam install core_bench</code> before you compile\n        this code:</blockquote>")))
 (idm181609676848
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>The OCaml compiler keeps track of any mutable types and adds a call to the runtime\n            <code>caml_modify</code> function before making the change. This\n          checks the location of the target write and the value it's being changed to, and ensures\n          that the remembered set is consistent. Although the write barrier is reasonably efficient,\n          it can sometimes be slower than simply allocating a fresh value on the fast minor heap and\n          doing some extra minor collections.</blockquote>")))
 (idm181609677504
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>The write barrier can have profound implications for the\n        structure of your code. It's one of the reasons using immutable data\n        structures and allocating a fresh copy with changes can sometimes be\n        faster than mutating a record in place.</blockquote>")))
 (idm181609681712
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>OCaml maintains a set of such <span><em>intergenerational\n      pointers</em></span> to avoid this dependency between a major and minor\n      heap collection. The compiler introduces a write barrier to update this\n      so-called <span><em>remembered set</em></span> whenever a major-heap\n      block is modified to point at a minor-heap block.<a name=\"idm181609680352\"></a><a name=\"idm181609679456\"></a></blockquote>")))
 (idm181609686496
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>One complexity of generational collection arises from the fact\n      that minor heap sweeps are much more frequent than major heap\n      collections. In order to know which blocks in the minor heap are live,\n      the collector must track which minor-heap blocks are directly pointed to\n      by major-heap blocks. Without this information, each minor collection\n      would also require scanning the much larger major heap.<a name=\"idm181609686240\"></a><a name=\"idm181609684048\"></a><a name=\"idm181609683152\"></a></blockquote>")))
 (idm181609693568
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>A value of <code>0</code> triggers a\n        compaction after every major garbage collection cycle, whereas the\n        maximum value of <code>1000000</code> disables\n        heap compaction completely. The default settings should be fine unless\n        you have unusual allocation patterns that are causing a\n        higher-than-usual rate of compactions:</blockquote>")))
 (idm181609695392
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>The <code>max_overhead</code> setting in\n        the <code>Gc</code> module defines the\n        connection between free memory and allocated memory after which\n        compaction is activated.</blockquote>")))
 (idm181609696816
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>The heap compaction cycle avoids this by relocating all the values in the major heap\n        into a fresh heap that places them all contiguously in memory again. A naive implementation\n        of the algorithm would require extra memory to store the new heap, but OCaml performs the\n        compaction in place within the existing heap.</blockquote>")))
 (idm181609701056
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>After a certain number of major GC cycles have completed, the heap\n      may begin to be fragmented due to values being deallocated out of order\n      from how they were allocated. This makes it harder for the GC to find a\n      contiguous block of memory for fresh allocations, which in turn would\n      require the heap to be grown unnecessarily.<a name=\"idm181609700448\"></a><a name=\"idm181609699136\"></a><a name=\"idm181609698240\"></a></blockquote>")))
 (idm181609704432
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>The <code>space_overhead</code> setting\n        controls how aggressive the GC is about setting the slice size to a\n        large size. This represents the proportion of memory used for live\n        data that will be &quot;wasted&quot; because the GC doesn't immediately collect\n        unreachable blocks. Core defaults this to <code>100</code> to reflect a typical system that isn't\n        overly memory-constrained. Set this even higher if you have lots of\n        memory, or lower to cause the GC to work harder and collect blocks\n        faster at the expense of using more CPU time.</blockquote>")))
 (idm181609711504
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>You can trigger a single slice of the major GC via the <code>major_slice</code> call. This performs a minor\n        collection first, and then a single slice. The size of the slice is\n        normally automatically computed by the GC to an appropriate value and\n        returns this value so that you can modify it in future calls if\n        necessary:</blockquote>")))
 (idm181609714464
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>To mark an impure heap, the GC first marks it as pure and walks\n      through the entire heap block-by-block in increasing order of memory\n      address. If it finds a gray block, it adds it to the gray list and\n      recursively marks it using the usual strategy for a pure heap. Once the\n      scan of the complete heap is finished, the mark phase checks again\n      whether the heap has again become impure and repeats the scan until it\n      is pure again. These full-heap scans will continue until a successful\n      scan completes without overflowing the gray list.<a name=\"idm181609713632\"></a></blockquote>")))
 (idm181609716672
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>This process is repeated until the gray value stack is empty and\n      there are no further values to mark. There's one important edge case in\n      this process, though. The gray value stack can only grow to a certain\n      size, after which the GC can no longer recurse into intermediate values\n      since it has nowhere to store them while it follows their fields. If\n      this happens, the heap is marked as <span><em>impure</em></span> and a\n      more expensive check is initiated once the existing gray values have\n      been processed.<a name=\"idm181609715488\"></a></blockquote>")))
 (idm181609720224
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>The marking process starts with a set of <span><em>root</em></span>\n      values that are always live (such as the application stack). All values\n      on the heap are initially marked as white values that are possibly\n      reachable but haven't been scanned yet. It recursively follows all the\n      fields in the roots via a depth-first search, and pushes newly\n      encountered white blocks onto an intermediate stack of <span><em>gray\n      values</em></span> while it follows their fields. When a gray value's\n      fields have all been followed, it is popped off the stack and colored\n      black.<a name=\"idm181609718592\"></a><a name=\"idm181609717696\"></a></blockquote>")))
 (idm181609721040
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>The color tags in the value headers store most of the state of the\n      marking process, allowing it to be paused and resumed later. The GC and\n      application alternate between marking a slice of the major heap and\n      actually getting on with executing the program logic. The OCaml runtime\n      calculates a sensible value for the size of each major heap slice based\n      on the rate of allocation and available memory.</blockquote>")))
 (idm181609734272
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>The marking process can take a long time to run over the complete\n      major heap and has to pause the main application while it's active. It\n      therefore runs incrementally by marking the heap in\n      <span><em>slices</em></span>. Each value in the heap has a 2-bit\n      <span><em>color</em></span> field in its header that is used to store\n      information about whether the value has been marked so that the GC can\n      resume easily between slices.<a name=\"idm181609732800\"></a></blockquote>")))
 (idm181609738032
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>The same behavior can be controlled at runtime by setting\n          <code>a=0</code> or <code>a=1</code> in <code>OCAMLRUNPARAM</code>.</blockquote>")))
 (idm181609740512
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>You can set the heap allocation policy via the <code>Gc.allocation_policy</code> field. A value of\n          <code>0</code> (the default) sets it to\n          next-fit, and <code>1</code> to the first-fit\n          allocator.</blockquote>")))
 (idm181609741760
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>For some workloads that need more real-time behavior under load, the reduction in the\n          frequency of heap compaction will outweigh the extra allocation cost.</blockquote>")))
 (idm181609743808
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>First-fit allocation focuses on reducing memory fragmentation\n        (and hence the number of compactions), but at the expense of slower\n        memory allocation. Every allocation scans the free list from the\n        beginning for a suitable free chunk, instead of reusing the most\n        recent heap chunk as the next-fit allocator does.<a name=\"idm181609743200\"></a></blockquote>")))
 (idm181609744528
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>If your program allocates values of many varied sizes, you may sometimes find that\n          your free list becomes fragmented. In this situation, the GC is forced to perform an\n          expensive compaction despite there being free chunks, since none of the chunks alone are\n          big enough to satisfy the request.</blockquote>")))
 (idm181609746272
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>Next-fit allocation is the default allocation strategy. It's\n        quite a cheap allocation mechanism, since the same heap chunk can be\n        reused across allocation requests until it runs out. This in turn\n        means that there is good memory locality to use CPU caches\n        better.</blockquote>")))
 (idm181609746976
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>Next-fit allocation keeps a pointer to the block in the free list that was most\n          recently used to satisfy a request. When a new request comes in, the allocator searches\n          from the next block to the end of the free list, and then from the beginning of the free\n          list up to that block.</blockquote>")))
 (idm181609751152
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>The free list of blocks is always checked first when allocating a\n      new block in the major heap. The default free list search is called\n      <span><em>next-fit allocation</em></span>, with an alternative\n      <span><em>first-fit</em></span> algorithm also available.<a name=\"idm181609749856\"></a><a name=\"idm181609748944\"></a></blockquote>")))
 (idm181609754512
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>The major heap does its best to manage memory allocation as\n      efficiently as possible and relies on heap compaction to ensure that\n      memory stays contiguous and unfragmented. The default allocation policy\n      normally works fine for most applications, but it's worth bearing in\n      mind that there are other options, too.<a name=\"idm181609753920\"></a><a name=\"idm181609752592\"></a></blockquote>")))
 (idm181609756432
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>Remember that most allocations to the major heap will go via the\n      minor heap and only be promoted if they are still used by the program\n      after a minor collection. The one exception to this is for values larger\n      than 256 words (that is, 2 KB on 64-bit platforms). These will be\n      allocated directly on the major heap, since an allocation on the minor\n      heap would likely trigger an immediate collection and copy it to the\n      major heap anyway.</blockquote>")))
 (idm181609757232
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>Allocating an OCaml value on the major heap first checks the free\n      list of blocks for a suitable region to place it. If there isn't enough\n      room on the free list, the runtime expands the major heap by allocating\n      a fresh heap chunk that will be large enough. That chunk is then added\n      to the free list, and the free list is checked again (and this time will\n      definitely succeed).</blockquote>")))
 (idm181609762160
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>If you anticipate allocating some large OCaml values or many small values in one go,\n          then setting the heap increment to a larger value will improve performance by reducing the\n          amount of heap resizing required in order to satisfy the allocation requests. A small\n          increment may result in lots of smaller heap chunks spread across different regions of\n          virtual memory that require more housekeeping in the OCaml runtime to keep track of\n          them:</blockquote>")))
 (idm181609764192
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>The <code>Gc</code> module uses the\n        <code>major_heap_increment</code> value to\n        control the major heap growth. This defines the number of words to add\n        to the major heap per expansion and is the only memory allocation\n        operation that the operating system observes from the OCaml runtime\n        after initial startup (since the minor is fixed in size).</blockquote>")))
 (idm181609766864
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>Each chunk's data area starts on a page boundary, and its size is a multiple of the page\n        size (4 KB). It contains a contiguous sequence of heap blocks that can be as small as one or\n        two 4 KB pages, but are usually allocated in 1 MB chunks (or 512 KB on 32-bit\n          architectures).<a name=\"idm181609766304\"></a></blockquote>")))
 (idm181609767552
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>A link to the next heap chunk in the list</blockquote>")))
 (idm181609768432
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>An allocation size in bytes used during heap compaction to\n          merge small blocks to defragment the heap</blockquote>")))
 (idm181609769248
  ((file understanding-the-garbage-collector.html)
   (html "<blockquote>The size in bytes of the data area</blockquote>")))
 (idm181609770512
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>The <span><em>malloc</em></span>ed virtual address of the memory region containing\n            the chunk</blockquote>")))
 (idm181609774320
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>The major heap consists of a singly linked list of contiguous memory chunks sorted in\n        increasing order of virtual address. Each chunk is a single memory region allocated via\n          <span><em>malloc(3)</em></span> and consists of a header and data area which contains OCaml\n        heap chunks. A heap chunk header contains:<a name=\"idm181609773344\"></a><a name=\"idm181609772448\"></a></blockquote>")))
 (idm181609776720
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>A major garbage collection must also stop the world to ensure that blocks can be moved\n      around without this being observed by the live application. The mark-and-sweep phases run\n      incrementally over slices of the heap to avoid pausing the application for long <span>periods</span> of time, and also precede each slice with a fast minor\n      collection. Only the compaction phase touches all the memory in one go, and is a relatively\n      rare operation.</blockquote>")))
 (idm181609778688
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>The <span><em>compact</em></span> phase relocates live blocks into a freshly allocated\n          heap to eliminate gaps in the free list. This prevents the fragmentation of heap blocks in\n          long-running programs and normally occurs much less frequently than the mark and sweep\n            <span>phases</span>.</blockquote>")))
 (idm181609779984
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>The <span><em>sweep</em></span> phase sequentially scans the heap\n        chunks and identifies dead blocks that weren't marked earlier.</blockquote>")))
 (idm181609781728
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>The <span><em>mark</em></span> phase scans the block graph and\n        marks all live blocks by setting a bit in the tag of the block header\n        (known as the <span><em>color</em></span> tag).</blockquote>")))
 (idm181609782832
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>The major heap is typically much larger than the minor heap and can\n    scale to gigabytes in size. It is cleaned via a mark-and-sweep garbage\n    collection algorithm that operates in several phases:</blockquote>")))
 (idm181609790320
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>The major heap is where the bulk of the longer-lived and larger\n    values in your program are stored. It consists of any number of\n    noncontiguous chunks of virtual memory, each containing live blocks\n    interspersed with regions of free memory. The runtime system maintains a\n    free-list data structure that indexes all the free memory that it has\n    allocated, and uses it to satisfy allocation requests for OCaml\n    blocks.<a name=\"idm181609789616\"></a><a name=\"idm181609788288\"></a><a name=\"idm181609787360\"></a><a name=\"Hmh\"></a><a name=\"idm181609784528\"></a></blockquote>")))
 (idm181609792336
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>Changing the GC size dynamically will trigger an immediate minor\n        heap collection. Note that Core increases the default minor heap size\n        from the standard OCaml installation quite significantly, and you'll\n        want to reduce this if running in very memory-constrained\n        environments.</blockquote>")))
 (idm181609802720
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>The default minor heap size in OCaml is normally 2 MB on 64-bit platforms, but this is\n          increased to 8 MB if you use Core (which generally prefers default settings that improve\n          performance, but at the cost of a bigger memory profile). This setting can be overridden\n          via the <code>s=&lt;words&gt;</code> argument to <code>OCAMLRUNPARAM</code>. You can change it after the program has started\n          by calling the <code>Gc.set</code> function:</blockquote>")))
 (idm181609808160
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>You may wonder why <code>limit</code> is\n      required at all, since it always seems to equal <code>start</code>. It's because the easiest way for the\n      runtime to schedule a minor heap collection is by setting <code>limit</code> to equal <code>end</code>. The next allocation will never have\n      enough space after this is done and will always trigger a garbage\n      collection. There are various internal reasons for such early\n      collections, such as handling pending UNIX signals, and they don't\n      ordinarily matter for application code.<a name=\"idm181609804832\"></a></blockquote>")))
 (idm181609810848
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>Allocating a block in the minor heap just requires <code>ptr</code> to be decremented by the size of the block (including the header) and a\n        check that it's not less than <code>limit</code>. If there isn't\n        enough space left for the block without decrementing past <code>limit</code>, a minor garbage collection is triggered. This is a very fast check (with\n        no branching) on most CPU architectures.</blockquote>")))
 (idm181609815296
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>In a fresh minor heap, the <code>limit</code> equals the <code>start</code>, and the current <code>ptr</code> will equal the <code>end</code>. <code>ptr</code>\n      decreases as blocks are allocated until it reaches <code>limit</code>, at which point a minor garbage\n      collection is triggered.</blockquote>")))
 (idm181609820576
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>The runtime stores the boundaries of the minor heap in two\n      pointers that delimit the start and end of the heap region (<code>caml_young_start</code> and <code>caml_young_end</code>, but we will drop the <code>caml_young</code> prefix for brevity). The <code>base</code> is the memory address returned by the\n      system <code>malloc</code>, and <code>start</code> is aligned against the next nearest word\n      boundary from <code>base</code> to make it easier\n      to store OCaml values.</blockquote>")))
 (idm181609825840
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>The minor heap is a contiguous chunk of virtual memory that is usually a few megabytes\n        in size so that it can be scanned quickly.<a name=\"idm181609825440\"></a></blockquote>")))
 (idm181609828464
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>To garbage-collect the minor heap, OCaml uses <span><em>copying collection</em></span> to\n      move all live blocks in the minor heap to the major heap. This takes work proportional to the\n      number of live blocks in the minor heap, which is typically small according to the\n      generational hypothesis. The minor collection <span><em>stops the world</em></span> (that it,\n      halts the application) while it runs, which is why it's so important that it complete quickly\n      to let the application resume running with minimal interruption.</blockquote>")))
 (idm181609834240
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>The minor heap is where most of your short-lived values are held. It\n    consists of one contiguous chunk of virtual memory containing a sequence\n    of OCaml blocks. If there is space, allocating a new block is a fast,\n    constant-time operation that requires just a couple of CPU\n    instructions.<a name=\"idm181609833680\"></a><a name=\"idm181609832384\"></a><a name=\"idm181609831072\"></a><a name=\"idm181609830160\"></a></blockquote>")))
 (idm181609838112
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>You can also control the behavior of OCaml programs by setting the <code>OCAMLRUNPARAM</code> environment variable before launching your\n        application. This lets you set GC parameters without recompiling, for example to benchmark\n        the effects of different settings. The format of <code>OCAMLRUNPARAM</code> is documented in the <a href=\"http://caml.inria.fr/pub/docs/manual-ocaml/manual024.html\" target=\"_top\">OCaml\n        manual</a>.</blockquote>")))
 (idm181609840864
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>OCaml provides several mechanisms to query and alter the behavior\n      of the runtime system. The <code>Gc</code> module\n      provides this functionality from within OCaml code, and we'll frequently\n      refer to it in the rest of the chapter. As with several other standard\n      library modules, Core alters the <code>Gc</code>\n      interface from the standard OCaml library. We'll assume that you've\n      opened <code>Core.Std</code> in our\n      explanations.</blockquote>")))
 (idm181609844336
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>OCaml uses different memory layouts and garbage-collection algorithms for the major and\n      minor heaps to account for this generational difference. We'll explain how they differ in more\n      detail next.<a name=\"idm181609843872\"></a><a name=\"idm181609842976\"></a></blockquote>")))
 (idm181609846240
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>A typical functional programming style means that young blocks tend\n    to die young and old blocks tend to stay around for longer than young\n    ones. This is often referred to as the <span><em>generational\n    hypothesis</em></span>.<a name=\"idm181609845376\"></a></blockquote>")))
 (idm181609847376
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>A larger, variable-size <span><em>major heap</em></span> for blocks that have been live\n          longer</blockquote>")))
 (idm181609848640
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>A small, fixed-size <span><em>minor heap</em></span> where most\n        blocks are initially allocated</blockquote>")))
 (idm181609851008
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>A generational GC maintains separate memory regions to hold blocks based on how long the\n      blocks have been live. OCaml's heap is split into two such regions:<a name=\"idm181609850576\"></a></blockquote>")))
 (idm181609854288
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>The usual OCaml programming style involves allocating many small variables that are used\n      for a short period of time and then never accessed again. OCaml takes advantage of this fact\n      to improve performance by using a <span><em>generational</em></span> GC.<a name=\"idm181609853376\"></a><a name=\"idm181609852464\"></a></blockquote>")))
 (idm181609856432
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>All blocks reachable from the roots by following edges in the graph\n    must be retained, and unreachable blocks can be reused by the application.\n    The algorithm used by OCaml to perform this heap traversal is commonly\n    known as <span><em>mark and sweep</em></span> garbage collection, and we'll\n    explain it further now.</blockquote>")))
 (idm181609860192
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>The GC doesn't keep constant track of values as they are allocated and used. Instead, it\n      regularly scans them by starting from a set of <span><em>root</em></span> values that the\n      application always has access to (such as the stack). The GC maintains a directed graph in\n      which heap blocks are nodes, and there is an edge from heap block <code>b1</code> to heap block <code>b2</code> if some field of <code>b1</code> is a pointer to <code>b2</code>.</blockquote>")))
 (idm181609864112
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>When there isn't enough memory available to satisfy an allocation request from the pool of\n      allocated heap blocks, the runtime system invokes the garbage collector (GC). An OCaml program\n      can't explicitly free a value when it is done with it. Instead, the GC regularly determines\n      which values are <span><em>live</em></span> and which values are <span><em>dead</em></span>,\n      i.e., no longer in use. Dead values are collected and their memory made available for reuse by\n      the application.<a name=\"idm181609862576\"></a><a name=\"idm181609861648\"></a></blockquote>")))
 (idm181609870528
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>The OCaml runtime is a C library that provides routines that can be\n  called from running OCaml programs. The runtime manages a\n  <span><em>heap</em></span>, which is a collection of memory regions that it\n  obtains from the operating system. The runtime uses this memory to hold\n  <span><em>heap blocks</em></span> that it fills up with OCaml values in\n  response to allocation requests by the OCaml program.<a name=\"idm181609869104\"></a><a name=\"idm181609867792\"></a><a name=\"idm181609866496\"></a></blockquote>")))
 (idm181609873184
  ((file understanding-the-garbage-collector.html)
   (html
    "<blockquote>We've described the runtime format of individual OCaml variables earlier, in <a href=\"memory-representation-of-values.html\">ChapterÂ 20, <i>Memory Representation of Values</i></a>. When you execute your program, OCaml manages the\n    lifecycle of these variables by regularly scanning allocated values and freeing them when\n    they're no longer needed. This in turn means that your applications don't need to manually\n    implement memory management, and it greatly reduces the likelihood of memory leaks creeping into\n    your code.<a name=\"idm181609871968\"></a></blockquote>")))
 (idm181608792400
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>There are several new integrated tools emerging that combine these typed AST files with common editors such as Emacs or Vim.  The best of these is <a href=\"https://github.com/def-lkb/merlin\" target=\"_top\">Merlin</a>, which adds value and module autocompletion, displays inferred types and can build and display errors directly from within your editor.  There are instructions available on its homepage for configuring Merlin with your favorite editor.</blockquote>")))
 (idm181608794288
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>You'll rarely need to look at this raw output from the compiler unless you're building\n        IDE tools such as <span><strong>ocp-index</strong></span>, or are hacking on extensions\n        to the core compiler itself. However, it's useful to know that this intermediate form exists\n        before we delve further into the code generation process next, in <a href=\"the-compiler-backend-byte-code-and-native-code.html\">ChapterÂ 23, <i>The Compiler Backend: Bytecode and Native code</i></a>.</blockquote>")))
 (idm181608797968
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The typed AST is more explicit than the untyped syntax tree. For\n      instance, the type declaration has been given a unique name (<code>t/1008</code>), as has the <code>v</code> value (<code>v/1011</code>).<a name=\"idm181608795632\"></a><a name=\"idm181608795024\"></a></blockquote>")))
 (idm181608825776
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The typed AST that is normally output as a compiled <code>cmt</code> file can be displayed in a more\n      developer-readable form via the <code>-dtypedtree</code> option:</blockquote>")))
 (idm181608826400
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Each portion of the AST is decorated with the precise location information (including\n        the filename and character location of the token). This code hasn't been type checked yet,\n        so the raw tokens are all included.</blockquote>")))
 (idm181608826960
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>This is rather a lot of output for a simple two-line program, but\n      it shows just how much structure the OCaml parser generates even from a\n      small source file.</blockquote>")))
 (idm181608856240
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Let's first look at the untyped syntax tree that's generated from\n      the parsing phase:</blockquote>")))
 (idm181608859536
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>We'll use our toy <code>typedef.ml</code>\n      again:</blockquote>")))
 (idm181608861072
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The compiler has a couple of advanced flags that can dump the raw\n      output of the internal AST representation. You can't depend on these\n      flags to give the same output across compiler revisions, but they are a\n      useful learning tool.<a name=\"idm181608860560\"></a></blockquote>")))
 (idm181608864864
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>You need to pass <span><strong>ocp-index</strong></span> a set of directories to\n        search for <code>cmt</code> files in, and a fragment of text to\n        autocomplete. As you can imagine, autocompletion is invaluable on larger codebases. See the\n          <a href=\"https://github.com/ocamlpro/ocp-index\" target=\"_top\"><span><em>ocp-index</em></span></a>\n        home page for more information on how to integrate it with your favorite editor.</blockquote>")))
 (idm181608884720
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Let's refer back to our Ncurses binding example from the beginning\n      of <a href=\"foreign-function-interface.html\">ChapterÂ 19, <i>Foreign Function Interface</i></a>. This module defined\n      bindings for the Ncurses library. First, compile the interfaces with\n      <span><code>-bin-annot</code></span> so that we can obtain the\n        <code>cmt</code> and <code>cmti</code> files, and then run <span><strong>ocp-index</strong></span> in completion mode:</blockquote>")))
 (idm181608891920
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>One such command-line tool to display autocompletion information\n      in your editor is <span><strong>ocp-index</strong></span>. Install\n      it via OPAM as follows:<a name=\"idm181608890880\"></a><a name=\"idm181608889984\"></a></blockquote>")))
 (idm181608894048
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The <code>cmt</code> files are particularly\n    useful for IDE tools to match up OCaml source code at a specific location\n    to the inferred or external types.</blockquote>")))
 (idm181608896576
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The compiler can output this as compiled <code>cmt</code> and <code>cmti</code>\n    files that contain the typed AST for the implementation and signatures of\n    a compilation unit. This is activated by passing the <code>-bin-annot</code> flag to the compiler.</blockquote>")))
 (idm181608905664
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>When the type checking process has successfully completed, it is\n    combined with the AST to form a <span><em>typed abstract syntax\n    tree</em></span>. This contains precise location information for every\n    token in the input file, and decorates each token with concrete type\n    information.<a name=\"idm181608904720\"></a><a name=\"idm181608903824\"></a><a name=\"idm181608902928\"></a><a name=\"idm181608901632\"></a><a name=\"idm181608900336\"></a><a name=\"typesyntree\"></a><a name=\"CPtypsyn\"></a></blockquote>")))
 (idm181608909456
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>You'll need to choose for yourself if you prefer short paths or\n      the default behavior in your own projects, and pass the <code>-short-paths</code> flag to the compiler if you need\n      it.<a name=\"idm181608907584\"></a></blockquote>")))
 (idm181608910496
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The <span><strong>utop</strong></span> enhanced toplevel activates short paths by\n        default, which is why we have not had to do this before in our interactive examples.\n        However, the compiler doesn't default to the short path heuristic, since there are some\n        situations where the type aliasing information is useful to know, and it would be lost in\n        the error if the shortest module path is always picked.</blockquote>")))
 (idm181608918544
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The compiler can remedy this via a so-called short paths\n      heuristic. This causes the compiler to search all the type aliases for\n      the shortest module path and use that as the preferred output type. The\n      option is activated by passing <code>-short-paths</code> to the compiler, and works on the\n      toplevel, too.<a name=\"idm181608917328\"></a></blockquote>")))
 (idm181608920400
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The default <code>List</code> module in\n      OCaml is overridden by <code>Core.Std.List</code>.\n      The compiler does its best to show the type equivalence, but at the cost\n      of a more verbose error message.</blockquote>")))
 (idm181608927344
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>This type error without <code>Core.Std</code> has a straightforward type error.\n      When we switch to Core, though, it gets more verbose:</blockquote>")))
 (idm181608933632
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>There's one downside to this approach: type errors suddenly get\n      much more verbose. We can see this if you run the vanilla OCaml toplevel\n      (not <span><strong>utop</strong></span>).</blockquote>")))
 (idm181608936272
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Core uses the OCaml module system quite extensively to provide a complete replacement\n        standard library. It collects these modules into a single <code>Std</code> module, which provides a single module that needs to be opened to import\n        the replacement modules and functions.<a name=\"idm181608935072\"></a></blockquote>")))
 (idm181608938208
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>This mostly only happens with unit tests, since they are built at the same time as the\n          library. You can avoid it by being aware of the need to open the packed module from the\n          test, or only using the library after it has been installed (and hence not exposing the\n          intermediate compiled modules).</blockquote>")))
 (idm181608940464
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>However, the types of <code>A</code> and <code>X.A</code> are <span><em>not</em></span> automatically equivalent so\n          the type checker will complain if you attempt to mix and match the packed and unpacked\n          versions of the library.</blockquote>")))
 (idm181608943184
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>One very common build error that happens with packing is\n        confusion resulting from building the packed <code>cmi</code> in the same directory as the submodules.\n        When you add this directory to your module search path, the submodules\n        are also visible. If you forget to include the top-level prefix (e.g.,\n        <code>X.A</code>) and instead use a submodule\n        directly (<code>A</code>), then this will\n        compile and link fine.</blockquote>")))
 (idm181608958400
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>You can now compile this test module and see that its inferred\n      interface is the result of using the packed contents of <code>X</code>. We further verify this by examining the\n      imported interfaces in <code>Test</code> and\n      confirming that neither <code>A</code> nor\n      <code>B</code> are mentioned in there and that\n      only the packed <code>X</code> module is\n      used:</blockquote>")))
 (idm181608962816
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>You can now run <span><em>corebuild</em></span> to build the <code>X.cmx</code> file directly, but let's create a new module to link against <code>X</code> to complete the example:</blockquote>")))
 (idm181608980480
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>First, create a couple of toy modules called <code>A.ml</code> and <code>B.ml</code> that contain a single value. You will\n      also need a <code>_tags</code> file that adds the\n      <code>-for-pack</code> option for the <code>cmx</code> files (but careful to exclude the pack\n      target itself). Finally, the <code>X.mlpack</code>\n      file contains the list of modules that are intended to be packed under\n      module <code>X</code>. There are special rules in\n      <span><strong>ocamlbuild</strong></span> that tell it how to map\n      <code>%.mlpack</code> files to the packed <code>%.cmx</code> or <code>%.cmo</code> equivalent:</blockquote>")))
 (idm181608982528
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Packing for native code introduces an additional requirement: the\n      modules that are intended to be packed must be compiled with the\n      <code>-for-pack</code> argument that specifies the\n      eventual name of the pack. The easiest way to handle packing is to let\n      <span><strong>ocamlbuild</strong></span> figure out the\n      command-line arguments for you, so let's try that out next with a simple\n      example.</blockquote>")))
 (idm181608987824
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The <code>-pack</code> compiler option\n      accepts a list of compiled object files (<code>.cmo</code> in bytecode and <code>.cmx</code> for native code) and their associated\n      <code>.cmi</code> compiled interfaces, and\n      combines them into a single module that contains them as submodules of\n      the output. Packing thus generates an entirely new <code>.cmo</code> (or <code>.cmx</code> file) and <code>.cmi</code> that includes the input modules.</blockquote>")))
 (idm181608989808
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The module-to-file mapping described so far rigidly enforces a 1:1\n      mapping between a top-level module and a file. It's often convenient to\n      split larger modules into separate files to make editing easier, but\n      still compile them all into a single OCaml module.<a name=\"idm181608989264\"></a></blockquote>")))
 (idm181608991856
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>This hash check is very conservative, but ensures that\n          separate compilation remains type-safe all the way up to the final\n          link phase. Your build system should ensure that you never see the\n          preceding error messages, but if you do run into it, just clean out\n          your intermediate files and recompile from scratch.</blockquote>")))
 (idm181608998624
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The long alphanumeric identifier beside each module name is a\n          hash calculated from all the types and values exported from that\n          compilation unit. It's used during type-checking and linking to\n          ensure that all of the compilation units have been compiled\n          consistently against one another. A difference in the hashes means\n          that a compilation unit with the same module name may have\n          conflicting type signatures in different modules. The compiler will\n          reject such programs with an error similar to this:</blockquote>")))
 (idm181609001824
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote><code>ocamlobjinfo</code> examines the\n          compiled interface and displays what other compilation units it\n          depends on. In this case, we don't use any external modules other\n          than <code>Pervasives</code>. Every module\n          depends on <code>Pervasives</code> by default,\n          unless you use the <code>-nopervasives</code>\n          flag (this is an advanced use case, and you shouldn't normally need\n          it).</blockquote>")))
 (idm181609011184
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>OCaml guards against this by recording a MD5 checksum in every\n          <code>cmi</code>. Let's examine our earlier\n          <code>typedef.ml</code> more closely:</blockquote>")))
 (idm181609012656
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>For separate compilation to be sound, we need to ensure that\n          all the <code>cmi</code> files used to\n          type-check a module are the same across compilation runs. If they\n          vary, this raises the possibility of two modules checking different\n          type signatures for a common module with the same name. This in turn\n          lets the program completely violate the static type system and can\n          lead to memory corruption and crashes.</blockquote>")))
 (idm181609020320
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>By default, only the current directory and the OCaml standard\n        library will be searched for <code>cmi</code>\n        files. The <code>Pervasives</code> module from\n        the standard library will also be opened by default in every\n        compilation unit. The standard library location is obtained by running\n        <code>ocamlc -where</code> and can be overridden\n        by setting the <code>CAMLLIB</code> environment\n        variable. Needless to say, don't override the default path unless you\n        have a good reason to (such as setting up a cross-compilation\n        environment).<a name=\"idm181609016960\"></a><a name=\"idm181609016064\"></a><a name=\"idm181609014768\"></a></blockquote>")))
 (idm181609022464
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The module search path is set by adding <code>-I</code> flags to the compiler command line with\n        the directory containing the <code>cmi</code>\n        files as the argument. Manually specifying these flags gets complex\n        when you have lots of libraries, and is the reason why the OCamlfind\n        frontend to the compiler exists. OCamlfind automates the process of\n        turning third-party package names and build descriptions into\n        command-line flags that are passed to the compiler command\n        line.</blockquote>")))
 (idm181609025840
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The type checker resolves such module references into concrete\n        structures and signatures in order to unify types across module\n        boundaries. It does this by searching a list of directories for a\n        compiled interface file matching that module's name. For example, it\n        will look for <code>alice.cmi</code> and\n        <code>bob.cmi</code> on the search path and use\n        the first ones it encounters as the interfaces for <code>Alice</code> and <code>Bob</code>.</blockquote>")))
 (idm181609031664
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>In the preceding example, <code>Alice</code> also has a reference to another module\n        <code>Bob</code>. For the overall type of\n        <code>Alice</code> to be valid, the compiler\n        also needs to check that the <code>Bob</code>\n        module contains at least a <code>Bob.name</code>\n        value and defines a <code>Bob.t</code>\n        type.<a name=\"idm181609027280\"></a></blockquote>")))
 (idm181609036176
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>These two files are exactly analogous to including the following\n        code directly in another module that references <code>Alice</code>:</blockquote>")))
 (idm181609038832
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html "<blockquote>and a corresponding signature file:</blockquote>")))
 (idm181609042160
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Create a file called <code>alice.ml</code>\n        with the following contents:</blockquote>")))
 (idm181609044112
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Individual compilation units provide a convenient way to break\n        up a big module hierarchy into a collection of files. The relationship\n        between files and modules can be explained directly in terms of the\n        module system.<a name=\"idm181609043600\"></a></blockquote>")))
 (idm181609047168
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>This section discusses how the compiler implements them in more\n      detail. Modules are essential for larger projects that consist of many\n      source files (also known as <span><em>compilation units</em></span>).\n      It's impractical to recompile every single source file when changing\n      just one or two files, and the module system minimizes such\n      recompilation while still encouraging code reuse.<a name=\"idm181609046112\"></a></blockquote>")))
 (idm181609050800
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The OCaml module system enables smaller components to be reused\n      effectively in large projects while still retaining all the benefits of\n      static type safety. We covered the basics of using modules earlier in\n      <a href=\"files-modules-and-programs.html\">ChapterÂ 4, <i>Files, Modules, and Programs</i></a>. The module language that\n      operates over these signatures also extends to functors and first-class\n      modules, described in <a href=\"functors.html\">ChapterÂ 9, <i>Functors</i></a> and <a href=\"first-class-modules.html\">ChapterÂ 10, <i>First-Class Modules</i></a>, respectively.<a name=\"idm181609048608\"></a></blockquote>")))
 (idm181609053440
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Bear in mind that the <code>cmi</code> files generated in\n          principal mode differ from the default mode. Try to ensure that you compile your whole\n          project with it activated. Getting the files mixed up won't let you violate type safety,\n          but it can result in the type checker failing unexpectedly very occasionally. In this\n          case, just recompile with a clean source tree.</blockquote>")))
 (idm181609054832
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>If compiling in principal mode works, it is guaranteed that the\n        program will pass type checking in nonprincipal mode, too. For this\n        reason, the <span><strong>corebuild</strong></span> wrapper\n        script activates principal mode by default, preferring stricter type\n        inference over a small loss in compilation speed and extra disk space\n        usage.</blockquote>")))
 (idm181609056912
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Ideally, all code should systematically use <code>-principal</code>. It reduces variance in type inference and enforces the notion of\n          a single known type. However, there are drawbacks to this mode: type inference is slower,\n          and the <code>cmi</code> files become larger. This is generally only\n          a problem if you extensively use objects, which usually have larger type signatures to\n          cover all their methods.</blockquote>")))
 (idm181609063712
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The <span><strong>ocamlbuild</strong></span> equivalent is to add the tag\n            <code>principal</code> to your build. The\n            <span><em>corebuild</em></span> wrapper script actually adds this by default, but it does\n          no harm to explicitly repeat it:</blockquote>")))
 (idm181609069408
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>There is now no ambiguity about the inferred types, since we've\n        explicitly given the argument a type, and the order of inference of\n        the subexpressions no longer matters.</blockquote>")))
 (idm181609072208
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>You can fix this either by permuting the order of the type\n        declarations, or by adding an explicit type annotation:</blockquote>")))
 (idm181609076768
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>This example isn't principal, since the inferred type for\n        <code>x.foo</code> is guided by the inferred\n        type of <code>x.bar</code>, whereas principal\n        typing requires that each subexpression's type can be calculated\n        independently. If the <code>x.bar</code> use is\n        removed from the definition of <code>f</code>,\n        its argument would be of type <code>t</code> and\n        not <code>type s</code>.</blockquote>")))
 (idm181609084384
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Inferring the signature with <code>-principal</code> will show you a new\n        warning:</blockquote>")))
 (idm181609087168
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Here's an example of principality warnings when used with record\n        disambiguation.</blockquote>")))
 (idm181609087904
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Automatic disambiguation of record field and constructor\n            names (since OCaml 4.1)</blockquote>")))
 (idm181609088752
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Generalized algebraic data types (GADTs) present from OCaml 4.0 onward</blockquote>")))
 (idm181609089568
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html "<blockquote>Discarding optional labeled arguments</blockquote>")))
 (idm181609090432
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Permuting the order of labeled arguments in a function from\n            their type definition</blockquote>")))
 (idm181609091232
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html "<blockquote>Polymorphic methods for objects</blockquote>")))
 (idm181609092208
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The principality check only affects a few language\n        features:</blockquote>")))
 (idm181609097520
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The compiler also has a stricter <span><em>principal type checking</em></span> mode\n          that is activated via the <span><code>-principal</code></span> flag. This warns about risky uses of type information\n          to ensure that the type inference has one principal result. A type is considered risky if\n          the success or failure of type inference depends on the order in which subexpressions are\n            typed.<a name=\"idm181609095456\"></a><a name=\"idm181609094144\"></a><a name=\"idm181609093248\"></a></blockquote>")))
 (idm181609099280
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>This error points directly to the correct line number that\n        contains the typo. Once you fix the problem, you can remove the manual\n        annotations if you prefer more succinct code. You can also leave the\n        annotations there, of course, to help with future refactoring and\n        debugging.</blockquote>")))
 (idm181609107152
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>This code contains exactly the same error as before, but we've\n        added a closed type definition of the polymorphic variants, and a type\n        annotation to the <code>algebra</code>\n        definition. The compiler error we get is much more useful now:</blockquote>")))
 (idm181609109984
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Let's see what happens with an explicit type annotation to help\n        the compiler out:</blockquote>")))
 (idm181609111328
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>This is because the type checker doesn't have enough information\n        to match the inferred type of the <code>algebra</code> definition to its application a few\n        lines down. It calculates types for both expressions separately, and\n        when they don't match up, outputs the difference as best it\n        can.</blockquote>")))
 (idm181609112640
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The type error is perfectly accurate, but rather verbose and\n        with a line number that doesn't point to the exact location of the\n        incorrect variant name. The best the compiler can do is to point you\n        in the general direction of the <code>algebra</code> function application.</blockquote>")))
 (idm181609126368
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>There's a single character typo in the code so that it uses\n        <code>Nu</code> instead of <code>Num</code>. The resulting type error is\n        impressive:</blockquote>")))
 (idm181609129232
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>For instance, consider this broken example that expresses some\n        simple algebraic operations over integers:</blockquote>")))
 (idm181609132176
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Manual type annotations are particularly useful if you use lots\n        of polymorphic variants or objects. Type inference with row\n        polymorphism can generate some very large signatures, and errors tend\n        to propagate more widely than if you are using more explicitly typed\n        variants or classes.<a name=\"idm181609131600\"></a><a name=\"idm181609130272\"></a></blockquote>")))
 (idm181609132992
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>There are a couple of tricks to make it easier to quickly locate\n        type errors in your code. The first is to introduce manual type\n        annotations to narrow down the source of your error more accurately.\n        These annotations shouldn't actually change your types and can be\n        removed once your code is correct. However, they act as anchors to\n        locate errors while you're still writing your code.</blockquote>")))
 (idm181609139664
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>It's often said that the hardest part of writing OCaml code is\n        getting past the type checkerâ\128\148but once the code does compile, it works\n        correctly the first time! This is an exaggeration of course, but it\n        can certainly feel true when moving from a dynamically typed language.\n        The OCaml static type system protects you from certain classes of bugs\n        such as memory errors and abstraction violations by rejecting your\n        program at compilation time rather than by generating an error at\n        runtime. Learning how to navigate the type checker's compile-time\n        feedback is key to building robust libraries and applications that\n        take full advantage of these static checks.<a name=\"idm181609138480\"></a><a name=\"idm181609137168\"></a><a name=\"idm181609136256\"></a><a name=\"idm181609134944\"></a><a name=\"idm181609134032\"></a></blockquote>")))
 (idm181609141664
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>OCaml does have some language extensions that strain the limits of\n      principal type inference, but by and large, most programs you write will\n      never <span><em>require</em></span> annotations (although they sometimes\n      help the compiler produce better error messages).</blockquote>")))
 (idm181609142976
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>OCaml type inference is based on the Hindley-Milner algorithm,\n      which is notable for its ability to infer the most general type for an\n      expression without requiring any explicit type annotations. The\n      algorithm can deduce multiple types for an expression and has the notion\n      of a <span><em>principal type</em></span> that is the most general choice\n      from the possible inferences. Manual type annotations can specialize the\n      type explicitly, but the automatic inference selects the most general\n      type unless told otherwise.</blockquote>")))
 (idm181609145888
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Type inference is the process of determining the appropriate types\n      for expressions based on their use. It's a feature that's partially\n      present in many other languages such as Haskell and Scala, but OCaml\n      embeds it as a fundamental feature throughout the core\n      language.<a name=\"idm181609145328\"></a><a name=\"idm181609144416\"></a></blockquote>")))
 (idm181609148432
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Signature files provide a place to write succinct documentation\n        and to abstract internal details that shouldn't be exported.\n        Maintaining separate signature files also speeds up incremental\n        compilation in larger code bases, since recompiling a <code>mli</code> signature is much faster than a full\n        compilation of the implementation to native code.</blockquote>")))
 (idm181609151808
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>As with any such stylistic debate, you should experiment with which system works best\n          for you. Everyone agrees on one thing though: no matter in what order you write them,\n          production code should always explicitly define an <code>mli</code>\n          file for every <code>ml</code> file in the project. It's also\n          perfectly fine to have an <code>mli</code> file without a\n          corresponding <code>ml</code> file if you're only declaring\n          signatures (such as module types).</blockquote>")))
 (idm181609153216
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>If you're writing code that spans multiple files, it's sometimes easier to start by\n          writing all the <code>mli</code> signatures and checking that they\n          type-check against one another. Once the signatures are in place, you can write the\n          implementations with the confidence that they'll all glue together correctly, with no\n          cyclic dependencies among the modules.</blockquote>")))
 (idm181609161296
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>There are two schools of thought on which order OCaml code\n        should be written in. It's very easy to begin writing code by starting\n        with an <code>ml</code> file and using the type\n        inference to guide you as you build up your functions. The <code>mli</code> file can then be generated as described,\n        and the exported functions documented.<a name=\"idm181609159440\"></a><a name=\"idm181609157728\"></a><a name=\"idm181609156832\"></a><a name=\"idm181609155536\"></a><a name=\"idm181609154640\"></a></blockquote>")))
 (idm181609174880
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The compiler makes sure that your <code>ml</code> and <code>mli</code>\n      files have compatible signatures. The type checker throws an immediate\n      error if this isn't the case:</blockquote>")))
 (idm181609177456
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The compiler stores a compiled version of the interface as a\n      <code>cmi</code> file. This interface is either\n      obtained from compiling an <code>mli</code>\n      signature file for a module, or by the inferred type if there is only an\n      <code>ml</code> implementation present.</blockquote>")))
 (idm181609178736
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The output is the default signature for the module that represents the input file. It's\n        often useful to redirect this output to an <code>mli</code> file to\n        give you a starting signature to edit the external interface without having to type it all\n        in by hand.</blockquote>")))
 (idm181609184400
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Now run the compiler with the <code>-i</code> flag to infer the type signature for that\n      file. This runs the type checker but doesn't compile the code any\n      further after displaying the interface to the standard output:</blockquote>")))
 (idm181609187552
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>We've already seen how you can explore type inference directly\n      from the toplevel. It's also possible to generate type signatures for an\n      entire file by asking the compiler to do the work for you. Create a file\n      with a single type definition and value:</blockquote>")))
 (idm181609189760
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Subtyping in OCaml objects is always an explicit operation (via the\n    <code>:&gt;</code> operator). This means that it\n    doesn't complicate the core type inference engine and can be tested as a\n    separate concern.</blockquote>")))
 (idm181609193200
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Type inference doesn't scale to very large codebases that depend on separate compilation\n      of files. A small change in one module may ripple through thousands of other files and\n      libraries and require all of them to be recompiled. The module system solves this by providing\n      the facility to combine and manipulate explicit type signatures for modules within a large\n      project, and also to reuse them via functors and first-class modules.<a name=\"idm181609192480\"></a><a name=\"idm181609191184\"></a></blockquote>")))
 (idm181609193760
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Automatic type inference lets you write succinct code for a\n    particular task and have the compiler ensure that your use of variables is\n    locally consistent.</blockquote>")))
 (idm181609194576
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Checks for objects and polymorphic variants</blockquote>")))
 (idm181609196240
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Combines software components with explicit knowledge of their\n          type signatures</blockquote>")))
 (idm181609197904
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>An algorithm that calculates types for a module without\n          requiring manual type annotations</blockquote>")))
 (idm181609208464
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Although type checking is done in a single pass in OCaml, it\n    actually consists of three distinct steps that happen\n    simultaneously:<a name=\"idm181609208064\"></a><a name=\"idm181609206752\"></a><a name=\"idm181609205440\"></a><a name=\"idm181609203888\"></a><a name=\"idm181609202336\"></a><a name=\"CPstatictype\"></a></blockquote>")))
 (idm181609209104
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>After obtaining a valid abstract syntax tree, the compiler has to\n    verify that the code obeys the rules of the OCaml type system. Code that\n    is syntactically correct but misuses values is rejected with an\n    explanation of the problem.</blockquote>")))
 (idm181609211024
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Using OPAM to install existing Camlp4 extensions and\n          inspecting their source code</blockquote>")))
 (idm181609212368
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The online <a href=\"http://brion.inria.fr/gallium/index.php/Camlp4\" target=\"_top\">Camlp4\n          wiki</a></blockquote>")))
 (idm181609213968
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>A series of <a href=\"http://ambassadortothecomputers.blogspot.co.uk/p/reading-camlp4.html\" target=\"_top\">blog\n          posts</a> by Jake Donham describe the internals of Camlp4 and\n          its syntax extension mechanism</blockquote>")))
 (idm181609217344
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The best resources to get started are:<a name=\"idm181609217040\"></a><a name=\"idm181609216432\"></a><a name=\"idm181609215824\"></a><a name=\"idm181609215216\"></a></blockquote>")))
 (idm181609220592
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>We've deliberately only shown you how to use Camlp4 extensions\n      here, and not how to build your own. The full details of building new\n      extensions are fairly daunting and could be the subject of an entirely\n      new book.<a name=\"idm181609220096\"></a><a name=\"idm181609218784\"></a></blockquote>")))
 (idm181609223840
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Another thing to consider before deploying your own syntax\n        extension is compatibility with other extensions. Two separate\n        extensions can create a grammar clash that leads to odd syntax errors\n        and hard-to-reproduce bugs. That's why most of Core's syntax\n        extensions go through <code>type_conv</code>,\n        which acts as a single point for extending the grammar via the\n        <code>with</code> keyword.</blockquote>")))
 (idm181609225216
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>While it's tempting to compress all your boilerplate code into Camlp4 extensions, it\n          can make your source code much harder for other people to quickly read and understand.\n          Core mainly focuses on type-driven code generation using the <code>type_conv</code> extension and doesn't fundamentally change the OCaml syntax.</blockquote>")))
 (idm181609225600
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Syntax extensions are a powerful extension mechanism that can\n        completely alter your source code's layout and style. Core includes a\n        very conservative set of extensions that take care to minimize the\n        syntax changes. There are a number of third-party libraries that are\n        much more ambitiousâ\128\148some introduce whitespace-sensitive indentation,\n        while others build entirely new embedded languages using OCaml as a\n        host language, and yet others introduce conditional compilation for\n        macros or optional logging.</blockquote>")))
 (idm181609233104
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The external signature generated by <code>comparelib</code> is much simpler than the actual\n      code. Running Camlp4 directly on the original source code lets you see\n      these all these transformations precisely.<a name=\"idm181609232000\"></a><a name=\"idm181609230720\"></a><a name=\"idm181609229824\"></a><a name=\"idm181609228912\"></a><a name=\"idm181609227984\"></a></blockquote>")))
 (idm181609240000
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>If you rerun the Camlp4 dumper script now, you'll see that\n      different code is produced for signature files:</blockquote>")))
 (idm181609247392
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Another useful feature of <code>type_conv</code> is that it can\n        generate module signatures, too. Copy the earlier type definition into a <code>comparelib_test.mli</code> that's got exactly the same <span>content</span>:<a name=\"idm181609245024\"></a><a name=\"idm181609243712\"></a></blockquote>")))
 (idm181609249728
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Although you don't use <code>_z</code> in\n        your code, this will never generate an unused variable warning.</blockquote>")))
 (idm181609252624
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>One other important reason for using wildcard matches is to bind\n        a variable name to something that you want to use in future code but\n        don't want to use right away. This would normally generate an &quot;unused\n        value&quot; compiler warning. These warnings are suppressed for any\n        variable name that's prepended with an underscore:</blockquote>")))
 (idm181609253152
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The last one is used to ignore Async expressions that should run\n        in the background rather than blocking in the current thread.</blockquote>")))
 (idm181609256320
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>If the expression has a different type, then write it\n        explicitly:</blockquote>")))
 (idm181609259712
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>This is fine for mechanically generated code from Type_conv but\n        should be avoided in code that you write by hand. If it's a\n        unit-returning expression, then write a <code>unit</code> binding explicitly instead. This will\n        cause a type error if the expression changes type in the future (e.g.,\n        due to code refactoring):</blockquote>")))
 (idm181609261664
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>You may have noticed the <code>let _ =\n        fun</code> construct in the autogenerated code above. The\n        underscore in a <code>let</code> binding is just\n        the same as a wildcard underscore in a pattern match, and tells the\n        compiler to accept any return value and discard it immediately.</blockquote>")))
 (idm181609270080
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Note that although the generated code uses <code>Pervasives.compare</code>, it is also annotated with\n      a <code>string</code> type. This lets the compiler\n      use a specialized string comparison function and not actually call the\n      runtime polymorphic comparison function. This has implications for\n      correctness, too: recall from <a href=\"maps-and-hash-tables.html\">ChapterÂ 13, <i>Maps and Hash Tables</i></a>\n      that <code>comparelib</code> provides reliable\n      comparison functions that work for values that are logically the same\n      but that have differing internal representations (e.g., <code>Int.Set.t</code>).<a name=\"idm181609266240\"></a><a name=\"idm181609265344\"></a><a name=\"idm181609264032\"></a></blockquote>")))
 (idm181609270800
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The output contains the original type definition accompanied by\n      some automatically generated code that implements an explicit comparison\n      function for each field in the record. If you're using the extension in\n      your compiler command line, this generated code is then compiled as if\n      you had typed it in yourself.</blockquote>")))
 (idm181609292128
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The script uses the <span><strong>ocamlfind</strong></span>\n      package manager to list the include and library paths needed by <code>comparelib</code>. It then invokes the <span><strong>camlp4o</strong></span> preprocessor with these paths and\n      outputs the resulting AST to the standard output:</blockquote>")))
 (idm181609295104
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>We need to run the Camlp4 binary with the library paths to\n      Comparelib and Type_conv. Let's use a small shell script to wrap this\n      invocation:</blockquote>")))
 (idm181609298576
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Let's turn to the command line to obtain the result of the\n      <code>comparelib</code> transformation instead.\n      Create a file that contains the type declaration from earlier:</blockquote>")))
 (idm181609301184
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The toplevel is a quick way to examine the signatures generated from the extensions, but\n        how can we see what these new functions actually do? We can't do this from <span><strong>utop</strong></span> directly, since it embeds the Camlp4 invocation as an\n        automated part of its operation.<a name=\"idm181609300016\"></a></blockquote>")))
 (idm181670357744
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The first definition of <code>t</code> is a standard OCaml phrase\n        and results in the expected output. The second one includes the <code>with compare</code> directive. This is intercepted by <code>comparelib</code> and transformed into the original type definition with two new\n        functions also <span>included</span>.</blockquote>")))
 (idm181609310016
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Let's see how <code>comparelib</code> solves\n      this problem by running it in <span><strong>utop</strong></span>:</blockquote>")))
 (idm181609313792
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>OCaml provides a built-in polymorphic comparison operator that inspects the runtime\n        representation of two values to see if they're equal. As we noted in <a href=\"maps-and-hash-tables.html\">ChapterÂ 13, <i>Maps and Hash Tables</i></a>, the polymorphic comparison is less efficient than\n        defining explicit comparison functions between values. However, it quickly becomes tedious\n        to manually define comparison functions for complex type definitions.<a name=\"idm181609312608\"></a><a name=\"idm181609311056\"></a></blockquote>")))
 (idm181609317104
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The first directive loads the <span><strong>ocamlfind</strong></span> top-level interface that lets you\n      require <span><strong>ocamlfind</strong></span> packages (including\n      all their dependent packages). The second directive instructs the\n      toplevel to filter all phrases via Camlp4. You can now run <span><strong>utop</strong></span> and load the syntax extensions in. We'll\n      use the <code>comparelib</code> syntax extension\n      for our experiments.</blockquote>")))
 (idm181609331840
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The <span><strong>utop</strong></span> toplevel can run the\n      phrases that you type through <span><strong>camlp4</strong></span>\n      automatically. You should have at least these lines in your <code>~/.ocamlinit</code> file in your home directory (see\n        <a href=\"http://realworldocaml.org/install\" target=\"_top\">this Real World OCaml page</a> for more information):</blockquote>")))
 (idm181609333632
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The syntax extensions accept an input AST and output a modified one.\n    If you're not familiar with the Camlp4 module in question, how do you\n    figure out what changes it's made to your code? The obvious way is to read\n    the documentation that accompanies the extension. Another approach is to\n    use the toplevel to explore the extension's behavior or run Camlp4\n    manually yourself to see the transformation in action. We'll show you how\n    to do both of these now.</blockquote>")))
 (idm181609335632
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The two extensions generate boilerplate OCaml code based on the type definition at\n      compilation time. This avoids the performance hit of doing the code generation dynamically and\n      also doesn't require a just-in-time (JIT) runtime that can be a source of unpredictable\n      dynamic behavior. Instead, all the extra code is simply generated at compilation time via\n      Camlp4, and type information can be discarded from the runtime image.<a name=\"idm181609334912\"></a></blockquote>")))
 (idm181609337664
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Both Fieldslib and Sexplib need this new <code>with</code> keyword,\n      but they both can't register the same extension. Instead, a library called Type_conv provides\n      the common extension framework for them to use. Type_conv registers the <code>with</code> grammar extension to Camlp4, and the OCamlfind packaging\n      ensures that it's loaded before Fieldslib or Sexplib.</blockquote>")))
 (idm181609340480
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The <code>-package</code> flag imports other\n    OCaml libraries. The <code>.syntax</code> suffix in\n    the package name is a convention that indicates these libraries are\n    preprocessors that should be run during parsing. The syntax extension\n    modules are dynamically loaded into the <span><strong>camlp4o</strong></span> command, which rewrites the input source\n    code into conventional OCaml code that has no trace of the new keywords.\n    The compiler then compiles this transformed code with no knowledge of the\n    preprocessor's actions.</blockquote>")))
 (idm181609342992
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>We've specified a couple of additional flags here. The <code>-syntax</code> flag directs <span><strong>ocamlfind</strong></span> to add the <code>-pp</code> flag to the compiler command line. This flag\n    instructs the compiler to run the preprocessor during its parsing\n    phase.</blockquote>")))
 (idm181609347328
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Now add in the syntax extension packages for Fieldslib and Sexplib,\n    and everything will compile again:</blockquote>")))
 (idm181609353008
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Compiling this code will normally give you a syntax error if you do so without Camlp4,\n      since the <code>with</code> keyword isn't normally allowed after a type\n      definition:</blockquote>")))
 (idm181609356576
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>These libraries all extend the language in quite a minimal way by\n    adding a <code>with</code> keyword to type\n    declarations to signify that extra code should be generated from that\n    declaration. For example, here's a trivial use of Sexplib and\n    Fieldslib:</blockquote>")))
 (idm181609357392
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>For efficient binary conversion and parsing</blockquote>")))
 (idm181609359360
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>To convert types to textual s-expressions</blockquote>")))
 (idm181609361360
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Generates first-class values that represent fields of a\n          record</blockquote>")))
 (idm181609363344
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>We've already seen several Core libraries that use Camlp4:</blockquote>")))
 (idm181609374704
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The OCaml distribution includes a system called Camlp4 for writing extensible parsers.\n      This provides some OCaml libraries that are used to define grammars, as well as dynamically\n      loadable syntax extensions of such grammars. Camlp4 modules register new language keywords and\n      later transform these keywords (or indeed, any portion of the input program) into conventional\n      OCaml code that can be understood by the rest of the compiler.<a name=\"SEcamlp\"></a><a name=\"idm181609372192\"></a><a name=\"idm181609370880\"></a><a name=\"idm181609369968\"></a><a name=\"idm181609369056\"></a><a name=\"idm181609367760\"></a><a name=\"idm181609366864\"></a><a name=\"idm181609365552\"></a><a name=\"camlp\"></a></blockquote>")))
 (idm181609380448
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>One powerful feature in OCaml is a facility to extend the standard-language grammar\n      without having to modify the compiler. You can roughly think of it as a type-safe version of\n      the <code>cpp</code> preprocessor used in C/C++ to control conditional\n      compilation directives.<a name=\"idm181609379264\"></a><a name=\"SCpreproc\"></a><a name=\"CPpreproc\"></a></blockquote>")))
 (idm181609383152
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>JSON output is available via a custom <a href=\"https://github.com/xen-org/ocamldoc-json\" target=\"_top\">generator</a>\n            in Xen.</blockquote>")))
 (idm181609384656
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote><a href=\"https://gitorious.org/ocamldoc-generators/ocamldoc-generators\" target=\"_top\">ocamldoc generators</a> add support for Bibtex references within comments and\n              generating literate documentation that embeds the code alongside the comments.</blockquote>")))
 (idm181609386080
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote><a href=\"http://argot.x9c.fr/\" target=\"_top\">Argot</a> is an\n            enhanced HTML generator that supports code folding and searching\n            by name or type definition.</blockquote>")))
 (idm181609387888
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The default HTML output stylesheets from <span><strong>ocamldoc</strong></span> are pretty spartan and distinctly\n        Web 1.0. The tool supports plugging in custom documentation\n        generators, and there are several available that provide prettier or\n        more detailed output:</blockquote>")))
 (idm181609398832
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>You should now have HTML files inside the <code>html/</code> directory and also\n        be able to view the UNIX manual pages held in <code>man/man3</code>. There are quite\n        a few comment formats and options to control the output for the various backends. Refer to\n        the <a href=\"http://caml.inria.fr/pub/docs/manual-ocaml/manual029.html\" target=\"_top\">OCaml\n          manual</a> for the complete list.<a name=\"idm181609396768\"></a><a name=\"idm181609395856\"></a><a name=\"idm181609394544\"></a><a name=\"idm181609393648\"></a><a name=\"idm181609392336\"></a><a name=\"idm181609391424\"></a><a name=\"idm181609390528\"></a><a name=\"idm181609389920\"></a><a name=\"idm181609389312\"></a></blockquote>")))
 (idm181609406528
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Try compiling the HTML documentation and UNIX man pages by running\n      <span><strong>ocamldoc</strong></span> over the source file:</blockquote>")))
 (idm181609408304
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The <span><strong>ocamldoc</strong></span> comments are\n      distinguished by beginning with the double asterisk. There are\n      formatting conventions for the contents of the comment to mark metadata.\n      For instance, the <code>@tag</code> fields mark\n      specific properties such as the author of that section of code.</blockquote>")))
 (idm181609411808
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Here's a sample of some source code that's been annotated with\n      <span><strong>ocamldoc</strong></span> comments:</blockquote>")))
 (idm181609413904
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The <span><strong>ocamldoc</strong></span> tool uses specially formatted comments\n        in the source code to generate documentation bundles. These comments are combined with the\n        function definitions and signatures, and output as structured documentation in a variety of\n        formats. It can generate HTML pages, LaTeX and PDF documents, UNIX manual pages, and even\n        module dependency graphs that can be viewed using <a href=\"http://www.graphviz.org\" target=\"_top\">Graphviz</a>.</blockquote>")))
 (idm181609418064
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Whitespace and source code comments are removed during parsing and\n      aren't significant in determining the semantics of the program. However,\n      other tools in the OCaml distribution can interpret comments for their\n      own ends.<a name=\"idm181609417568\"></a><a name=\"idm181609416272\"></a><a name=\"idm181609414960\"></a></blockquote>")))
 (idm181609421104
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The <span><strong>ocp-indent</strong></span>\n<a href=\"https://github.com/OCamlPro/ocp-indent\" target=\"_top\">home page</a> documents how to\n        integrate it with your favorite editor. All the Core libraries are formatted using it to\n        ensure consistency, and it's a good idea to do this before publishing your own source code\n        online.</blockquote>")))
 (idm181609435904
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The <code>add_and_print</code> definition has been indented as if\n        it were part of the first <code>concat_and_print</code> definition,\n        and the errant semicolon is now much easier to spot. We just need to remove that semicolon\n        and rerun <span><strong>ocp-indent</strong></span> to verify that the syntax is\n        correct:</blockquote>")))
 (idm181609449216
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Let's run our erroneous file through <span><strong>ocp-indent</strong></span> and see how it processes it:</blockquote>")))
 (idm181609451728
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>This class of bug (due to a single errant character) can be hard\n      to spot in a large body of code. Luckily, there's a great tool available\n      via OPAM called <span><strong>ocp-indent</strong></span> that\n      applies structured indenting rules to your source code on a line-by-line\n      basis. This not only beautifies your code layout, but it also makes this\n      syntax error much easier to locate.<a name=\"idm181609450656\"></a></blockquote>")))
 (idm181609454176
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The line number in the error points to the end of the <code>add_and_print</code> function, but the actual error\n      is at the end of the <span><em>first</em></span> function definition.\n      There's an extra semicolon at the end of the first definition that\n      causes the second definition to become part of the first <code>let</code> binding. This eventually results in a\n      parsing error at the very end of the second function.</blockquote>")))
 (idm181609459088
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>When you compile this file, you'll get a syntax error\n      again:</blockquote>")))
 (idm181609463424
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Sadly, syntax errors do get more inaccurate sometimes, depending\n      on the nature of your mistake. Try to spot the deliberate error in the\n      following function definitions:<a name=\"idm181609462976\"></a></blockquote>")))
 (idm181609465792
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The syntax error points to the line and character number of the\n      first token that couldn't be parsed. In the broken example, the <code>module</code> keyword isn't a valid token at that\n      point in parsing, so the error location information is correct.</blockquote>")))
 (idm181609469216
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The correct version of this source code creates the <code>MyString</code> module correctly via a local open,\n      and compiles successfully:</blockquote>")))
 (idm181609474112
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The code results in a syntax error when compiled:</blockquote>")))
 (idm181609477280
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Here's an example syntax error that we obtain by performing a module assignment as a\n        statement instead of as a <code>let</code> binding:</blockquote>")))
 (idm181609480624
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The OCaml parser's goal is to output a well-formed AST data structure to the next phase\n        of compilation, and so it any source code that doesn't match basic syntactic requirements.\n        The compiler emits a <span><em>syntax error</em></span> in this situation, with a pointer to\n        the filename and line and character number that's as close to the error as\n          possible.<a name=\"idm181609479600\"></a><a name=\"idm181609478304\"></a></blockquote>")))
 (idm181609488992
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>When a source file is passed to the OCaml compiler, its first task is to parse the text\n      into a more structured abstract syntax tree (AST). The parsing logic is implemented in OCaml\n      itself using the techniques described earlier in <a href=\"parsing-with-ocamllex-and-menhir.html\">ChapterÂ 16, <i>Parsing with OCamllex and Menhir</i></a>. The lexer and parser rules can be found in the\n        <code>parsing</code> directory in the source distribution.<a name=\"idm181609487200\"></a><a name=\"SCpras\"></a><a name=\"PARSsource\"></a><a name=\"CPpars\"></a></blockquote>")))
 (idm181609490576
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>We'll go through each of the compilation stages now and explain how they will be useful to\n      you during day-to-day OCaml development.</blockquote>")))
 (idm181609491520
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html "<blockquote>Regression tests for the core compiler.</blockquote>")))
 (idm181609494176
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Command-line utilities such as <code>ocamldep</code> that are installed with the\n            compiler.</blockquote>")))
 (idm181609496176
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Optional libraries such as the Unix and graphics\n            modules.</blockquote>")))
 (idm181609498176
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Build system that automates common OCaml compilation\n            modes.</blockquote>")))
 (idm181609500800
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The compiler standard library, including the <code>Pervasives</code> module.</blockquote>")))
 (idm181609503184
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>: A <span><em>caml-mode</em></span> for the Emacs\n            editor.</blockquote>")))
 (idm181609505136
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html "<blockquote>Interactive top-level console.</blockquote>")))
 (idm181609507104
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html "<blockquote>The interactive bytecode debugger.</blockquote>")))
 (idm181609509104
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>A number of tools and scripts are also built alongside the core compiler:</blockquote>")))
 (idm181609509920
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Command-line interfaces for the compiler tools.</blockquote>")))
 (idm181609511888
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html "<blockquote>The source code macro preprocessor.</blockquote>")))
 (idm181609513888
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The static type checking implementation and type\n            definitions.</blockquote>")))
 (idm181609515888
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The OCaml lexer, parser, and libraries for manipulating\n            them.</blockquote>")))
 (idm181609518624
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Native-code compiler and runtime. The native runtime symlinks many modules from\n              the <code>byterun</code> directory to share code, most notably\n              the GC.</blockquote>")))
 (idm181609521280
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Bytecode compiler and runtime, including the garbage collector (GC).</blockquote>")))
 (idm181609523968
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Configuration directives to tailor OCaml for your operating\n            system and architecture.</blockquote>")))
 (idm181609525984
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The source tree is split up into subdirectories. The core compiler\n      consists of:</blockquote>")))
 (idm181609527296
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>A Git mirror of the Subversion repository with all the history and development\n            branches included, browsable online at <a href=\"https://github.com/ocaml/ocaml\" target=\"_top\">GitHub</a></blockquote>")))
 (idm181609528864
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>A Subversion anonymous mirror of the main development sources\n          available on the <a href=\"http://caml.inria.fr/ocaml/anonsvn.en.html\" target=\"_top\">development\n          resources</a> page online</blockquote>")))
 (idm181609531040
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Stable releases as <code>zip</code> and <code>tar</code> archives\n            from the <a href=\"http://caml.inria.fr/download.en.html\" target=\"_top\">OCaml download\n            site</a></blockquote>")))
 (idm181609532176
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Although it's not necessary to understand the examples, you may\n      find it useful to have a copy of the OCaml source tree checked out while\n      you read through this chapter. The source code is available from\n      multiple places:</blockquote>")))
 (idm181609538480
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Notice that the pipeline branches toward the end. OCaml has multiple compiler backends\n      that reuse the early stages of compilation but produce very different final outputs. The\n        <span><em>bytecode</em></span> can be run by a portable interpreter and can even be\n      transformed into JavaScript (via <a href=\"http://ocsigen.org/js_of_ocaml\" target=\"_top\">js_of_ocaml</a>) or C source code (via <a href=\"https://github.com/ocaml-bytes/ocamlcc\" target=\"_top\">OCamlCC</a>). The <span><em>native\n        code</em></span> compiler generates specialized executable binaries suitable for\n      high-performance applications.<a name=\"idm181609535632\"></a><a name=\"idm181609534304\"></a></blockquote>")))
 (idm181609543696
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The overall compilation pipeline looks like this:<a name=\"idm181609543376\"></a></blockquote>")))
 (idm181609545776
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Each source file represents a <span><em>compilation unit</em></span>\n    that is built separately. The compiler generates intermediate files with\n    different filename extensions to use as it advances through the\n    compilation stages. The linker takes a collection of compiled units and\n    produces a standalone executable or library archive that can be reused by\n    other applications.<a name=\"idm181609544736\"></a></blockquote>")))
 (idm181609549568
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The OCaml tools accept textual source code as input, using the filename extensions\n        <code>.ml</code> and <code>.mli</code> for\n      modules and signatures, respectively. We explained the basics of the build process in <a href=\"files-modules-and-programs.html\">ChapterÂ 4, <i>Files, Modules, and Programs</i></a>, so we'll assume you've built a few OCaml programs\n      already by this point.<a name=\"idm181609547200\"></a></blockquote>")))
 (idm181609551504
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The details of the compilation process into executable code can be found next, in <a href=\"the-compiler-backend-byte-code-and-native-code.html\">ChapterÂ 23, <i>The Compiler Backend: Bytecode and Native code</i></a>.</blockquote>")))
 (idm181609552208
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The type-checking process, including module resolution</blockquote>")))
 (idm181609569312
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Source preprocessing via Camlp4 and the intermediate forms</blockquote>")))
 (idm181609570144
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>The compilation pipeline and what each stage represents</blockquote>")))
 (idm181609571104
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>In this chapter, we'll cover the following topics:</blockquote>")))
 (idm181609575792
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>You don't have to do all of this manually, of course. The compiler frontends (<code>ocamlc</code> and <code>ocamlopt</code>) are invoked\n    via the command line and chain the stages together for you. Sometimes though, you'll need to\n    dive into the toolchain to hunt down a bug or investigate a performance problem. This chapter\n    explains the compiler pipeline in more depth so you understand how to harness the command-line\n    tools effectively.<a name=\"idm181609573824\"></a><a name=\"idm181609572528\"></a></blockquote>")))
 (idm181609578528
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>OCaml has a strong emphasis on static type safety and rejects source\n  code that doesn't meet its requirements as early as possible. The compiler\n  does this by running the source code through a series of checks and\n  transformations. Each stage performs its job (e.g., type checking,\n  optimization, or code generation) and discards some information from the\n  previous stage. The final native code output is low-level assembly code that\n  doesn't know anything about the OCaml modules or objects that the compiler\n  started with.<a name=\"idm181609577728\"></a><a name=\"idm181609576832\"></a></blockquote>")))
 (idm181609580480
  ((file the-compiler-frontend-parsing-and-type-checking.html)
   (html
    "<blockquote>Compiling source code into executable programs is a fairly complex\n  libraries, linkers, and assemblers. It's important to understand how these\n  fit together to help with your day-to-day workflow of developing, debugging,\n  and deploying applications.<a name=\"idm181609579968\"></a></blockquote>")))
 (idm181608285680
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>The native code compiler generates some additional files (see <a href=\"the-compiler-backend-byte-code-and-native-code.html#Table2302\">TableÂ 23.2, â\128\156Intermediate outputs produced by the native code OCaml toolchainâ\128\157</a>).<a name=\"idm181608284864\"></a></blockquote>")))
 (idm181608307104
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote> <a href=\"the-compiler-backend-byte-code-and-native-code.html#Table2301\">TableÂ 23.1, â\128\156Intermediate files generated by the OCaml compiler toolchainâ\128\157</a> shows the intermediate files generated by <span><strong>ocamlc</strong></span>.</blockquote>")))
 (idm181608310288
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>We've seen how the compiler uses intermediate files to store various\n    stages of the compilation toolchain. Here's a cheat sheet of all them in\n    one place.<a name=\"idm181608309856\"></a><a name=\"idm181608308544\"></a></blockquote>")))
 (idm181608314112
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>If you get an error that <code>libasmrund.a</code> is not found,\n          it's probably because you're using OCaml 4.00 and not 4.01. It's only installed by default\n          in the very latest version, which you should be using via the <code>4.01.0</code> OPAM switch.<a name=\"idm181608312336\"></a></blockquote>")))
 (idm181608324832
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>To use the debug library, just link your program with the\n        <code>-runtime-variant d</code> flag:</blockquote>")))
 (idm181608326352
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>Despite your best efforts, it is easy to introduce a bug into some components, such as\n          C bindings, that causes heap invariants to be violated. OCaml includes a <code>libasmrund.a</code> variant of the runtime library which is compiled\n          with extra debugging checks that perform extra memory integrity checks during every\n          garbage collection cycle. Running these extra checks will abort the program nearer the\n          point of corruption and help isolate the bug in the C code.</blockquote>")))
 (idm181608329744
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>The <code>embed_native.o</code> is a standalone object file that\n        has no further references to OCaml code beyond the runtime library, just as with the\n        bytecode runtime. Do remember that the link order of the libraries is significant in modern\n        GNU toolchains (especially as used in Ubuntu 11.10 and later) that resolve symbols from left\n        to right in a single pass.<a name=\"idm181608328464\"></a></blockquote>")))
 (idm181608339056
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>Try this custom linking by using the same source files from the\n      bytecode embedding example earlier in this chapter:</blockquote>")))
 (idm181608340256
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>The native code runtime is a different library from the bytecode one, and is installed\n        as <code>libasmrun.a</code> in the OCaml standard library\n        directory.</blockquote>")))
 (idm181608343136
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>The native code compiler normally links a complete executable, but\n      can also output a standalone native object file just as the bytecode\n      compiler can. This object file has no further dependencies on OCaml\n      except for the runtime library.<a name=\"idm181608342624\"></a><a name=\"idm181608341712\"></a></blockquote>")))
 (idm181608345744
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>Using the frame pointer changes the OCaml calling convention,\n          but OPAM takes care of recompiling all your libraries with the new\n          interface. You can read more about this on the OCamlPro <a href=\"http://www.ocamlpro.com/blog/2012/08/08/profile-native-code.html\" target=\"_top\">blog</a>.</blockquote>")))
 (idm181608349456
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>OPAM provides a compiler switch that compiles OCaml with the\n          frame pointer activated:</blockquote>")))
 (idm181608350144
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>Using the frame pointer in this fashion means a slowdown\n          (typically around 3-5%) since it's no longer available for\n          general-purpose use. OCaml 4.1 thus makes the frame pointer an\n          optional feature that can be used to improve the resolution of Perf\n          traces.</blockquote>")))
 (idm181608351264
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>OCaml stack frames are too complex for Perf to understand\n          directly, and so it needs the compiler to fall back to using the\n          same conventions as C for function calls. On 64-bit Intel systems,\n          this means that a special register known as the <span><em>frame\n          pointer</em></span> is used to record function call history.</blockquote>")))
 (idm181608351888
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>Although Perf doesn't require adding in explicit probes to the\n          binary, it does need to understand how to unwind function calls so\n          that the kernel can accurately record the function backtrace for\n          every event.</blockquote>")))
 (idm181608354688
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>Perf has a growing collection of other commands that let you archive these runs and\n          compare them against each other. You can read more on the <a href=\"http://perf.wiki.kernel.org\" target=\"_top\">home page</a>.<a name=\"idm181608353616\"></a></blockquote>")))
 (idm181608356672
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>This trace broadly reflects the results of the benchmark itself.\n        The mutable benchmark consists of the combination of the call to\n        <code>test_mutable</code> and the <code>caml_modify</code> write barrier function in the\n        runtime. This adds up to slightly over half the execution time of the\n        application.</blockquote>")))
 (idm181608362336
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>When this completes, you can interactively explore the\n        results:</blockquote>")))
 (idm181608378864
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>Run Perf on a compiled binary to record information first. We'll use our write barrier\n          benchmark from earlier, which measures memory allocation versus in-place\n          modification:</blockquote>")))
 (idm181608380128
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>Perf is a more modern alternative to <span><strong>gprof</strong></span> that doesn't require you to instrument\n        the binary. Instead, it uses hardware counters and debug information\n        within the binary to record information accurately.</blockquote>")))
 (idm181608384816
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>Getting precise information out of <span><strong>gprof</strong></span> requires passing the <code>-p</code> flag to the native code compiler when\n        compiling <span><em>and</em></span> linking the binary. This generates\n        extra code that records profile information to a file called <code>gmon.out</code> when the program is executed. This\n        profile information can then be examined using <span><strong>gprof</strong></span>.</blockquote>")))
 (idm181608386832
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote><span><strong>gprof</strong></span> produces an execution\n        profile of an OCaml program by recording a call graph of which\n        functions call one another, and recording the time these calls take\n        during the program execution.<a name=\"idm181608385856\"></a></blockquote>")))
 (idm181608388944
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>Note that many other tools that operate on native binaries, such as Valgrind, will work\n        just fine with OCaml as long as the program is linked with the <code>-g</code> flag to embed debugging symbols.</blockquote>")))
 (idm181608390320
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>The <a href=\"https://perf.wiki.kernel.org/\" target=\"_top\">Perf</a>\n          profiling framework in modern versions of Linux</blockquote>")))
 (idm181608391808
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>GNU <span><strong>gprof</strong></span>, to measure execution time and call\n            graphs</blockquote>")))
 (idm181608392832
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>Most profiling tools benefit from having some instrumentation\n      included in the binary. OCaml supports two such tools:</blockquote>")))
 (idm181608396976
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>The recording and analysis of where your application spends its\n      execution time is known as <span><em>performance profiling</em></span>.\n      OCaml native code binaries can be profiled just like any other C binary,\n      by using the name mangling described earlier to map between OCaml\n      variable names and the profiler output.<a name=\"idm181608396096\"></a><a name=\"idm181608395200\"></a><a name=\"idm181608394288\"></a></blockquote>")))
 (idm181608399344
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>One very useful feature of OCaml native code is that C and OCaml share the same stack.\n          This means that GDB backtraces can give you a combined view of what's going on in your\n          program <span><em>and</em></span> runtime library. This includes any calls to C libraries\n          or even callbacks into OCaml from the C layer if you're in an environment which embeds the\n          OCaml runtime as a library.</blockquote>")))
 (idm181608402464
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>The <code>cont</code> command resumes execution after a\n          breakpoint has paused it, <code>bt</code> displays a stack\n          backtrace, and <code>clear</code> deletes the breakpoint so the\n          application can execute until completion. GDB has a host of other features we won't cover\n          here, but you can view more guidelines via Mark Shinwell's talk on <a href=\"http://www.youtube.com/watch?v=NF2WpWnB-nk&lt;\" target=\"_top\">&quot;Real-world debugging in\n            OCaml.&quot;</a></blockquote>")))
 (idm181608421616
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>The binary has run until the first take invocation and stopped,\n        waiting for further instructions. GDB has lots of features, so let's\n        continue the program and check the stacktrace after a couple of\n        recursions:</blockquote>")))
 (idm181608428720
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>Once you've set the breakpoint, start the program\n        executing:</blockquote>")))
 (idm181608429776
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>We used the C symbol name by following the name mangling rules defined earlier. A\n          convenient way to figure out the full name is by tab completion. Just type in a portion of\n          the name and press the &lt;tab&gt; key to see a list of possible completions.</blockquote>")))
 (idm181608434880
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>The <span><strong>gdb</strong></span> prompt lets you enter\n        debug directives. Let's set the program to break just before the first\n        call to <code>take</code>:</blockquote>")))
 (idm181608446448
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>Now we can run this interactively within <span><strong>gdb</strong></span>:</blockquote>")))
 (idm181608451776
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>Compile and run this with debugging symbols. You should see the\n        following output:</blockquote>")))
 (idm181608455056
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>Let's write a mutually recursive function that selects alternating values from a list.\n          This isn't tail-recursive, so our stack size will grow as we single-step through the\n          execution:</blockquote>")))
 (idm181608456784
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>MacOS 10.9 removes <span><strong>gdb</strong></span> entirely and uses the lldb debugger from\n            the LLVM project by default. Many of the guidelines here still apply since the debug\n            information embedded in the binary output can be interpreted by lldb (or any other\n            DWARF-aware debugger), but the command-line interfaces to lldb is different from\n              <span><strong>gdb</strong></span>. Refer to the lldb manual for more information.</blockquote>")))
 (idm181608457408
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>For OCaml 4.1, we'd recommend you do native code debugging on\n          an alternate platform such as Linux, or manually look at the\n          assembly code output to map the symbol names onto their precise\n          OCaml functions.</blockquote>")))
 (idm181608460096
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>The examples here assume that you are running <span><strong>gdb</strong></span> on either Linux or FreeBSD. Mac OS X\n          10.8 does have <span><strong>gdb</strong></span> installed, but\n          it's a rather quirky experience that doesn't reliably interpret the\n          debugging information contained in the native binaries. This can\n          result in function names showing up as raw symbols such as <code>.L101</code> instead of their more human-readable\n          form.</blockquote>")))
 (idm181608462768
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>Let's see name mangling in action with some interactive\n        debugging using GNU <span><strong>gdb</strong></span>.<a name=\"idm181608461792\"></a></blockquote>")))
 (idm181608464496
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>Anonymous functions are hard to predict without inspecting\n        intermediate compiler output. If you need to debug them, it's usually\n        easier to modify the source code to let-bind the anonymous function to\n        a variable name.</blockquote>")))
 (idm181608467328
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>The variable name is also suffixed by a <code>_</code> and a\n              number. This is the result of the lambda compilation, which replaces each variable\n              name with a unique value within the module. You can determine this number by examining\n              the <code>-dlambda</code> output from <span><strong>ocamlopt</strong></span>.</blockquote>")))
 (idm181608468784
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>This is followed by a double <code>__</code> suffix and the variable name.</blockquote>")))
 (idm181608470304
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>The symbol is prefixed by <code>caml</code> and the local module name, with\n            dots replaced by underscores.</blockquote>")))
 (idm181608471296
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>The conversion follows some straightforward rules for named\n        variables and functions:</blockquote>")))
 (idm181608472128
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>Each OCaml source file is compiled into a native object file that must export a unique\n          set of symbols to comply with the C binary interface. This means that any OCaml values\n          that may be used by another compilation unit need to be mapped onto a symbol name. This\n          mapping has to account for OCaml language features such as nested modules, anonymous\n          functions, and variable names that shadow one another.</blockquote>")))
 (idm181608478032
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>So how do you refer to OCaml functions in an interactive debugger like <span><strong>gdb</strong></span>? The first thing you need to know is how OCaml function\n          names compile down to symbol names in the compiled object files, a procedure generally\n          called <span><em>name mangling</em></span>.<a name=\"idm181608476672\"></a><a name=\"idm181608475776\"></a><a name=\"idm181608474464\"></a><a name=\"idm181608473152\"></a></blockquote>")))
 (idm181608480912
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>Extra debugging information is inserted into the output assembly\n      when the library is compiled in debug mode. These include the CFI stubs\n      you will have noticed in the profiling output earlier (<code>.cfi_start_proc</code> and <code>.cfi_end_proc</code> to delimit an OCaml function\n      call, for example).</blockquote>")))
 (idm181608485488
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>The native code compiler builds executables that can be debugged using conventional\n        system debuggers such as GNU <span><strong>gdb</strong></span>. You need to compile\n        your libraries with the <code>-g</code> option to add the debug\n        information to the output, just as you need to with C compilers.<a name=\"idm181608483680\"></a><a name=\"idm181608482368\"></a></blockquote>")))
 (idm181608487520
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>We see that the polymorphic comparison is close to 20 times slower! These results\n          shouldn't be taken too seriously, as this is a very narrow test that, like all such\n          microbenchmarks, isn't representative of more complex codebases. However, if you're\n          building numerical code that runs many iterations in a tight inner loop, it's worth\n          manually peering at the produced assembly code to see if you can hand-optimize it.</blockquote>")))
 (idm181608496912
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>Running this shows quite a significant runtime difference\n        between the two:</blockquote>")))
 (idm181608501344
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>You don't have to fully understand the intricacies of assembly\n        language to see that this polymorphic comparison is much heavier than\n        the simple monomorphic integer comparison from earlier. Let's confirm\n        this hypothesis again by writing a quick <code>Core_bench</code> test with both functions:</blockquote>")))
 (idm181608521488
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>OCaml on x86_64 architectures caches the location of the minor\n        heap in the <code>%r15</code> register since\n        it's so frequently referenced in OCaml functions. The minor heap\n        pointer can also be changed by the C code that's being called (e.g.,\n        when it allocates OCaml values), and so <code>%r15</code> is restored after returning from the\n        <code>caml_greaterthan</code> call. Finally, the\n        return value of the comparison is popped from the stack and\n        returned.</blockquote>")))
 (idm181608526480
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>The <code>.cfi</code> directives are assembler hints that\n          contain Call Frame Information that lets the debugger provide more sensible backtraces,\n          and they have no effect on runtime performance. Notice that the rest of the implementation\n          is no longer a simple register comparison. Instead, the arguments are pushed on the stack\n          (the <code>%rsp</code> register), and a C function call is invoked\n          by placing a pointer to <code>caml_greaterthan</code> in <code>%rax</code> and jumping to <code>caml_c_call</code>.<a name=\"idm181608522512\"></a></blockquote>")))
 (idm181608530544
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>Compiling this code with <code>-S</code>\n        results in a significantly more complex assembly output for the same\n        function:</blockquote>")))
 (idm181608536160
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>The arguments to <code>cmp</code> are\n        passed in the <code>%rbx</code> and <code>%rax</code> registers, and compared using the\n        <code>jle</code> &quot;jump if less than or equal&quot;\n        instruction. This requires both the arguments to be immediate integers\n        to work. Now let's see what happens if our OCaml code omits the type\n        annotations and is a polymorphic comparison instead:</blockquote>")))
 (idm181608539440
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>The <code>_camlCompare_mono__cmp_1008</code> is an assembly\n        label that has been computed from the module name (<code>Compare_mono</code>) and the function name\n        (<code>cmp_1008</code>). The numeric suffix for\n        the function name comes straight from the lambda form (which you can\n        inspect using <code>-dlambda</code>, but in this\n        case isn't necessary).</blockquote>")))
 (idm181608543168
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>If you've never seen assembly language before, then the contents\n        may be rather scary. While you'll need to learn x86 assembly to fully\n        understand it, we'll try to give you some basic instructions to spot\n        patterns in this section. The excerpt of the implementation of the\n        <code>cmp</code> function can be found\n        below:</blockquote>")))
 (idm181608547616
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>Now compile this into assembly and read the resulting <code>compare_mono.S</code> file. This file extension may\n        be lowercase on some platforms such as Linux:</blockquote>")))
 (idm181608550496
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>First let's create a comparison function where we've explicitly annotated the types,\n          so the compiler knows that only integers are being compared:</blockquote>")))
 (idm181608552512
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>We warned you in <a href=\"maps-and-hash-tables.html\">ChapterÂ 13, <i>Maps and Hash Tables</i></a> that using polymorphic\n          comparison is both convenient and perilous. Let's look at precisely what the difference is\n          at the assembly language level now.<a name=\"idm181608551536\"></a></blockquote>")))
 (idm181608555776
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>The assembly code is highly architecture-specific, so the following discussion assumes\n        an Intel or AMD 64-bit platform. We've generated the example code using <code>-inline 20</code> and <code>-nodynlink</code>\n        since it's best to generate assembly code with the full optimizations that the compiler\n        supports. Even though these optimizations make the code a bit harder to read, it will give\n        you a more accurate picture of what executes on the CPU. Don't forget that you can use the\n        lambda code from earlier to get a slightly higher-level picture of the code if you get lost\n        in the more verbose assembly.</blockquote>")))
 (idm181608558848
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>The native code compiler generates assembly language that is then\n      passed to the system assembler for compiling into object files. You can\n      get <span><strong>ocamlopt</strong></span> to output the assembly\n      by passing the <code>-S</code> flag to the\n      compiler command line.<a name=\"idm181608557232\"></a></blockquote>")))
 (idm181608563776
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>Collections of <code>.cmx</code> and <code>.o</code> files can also be be linked into a <code>.cmxa</code> archive by passing the <code>-a</code> flag to the compiler. However, unlike the\n    bytecode version, you must keep the individual <code>cmx</code> files in the compiler search path so that\n    they are available for cross-module inlining. If you don't do this, the\n    compilation will still succeed, but you will have missed out on an\n    important optimization and have slower binaries.</blockquote>")))
 (idm181608565088
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>When the compiler links modules together into an executable, it uses\n    the contents of the <code>cmx</code> files to\n    perform cross-module inlining across compilation units. This can be a\n    significant speedup for standard library functions that are frequently\n    used outside of their module.</blockquote>")))
 (idm181608566448
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>A <code>.cmi</code> compiled interface\n        file that is the same as the bytecode compiler</blockquote>")))
 (idm181608567952
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>A <code>.cmx</code> file containing extra\n        information for linking and cross-module optimization</blockquote>")))
 (idm181608569392
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>A <code>.o</code> file containing native\n        object code</blockquote>")))
 (idm181608573040
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>The <span><strong>ocamlopt</strong></span> command is the\n    frontend to the native code compiler and has a very similar interface to\n    <span><strong>ocamlc</strong></span>. It also accepts <code>ml</code> and <code>mli</code>\n    files, but compiles them to:</blockquote>")))
 (idm181608584608
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>The native code compiler is ultimately the tool that most production\n    OCaml code goes through. It compiles the lambda form into fast native code\n    executables, with cross-module inlining and additional optimization passes\n    that the bytecode interpreter doesn't perform. Care is taken to ensure\n    compatibility with the bytecode runtime, so the same code should run\n    identically when compiled with either toolchain.<a name=\"idm181608583920\"></a><a name=\"idm181608583024\"></a><a name=\"idm181608581728\"></a><a name=\"idm181608580832\"></a><a name=\"idm181608579536\"></a><a name=\"idm181608578640\"></a><a name=\"idm181608577344\"></a><a name=\"idm181608576048\"></a><a name=\"CPfast\"></a></blockquote>")))
 (idm181608588496
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>Embedding OCaml code like this lets you write OCaml that\n      interfaces with any environment that works with a C compiler. You can\n      even cross back from the C code into OCaml by using the <code>Callback</code> module to register named entry points\n      in the OCaml code. This is explained in detail in the <a href=\"http://caml.inria.fr/pub/docs/manual-ocaml/manual033.html#toc149\" target=\"_top\">interfacing\n      with C</a> section of the OCaml manual.<a name=\"idm181608586528\"></a></blockquote>")))
 (idm181608595680
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>You can inspect the commands that <span><strong>ocamlc</strong></span> is invoking by adding <code>-verbose</code> to the command line to help figure\n      out the GCC command line if you get stuck. You can even obtain the C\n      source code to the <code>-output-obj</code> result\n      by specifying a <code>.c</code> output file\n      extension instead of the <code>.o</code> we used\n      earlier:</blockquote>")))
 (idm181608605184
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>After this point, you no longer need the OCaml compiler, as\n      <code>embed_out.o</code> has all of the OCaml code\n      compiled and linked into a single object file. Compile an output binary\n      using <span><strong>gcc</strong></span> to test this out:</blockquote>")))
 (idm181608609808
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>Now compile the OCaml files into a standalone object file:</blockquote>")))
 (idm181608613344
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>Next, create a C file to be your main entry point:</blockquote>")))
 (idm181608618320
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>Create two OCaml source files that contain a single print\n      line:</blockquote>")))
 (idm181608619680
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>This object file can then be linked with C code using the standard C compiler, needing\n        only the bytecode runtime library (which is installed as <code>libcamlrun.a</code>). Creating an executable just requires you to link the runtime\n        library with the bytecode object file. Here's an example to show how it all fits\n        together.</blockquote>")))
 (idm181608621632
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>This mode causes <span><strong>ocamlc</strong></span> to output an object file\n        containing the bytecode for the OCaml part of the program, as well as a <code>caml_startup</code> function. All of the OCaml modules are linked into\n        this object file as bytecode, just as they would be for an executable.</blockquote>")))
 (idm181608624880
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>A consequence of using the bytecode compiler is that the final link phase must be\n        performed by <span><strong>ocamlc</strong></span>. However, you might sometimes want to\n        embed your OCaml code inside an existing C application. OCaml also supports this mode of\n        operation via the <span><code>-output-obj</code></span>\n          directive.<a name=\"idm181608622656\"></a></blockquote>")))
 (idm181608627312
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>The custom mode is the most similar mode to native code\n      compilation, as both generate standalone executables. There are quite a\n      few other options available for compiling bytecode (notably with shared\n      libraries or building custom runtimes). Full details can be found in the\n      <a href=\"http://caml.inria.fr/pub/docs/manual-ocaml/manual022.html\" target=\"_top\">OCaml</a>.</blockquote>")))
 (idm181608630128
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>OCamlbuild takes care of many of these details with its built-in rules. The <code>%.byte</code> rule that you've been using throughout the book builds a\n        bytecode executable, and adding the <code>custom</code> tag will\n        bundle the interpreter with it, too.<a name=\"idm181608628336\"></a></blockquote>")))
 (idm181608635936
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>You can also generate a complete standalone executable that\n      bundles the <span><strong>ocamlrun</strong></span> interpreter with\n      the bytecode in a single binary. This is known as a <span><em>custom\n      runtime</em></span> mode and is built as follows:<a name=\"idm181608634432\"></a></blockquote>")))
 (idm181608637264
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>The <code>dllib</code> flag embeds the\n      arguments in the archive file. Any subsequent packages linking this\n      archive will also include the extra C linking directive. This in turn\n      lets the interpreter dynamically load the external library symbols when\n      it executes the bytecode.</blockquote>")))
 (idm181608641024
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>Information about these extra libraries can be specified while\n      linking a bytecode archive:</blockquote>")))
 (idm181608641632
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>The OCaml linker produces bytecode that targets the standard OCaml\n      runtime by default, and so needs to know about any C functions that are\n      referenced from other libraries that aren't loaded by default.</blockquote>")))
 (idm181608642256
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>The bytecode runtime comprises three parts: the bytecode interpreter, GC, and a set of C\n        functions that implement the primitive operations. The bytecode contains instructions to\n        call these C functions when required.</blockquote>")))
 (idm181608645392
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>The bytecode files are then linked together with the OCaml\n      standard library to produce an executable program. The order in which\n      <code>.cmo</code> arguments are presented on the\n      command line defines the order in which compilation units are\n      initialized at runtime. Remember that OCaml has no single <code>main</code> function like C, so this link order is\n      more important than in C programs.</blockquote>")))
 (idm181608648816
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>The individual objects in the library are linked as regular\n      <code>cmo</code> files in the order specified when\n      the library file was built. If an object file within the library isn't\n      referenced elsewhere in the program, then it isn't included in the final\n      binary unless the <code>-linkall</code> flag\n      forces its inclusion. This behavior is analogous to how C handles object\n      files and archives (<code>.o</code> and <code>.a</code>, respectively).</blockquote>")))
 (idm181608651504
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>A typical OCaml library consists of multiple source files, and\n      hence multiple <code>cmo</code> files that all\n      need to be passed as command-line arguments to use the library from\n      other code. The compiler can combine these multiple files into a more\n      convenient single archive file by using the <code>-a</code> flag. Bytecode archives are denoted by the\n      <code>cma</code> extension.</blockquote>")))
 (idm181608656048
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>The <span><strong>ocamlc</strong></span> command compiles\n      individual <code>ml</code> files into bytecode\n      files that have a <code>cmo</code> extension. The\n      compiled bytecode files are matched with the associated <code>cmi</code> interface, which contains the type\n      signature exported to other compilation units.<a name=\"idm181608652960\"></a></blockquote>")))
 (idm181608657680
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>Understanding the reasoning behind the different implementations\n      of the bytecode interpreter and the native compiler is a very useful\n      exercise for any budding language hacker.</blockquote>")))
 (idm181608658496
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>This paper laid the theoretical basis for the implementation of an instruction set for a\n        strictly evaluated functional language such as OCaml. The bytecode interpreter in modern\n        OCaml is still based on the ZINC model. The native code compiler uses a different model\n        since it uses CPU registers for function calls instead of always passing arguments on the\n        stack, as the bytecode interpreter does.</blockquote>")))
 (idm181608659776
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>The bytecode interpreter is much slower than compiled native code,\n      but is still remarkably performant for an interpreter without a JIT\n      compiler. Its efficiency can be traced back to Xavier Leroy's\n      ground-breaking work in 1990, <a href=\"http://hal.inria.fr/docs/00/07/00/49/PS/RT-0117.ps\" target=\"_top\">&quot;The ZINC\n      experiment: An Economical Implementation of the ML\n      Language&quot;.</a></blockquote>")))
 (idm181608663088
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>There are around 140 instructions in total, but most are just minor\n    variants of commonly encountered operations (e.g., function application at\n    a specific arity). You can find full details <a href=\"http://cadmium.x9c.fr/distrib/caml-instructions.pdf\" target=\"_top\">online</a>.<a name=\"idm181608661936\"></a></blockquote>")))
 (idm181608663632
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>The preceding bytecode has been simplified from the lambda form into\n    a set of simple instructions that are executed serially by the\n    interpreter.</blockquote>")))
 (idm181608678912
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>The interpreter virtual machine only has seven registers in total: the program counter,\n      stack pointer, accumulator, exception and argument pointers, and environment and global data.\n      You can display the bytecode instructions in textual form via <code>-dinstr</code>. Try this on one of our earlier pattern-matching examples:</blockquote>")))
 (idm181608679744
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>Values that are relative to the starting code address</blockquote>")))
 (idm181608681456
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>Values that contain the block header and a memory address with\n          the data fields that contain further OCaml values indexed by an\n          integer</blockquote>")))
 (idm181608683696
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>Values that correspond to an OCaml <code>int</code> type</blockquote>")))
 (idm181608690752
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>The bytecode interpreter implements a stack-based virtual machine. The OCaml stack and an\n      associated accumulator store values that consist of:<a name=\"idm181608690336\"></a><a name=\"idm181608689008\"></a><a name=\"idm181608688096\"></a><a name=\"idm181608687200\"></a><a name=\"idm181608686304\"></a></blockquote>")))
 (idm181608691360
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>The big advantage of using bytecode is simplicity, portability, and compilation speed. The\n      mapping from the lambda form to bytecode is straightforward, and this results in predictable\n      (but slow) execution speed.</blockquote>")))
 (idm181608692192
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>A portable interpreter that executes the bytecode</blockquote>")))
 (idm181608694208
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>Compiles files into a bytecode that is a close mapping to the\n          lambda form</blockquote>")))
 (idm181608701856
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>After the lambda form has been generated, we are very close to\n    having executable code. The OCaml toolchain branches into two separate\n    compilers at this point. We'll describe the bytecode compiler first, which\n    consists of two pieces:<a name=\"idm181608701344\"></a><a name=\"idm181608700048\"></a><a name=\"idm181608698752\"></a><a name=\"CPportbyte\"></a></blockquote>")))
 (idm181608704304
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>The lambda form is primarily a stepping stone to the bytecode\n      executable format that we'll cover next. It's often easier to look at\n      the textual output from this stage than to wade through the native\n      assembly code from compiled executables.<a name=\"idm181608703776\"></a></blockquote>")))
 (idm181608705152
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>These results confirm the performance hypothesis that we obtained earlier by inspecting\n        the lambda code. The shortest running time comes from the small conditional pattern match,\n        and polymorphic variant pattern matching is the slowest. There isn't a hugely significant\n        difference in these examples, but you can use the same techniques to peer into the innards\n        of your own source code and narrow down any performance hotspots.</blockquote>")))
 (idm181608715344
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>Building and executing this example will run for around 30 seconds\n      by default, and you'll see the results summarized in a neat\n      table:</blockquote>")))
 (idm181608722352
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>Let's benchmark these three pattern-matching techniques to quantify their runtime costs\n        more accurately. The <code>Core_bench</code> module runs the tests\n        thousands of times and also calculates statistical variance of the results. You'll need to\n          <code>opam install core_bench</code> to get the library:<a name=\"idm181608720496\"></a><a name=\"idm181608719184\"></a></blockquote>")))
 (idm181608724160
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>It's not essential that you understand all of this just to use\n        pattern matching, of course, but it'll give you insight as to why\n        pattern matching is such a lightweight language construct to use in\n        OCaml code.</blockquote>")))
 (idm181608724816
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>The paper describes the backtracking algorithm used in classical pattern matching\n          compilation, and also several OCaml-specific optimizations, such as the use of\n          exhaustiveness information and control flow optimizations via static exceptions.</blockquote>")))
 (idm181608726176
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>Pattern matching is an important part of OCaml programming.\n        You'll often encounter deeply nested pattern matches over complex data\n        structures in real code. A good paper that describes the fundamental\n        algorithms implemented in OCaml is <a href=\"http://dl.acm.org/citation.cfm?id=507641\" target=\"_top\">&quot;Optimizing pattern\n        matching&quot;</a> by Fabrice Le Fessant and Luc Maranget.</blockquote>")))
 (idm181608729584
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>We mentioned in <a href=\"variants.html\">ChapterÂ 6, <i>Variants</i></a> that pattern matching over polymorphic\n        variants is slightly less efficient, and it should be clearer why this is the case now.\n        Polymorphic variants have a runtime value that's calculated by hashing the variant name, and\n        so the compiler can't use a jump table as it does for normal variants. Instead, it creates a\n        decision tree that compares the hash values against the input variable in as few comparisons\n        as possible.<a name=\"idm181608728336\"></a></blockquote>")))
 (idm181608739264
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>The lambda form for this also shows up the runtime representation\n      of polymorphic variants:</blockquote>")))
 (idm181608742512
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>The compiler emits simpler conditional jumps rather than setting\n      up a jump table, since it statically determines that the range of\n      possible variants is small enough. Finally, let's look at the same code,\n      but with polymorphic variants instead of normal variants:</blockquote>")))
 (idm181608748096
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>The lambda output for this code is now quite different:</blockquote>")))
 (idm181608751120
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>The compiler computes a jump table in order to handle all four\n      cases. If we drop the number of variants to just two, then there's no\n      need for the complexity of computing this table:</blockquote>")))
 (idm181608753504
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>Values are addressed by a unique name that distinguishes shadowed values by\n            appending a number (e.g., <code>v/1014</code>). The type safety\n            checks in the earlier phase ensure that these low-level accesses never violate runtime\n            memory safety, so this layer doesn't do any dynamic checks. Unwise use of unsafe\n            features such as the <code>Obj.magic</code> module can still\n            easily induce crashes at this level.</blockquote>")))
 (idm181608755280
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>The pattern match has turned into a switch case that jumps to the right case\n            depending on the header tag of <code>v</code>. Recall that\n            variants without parameters are stored in memory as integers in the order which they\n            appear. The pattern-matching engine knows this and has transformed the pattern into an\n            efficient jump table.</blockquote>")))
 (idm181608758016
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>There are no mention of modules or types any more. Global\n          values are created via <code>setglobal</code>,\n          and OCaml values are constructed by <code>makeblock</code>. The blocks are the runtime\n          values you should remember from <a href=\"memory-representation-of-values.html\">ChapterÂ 20, <i>Memory Representation of Values</i></a>.</blockquote>")))
 (idm181608759152
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>It's not important to understand every detail of this internal\n      form, and it is explicitly undocumented since it can change across\n      compiler revisions. Despite these caveats, some interesting points\n      emerge from reading it:</blockquote>")))
 (idm181608769312
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>The lambda output for this code looks like this:</blockquote>")))
 (idm181608772288
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>Let's start by creating a straightforward exhaustive pattern match\n      using four normal variants:</blockquote>")))
 (idm181608776640
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>The compiler dumps the lambda form in an s-expression syntax if you add the <span><code>-dlambda</code></span> directive to the\n        command line. Let's use this to learn more about how the OCaml pattern-matching engine works\n        by building three different pattern matches and comparing their lambda forms.<a name=\"idm181608775088\"></a><a name=\"idm181608773744\"></a></blockquote>")))
 (idm181608778784
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>The lambda form is the key stage that discards the OCaml type information and maps the\n      source code to the runtime memory model described in <a href=\"memory-representation-of-values.html\">ChapterÂ 20, <i>Memory Representation of Values</i></a>. This stage also performs some optimizations,\n      most notably converting pattern-match statements into more optimized but low-level\n      statements.</blockquote>")))
 (idm181608782816
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>The first code generation phase eliminates all the static type\n    information into a simpler intermediate <span><em>lambda form</em></span>.\n    The lambda form discards higher-level constructs such as modules and\n    objects and replaces them with simpler values such as records and function\n    pointers. Pattern matches are also analyzed and compiled into highly\n    optimized automata.<a name=\"idm181608781792\"></a><a name=\"CPuntype\"></a></blockquote>")))
 (idm181608785120
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>The native code <span><strong>ocamlopt</strong></span> code\n      generator, and debugging and profiling native code</blockquote>")))
 (idm181608787232
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>The bytecode <span><strong>ocamlc</strong></span> compiler\n      and <span><strong>ocamlrun</strong></span> interpreter</blockquote>")))
 (idm181608788080
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>The untyped intermediate lambda code where pattern matching is\n      optimized</blockquote>")))
 (idm181608789040
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>In this chapter, we'll cover the following topics:</blockquote>")))
 (idm181608789600
  ((file the-compiler-backend-byte-code-and-native-code.html)
   (html
    "<blockquote>Once OCaml has passed the type checking stage, it can stop emitting\n  syntax and type errors and begin the process of compiling the well-formed\n  modules into executable code.</blockquote>")))
 (idm181618001392
  ((file records.html)
   (html
    "<blockquote>Field iterators are useful for a variety of record-related tasks,\n    from building record-validation functions to scaffolding the definition of\n    a web form from a record type. Such applications can benefit from the\n    guarantee that all fields of the record type in question have been\n    considered.<a name=\"idm181618000816\"></a><a name=\"idm181618000224\"></a><a name=\"idm181617999616\"></a></blockquote>")))
 (idm181618004064
  ((file records.html)
   (html
    "<blockquote>One nice side effect of this approach is that it helps you adapt\n    your code when the fields of a record change. If you were to add a field\n    to <code>Logon.t</code>, the type of <code>Logon.Fields.iter</code> would change along with it,\n    acquiring a new argument. Any code using <code>Logon.Fields.iter</code> won't compile until it's fixed\n    to take this new argument into account.</blockquote>")))
 (idm181618020752
  ((file records.html)
   (html
    "<blockquote>Now, let's use <code>Logon.Fields.iter</code>\n    and <code>show_field</code> to print out all the\n    fields of a <code>Logon</code> record:</blockquote>")))
 (idm181618023472
  ((file records.html)
   (html
    "<blockquote>This is a bit daunting to look at, largely because of the access\n    control markers, but the structure is actually pretty simple. Each labeled\n    argument is a function that takes a first-class field of the necessary\n    type as an argument. Note that <code>iter</code>\n    passes each of these callbacks the <code>Field.t</code>, not the contents of the specific record\n    field. The contents of the field, though, can be looked up using the\n    combination of the record and the <code>Field.t</code>.</blockquote>")))
 (idm181618037072
  ((file records.html)
   (html
    "<blockquote><code>fieldslib</code> also provides\n    higher-level operators, like <code>Fields.fold</code> and <code>Fields.iter</code>, which let you walk over the fields\n    of a record. So, for example, in the case of <code>Logon.t</code>, the field iterator has the following\n    type:</blockquote>")))
 (idm181618038960
  ((file records.html)
   (html
    "<blockquote>As a side note, the preceding example is our first use of the\n    <code>Fn</code> module (short for &quot;function&quot;), which\n    provides a collection of useful primitives for dealing with functions.\n    <code>Fn.id</code> is the identity function.</blockquote>")))
 (idm181618052240
  ((file records.html)
   (html
    "<blockquote>Here's an example of <code>show_field</code>\n    in action:</blockquote>")))
 (idm181618053408
  ((file records.html)
   (html
    "<blockquote>This takes three arguments: the <code>Field.t</code>, a function for converting the contents\n    of the field in question to a string, and a record from which the field\n    can be grabbed.</blockquote>")))
 (idm181618061328
  ((file records.html)
   (html
    "<blockquote>We can use first-class fields to do things like write a generic\n    function for displaying a record field:</blockquote>")))
 (idm181618063312
  ((file records.html)
   (html
    "<blockquote>The type is <code>Field.t_with_perm</code>\n    rather than <code>Field.t</code> because fields have\n    a notion of access control that comes up in some special cases where we\n    expose the ability to read a field from a record, but not the ability to\n    create new records, and so we can't expose functional updates.</blockquote>")))
 (idm181618068416
  ((file records.html)
   (html
    "<blockquote>The type of <code>Field.get</code> is a little\n    more complicated than you might naively expect from the preceding\n    one:</blockquote>")))
 (idm181618070928
  ((file records.html)
   (html
    "<blockquote>Thus, the first parameter of the <code>Field.t</code> corresponds to\n      the record you pass to <code>get</code>, and the second parameter\n      corresponds to the value contained in the field, which is also the return type of <code>get</code>.</blockquote>")))
 (idm181618081408
  ((file records.html)
   (html
    "<blockquote>A <code>Field.t</code> has two type\n    parameters: the first for the type of the record, and the second for the\n    type of the field in question. Thus, the type of <code>Logon.Fields.session_id</code> is <code>(Logon.t, string) Field.t</code>, whereas the type of\n    <code>Logon.Fields.time</code> is <code>(Logon.t, Time.t) Field.t</code>. Thus, if you call\n    <code>Field.get</code> on <code>Logon.Fields.user</code>, you'll get a function for\n    extracting the <code>user</code> field from a\n    <code>Logon.t</code>:</blockquote>")))
 (idm181618084240
  ((file records.html)
   (html
    "<blockquote>Returns <code>None</code> if the field\n          is not mutable or <code>Some f</code> if it\n          is, where <code>f</code> is a function for\n          mutating that field</blockquote>")))
 (idm181618086208
  ((file records.html)
   (html "<blockquote>Does a functional update of a field</blockquote>")))
 (idm181618088160
  ((file records.html)
   (html "<blockquote>Returns the content of a field</blockquote>")))
 (idm181618090080
  ((file records.html)
   (html "<blockquote>Returns the name of a field</blockquote>")))
 (idm181618100864
  ((file records.html)
   (html
    "<blockquote>In addition to generating field accessor functions, <code>fieldslib</code> also creates a submodule called\n    <code>Fields</code> that contains a first-class\n    representative of each field, in the form of a value of type <code>Field.t</code>. The <code>Field</code> module provides the following\n    functions:<a name=\"idm181618097824\"></a><a name=\"idm181618096528\"></a><a name=\"idm181618095232\"></a><a name=\"idm181618093936\"></a><a name=\"idm181618092640\"></a></blockquote>")))
 (idm181618105888
  ((file records.html)
   (html
    "<blockquote>One of the functions we obtain is <code>Logon.user</code>, which we can use to extract the user\n    field from a logon message:</blockquote>")))
 (idm181618109104
  ((file records.html)
   (html
    "<blockquote>Note that this will generate <span><em>a lot</em></span> of output\n    because <code>fieldslib</code> generates a large\n    collection of helper functions for working with record fields. We'll only\n    discuss a few of these; you can learn about the remainder from the\n    documentation that comes with <code>fieldslib</code>.</blockquote>")))
 (idm181618114544
  ((file records.html)
   (html
    "<blockquote>The <code>with fields</code> annotation at the\n    end of the declaration of a record type will cause the extension to be\n    applied to a given type declaration. So, for example, we could have\n    defined <code>Logon</code> as follows:</blockquote>")))
 (idm181618117968
  ((file records.html)
   (html
    "<blockquote>Here, we wrote a small function <code>(fun x\n    -&gt; x.Logon.user)</code> to access the <code>user</code> field. This kind of accessor function is a\n    common enough pattern that it would be convenient to generate it\n    automatically. The <code>fieldslib</code> syntax\n    extension that ships with Core does just that.<a name=\"idm181618115584\"></a></blockquote>")))
 (idm181618128096
  ((file records.html)
   (html
    "<blockquote>Consider the following function for extracting the usernames from a\n    list of <code>Logon</code> messages:<a name=\"Ffc\"></a><a name=\"firstclass\"></a><a name=\"RECfirstclass\"></a></blockquote>")))
 (idm181618130272
  ((file records.html)
   (html
    "<blockquote>OCaml's policy of immutable-by-default is a good one, but imperative\n    programming is an important part of programming in OCaml. We go into more\n    depth about how (and when) to use OCaml's imperative features in <a href=\"a-guided-tour.html#imperative-programming\">the section called â\128\156Imperative Programmingâ\128\157</a>.</blockquote>")))
 (idm181618131424
  ((file records.html)
   (html
    "<blockquote>Note that mutable assignment, and thus the <code>&lt;-</code> operator, is not needed for initialization\n    because all fields of a record, including mutable ones, are specified when\n    the record is created.</blockquote>")))
 (idm181618139296
  ((file records.html)
   (html
    "<blockquote>The <code>&lt;-</code> operator is used for setting a mutable field.\n      The side-effecting version of <code>register_heartbeat</code> would be\n      written as follows:</blockquote>")))
 (idm181618155760
  ((file records.html)
   (html
    "<blockquote>Like most OCaml values, records are immutable by default. You can,\n    however, declare individual record fields as mutable. In the following\n    code, we've made the last two fields of <code>client_info</code> mutable:<a name=\"idm181618154656\"></a><a name=\"idm181618153744\"></a></blockquote>")))
 (idm181618164192
  ((file records.html)
   (html
    "<blockquote>The original implementation of <code>register_heartbeat</code> would now be invalid, and\n    thus the compiler would effectively warn us to think about how to handle\n    this new field. But the version using a functional update continues to\n    compile as is, even though it incorrectly ignores the new field. The\n    correct thing to do would be to update the code as follows:</blockquote>")))
 (idm181618178080
  ((file records.html)
   (html
    "<blockquote>Functional updates make your code independent of the identity of the\n    fields in the record that are not changing. This is often what you want,\n    but it has downsides as well. In particular, if you change the definition\n    of your record to have more fields, the type system will not prompt you to\n    reconsider whether your code needs to change to accommodate the new\n    fields. Consider what happens if we decided to add a field for the status\n    message received on the last heartbeat:</blockquote>")))
 (idm181618183808
  ((file records.html)
   (html
    "<blockquote>Given this, we can rewrite <code>register_heartbeat</code> more concisely:</blockquote>")))
 (idm181618184336
  ((file records.html)
   (html
    "<blockquote>The purpose of the functional update is to create a new record based\n    on an existing one, with a set of field changes layered on top.</blockquote>")))
 (idm181618190336
  ((file records.html)
   (html
    "<blockquote>This is fairly verbose, given that there's only one field that we\n    actually want to change, and all the others are just being copied over\n    from <code>t</code>. We can use OCaml's\n    <span><em>functional update</em></span> syntax to do this more tersely. The\n    syntax of a functional update is as follows:</blockquote>")))
 (idm181618210960
  ((file records.html)
   (html
    "<blockquote>Fairly often, you will find yourself wanting to create a new record\n    that differs from an existing record in only a subset of the fields. For\n    example, imagine our logging server had a record type for representing the\n    state of a given client, including when the last heartbeat was received\n    from that client. The following defines a type for representing this\n    information, as well as a function for updating the client information\n    when a new heartbeat arrives:<a name=\"idm181618210208\"></a><a name=\"idm181618209296\"></a></blockquote>")))
 (idm181618213744
  ((file records.html)
   (html
    "<blockquote>For functions defined within the module where a given record is\n    defined, the module qualification goes away entirely.<a name=\"idm181618213360\"></a><a name=\"idm181618212752\"></a></blockquote>")))
 (idm181618216576
  ((file records.html)
   (html
    "<blockquote>The syntax here is a little surprising when you first encounter it.\n    The thing to keep in mind is that the dot is being used in two ways: the\n    first dot is a record field access, with everything to the right of the\n    dot being interpreted as a field name; the second dot is accessing the\n    contents of a module, referring to the record field <code>important</code> from within the module <code>Log_entry</code>. The fact that <code>Log_entry</code> is capitalized and so can't be a field\n    name is what disambiguates the two uses.</blockquote>")))
 (idm181618221024
  ((file records.html)
   (html
    "<blockquote>When using dot notation for accessing record fields, we can qualify\n    the field by the module directly:</blockquote>")))
 (idm181618226784
  ((file records.html)
   (html
    "<blockquote>This is not restricted to constructing a record; we can use the same\n    trick when pattern matching:</blockquote>")))
 (idm181618235488
  ((file records.html)
   (html
    "<blockquote>The module name <code>Log_entry</code> is\n    required to qualify the fields, because this function is outside of the\n    <code>Log_entry</code> module where the record was\n    defined. OCaml only requires the module qualification for one record\n    field, however, so we can write this more concisely. Note that we are\n    allowed to insert whitespace between the module path and the field\n    name:</blockquote>")))
 (idm181618242688
  ((file records.html)
   (html
    "<blockquote>Now, our log-entry-creation function can be rendered as\n    follows:</blockquote>")))
 (idm181618276000
  ((file records.html)
   (html
    "<blockquote>We can avoid this ambiguity altogether, either by using\n    nonoverlapping field names or, more generally, by minting a module for\n    each type. Packing types into modules is a broadly useful idiom (and one\n    used quite extensively by Core), providing for each type a namespace\n    within which to put related values. When using this style, it is standard\n    practice to name the type associated with the module <code>t</code>. Using this style we would write:</blockquote>")))
 (idm181618280000
  ((file records.html)
   (html
    "<blockquote>Why did the first definition succeed without a type annotation and\n    the second one fail? The difference is that in the first case, the\n    type-checker considered the <code>status_message</code> field first and thus concluded\n    that the record was a <code>heartbeat</code>. When\n    the order was switched, the <code>session_id</code>\n    field was considered first, and so that drove the type to be considered to\n    be a <code>logon</code>, at which point <code>t.status_message</code> no longer made sense.</blockquote>")))
 (idm181618289008
  ((file records.html)
   (html
    "<blockquote>While it's possible to resolve ambiguous field names using type\n    annotations, the ambiguity can be a bit confusing. Consider the following\n    functions for grabbing the session ID and status from a heartbeat:</blockquote>")))
 (idm181618294240
  ((file records.html)
   (html
    "<blockquote>In this case, OCaml just picks the most recent definition of that\n    record field. We can force OCaml to assume we're dealing with a different\n    type (say, a <code>heartbeat</code>) using a type\n    annotation:</blockquote>")))
 (idm181618299152
  ((file records.html)
   (html
    "<blockquote>Reusing field names can lead to some ambiguity. For example, if we\n    want to write a function to grab the <code>session_id</code> from a\n    record, what type will it have?</blockquote>")))
 (idm181618329168
  ((file records.html)
   (html
    "<blockquote>We'll describe three message types: <code>log_entry</code>, <code>heartbeat</code>, and <code>logon</code>. The <code>log_entry</code> message is used to deliver a log entry\n    to the server; the <code>logon</code> message is\n    sent to initiate a connection and includes the identity of the user\n    connecting and credentials used for authentication; and the <code>heartbeat</code> message is periodically sent by the\n    client to demonstrate to the server that the client is alive and\n    connected. All of these messages include a session ID and the time the\n    message was generated:</blockquote>")))
 (idm181618332832
  ((file records.html)
   (html
    "<blockquote>Defining records with the same field names can be problematic. Let's\n    consider a simple example: building types to represent the protocol used\n    for a logging server.<a name=\"FNreus\"></a><a name=\"RECreusfn\"></a></blockquote>")))
 (idm181618334528
  ((file records.html)
   (html
    "<blockquote>Together, labeled arguments, field names, and field and label\n    punning encourage a style where you propagate the same names throughout\n    your codebase. This is generally good practice, since it encourages\n    consistent naming, which makes it easier to navigate the source.</blockquote>")))
 (idm181618344960
  ((file records.html)
   (html
    "<blockquote>This is considerably more concise than what you would get without\n    punning:</blockquote>")))
 (idm181618355152
  ((file records.html)
   (html
    "<blockquote>You can take advantage of both field punning and label punning when\n    writing a function for constructing a record from labeled\n    arguments:<a name=\"idm181618354736\"></a><a name=\"idm181618353840\"></a></blockquote>")))
 (idm181618355728
  ((file records.html)
   (html
    "<blockquote>In the preceding code, we defined variables corresponding to the\n    record fields first, and then the record declaration itself simply listed\n    the fields that needed to be included.</blockquote>")))
 (idm181618368720
  ((file records.html)
   (html
    "<blockquote>Field punning can also be used to construct a record. Consider the\n    following code for generating a <code>host_info</code> record:<a name=\"idm181618367744\"></a></blockquote>")))
 (idm181618377968
  ((file records.html)
   (html
    "<blockquote>When the name of a variable coincides with the name of a record\n    field, OCaml provides some handy syntactic shortcuts. For example, the\n    pattern in the following function binds all of the fields in question to\n    variables of the same name. This is called <span><em>field\n    punning</em></span>:<a name=\"idm181618377024\"></a><a name=\"idm181618375728\"></a></blockquote>")))
 (idm181618379968
  ((file records.html)
   (html
    "<blockquote>Treating warnings as errors (i.e., making OCaml fail to compile\n      any code that triggers a warning) is good practice, since without it,\n      warnings are too often ignored during development. When preparing a\n      package for distribution, however, this is a bad idea, since the list of\n      warnings may grow from one release of the compiler to another, and so\n      this may lead your package to fail to compile on newer compiler\n      releases.</blockquote>")))
 (idm181618381808
  ((file records.html)
   (html
    "<blockquote>The syntax of this can be found by running <code>ocaml -help</code>, but this particular invocation\n      turns on all warnings as errors, disabling only the numbers listed\n      explicitly after the <code>A</code>.</blockquote>")))
 (idm181618382960
  ((file records.html)
   (html
    "<blockquote>The warnings used for building the examples in this book are\n      specified with the following flag: <code>-w\n      @A-4-33-41-42-43-34-44</code>.</blockquote>")))
 (idm181618383632
  ((file records.html)
   (html
    "<blockquote>You should think of OCaml's warnings as a powerful set of optional\n      static analysis tools, and you should eagerly enable them in your build\n      environment. You don't typically enable all warnings, but the defaults\n      that ship with the compiler are pretty good.</blockquote>")))
 (idm181618388624
  ((file records.html)
   (html
    "<blockquote>The OCaml compiler is packed full of useful warnings that can be\n      enabled and disabled separately. These are documented in the compiler\n      itself, so we could have found out about warning 9 as follows:</blockquote>")))
 (idm181618390688
  ((file records.html)
   (html
    "<blockquote>It's a good idea to enable the warning for incomplete record matches\n    and to explicitly disable it with an <code>_</code>\n    where necessary.</blockquote>")))
 (idm181618397264
  ((file records.html)
   (html
    "<blockquote>We can disable the warning for a given pattern by explicitly\n    acknowledging that we are ignoring extra fields. This is done by adding an\n    underscore to the pattern:</blockquote>")))
 (idm181618413648
  ((file records.html)
   (html
    "<blockquote>Happily, OCaml does offer an optional warning for missing fields in\n    a record pattern. With that warning turned on (which you can do in the\n    toplevel by typing <code>#warnings &quot;+9&quot;</code>), the\n    compiler will warn about the missing field:<a name=\"idm181618412512\"></a><a name=\"idm181618411200\"></a><a name=\"idm181618409888\"></a><a name=\"idm181618408576\"></a></blockquote>")))
 (idm181618416256
  ((file records.html)
   (html
    "<blockquote>The code for <code>host_info_to_string</code>\n    would continue to compile without change. In this particular case, it's\n    pretty clear that you might want to update <code>host_info_to_string</code> in order to include <code>os_release</code>, and it would be nice if the type\n    system would give you a warning about the change.</blockquote>")))
 (idm181618429728
  ((file records.html)
   (html
    "<blockquote>As an example, imagine that we wanted to add a new field to our\n    <code>host_info</code> record called <code>os_release</code>:</blockquote>")))
 (idm181618430528
  ((file records.html)
   (html
    "<blockquote>Another important characteristic of record patterns is that they\n    don't need to be complete; a pattern can mention only a subset of the\n    fields in the record. This can be convenient, but it can also be error\n    prone. In particular, this means that when new fields are added to the\n    record, code that should be updated to react to the presence of those new\n    fields will not be flagged by the compiler.</blockquote>")))
 (idm181618434688
  ((file records.html)
   (html
    "<blockquote>Note that the pattern we used had only a single case, rather than\n    using several cases separated by <code>|</code>'s.\n    We needed only one pattern because record patterns are\n    <span><em>irrefutable</em></span>, meaning that a record pattern match will\n    never fail at runtime. This makes sense, because the set of fields\n    available in a record is always the same. In general, patterns for types\n    with a fixed structure, like records and tuples, are irrefutable, unlike\n    types with variable structures like lists and variants.<a name=\"idm181618432880\"></a><a name=\"idm181618431968\"></a></blockquote>")))
 (idm181618446592
  ((file records.html)
   (html
    "<blockquote>Another way of getting information out of a record is by using a\n    pattern match, as in the definition of <code>host_info_to_string</code>:<a name=\"idm181618445568\"></a><a name=\"idm181618444000\"></a></blockquote>")))
 (idm181618453344
  ((file records.html)
   (html
    "<blockquote>We can then write polymorphic functions that operate over this\n  parameterized type:</blockquote>")))
 (idm181618457904
  ((file records.html)
   (html
    "<blockquote>When declaring an OCaml type, you always have the option of\n  parameterizing it by a polymorphic type. Records are no different in this\n  regard. So, for example, here's a type one might use to timestamp arbitrary\n  items:</blockquote>")))
 (idm181618462288
  ((file records.html)
   (html
    "<blockquote>Once we have a record value in hand, we can extract elements from the\n  record field using dot notation:</blockquote>")))
 (idm181618464272
  ((file records.html)
   (html
    "<blockquote>You might wonder how the compiler inferred that <code>my_host</code> is of type <code>host_info</code>. The hook that the compiler uses in this\n  case to figure out the type is the record field name. Later in the chapter,\n  we'll talk about what happens when there is more than one record type in\n  scope with the same field name.</blockquote>")))
 (idm181618479696
  ((file records.html)
   (html
    "<blockquote>We can construct a <code>host_info</code> just\n  as easily. The following code uses the <code>Shell</code> module from <code>Core_extended</code> to dispatch commands to the shell to\n  extract the information we need about the computer we're running on. It also\n  uses the <code>Time.now</code> call from Core's\n  <code>Time</code> module:</blockquote>")))
 (idm181618491072
  ((file records.html)
   (html
    "<blockquote>Here's a simple example, a <code>host_info</code> record that summarizes information about\n  a given computer:</blockquote>")))
 (idm181618491536
  ((file records.html)
   (html
    "<blockquote>Note that record field names must start with a lowercase\n  letter.</blockquote>")))
 (idm181618497744
  ((file records.html)
   (html
    "<blockquote>A record represents a collection of values stored together as one,\n  where each component is identified by a different field name. The basic\n  syntax for a record type declaration is as follows:<a name=\"idm181618497280\"></a></blockquote>")))
 (idm181618498992
  ((file records.html)
   (html
    "<blockquote>One of OCaml's best features is its concise and expressive system for\n  declaring new data types, and records are a key element of that system. We\n  discussed records briefly in <a href=\"a-guided-tour.html\">ChapterÂ 1, <i>A Guided Tour</i></a>, but this\n  chapter will go into more depth, covering the details of how records work,\n  as well as advice on how to use them effectively in your software\n  designs.</blockquote>")))
 (idm181621267216
  ((file prologue.html)
   (html
    "<blockquote>The many people who collectively submitted over 2400 comments to online drafts of this\n          book, through whose efforts countless errors were found and fixed.</blockquote>")))
 (idm181621268992
  ((file prologue.html)
   (html
    "<blockquote>Jeremie Dimino, the author of <span><em>utop</em></span>, the interactive command-line\n          interface that is used throughout this book. We're particularly grateful for the changes\n          that he pushed through to make <span><em>utop</em></span> work better in the context of the\n          book. </blockquote>")))
 (idm181621270912
  ((file prologue.html)
   (html
    "<blockquote>Stephen Weeks is responsible for much of the modular architecture behind Core, and his\n          extensive notes formed the basis of <a href=\"memory-representation-of-values.html\">ChapterÂ 20, <i>Memory Representation of Values</i></a> and\n            <a href=\"understanding-the-garbage-collector.html\">ChapterÂ 21, <i>Understanding the Garbage Collector</i></a>.</blockquote>")))
 (idm181621272240
  ((file prologue.html)
   (html
    "<blockquote>Jeremy Yallop authored and documented the Ctypes library\n        described in <a href=\"foreign-function-interface.html\">ChapterÂ 19, <i>Foreign Function Interface</i></a>.</blockquote>")))
 (idm181621274048
  ((file prologue.html)
   (html
    "<blockquote>Leo White contributed greatly to the content and examples in\n        <a href=\"objects.html\">ChapterÂ 11, <i>Objects</i></a> and <a href=\"classes.html\">ChapterÂ 12, <i>Classes</i></a>.</blockquote>")))
 (idm181621275408
  ((file prologue.html)
   (html
    "<blockquote>We would especially like to thank the following individuals for\n    improving <span><em>Real World OCaml</em></span>:</blockquote>")))
 (idm181621276960
  ((file prologue.html)
   (html
    "<blockquote>Watch us on YouTube: <a href=\"http://www.youtube.com/oreillymedia\" target=\"_top\">http://www.youtube.com/oreillymedia</a></blockquote>")))
 (idm181621277696
  ((file prologue.html)
   (html
    "<blockquote>Follow us on Twitter: <a href=\"http://twitter.com/oreillymedia\" target=\"_top\">http://twitter.com/oreillymedia</a></blockquote>")))
 (idm181621278432
  ((file prologue.html)
   (html
    "<blockquote>Find us on Facebook: <a href=\"http://facebook.com/oreilly\" target=\"_top\">http://facebook.com/oreilly</a></blockquote>")))
 (idm181621279392
  ((file prologue.html)
   (html
    "<blockquote>For more information about our books, courses, conferences, and\n    news, see our website at <a href=\"http://www.oreilly.com\" target=\"_top\">http://www.oreilly.com</a>.</blockquote>")))
 (idm181621280976
  ((file prologue.html)
   (html
    "<blockquote>To comment or ask technical questions about this book, send email\n    to:</blockquote>")))
 (idm181621282720
  ((file prologue.html)
   (html
    "<blockquote>We have a web page for this book, where we list errata, examples,\n    and any additional information. You can access this page at:</blockquote>")))
 (idm181621286080
  ((file prologue.html)
   (html
    "<blockquote>Please address comments and questions concerning this book to the\n    publisher:</blockquote>")))
 (idm181621293584
  ((file prologue.html)
   (html
    "<blockquote>Safari Books Online offers a range of <a href=\"http://www.safaribooksonline.com/subscriptions\" target=\"_top\">product mixes</a>\n    and pricing programs for <a href=\"http://www.safaribooksonline.com/organizations-teams\" target=\"_top\">organizations</a>,\n    <a href=\"http://www.safaribooksonline.com/government\" target=\"_top\">government\n    agencies</a>, and <a href=\"http://www.safaribooksonline.com/individuals\" target=\"_top\">individuals</a>.\n    Subscribers have access to thousands of books, training videos, and\n    prepublication manuscripts in one fully searchable database from\n    publishers like Oâ\128\153Reilly Media, Prentice Hall Professional, Addison-Wesley\n    Professional, Microsoft Press, Sams, Que, Peachpit Press, Focal Press,\n    Cisco Press, John Wiley &amp; Sons, Syngress, Morgan Kaufmann, IBM\n    Redbooks, Packt, Adobe Press, FT Press, Apress, Manning, New Riders,\n    McGraw-Hill, Jones &amp; Bartlett, Course Technology, and dozens <a href=\"http://www.safaribooksonline.com/publishers\" target=\"_top\">more</a>. For more\n    information about Safari Books Online, please visit us <a href=\"http://www.safaribooksonline.com/\" target=\"_top\">online</a>.</blockquote>")))
 (idm181621296576
  ((file prologue.html)
   (html
    "<blockquote>Safari Books Online (<a href=\"http://my.safaribooksonline.com/?portal=oreilly\" target=\"_top\">www.safaribooksonline.com</a>)\n      is an on-demand digital library that delivers expert <a href=\"http://www.safaribooksonline.com/content\" target=\"_top\">content</a> in both\n      book and video form from the worldâ\128\153s leading authors in technology and\n      business. Technology professionals, software developers, web designers,\n      and business and creative professionals use Safari Books Online as their\n      primary resource for research, problem solving, learning, and\n      certification training.</blockquote>")))
 (idm181621298768
  ((file prologue.html)
   (html
    "<blockquote>If you feel your use of code examples falls outside fair use or\n      the permission given above, feel free to contact us at\n      <code>&lt;<a href=\"mailto:permissions@oreilly.com\">permissions@oreilly.com</a>&gt;</code>.</blockquote>")))
 (idm181621299856
  ((file prologue.html)
   (html
    "<blockquote>The code repository is available online at <a href=\"https://github.com/realworldocaml/examples\" target=\"_top\">https://github.com/realworldocaml/examples</a>. Every code snippet in the book has a clickable\n        header that tells you the filename in that repository to find the source code, shell script,\n        or ancillary data file that the snippet was sourced from.</blockquote>")))
 (idm181621301760
  ((file prologue.html)
   (html
    "<blockquote>All of the code examples in this book are available freely online\n      under a public-domain-like license. You are most welcome to copy and use\n      any of the snippets as you see fit in your own code, without any\n      attribution or other restrictions on their use.<a name=\"idm181621301232\"></a></blockquote>")))
 (idm181621304128
  ((file prologue.html)
   (html
    "<blockquote>This book is not intended as a reference manual. We aim to teach\n      you about the language and about libraries tools and techniques that\n      will help you be a more effective OCaml programmer. But it's no\n      replacement for API documentation or the OCaml manual and man pages. You\n      can find documentation for all of the libraries and tools referenced in\n      the book <a href=\"https://realworldocaml.org/doc\" target=\"_top\">online</a>.</blockquote>")))
 (idm181621306112
  ((file prologue.html)
   (html
    "<blockquote>As of publication time, the Windows operating system is\n      unsupported by Core, and so only Mac OS X, Linux, FreeBSD, and OpenBSD\n      can be expected to work reliably. Please check the online installation\n      instructions for updates regarding Windows, or install a Linux virtual\n      machine to work through the book as it stands.<a name=\"idm181621305504\"></a></blockquote>")))
 (idm181621309936
  ((file prologue.html)
   (html
    "<blockquote><span><em>Real World OCaml</em></span> uses some tools that we've\n      developed while writing this book. Some of these resulted in\n      improvements to the OCaml compiler, which means that you will need to\n      ensure that you have an up-to-date development environment (using the\n      4.01 version of the compiler). The installation process is largely automated through the OPAM package manager.\n      Instructions on how to it set up and what packages to install can be found at <a href=\"http://realworldocaml.org/install\" target=\"_top\">this Real World OCaml page</a>.<a name=\"idm181621308352\"></a><a name=\"idm181621307488\"></a></blockquote>")))
 (idm181621312608
  ((file prologue.html)
   (html
    "<blockquote>Part III discusses OCaml's runtime system and compiler\n          toolchain. It is remarkably simple when compared to some other\n          language implementations (such as Java's or .NET's CLR). Reading\n          this part will enable you to build very-high-performance systems, or\n          to interface with C libraries. This is also where we talk about\n          profiling and debugging techniques using tools such as GNU <span><strong>gdb</strong></span>.</blockquote>")))
 (idm181621314400
  ((file prologue.html)
   (html
    "<blockquote>Part II builds on the basics by working through useful tools and techniques for\n            addressing common practical applications, from command-line parsing to asynchronous\n            network programming. Along the way, you'll see how some of the <span>concepts</span> from Part I are glued together into real\n            libraries and tools that combine different features of the language to good\n            effect.</blockquote>")))
 (idm181621315568
  ((file prologue.html)
   (html
    "<blockquote>After covering the core language, Part I then moves onto more\n          advanced features like modules, functors, and objects, which may\n          take some time to digest. Understanding these concepts is important,\n          though. These ideas will put you in good stead even beyond OCaml\n          when switching to other modern languages, many of which have drawn\n          inspiration from ML.</blockquote>")))
 (idm181621316320
  ((file prologue.html)
   (html
    "<blockquote>Part I covers the language itself, opening with a guided tour\n          designed to provide a quick sketch of the language. Don't expect to\n          understand everything in the tour; it's meant to give you a taste of\n          many different aspects of the language, but the ideas covered there\n          will be explained in more depth in the chapters that follow.</blockquote>")))
 (idm181621317472
  ((file prologue.html)
   (html
    "<blockquote><span><em>Real World OCaml</em></span> is split into three\n      parts:</blockquote>")))
 (idm181621319408
  ((file prologue.html)
   (html
    "<blockquote>Code that uses only the traditional compiler standard library will\n    always exist, but there are other online resources for learning how that\n    works. <span><em>Real World OCaml</em></span> focuses on the techniques the\n    authors have used in their personal experience to construct scalable,\n    robust software systems.</blockquote>")))
 (idm181621320384
  ((file prologue.html)
   (html
    "<blockquote>If you already know OCaml, this book may surprise you. Core redefines most of the standard\n      namespace to make better use of the OCaml module system and expose a number of powerful,\n      reusable data structures by default. Older OCaml code will still interoperate with Core, but\n      you may need to adapt it for maximal benefit. All the new code that we write uses Core, and we\n      believe the Core model is worth learning; it's been successfully used on large,\n      multimillion-line codebases and removes a big barrier to building sophisticated applications\n      in OCaml.</blockquote>")))
 (idm181621321456
  ((file prologue.html)
   (html
    "<blockquote><span><em>Real World OCaml</em></span> is aimed at programmers who\n    have some experience with conventional programming languages, but not\n    specifically with statically typed functional programming. Depending on\n    your background, many of the concepts we cover will be new, including\n    traditional functional-programming techniques like higher-order functions\n    and immutable data types, as well as aspects of OCaml's powerful type and\n    module systems.</blockquote>")))
 (idm181621324416
  ((file prologue.html)
   (html
    "<blockquote>We'll also use OPAM for installing the <span><strong>utop</strong></span> command-line interface. This is a modern\n      interactive tool that supports command history, macro expansion, module\n      completion, and other niceties that make it much more pleasant to work\n      with the language. We'll be using <span><strong>utop</strong></span> throughout the book to let you step\n      through the examples interactively.</blockquote>")))
 (idm181621325808
  ((file prologue.html)
   (html
    "<blockquote>The installation and management of these third-party libraries is made much easier via a\n        package management tool known as <a href=\"http://opam.ocaml.org/\" target=\"_top\">OPAM</a>. We'll explain more about OPAM\n        as the book unfolds, but it forms the basis of the Platform, which is a set of tools and\n        libraries that, along with the OCaml compiler, lets you build real-world applications\n        quickly and effectively.</blockquote>")))
 (idm181621327808
  ((file prologue.html)
   (html
    "<blockquote>Core is a comprehensive and effective standard library, but\n      there's much more OCaml software out there. A large community of\n      programmers has been using OCaml since its first release in 1996, and\n      has generated many useful libraries and tools. We'll introduce some of\n      these libraries in the course of the examples presented in the\n      book.<a name=\"idm181621327184\"></a></blockquote>")))
 (idm181621329600
  ((file prologue.html)
   (html
    "<blockquote>Core is distributed with syntax extensions that provide useful new\n      functionality to OCaml, and there are additional libraries such as the\n      Async network communications library that extend the reach of Core into\n      building complex distributed systems. All of these libraries are\n      distributed under a liberal Apache 2 license to permit free use in\n      hobby, academic, and commercial settings.</blockquote>")))
 (idm181621330336
  ((file prologue.html)
   (html
    "<blockquote>Jane Street, a company that has been using OCaml for more than a\n      decade, developed Core for its own internal use, but designed it from\n      the start with an eye toward being a general-purpose standard library.\n      Like the OCaml language itself, Core is engineered with correctness,\n      reliability, and performance in mind.</blockquote>")))
 (idm181621330960
  ((file prologue.html)
   (html
    "<blockquote>Happily, in the world of open source software, nothing stops\n      alternative libraries from being written to supplement the\n      compiler-supplied standard library, and this is exactly what the Core\n      distribution is.</blockquote>")))
 (idm181621334384
  ((file prologue.html)
   (html
    "<blockquote>A language on its own isn't enough. You also need a rich set of\n      libraries to base your applications on. A common source of frustration\n      for those learning OCaml is that the standard library that ships with\n      the compiler is limited, covering only a small subset of the\n      functionality you would expect from a general-purpose standard library.\n      That's because the standard library isn't a general-purpose tool; it was\n      developed for use in bootstrapping the compiler and is purposefully kept\n      small and simple.<a name=\"idm181621333584\"></a><a name=\"idm181621332336\"></a></blockquote>")))
 (idm181621336896
  ((file prologue.html)
   (html
    "<blockquote>The last decade has seen OCaml attract a significant user base,\n      and language improvements have been steadily added to support the\n      growing commercial and academic <span>codebases</span>. First-class modules,\n      Generalized Algebraic Data Types (GADTs), and dynamic linking have\n      improved the flexibility of the language. There is also fast native code\n      support for x86_64, ARM, PowerPC, and Sparc, making OCaml a good choice\n      for systems where resource usage, predictability, and performance all\n      matter.</blockquote>")))
 (idm181621338224
  ((file prologue.html)
   (html
    "<blockquote>The modern OCaml emerged in 1996, when a powerful and elegant\n      object system was implemented by Didier RÃ©my and JÃ©rÃ´me Vouillon. This\n      object system was notable for supporting many common object-oriented\n      idioms in a statically type-safe way, whereas the same idioms required\n      runtime checks in languages such as C++ or Java. In 2000, Jacques\n      Garrigue extended OCaml with several new features such as polymorphic\n      methods, variants, and labeled and optional arguments.</blockquote>")))
 (idm181621339088
  ((file prologue.html)
   (html
    "<blockquote>Xavier Leroy continued extending Caml Light with new features,\n      which resulted in the 1995 release of Caml Special Light. This improved\n      the executable efficiency significantly by adding a fast native code\n      compiler that made Caml's performance competitive with mainstream\n      languages such as C++. A module system inspired by Standard ML also\n      provided powerful facilities for abstraction and made larger-scale\n      programs easier to construct.</blockquote>")))
 (idm181621340240
  ((file prologue.html)
   (html
    "<blockquote>The first implementation of Caml appeared in 1987. It was created\n      by AscÃ¡nder SuÃ¡rez and later continued by Pierre Weis and Michel Mauny.\n      In 1990, Xavier Leroy and Damien Doligez built a new implementation\n      called Caml Light that was based on a bytecode interpreter with a fast,\n      sequential garbage collector. Over the next few years useful libraries\n      appeared, such as Michel Mauny's syntax manipulation tools, and this\n      helped promote the use of Caml in education and research teams.</blockquote>")))
 (idm181621341344
  ((file prologue.html)
   (html
    "<blockquote>ML was originally the <span><em>meta language</em></span> of the\n      LCF (Logic for Computable Functions) proof assistant released by Robin\n      Milner in 1972 (at Stanford, and later at Cambridge). ML was turned into\n      a compiler in order to make it easier to use LCF on different machines,\n      and it was gradually turned into a full-fledged system of its own by the\n      1980s.</blockquote>")))
 (idm181621343520
  ((file prologue.html)
   (html
    "<blockquote>OCaml was written in 1996 by Xavier Leroy, JÃ©rÃ´me Vouillon, Damien\n      Doligez, and Didier RÃ©my at INRIA in France. It was inspired by a long\n      line of research into ML starting in the 1960s, and continues to have\n      deep links to the academic community.<a name=\"idm181621342720\"></a></blockquote>")))
 (idm181621344944
  ((file prologue.html)
   (html
    "<blockquote>All of this makes OCaml a great choice for programmers who want to\n    step up to a better programming language, and at the same time get\n    practical work done.</blockquote>")))
 (idm181621346736
  ((file prologue.html)
   (html
    "<blockquote>Among this worthy set of languages, OCaml stands apart because it\n    manages to provide a great deal of power while remaining highly pragmatic.\n    The compiler has a straightforward compilation strategy that produces\n    performant code without requiring heavy optimization and without the\n    complexities of dynamic just-in-time (JIT) compilation. This, along with\n    OCaml's strict evaluation model, makes runtime behavior easy to predict.\n    The garbage collector is <span><em>incremental</em></span>, letting you\n    avoid large garbage collection (GC)-related pauses, and\n    <span><em>precise</em></span>, meaning it will collect all unreferenced\n    data (unlike many reference-counting collectors), and the runtime is\n    simple and highly portable.</blockquote>")))
 (idm181621349824
  ((file prologue.html)
   (html
    "<blockquote>Some of you will know and love all of these features, and for others they will be largely\n      new, but most of you will have seen <span><em>some</em></span> of them in other languages that\n      you've used. As we'll demonstrate over the course of this book, there is something\n      transformative about having them all together and able to interact in a single language.\n      Despite their importance, these ideas have made only limited inroads into mainstream\n      languages, and when they do arrive there, like first-class functions in C# or parametric\n      polymorphism in Java, it's typically in a limited and awkward form. The only languages that\n      completely embody these ideas are <span><em>statically typed, functional programming\n        languages</em></span> like OCaml, F#, Haskell, Scala, and Standard ML.<a name=\"idm181621348112\"></a></blockquote>")))
 (idm181621351200
  ((file prologue.html)
   (html
    "<blockquote><span><em>Algebraic data types</em></span> and <span><em>pattern\n        matching</em></span> to define and manipulate complex data structures.\n        Available in Scala and F#.</blockquote>")))
 (idm181621353120
  ((file prologue.html)
   (html
    "<blockquote><span><em>Automatic type inference</em></span> to avoid having to\n        laboriously define the type of every single variable in a program and\n        instead have them inferred based on how a value is used. Available in\n        a limited form in C# with implicitly typed local variables, and in\n        C++11 with its <code>auto</code> keyword.</blockquote>")))
 (idm181621355120
  ((file prologue.html)
   (html
    "<blockquote>Good support for <span><em>immutable programming</em></span>, i.e., programming without\n          making destructive updates to data structures. This is present in traditional functional\n            <span>languages</span> like Scheme, and is also found in\n          distributed, big-data frameworks like Hadoop.</blockquote>")))
 (idm181621356784
  ((file prologue.html)
   (html
    "<blockquote><span><em>Parametric polymorphism</em></span>, which enables the\n        construction of abstractions that work across different data types,\n        similar to generics in Java and C# and templates in <span>C++.</span></blockquote>")))
 (idm181621357920
  ((file prologue.html)
   (html
    "<blockquote><span><em>Static type-checking</em></span> to increase\n        performance and reduce the number of runtime errors, as found in Java\n        and C#.</blockquote>")))
 (idm181621359056
  ((file prologue.html)
   (html
    "<blockquote><span><em>First-class functions</em></span> that can be passed around like ordinary\n          values, as seen in JavaScript, Common Lisp, and C#.</blockquote>")))
 (idm181621360192
  ((file prologue.html)
   (html
    "<blockquote><span><em>Garbage collection</em></span> for automatic memory\n        management, now a feature of almost every modern, high-level\n        language.</blockquote>")))
 (idm181621362848
  ((file prologue.html)
   (html
    "<blockquote>What makes OCaml special is that it occupies a sweet spot in the space of programming\n      language designs. It provides a combination of efficiency, expressiveness and practicality\n      that is matched by no other language. That is in large part because OCaml is an elegant\n      combination of a few key language features that have been developed over the last 40\n        years.<a name=\"idm181621362208\"></a> These include: </blockquote>")))
 (idm181621363776
  ((file prologue.html)
   (html
    "<blockquote>We wrote this book because we believe in the importance of programming languages, and that\n      OCaml in particular is an important language to learn. The three of us have been using OCaml\n      in our academic and professional lives for over 15 years, and in that time we've come to see\n      it as a secret weapon for building complex software systems. This book aims to make this\n      secret weapon available to a wider audience, by providing a clear guide to what you need to\n      know to use OCaml effectively in the real world. </blockquote>")))
 (idm181621364480
  ((file prologue.html)
   (html
    "<blockquote>Programming languages matter. They affect the reliability, security, and efficiency of the\n      code you write, as well as how easy it is to read, refactor, and extend. The languages you\n      know can also change how you think, influencing the way you design software even when you're\n      not using them. </blockquote>")))
 (idm181611989152
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>That wraps up our parsing tutorial. As an aside, notice that the\n    JSON polymorphic variant type that we defined in this chapter is actually\n    structurally compatible with the Yojson representation explained in <a href=\"handling-json-data.html\">ChapterÂ 15, <i>Handling JSON Data</i></a>. That means that you can take this parser\n    and use it with the helper functions in Yojson to build more sophisticated\n    applications.</blockquote>")))
 (idm181611998432
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>With our simple error handling scheme, errors are fatal and cause\n    the program to terminate with a nonzero exit code:</blockquote>")))
 (idm181612009760
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>Now build and run the example using this file, and you can see the\n    full parser in action:</blockquote>")))
 (idm181612012320
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>Here's a test input file we can use to test the code we just\n    wrote:</blockquote>")))
 (idm181612022736
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>The standard lexing library <code>Lexing</code> provides a function <code>from_channel</code> to read the input from a channel.\n    The following function describes the structure, where the <code>Lexing.from_channel</code> function is used to\n    construct a <code>lexbuf</code>, which is passed\n    with the lexing function <code>Lexer.read</code> to\n    the <code>Parser.prog</code> function. <code>Parsing.prog</code> returns <code>None</code> when it reaches end of file. We define a\n    function <code>Json.output_value</code>, not shown\n    here, to print a <code>Json.value</code>:</blockquote>")))
 (idm181612026048
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>The &quot;give up on the first error&quot; approach is easy to implement but\n    isn't very friendly. In general, error handling can be pretty intricate,\n    and we won't discuss it here. However, the Menhir parser defines\n    additional mechanisms you can use to try and recover from errors. These\n    are described in detail in its reference <a href=\"http://gallium.inria.fr/~fpottier/menhir/\" target=\"_top\">manual</a>.<a name=\"idm181612024176\"></a></blockquote>")))
 (idm181612031728
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>Before we start with the lexing, let's first define some functions\n    to handle parsing errors. There are currently two errors: <code>Parser.Error</code> and <code>Lexer.SyntaxError</code>. A simple solution when\n    encountering an error is to print the error and give up:<a name=\"idm181612029952\"></a></blockquote>")))
 (idm181612038000
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>For the final part, we need to compose the lexer and parser. As we saw in the type\n      definition in <code>parser.mli</code>, the parsing function expects a\n      lexer of type <code>Lexing.lexbuf -&gt; token</code>, and a <code>lexbuf</code>:<a name=\"idm181612035600\"></a></blockquote>")))
 (idm181612040400
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>All of these libraries are available via OPAM under their\n        respective names.<a name=\"idm181612040048\"></a></blockquote>")))
 (idm181612044000
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote><a href=\"http://erratique.ch/software/uutf\" target=\"_top\">Uutf</a>\n            is a nonblocking streaming Unicode codec for OCaml, available as a\n            standalone library. It is accompanied by the <a href=\"http://erratique.ch/software/uunf\" target=\"_top\">Uunf</a> text\n            normalization and <a href=\"http://erratique.ch/software/uucd\" target=\"_top\">Uucd</a> Unicode\n            character database libraries. There is also a robust parser for\n            <a href=\"http://erratique.ch/software/jsonm\" target=\"_top\">JSON</a>\n            available that illustrates the use of Uutf in your own\n            libraries.</blockquote>")))
 (idm181612046048
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote><a href=\"http://www.cduce.org/ulex\" target=\"_top\">Ulex</a> is a\n            lexer generator for Unicode that can serve as a Unicode-aware\n            replacement for <span><strong>ocamllex</strong></span>.</blockquote>")))
 (idm181612047536
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote><a href=\"http://camomile.sourceforge.net\" target=\"_top\">Camomile</a> supports\n            the full spectrum of Unicode character types, conversion from\n            around 200 encodings, and collation and locale-sensitive case\n            mappings.</blockquote>")))
 (idm181612048704
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>We've glossed over an important detail here: parsing Unicode\n        characters to handle the full spectrum of the world's writing systems.\n        OCaml has several third-party solutions to handling Unicode, with\n        varying degrees of flexibility and complexity:</blockquote>")))
 (idm181612056112
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>That covers the lexer. Next, we need to combine the lexer with the\n      parser to bring it all together.<a name=\"idm181612055744\"></a><a name=\"idm181612054448\"></a><a name=\"idm181612053536\"></a><a name=\"idm181612052240\"></a><a name=\"idm181612051328\"></a><a name=\"idm181612050416\"></a></blockquote>")))
 (idm181612058128
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>The other cases are for handling the string contents. The action\n      <code>[^ '&quot;' '\\\\']+ { ... }</code> matches normal\n      input that does not contain a double quote or backslash. The actions\n      beginning with a backslash <code>\\</code> define\n      what to do for escape sequences. In each of these cases, the final step\n      includes a recursive call to the lexer.</blockquote>")))
 (idm181612060608
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>This rule takes a <code>buf :\n      Buffer.t</code> as an argument. If we reach the terminating double\n      quote <code>&quot;</code>, then we return the contents\n      of the buffer as a <code>STRING</code>.</blockquote>")))
 (idm181612067632
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>Unlike many other lexer generators, <span><strong>ocamllex</strong></span> allows the definition of multiple\n      lexers in the same file, and the definitions can be recursive. In this\n      case, we use recursion to match string literals using the following rule\n      definition:<a name=\"idm181612066464\"></a><a name=\"idm181612065168\"></a></blockquote>")))
 (idm181612072720
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>If all matches have the same length, then the first action\n          wins. If the input were <code>true:\n          167</code>, then both <code>&quot;true&quot;</code>\n          and <code>id</code> match the first four\n          characters; <code>&quot;true&quot;</code> is first, so\n          the return value is <code>TRUE</code>.</blockquote>")))
 (idm181612076304
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>The longest match always wins. For example, the first input\n          <code>trueX: 167</code> matches the regular\n          expression <code>&quot;true&quot;</code> for four\n          characters, and it matches <code>id</code> for\n          five characters. The longer match wins, and the return value is\n          <code>ID &quot;trueX&quot;</code>.</blockquote>")))
 (idm181612079344
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>Some of these patterns overlap. For example, the regular\n      expression <code>&quot;true&quot;</code> is also matched by\n      the <code>id</code> pattern. <span><strong>ocamllex</strong></span> used the following disambiguation\n      when a prefix of the input is matched by more than one pattern:</blockquote>")))
 (idm181612081216
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>There are actions for each different kind of token. The string\n      expressions like <code>&quot;true&quot; { TRUE }</code> are\n      used for keywords, and the special characters have actions, too, like\n      <code>'{' { LEFT_BRACE }</code>.</blockquote>")))
 (idm181612084576
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>This action specifies that when the input matches the <code>int</code> regular expression, then the lexer should\n      return the expression <code>INT (int_of_string\n      (Lexing.lexeme lexbuf))</code>. The expression <code>Lexing.lexeme lexbuf</code> returns the complete\n      string matched by the regular expression. In this case, the string\n      represents a number, so we use the <code>int_of_string</code> function to convert it to a\n      number.</blockquote>")))
 (idm181612088832
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>The first <code>white { read lexbuf }</code>\n      calls the lexer recursively. That is, it skips the input whitespace and\n      returns the following token. The action <code>newline\n      { next_line lexbuf; read lexbuf }</code> is similar, but we use it to\n      advance the line number for the lexer using the utility function that we\n      defined at the top of the file. Let's skip to the third action:</blockquote>")))
 (idm181612091616
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>The rules are structured very similarly to pattern matches, except\n      that the variants are replaced by regular expressions on the lefthand\n      side. The righthand-side clause is the parsed OCaml return value of that\n      rule. The OCaml code for the rules has a parameter called <code>lexbuf</code> that defines the input, including the\n      position in the input file, as well as the text that was matched by the\n      regular expression.<a name=\"idm181612090288\"></a></blockquote>")))
 (idm181612097216
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>The lexing rules are essentially functions that consume the data,\n      producing OCaml expressions that evaluate to tokens. These OCaml\n      expressions can be quite complicated, using side effects and invoking\n      other rules as part of the body of the rule. Let's look at the <code>read</code> rule for parsing a JSON\n      expression:<a name=\"idm181612095984\"></a></blockquote>")))
 (idm181612100112
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>The <code>newline</code> introduces the\n      <code>|</code> operator, which lets one of several\n      alternative regular expressions match (in this case, the various\n      carriage-return combinations of CR, LF, or CRLF).</blockquote>")))
 (idm181612103216
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>Finally, we define whitespace, newlines, and identifiers:</blockquote>")))
 (idm181612106320
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>Floating-point numbers are specified similarly, but we deal with\n      decimal points and exponents. We make the expression easier to read by\n      building up a sequence of named regular expressions, rather than\n      creating one big and impenetrable expression:</blockquote>")))
 (idm181612111664
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>The syntax here is something of a hybrid between OCaml syntax and\n      traditional regular expression syntax. The <code>int</code> regular expression specifies an optional\n      leading <code>-</code>, followed by a digit from\n      <code>0</code> to <code>9</code>, followed by some number of digits from\n      <code>0</code> to <code>9</code>. The question mark is used to indicate an\n      optional component of a regular expression; the square brackets are used\n      to specify ranges; and the <code>*</code> operator\n      is used to indicate a (possibly empty) repetition.</blockquote>")))
 (idm181612117408
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>The next section of the lexing file is a collection of named\n      regular expressions. These look syntactically like ordinary OCaml\n      <code>let</code> bindings, but really this is a\n      specialized syntax for declaring regular expressions. Here's an\n      example:<a name=\"idm181612116400\"></a><a name=\"idm181612115488\"></a></blockquote>")))
 (idm181612122464
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>We also define a utility function <code>next_line</code> for tracking the location of tokens\n      across line breaks. The <code>Lexing</code> module\n      defines a <code>lexbuf</code> structure that holds\n      the state of the lexer, including the current location within the source\n      file. The <code>next_line</code> function simply\n      accesses the <code>lex_curr_p</code> field that\n      holds the current location and updates its line number.</blockquote>")))
 (idm181612123680
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>This code is there to define utility functions used by later\n      snippets of OCaml code and to set up the environment by opening useful\n      modules and define an exception, <code>SyntaxError</code>.</blockquote>")))
 (idm181612128176
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>Let's walk through the definition of a lexer section by section.\n      The first section is on optional chunk of OCaml code that is bounded by\n      a pair of curly braces:<a name=\"idm181612127744\"></a></blockquote>")))
 (idm181612137280
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>Now we can define a lexer, using <span><strong>ocamllex</strong></span>, to convert our input text into a\n    stream of tokens. The specification of the lexer is placed in a file with\n    an <code>.mll</code> suffix.<a name=\"idm181612135552\"></a><a name=\"idm181612134240\"></a><a name=\"idm181612132944\"></a><a name=\"idm181612132048\"></a><a name=\"PARlex\"></a></blockquote>")))
 (idm181612149216
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>We can invoke <span><strong>menhir</strong></span> by using\n      <span><strong>corebuild</strong></span> with the <code>-use-menhir</code> flag. This tells the build system\n      to switch to using <span><strong>menhir</strong></span> instead of\n      <span><strong>ocamlyacc</strong></span> to handle files with the\n      <code>.mly</code> suffix:<a name=\"idm181612144896\"></a><a name=\"idm181612143760\"></a><a name=\"idm181612142448\"></a></blockquote>")))
 (idm181612153552
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>A version of the JSON grammar using these more succinct Menhir\n      rules follows. Notice the use of <code>separated_list</code> to parse both JSON objects and\n      lists with one rule:</blockquote>")))
 (idm181612155744
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>Assembling lists like this is a pretty common requirement in most\n      realistic grammars, and the preceding rules (while useful for\n      illustrating how parsing works) are rather verbose. Menhir features an\n      extended standard library of built-in rules to simplify this handling.\n      These rules are detailed in the Menhir manual and include optional\n      values, pairs of values with optional separators, and lists of elements\n      (also with optional separators).<a name=\"idm181612155008\"></a></blockquote>")))
 (idm181612158928
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>Alternatively, we could keep the left-recursive definition and\n      simply construct the returned value in left-to-right order. This is even\n      less efficient, since the complexity of building the list incrementally\n      in this way is quadratic in the length of the list:</blockquote>")))
 (idm181612164160
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>The rules are structured as they are because <span><strong>menhir</strong></span> generates left-recursive parsers, which\n      means that the constructed pushdown automaton uses less stack space with\n      left-recursive definitions. The following right-recursive rule accepts\n      the same input, but during parsing, it requires linear stack space to\n      read object field definitions:<a name=\"idm181612162896\"></a></blockquote>")))
 (idm181612171856
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>The rule for <code>object_fields</code>\n      follows, and is really just a thin wrapper that reverses the list\n      returned by the following rule for <code>rev_object_fields</code>. Note that the first\n      production in <code>rev_object_fields</code> has\n      an empty lefthand side, because what we're matching on in this case is\n      an empty sequence of tokens. The comment <code>(*\n      empty *)</code> is used to make this clear:<a name=\"idm181612168624\"></a><a name=\"idm181612167712\"></a></blockquote>")))
 (idm181612174896
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>In each of the productions, the OCaml code in curly braces shows\n      what to transform the object in question to. Note that we still have two\n      nonterminals whose definitions we depend on here but have not yet\n      defined: <code>object_fields</code> and <code>array_values</code>. We'll look at how these are\n      parsed next.</blockquote>")))
 (idm181612175584
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>A string, integer, float, bool, or null value</blockquote>")))
 (idm181612176400
  ((file parsing-with-ocamllex-and-menhir.html)
   (html "<blockquote>An array bracketed by square braces</blockquote>")))
 (idm181612177216
  ((file parsing-with-ocamllex-and-menhir.html)
   (html "<blockquote>An object bracketed by curly braces</blockquote>")))
 (idm181612180352
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>According to these rules, a JSON <code>value</code> is either:<a name=\"idm181612179392\"></a></blockquote>")))
 (idm181612184112
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>Now let's consider a more complex example, the rule for the <code>value</code> symbol:</blockquote>")))
 (idm181612190608
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>We have two cases for <code>prog</code>: either there's an <code>EOF</code>, which means the text is empty, and so there's no JSON value\n        to read, we return the OCaml value <code>None</code>; or we have an\n        instance of the <code>value</code> nonterminal, which corresponds to a\n        well-formed JSON value, and we wrap the corresponding <code>Json.value</code> in a <code>Some</code> tag. Note that in the\n          <code>value</code> case, we wrote <code>v =\n          value</code> to bind the OCaml value that corresponds to the variable <code>v</code>, which we can then use within the curly braces for that\n        production.</blockquote>")))
 (idm181612194064
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>The syntax for this is reminiscent of an OCaml <code>match</code> statement. The\n        pipes separate the individual productions, and the curly braces contain a <span><em>semantic\n          action</em></span>: OCaml code that generates the OCaml value corresponding to the\n        production in question. Semantic actions are arbitrary OCaml expressions that are evaluated\n        during parsing to produce values that are attached to the non-terminal in the\n          rule.<a name=\"idm181612192560\"></a><a name=\"idm181612191648\"></a></blockquote>")))
 (idm181612198688
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>Once that's in place, we can start specifying the productions. In <span><strong>menhir</strong></span>, productions are organized into\n          <span><em>rules</em></span>, where each rule lists all the possible productions for a given\n        nonterminal symbols. Here, for example, is the rule for <code>prog</code>:</blockquote>")))
 (idm181612204320
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>We'll start describing the JSON grammar by declaring the start\n      symbol to be the non-terminal symbol <code>prog</code>, and by declaring that when parsed, a\n      <code>prog</code> value should be converted into\n      an OCaml value of type <code>Json.value\n      option</code>. We then end the declaration section of the parser with\n      a <code>%%</code>:</blockquote>")))
 (idm181612214800
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>The next thing we need to do is to specify the grammar of a JSON expression. <span><strong>menhir</strong></span>, like many parser generators, expresses grammars as\n          <span><em>context-free grammars</em></span>. (More precisely, <span><strong>menhir</strong></span> supports LR(1) grammars, but we will ignore that technical distinction\n        here.) You can think of a context-free grammar as a set of abstract names, called\n          <span><em>non-terminal symbols</em></span>, along with a collection of rules for\n        transforming a nonterminal symbol into a sequence of tokens and nonterminal symbols. A\n        sequence of tokens is parsable by a grammar if you can apply the grammar's rules to produce\n        a series of transformations, starting at a distinguished <span><em>start symbol</em></span>\n        that produces the token sequence in <span>question</span>.<a name=\"idm181612210688\"></a><a name=\"idm181612209392\"></a><a name=\"idm181612208496\"></a><a name=\"idm181612207600\"></a><a name=\"idm181612206688\"></a><a name=\"idm181612205776\"></a></blockquote>")))
 (idm181612223648
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>The <code>&lt;</code><em><code>type</code></em><code>&gt;</code> specifications mean that a token carries a\n    value. The <code>INT</code> token carries an integer\n    value with it, <code>FLOAT</code> has a <code>float</code> value, and <code>STRING</code> carries a <code>string</code> value. The remaining tokens, such as\n    <code>TRUE</code>, <code>FALSE</code>, or the punctuation, aren't associated\n    with any value, and so we can omit the <code>&lt;</code><em><code>type</code></em><code>&gt;</code> specification.</blockquote>")))
 (idm181612230880
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>We'll start by declaring the list of tokens. A token is declared\n    using the syntax <code>%token\n    &lt;</code><em><code>type</code></em><code>&gt;</code> <em><code>uid</code></em>, where the\n    <em><code>&lt;type&gt;</code></em> is optional and\n    <em><code>uid</code></em> is a capitalized identifier. For JSON, we\n    need tokens for numbers, strings, identifiers, and punctuation:<a name=\"idm181612227744\"></a></blockquote>")))
 (idm181612235824
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>A parser-specification file has suffix <code>.mly</code> and\n      contains two sections that are broken up by separator lines consisting of the characters\n        <code>%%</code> on a line by themselves. The first section of the file\n      is for declarations, including token and type specifications, precedence directives, and other\n      output directives; and the second section is for specifying the grammar of the language to be\n        parsed.<a name=\"idm181612233856\"></a><a name=\"PARSparsdef\"></a></blockquote>")))
 (idm181612240048
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>This representation is much richer than our token stream, capturing the fact that JSON\n      values can be nested inside each other and that JSON has a variety of value types, including\n      numbers, strings, arrays, and objects. The parser we'll write will convert a token stream into\n      a value of this AST type, as shown below for our earlier JSON example:</blockquote>")))
 (idm181612243584
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>This kind of representation is easier to work with than the original\n    text, since it gets rid of some unimportant syntactic details and adds\n    useful structure. But it's still a good deal more low-level than the\n    simple AST we used for representing JSON data in <a href=\"handling-json-data.html\">ChapterÂ 15, <i>Handling JSON Data</i></a>:</blockquote>")))
 (idm181612246352
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>If we converted the preceding example into a list of these tokens,\n    it would look something like this:</blockquote>")))
 (idm181612247024
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>Note that this representation loses some information about the\n    original text. For example, whitespace is not represented. It's common,\n    and indeed useful, for the token stream to forget some details of the\n    original text that are not required for understanding its meaning.</blockquote>")))
 (idm181612250112
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>At a syntactic level, we can think of a JSON file as a series of\n    simple logical units, like curly braces, square brackets, commas, colons,\n    identifiers, numbers, and quoted strings. Thus, we could represent our\n    JSON text as a sequence of tokens of the following type:</blockquote>")))
 (idm181612253728
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>Let's consider lexing and parsing in the context of the JSON format. Here's a snippet of\n      text that represents a JSON object containing a string labeled <code>title</code> and an array containing two objects, each with a name and array of zip\n      codes:</blockquote>")))
 (idm181612254432
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>It's confusing that the term parsing is applied to both the overall\n    process of converting textual data to structured data, and also more\n    specifically to the second phase of converting a stream of tokens to an\n    AST; so from here on out, we'll use the term parsing to refer only to this\n    second phase.</blockquote>")))
 (idm181612257856
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>Parsing is traditionally broken down into two parts:\n    <span><em>lexical analysis</em></span>, which is a kind of simplified\n    parsing phase that converts a stream of characters into a stream of\n    logical tokens; and full-on parsing, which involves converting a stream of\n    tokens into the final representation, which is often in the form of a\n    tree-like data structure called an <span><em>abstract syntax\n    tree</em></span>, or AST.<a name=\"idm181612256384\"></a><a name=\"idm181612255472\"></a></blockquote>")))
 (idm181612260048
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>Menhir isn't distributed directly with OCaml but is available\n    through OPAM by running <code>opam install\n    menhir</code>.</blockquote>")))
 (idm181612261376
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>The biggest advantage of Menhir is that its error messages are\n    generally more human-comprehensible, and the parsers that it generates are\n    fully reentrant and can be parameterized in OCaml modules more easily. We\n    recommend that any new code you develop should use Menhir instead of\n    <span><strong>ocamlyacc</strong></span>.</blockquote>")))
 (idm181612263376
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>Menhir is an alternative parser generator that is generally superior\n    to the venerable <span><strong>ocamlyacc</strong></span>, which dates\n    back quite a few years. Menhir is mostly compatible with <span><strong>ocamlyacc</strong></span> grammars, and so you can usually just\n    switch to Menhir and expect older code to work (with some minor\n    differences described in the Menhir manual).</blockquote>")))
 (idm181612267104
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>Parsing is a broad and often intricate topic, and our purpose here is\n  not to teach all of the theoretical issues, but to provide a pragmatic\n  introduction of how to build a parser in OCaml.<a name=\"idm181612266640\"></a><a name=\"idm181612265728\"></a></blockquote>")))
 (idm181612272912
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>Parser generators have a long history, including tools like <span><strong>lex</strong></span> and <span><strong>yacc</strong></span> that date back to the early 1970s.\n    OCaml has its own alternatives, including <span><strong>ocamllex</strong></span>, which\n    replaces <span><strong>lex</strong></span>, and <span><strong>ocamlyacc</strong></span> and <span><strong>menhir</strong></span>, which replace <span><strong>yacc</strong></span>. We'll explore these tools in the course of walking through the\n    implementation of a parser for the JSON serialization format that we discussed in <a href=\"handling-json-data.html\">ChapterÂ 15, <i>Handling JSON Data</i></a>.</blockquote>")))
 (idm181612275216
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>Often, you can find an existing parsing library that handles these issues for you. But there\n    are tools to simplify the task when you do need to write a parser, in the form of\n      <span><em>parser generators</em></span>. A parser generator creates a parser from a\n    specification of the data format that you want to parse, and uses that to generate a\n      parser.<a name=\"idm181612274352\"></a></blockquote>")))
 (idm181612275952
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>But this simplistic approach tends to fall down when parsing more\n  complicated data, particularly data with the kind of recursive structure you\n  find in full-blown programming languages or flexible data formats like JSON\n  and XML. Parsing such formats accurately and efficiently while providing\n  useful error messages is a complex task.</blockquote>")))
 (idm181612277152
  ((file parsing-with-ocamllex-and-menhir.html)
   (html
    "<blockquote>Many programming tasks start with the interpretion of some form of\n  structured textual data. <span><em>Parsing</em></span> is the process of\n  converting such data into data structures that are easy to program against.\n  For simple formats, it's often enough to parse the data in an ad hoc way,\n  say, by breaking up the data into lines, and then using regular expressions\n  for breaking those lines down into their component pieces.</blockquote>")))
 (idm181614238224
  ((file objects.html)
   (html
    "<blockquote>This chapter contains significant contributions from Leo\n        White.</blockquote>")))
 (idm181614247648
  ((file objects.html)
   (html
    "<blockquote>In both these cases we must use subtyping:<a name=\"idm181614247392\"></a></blockquote>")))
 (idm181614256160
  ((file objects.html)
   (html
    "<blockquote>Similarly, we cannot use row polymorphism to store different types\n      of object in the same reference:</blockquote>")))
 (idm181614262896
  ((file objects.html)
   (html
    "<blockquote>However, there are some situations where we cannot use row\n      polymorphism. In particular, row polymorphism cannot be used to place\n      different types of object in the same container. For example, lists of\n      heterogeneous elements cannot be created using row polymorphism:</blockquote>")))
 (idm181614270864
  ((file objects.html)
   (html
    "<blockquote>Writing a similar function with a closed type and applying it\n      using subtyping does not preserve the methods of the argument: the\n      returned object is only known to have an <code>area</code> method:</blockquote>")))
 (idm181614277968
  ((file objects.html)
   (html
    "<blockquote>The return type of this function is built from the open object\n      type of its argument, preserving any additional methods that it may\n      have:</blockquote>")))
 (idm181614287264
  ((file objects.html)
   (html
    "<blockquote>There is considerable overlap between subtyping and row\n      polymorphism. Both mechanisms allow you to write functions that can be\n      applied to objects of different types. In these cases, row polymorphism\n      is usually preferred over subtyping because it does not require explicit\n      coercions, and it preserves more type information, allowing functions\n      like the following:<a name=\"idm181614286608\"></a><a name=\"idm181614285328\"></a><a name=\"idm181614284432\"></a></blockquote>")))
 (idm181614289840
  ((file objects.html)
   (html
    "<blockquote>This pattern works, but it has drawbacks. In particular, the\n      recursive type definition should make it clear that this pattern is\n      essentially equivalent to using variants, and that objects do not\n      provide much value here.</blockquote>")))
 (idm181614293280
  ((file objects.html)
   (html
    "<blockquote>Regardless, there is a solution if you find yourself in this\n      situation, which is to augment the classes with variants. You can define\n      a method <code>variant</code> that injects the\n      actual object into a variant type:</blockquote>")))
 (idm181614296944
  ((file objects.html)
   (html
    "<blockquote>In this case, it is much less clear how to augment the <code>Shape</code> class to support this kind of pattern\n      analysis. It is also not obvious that object-oriented programming is\n      well-suited for this situation. Pattern matching seems like a better\n      fit:</blockquote>")))
 (idm181614301504
  ((file objects.html)
   (html
    "<blockquote>However, the situation is not always so obvious. The following\n      code checks whether an array of shapes looks like a &quot;barbell,&quot; composed\n      of two <code>Circle</code> objects separated by a\n      <code>Line</code>, where the circles have the same\n      radius:</blockquote>")))
 (idm181614303456
  ((file objects.html)
   (html
    "<blockquote>Most programmers would consider this code to be &quot;wrong.&quot; Instead\n      of performing a case analysis on the type of object, it would be better\n      to define a method to return the name of the shape. Instead of calling\n      <code>GetShapeName(s)</code>, we should call\n      <code>s.Name()</code> instead.</blockquote>")))
 (idm181614306512
  ((file objects.html)
   (html
    "<blockquote>More pragmatically, narrowing leads to poor object-oriented style.\n      Consider the following Java code, which returns the name of a shape\n      object:</blockquote>")))
 (idm181614309248
  ((file objects.html)
   (html
    "<blockquote>The design argument is this: narrowing violates abstraction. In\n      fact, with a structural typing system like in OCaml, narrowing would\n      essentially provide the ability to enumerate the methods in an object.\n      To check whether an object <code>obj</code> has\n      some method <code>foo : int</code>, one would\n      attempt a coercion <code>(obj :&gt; &lt; foo : int\n      &gt;)</code>.</blockquote>")))
 (idm181614309808
  ((file objects.html)
   (html
    "<blockquote>Why? There are two reasonable explanations, one based on a design\n      principle, and another technical (the technical reason is simple: it is\n      hard to implement).</blockquote>")))
 (idm181614310640
  ((file objects.html)
   (html
    "<blockquote>Narrowing is <span><em>not permitted</em></span> in OCaml.\n      Period.</blockquote>")))
 (idm181614320944
  ((file objects.html)
   (html
    "<blockquote>Narrowing, also called <span><em>down casting</em></span>, is the\n      ability to coerce an object to one of its subtypes. For example, if we\n      have a list of shapes <code>shape list</code>, we\n      might know (for some reason) what the actual type of each shape is.\n      Perhaps we know that all objects in the list have type <code>square</code>. In this case,\n      <span><em>narrowing</em></span> would allow the recasting of the object\n      from type <code>shape</code> to type <code>square</code>. Many languages support narrowing\n      through dynamic type checking. For example, in Java, a coercion <code>(Square) x</code> is allowed if the value <code>x</code> has type <code>Square</code> or one of its subtypes; otherwise the\n      coercion throws an exception.<a name=\"idm181614314768\"></a><a name=\"idm181614313856\"></a><a name=\"idm181614312960\"></a><a name=\"idm181614312064\"></a></blockquote>")))
 (idm181614327136
  ((file objects.html)
   (html
    "<blockquote>Aspects of this section may seem fairly complicated, but it should\n      be pointed out that this typing <span><em>works</em></span>, and in the\n      end, the type annotations are fairly minor. In most typed\n      object-oriented languages, these coercions would simply not be possible.\n      For example, in C++, a STL type <code>list&lt;T&gt;</code> is invariant in <code>T</code>, so it is simply not possible to use\n      <code>list&lt;square&gt;</code> where <code>list&lt;shape&gt;</code> is expected (at least\n      safely). The situation is similar in Java, although Java has an escape\n      hatch that allows the program to fall back to dynamic typing. The\n      situation in OCaml is much better: it works, it is statically checked,\n      and the annotations are pretty simple.<a name=\"idm181614323264\"></a><a name=\"idm181614322688\"></a></blockquote>")))
 (idm181614344560
  ((file objects.html)
   (html
    "<blockquote>Still, the <code>total_area</code> function\n      should be fine, in principle. It doesn't call <code>push</code>, so it isn't making that error. To make\n      it work, we need to use a more precise type that indicates we are not\n      going to be using the <code>set</code> method. We define a type\n      <code>readonly_stack</code> and confirm that we\n      can coerce the list of <code>stack</code>s to it:</blockquote>")))
 (idm181614348256
  ((file objects.html)
   (html
    "<blockquote>Another way of looking at this is that <code>&lt; push: 'a -&gt;\n          unit; .. &gt;</code> is contravariant in <code>'a</code>, so\n          <code>&lt; push: square -&gt; unit; pop: square option &gt;</code>\n        cannot be a subtype of <span><code>&lt; push:\n            shape -&gt; unit; pop: shape option &gt;</code></span>.</blockquote>")))
 (idm181614355264
  ((file objects.html)
   (html
    "<blockquote>As you can see, <code>square stack</code>\n      and <code>circle stack</code> are not subtypes of\n      <code>shape stack</code>. The problem is with the\n      <code>push</code> method. For <code>shape stack</code>, the <code>push</code> method takes an arbitrary <code>shape</code>. So if we could coerce a <code>square stack</code> to a <code>shape stack</code>, then it would be possible to push\n      an arbitrary shape onto <code>square stack</code>,\n      which would be an error.</blockquote>")))
 (idm181614363664
  ((file objects.html)
   (html
    "<blockquote>However, when we try to apply this function to our objects, we get\n      an error:</blockquote>")))
 (idm181614374176
  ((file objects.html)
   (html
    "<blockquote>If we wanted to write a function that took a list of such stacks\n      and found the total area of their shapes, we might try:</blockquote>")))
 (idm181614378224
  ((file objects.html)
   (html
    "<blockquote>For a more concrete example of variance, let's create some stacks\n      containing shapes by applying our <code>stack</code> function to some squares and some\n      circles:</blockquote>")))
 (idm181614392352
  ((file objects.html)
   (html
    "<blockquote>We can fix this by adding <span><em>variance\n        annotations</em></span> to the type's parameters in the signature:\n        <code>+</code> for covariance or <code>-</code> for contravariance:</blockquote>")))
 (idm181614409456
  ((file objects.html)
   (html
    "<blockquote>However, if the definition is hidden by a signature, then OCaml\n        is forced to assume that the type is invariant:</blockquote>")))
 (idm181614423024
  ((file objects.html)
   (html
    "<blockquote>OCaml works out the variance of a type using that type's\n        definition:</blockquote>")))
 (idm181614426800
  ((file objects.html)
   (html
    "<blockquote>We say that <code>'a -&gt; string</code> is\n      <span><em>contravariant</em></span> in <code>'a</code>. In general, function types are\n      contravariant in their arguments and covariant in their\n      results.<a name=\"idm181614424720\"></a></blockquote>")))
 (idm181614439072
  ((file objects.html)
   (html
    "<blockquote>Subtyping function types requires a third class of variance. A\n      function with type <code>square -&gt;\n      string</code> cannot be used with type <code>shape\n      -&gt; string</code> because it expects its argument to be a <code>square</code> and would not know what to do with a\n      <code>circle</code>. However, a function with type\n      <code>shape -&gt; string</code>\n<span><em>can</em></span> safely be used with type <code>square -&gt; string</code>:</blockquote>")))
 (idm181614444032
  ((file objects.html)
   (html
    "<blockquote>We say that <code>'a list</code> is\n      <span><em>covariant</em></span> (in <code>'a</code>), while <code>'a\n      array</code> is <span><em>invariant</em></span>.<a name=\"idm181614440992\"></a><a name=\"idm181614440096\"></a></blockquote>")))
 (idm181614454672
  ((file objects.html)
   (html
    "<blockquote>Note that this relies on lists being immutable. It would not be\n      safe to treat a <code>square array</code> as a\n      <code>shape array</code> because it would allow\n      you to store nonsquare shapes into what should be an array of squares.\n      OCaml recognizes this and does not allow the coercion:</blockquote>")))
 (idm181614466368
  ((file objects.html)
   (html
    "<blockquote>What about types built from object types? If a <code>square</code> is a <code>shape</code>, we expect a <code>square list</code> to be a <code>shape list</code>. OCaml does indeed allow such\n      coercions:<a name=\"var\"></a><a name=\"SUBvar\"></a></blockquote>")))
 (idm181614479088
  ((file objects.html)
   (html
    "<blockquote>Subtyping can also be used to coerce a polymorphic variant into\n        a larger polymorphic variant type. A polymorphic variant type\n        <span><em>A</em></span> is a subtype of <span><em>B</em></span>, if the\n        tags of <span><em>A</em></span> are a subset of the tags of\n        <span><em>B</em></span>:</blockquote>")))
 (idm181614489136
  ((file objects.html)
   (html
    "<blockquote>Both these objects have a <code>shape</code>\n      method whose type is a subtype of the <code>shape</code> type, so they can both be coerced into\n      the object type <code>&lt; shape : shape\n      &gt;</code>:</blockquote>")))
 (idm181614499392
  ((file objects.html)
   (html
    "<blockquote>For example, we can create two objects with a <code>shape</code> method:</blockquote>")))
 (idm181614505200
  ((file objects.html)
   (html
    "<blockquote>We can also use <span><em>depth</em></span> subtyping with objects.\n      Depth subtyping allows us coerce an object if its individual methods\n      could safely be coerced. So an object type <code>&lt;\n      m: t1 &gt;</code> is a subtype of <code>&lt; m: t2\n      &gt;</code> if <code>t1</code> is a subtype of\n      <code>t2</code>.<a name=\"idm181614501712\"></a><a name=\"idm181614500816\"></a></blockquote>")))
 (idm181614511440
  ((file objects.html)
   (html
    "<blockquote>This form of object subtyping is called <span><em>width</em></span>\n      subtyping. Width subtyping means that an object type\n      <span><em>A</em></span> is a subtype of <span><em>B</em></span>, if\n      <span><em>A</em></span> has all of the methods of <span><em>B</em></span>,\n      and possibly more. A <code>square</code> is a\n      subtype of <code>shape</code> because it\n      implements all of the methods of <code>shape</code> (the <code>area</code> method).</blockquote>")))
 (idm181614524240
  ((file objects.html)
   (html
    "<blockquote>A <code>square</code> has a method <code>area</code> just like a <code>shape</code>, and an additional method <code>width</code>. Still, we expect a <code>square</code> to be a <code>shape</code>, and it is. The coercion <code>:&gt;</code> must be explicit:</blockquote>")))
 (idm181614532720
  ((file objects.html)
   (html
    "<blockquote>To explore this, let's define some simple object types for\n      geometric shapes. The generic type <code>shape</code> has a method to compute the area, and\n      <code>square</code> and <code>circle</code> are specific kinds of shapes:<a name=\"idm181614530336\"></a><a name=\"idm181614529424\"></a><a name=\"idm181614528528\"></a></blockquote>")))
 (idm181614541168
  ((file objects.html)
   (html
    "<blockquote>Subtyping is a central concept in object-oriented programming. It\n    governs when an object with one type <span><em>A</em></span> can be used in\n    an expression that expects an object of another type\n    <span><em>B</em></span>. When this is true, we say that\n    <span><em>A</em></span> is a <span><em>subtype</em></span> of\n    <span><em>B</em></span>. More concretely, subtyping restricts when the\n    coercion operator <code>e :&gt; t</code> can be\n    applied. This coercion works only if the type of <code>e</code> is a subtype of <code>t</code>.<a name=\"idm181614536576\"></a><a name=\"OBsub\"></a></blockquote>")))
 (idm181614543152
  ((file objects.html)
   (html
    "<blockquote>We'll introduce you to classes, and examples using open recursion,\n    in <a href=\"classes.html\">ChapterÂ 12, <i>Classes</i></a>.</blockquote>")))
 (idm181614552480
  ((file objects.html)
   (html
    "<blockquote>In general, a rule of thumb is: use classes and objects in\n    situations where open recursion is a big win. Two good examples are Xavier\n    Leroy's <a href=\"http://gallium.inria.fr/~xleroy/software.html#cryptokit\" target=\"_top\">Cryptokit</a>,\n    which provides a variety of cryptographic primitives that can be combined\n    in building-block style; and the <a href=\"http://cristal.inria.fr/camlimages/\" target=\"_top\">Camlimages</a> library,\n    which manipulates various graphical file formats. Camlimages also provides\n    a module-based version of the same library, letting you choose between\n    functional and object-oriented styles depending on your problem\n    domain.<a name=\"idm181614550320\"></a><a name=\"idm181614549408\"></a><a name=\"idm181614548496\"></a><a name=\"idm181614547200\"></a><a name=\"idm181614545904\"></a><a name=\"idm181614544592\"></a></blockquote>")))
 (idm181614553136
  ((file objects.html)
   (html
    "<blockquote>In contrast, modules use early binding. If you want to parameterize\n    your module code so that some part of it can be implemented later, you\n    would write a function or functor. This is more explicit, but often more\n    verbose than overriding a method in a class.</blockquote>")))
 (idm181614558800
  ((file objects.html)
   (html
    "<blockquote>The real benefits of objects come from the class system. Classes\n    support inheritance and open recursion. Open recursion allows\n    interdependent parts of an object to be defined separately. This works\n    because calls between the methods of an object are determined when the\n    object is instantiated, a form of <span><em>late</em></span> binding. This\n    makes it possible (and necessary) for one method to refer to other methods\n    in the object without knowing statically how they will be\n    implemented.<a name=\"idm181614557648\"></a><a name=\"idm181614556752\"></a><a name=\"idm181614555456\"></a><a name=\"idm181614554560\"></a></blockquote>")))
 (idm181614559456
  ((file objects.html)
   (html
    "<blockquote>Objects have some advantages over records: they don't require type\n    definitions, and their support for row polymorphism makes them more\n    flexible. However, the heavy syntax and additional runtime cost means that\n    objects are rarely used in place of records.</blockquote>")))
 (idm181614563136
  ((file objects.html)
   (html
    "<blockquote>You might wonder when to use objects in OCaml, which has a multitude\n    of alternative mechanisms to express the similar concepts. First-class\n    modules are more expressive (a module can include types, while classes and\n    objects cannot). Modules, functors, and data types also offer a wide range\n    of ways to express program structure. In fact, many seasoned OCaml\n    programmers rarely use classes and objects, if at all.<a name=\"idm181614562448\"></a><a name=\"idm181614560896\"></a></blockquote>")))
 (idm181614566144
  ((file objects.html)
   (html
    "<blockquote>There are some restrictions on the use of the expression <code>{&lt;\n        ... &gt;}</code>. It can be used only within a method body, and only the values of fields\n      may be updated. Method implementations are fixed at the time the object is created; they\n      cannot be changed <span>dynamically</span>.</blockquote>")))
 (idm181614581648
  ((file objects.html)
   (html
    "<blockquote>The key parts of this implementation are in the <code>pop</code> and <code>push</code>\n    methods. The expression <code>{&lt; ... &gt;}</code>\n    produces a copy of the current object, with the same type, and the\n    specified fields updated. In other words, the <code>push hd</code> method produces a copy of the object,\n    with <code>v</code> replaced by <code>hd :: v</code>. The original object is not\n    modified:</blockquote>")))
 (idm181614593200
  ((file objects.html)
   (html
    "<blockquote>Indeed, in many programs this makes sense, but it is by no means\n    required. Let's define a function that creates immutable stack\n    objects:</blockquote>")))
 (idm181614595120
  ((file objects.html)
   (html
    "<blockquote>Many people consider object-oriented programming to be intrinsically\n    imperative, where an object is like a state machine. Sending a message to\n    an object causes it to change state, possibly sending messages to other\n    objects.<a name=\"idm181614594624\"></a></blockquote>")))
 (idm181614610864
  ((file objects.html)
   (html
    "<blockquote>An object of type <code>&lt; pop : int option; ..\n    &gt;</code> can be any object with a method <code>pop : int option</code>; it doesn't matter how it is\n    implemented. When the method <code>#pop</code> is\n    invoked, the actual method that is run is determined by the object:</blockquote>")))
 (idm181614612096
  ((file objects.html)
   (html
    "<blockquote>This kind of typing scheme using row variables is called\n      <span><em>row polymorphism</em></span>. Row polymorphism is also used in\n      polymorphic variant types, and there is a close relationship between\n      objects and polymorphic variants: objects are to records what\n      polymorphic variants are to ordinary variants.</blockquote>")))
 (idm181614613568
  ((file objects.html)
   (html
    "<blockquote>This is because <code>..</code> is really a\n      special kind of type variable called a <span><em>row\n      variable</em></span>.</blockquote>")))
 (idm181614624240
  ((file objects.html)
   (html
    "<blockquote>The <code>..</code> in an open object type\n      is an elision, standing for &quot;possibly more methods.&quot; It may not be\n      apparent from the syntax, but an elided object type is actually\n      polymorphic. For example, if we try to write a type definition, we get\n      an &quot;unbound type variable&quot; error:<a name=\"idm181614623056\"></a><a name=\"idm181614621744\"></a><a name=\"idm181614620832\"></a><a name=\"idm181614619936\"></a></blockquote>")))
 (idm181614637648
  ((file objects.html)
   (html
    "<blockquote>We can manually <span><em>close</em></span> an object type using a\n    type annotation:</blockquote>")))
 (idm181614641616
  ((file objects.html)
   (html
    "<blockquote>The <code>..</code> in the inferred object\n    types are ellipses, standing for other unspecified methods that the object\n    may have. The type <code>&lt; width : float; ..\n    &gt;</code> specifies an object that must have at least a <code>width</code> method, and possibly some others as well.\n    Such object types are said to be <span><em>open</em></span>.<a name=\"idm181614638688\"></a></blockquote>")))
 (idm181614649408
  ((file objects.html)
   (html
    "<blockquote>The type system will complain if it sees incompatible uses of the\n    same method:</blockquote>")))
 (idm181614649904
  ((file objects.html)
   (html
    "<blockquote>As you can see, object types are inferred automatically from the\n    methods that are invoked on them.</blockquote>")))
 (idm181614661552
  ((file objects.html)
   (html
    "<blockquote>Like polymorphic variants, methods can be used without an explicit\n    type declaration:<a name=\"idm181614661200\"></a><a name=\"idm181614659904\"></a></blockquote>")))
 (idm181614666448
  ((file objects.html)
   (html
    "<blockquote>Note that the types of the function <code>stack</code> and the returned object now use the\n    polymorphic type <code>'a</code>. When <code>stack</code> is invoked on a concrete value <code>[3; 2; 1]</code>, we get the same object type as\n    before, with type <code>int</code> for the values on\n    the stack.</blockquote>")))
 (idm181614682256
  ((file objects.html)
   (html
    "<blockquote>Objects can also be constructed by functions. If we want to specify\n    the initial value of the object, we can define a function that takes the\n    value and returns an object:</blockquote>")))
 (idm181614683680
  ((file objects.html)
   (html
    "<blockquote>Note that unlike functions, methods can have zero parameters, since the method call is\n      routed to a concrete object instance. That's why the <code>pop</code> method doesn't\n      have a <code>unit</code> argument, as the equivalent functional version would. </blockquote>")))
 (idm181614693696
  ((file objects.html)
   (html
    "<blockquote>The object type is enclosed in angle brackets <code>&lt; ... &gt;</code>, containing just the types of the\n    methods. Fields, like <code>v</code>, are not part\n    of the public interface of an object. All interaction with an object is\n    through its methods. The syntax for a method invocation uses the <code>#</code> character:</blockquote>")))
 (idm181614697360
  ((file objects.html)
   (html
    "<blockquote>The object has an integer list value <code>v</code>, a method <code>pop</code> that returns the head of <code>v</code>, and a method <code>push</code> that adds an integer to the head of\n    <code>v</code>.</blockquote>")))
 (idm181614709968
  ((file objects.html)
   (html
    "<blockquote>OCaml is entirely different. Classes are used to construct objects\n    and support inheritance, but classes are not types. Instead, objects have\n    <span><em>object types</em></span>, and if you want to use objects, you\n    aren't required to use classes at all. Here's an example of a simple\n    object:</blockquote>")))
 (idm181614714416
  ((file objects.html)
   (html
    "<blockquote>If you already know about object-oriented programming in a language\n    like Java or <span>C++,</span> the OCaml object\n    system may come as a surprise. Foremost is the complete separation of\n    objects and their types from the class system. In a language like Java, a\n    class name is also used as the type of objects created by instantiating\n    it, and the relationships between these object types correspond to\n    inheritance. For example, if we implement a class <code>Deque</code> in Java by inheriting from a class\n    <code>Stack</code>, we would be allowed to pass a\n    deque anywhere a stack is expected.<a name=\"idm181614711632\"></a></blockquote>")))
 (idm181614716016
  ((file objects.html)
   (html
    "<blockquote>Almost every notable modern programming language has been influenced\n    by OOP, and you'll have run across these terms if you've ever used C++,\n    Java, C#, Ruby, Python, or JavaScript.</blockquote>")))
 (idm181614718432
  ((file objects.html)
   (html
    "<blockquote>An object's methods can invoke another method in the same\n          object using a special variable (often called <code>self</code> or <code>this</code>). When objects are created from\n          classes, these calls use dynamic lookup, allowing a method defined\n          in one class to invoke methods defined in another class that\n          inherits from the first.</blockquote>")))
 (idm181614720176
  ((file objects.html)
   (html
    "<blockquote>The definition of one kind of object can be reused to produce\n          a new kind of object. This new definition can override some\n          behavior, but also share code with its parent.</blockquote>")))
 (idm181614724400
  ((file objects.html)
   (html
    "<blockquote>If an object <code>a</code> has all the\n          functionality of an object <code>b</code>,\n          then we may use <code>a</code> in any context\n          where <code>b</code> is expected.</blockquote>")))
 (idm181614726224
  ((file objects.html)
   (html
    "<blockquote>When a message is sent to an object, the method to be executed\n          is determined by the implementation of the object, not by some\n          static property of the program. In other words, different objects\n          may react to the same message in different ways.</blockquote>")))
 (idm181614727936
  ((file objects.html)
   (html
    "<blockquote>The details of the implementation are hidden in the object,\n          and the external interface is just the set of publicly accessible\n          methods.</blockquote>")))
 (idm181614729584
  ((file objects.html)
   (html
    "<blockquote>There are five fundamental properties that differentiate OOP from\n    other styles:</blockquote>")))
 (idm181614732112
  ((file objects.html)
   (html
    "<blockquote>Object-oriented programming (often shorted to OOP) is a programming\n    style that encapsulates computation and data within logical\n    <span><em>objects</em></span>. Each object contains some data stored in\n    <span><em>fields</em></span> and has <span><em>method</em></span> functions\n    that can be invoked against the data within the object (also called\n    &quot;sending a message&quot; to the object). The code definition behind an object\n    is called a <span><em>class</em></span>, and objects are constructed from a\n    class definition by calling a constructor with the data that the object\n    will use to build itself.</blockquote>")))
 (idm181614737888
  ((file objects.html)
   (html
    "<blockquote>We've already seen several tools that OCaml provides for organizing\n  programs, particularly modules. In addition, OCaml also supports\n  object-oriented programming. There are objects, classes, and their\n  associated types. In this chapter, we'll introduce you to OCaml objects and\n  subtyping. In the next chapter, <a href=\"classes.html\">ChapterÂ 12, <i>Classes</i></a>, we'll introduce\n  you to classes and inheritance.<a name=\"idm181614736752\"></a><a name=\"idm181614735184\"></a><a name=\"idm181614734256\"></a></blockquote>")))
 (idm181609877232
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>The <a href=\"https://bitbucket.org/mmottl/lacaml\" target=\"_top\">OCaml</a> library isn't\n      part of Core but provides the recommended interfaces to the widely used\n      BLAS and LAPACK mathematical Fortran libraries. These allow developers\n      to write high-performance numerical code for applications that require\n      linear algebra. It supports large vectors and matrices, but with static\n      typing safety of OCaml to make it easier to write safe\n      algorithms.<a name=\"idm181609875872\"></a><a name=\"idm181609875264\"></a></blockquote>")))
 (idm181609880816
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>The <code>Bigstring</code> module\n            provides a <code>String</code>-like\n            interface that uses <code>Bigarray</code>\n            internally. The <code>Bigbuffer</code>\n            collects these into extensible string buffers that can operate\n            entirely on external system memory.</blockquote>")))
 (idm181609883776
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>The <code>Iobuf</code> module maps I/O\n            buffers as a one-dimensional array of bytes. It provides a sliding\n            window interface that lets consumer processes read from the buffer\n            while it's being filled by producers. This lets OCaml use I/O\n            buffers that have been externally allocated by the operating\n            system without any extra data copying.</blockquote>")))
 (idm181609885824
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>Bigarray sees a lot of use beyond just scientific computing, and\n      several Core libraries use it for general-purpose I/O:</blockquote>")))
 (idm181609896144
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>A common use of custom blocks is to manage external system memory\n      directly from within OCaml. The Bigarray interface was originally\n      intended to exchange data with Fortran code, and maps a block of system\n      memory as a multidimensional array that can be accessed from OCaml.\n      Bigarray operations work directly on the external memory without\n      requiring it to be copied into the OCaml heap (which is a potentially\n      expensive operation for large arrays).<a name=\"idm181609895392\"></a><a name=\"idm181609894480\"></a><a name=\"idm181609893584\"></a><a name=\"idm181609892672\"></a><a name=\"idm181609891760\"></a><a name=\"idm181609890864\"></a><a name=\"idm181609889952\"></a><a name=\"idm181609889056\"></a><a name=\"idm181609888160\"></a><a name=\"idm181609886848\"></a></blockquote>")))
 (idm181609901424
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>The custom operations specify how the runtime should perform polymorphic comparison,\n      hashing and binary marshaling. They also optionally contain a <span><em>finalizer</em></span>\n      that the runtime calls just before the block is garbage-collected. This finalizer has nothing\n      to do with ordinary OCaml finalizers (as created by <code>Gc.finalize</code> and explained in <a href=\"understanding-the-garbage-collector.html\">ChapterÂ 21, <i>Understanding the Garbage Collector</i></a>). They are instead used to call C cleanup functions such as <code>free</code>.<a name=\"idm181609898544\"></a></blockquote>")))
 (idm181609905216
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>The first word of the data within the custom block is a C pointer to a <code>struct</code> of custom operations. The custom block cannot have pointers\n      to OCaml blocks and is opaque to the GC:</blockquote>")))
 (idm181609910496
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>OCaml supports <span><em>custom</em></span> heap blocks via a <code>Custom_tag</code> that lets the runtime perform user-defined operations over OCaml\n      values. A custom block lives in the OCaml heap like an ordinary block and can be of whatever\n      size the user desires. The <code>Custom_tag</code> (255) is higher than\n        <code>No_scan_tag</code> and so isn't scanned by the GC.<a name=\"idm181609907584\"></a><a name=\"idm181609906672\"></a></blockquote>")))
 (idm181609916240
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>Care should be taken that any C library functions that receive these buffers can also cope\n      with arbitrary bytes within the buffer contents and are not expecting C strings. For instance,\n      the C <code>memcopy</code> or <code>memmove</code>\n      standard library functions can operate on arbitrary data, but <code>strlen</code> or <code>strcpy</code> both require a <code>NULL</code>-terminated buffer, and neither has a mechanism for encoding a\n        <code>NULL</code> value within its contents.</blockquote>")))
 (idm181609918144
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>The guaranteed <code>NULL</code> termination comes in handy when\n      passing a string to C, but is not relied upon to compute the length from OCaml code. OCaml\n      strings can thus contain <code>NULL</code> bytes at any point within the\n      string.</blockquote>")))
 (idm181609922224
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>This string representation is a clever way to ensure that the\n    contents are always zero-terminated by the padding word and to still\n    compute its length efficiently without scanning the whole string. The\n    following formula is used:</blockquote>")))
 (idm181609934112
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>On a 32-bit machine, the padding is calculated based on the modulo of the string length\n      and word size to ensure the result is word-aligned. A 64-bit machine extends the potential\n      padding up to 7 bytes instead of 3 (see <a href=\"memory-representation-of-values.html#chapter_20_table\">TableÂ 20.2, â\128\156String length and paddingâ\128\157</a>).</blockquote>")))
 (idm181609942224
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>Strings are standard OCaml blocks with the header size defining the\n    size of the string in machine words. The <code>String_tag</code> (252) is higher than the <code>No_scan_tag</code>, indicating that the contents of the\n    block are opaque to the collector. The block contents are the contents of\n    the string, with padding bytes to align the block on a word\n    boundary.<a name=\"idm181609940320\"></a><a name=\"idm181609939008\"></a></blockquote>")))
 (idm181609944160
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>The extra space usage is generally not significant in a typical\n    application, and polymorphic variants offer a great deal more flexibility\n    than normal variants. However, if you're writing code that demands high\n    performance or must run within tight memory bounds, the runtime layout is\n    at least very predictable. The OCaml compiler never switches memory\n    representation due to optimization passes. This lets you predict the\n    precise runtime layout by referring to these guidelines and your source\n    code.</blockquote>")))
 (idm181609945168
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>Another inefficiency over normal variants is when a polymorphic variant constructor has\n      more than one parameter. Normal variants hold parameters as a single flat block with multiple\n      fields for each entry, but polymorphic variants must adopt a more flexible uniform memory\n      representation, since they may be reused in a different context across compilation units. They\n      allocate a tuple block for the parameters that is pointed to from the argument field of the\n      variant. There are thus three additional words for such variants, along with an extra memory\n      indirection due to the tuple.</blockquote>")))
 (idm181609946720
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>Polymorphic variants use more memory space than normal variants when parameters are\n      included in the data type constructors. Normal variants use the tag byte to encode the variant\n      value and save the fields for the contents, but this single byte is insufficient to encode the\n      hashed value for polymorphic variants. They must allocate a new block (with tag <code>0</code>) and store the value in there instead. Polymorphic variants with\n      constructors thus use one word of memory more than normal variant constructors.</blockquote>")))
 (idm181609947280
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>The hash function is designed to give the same results on 32-bit and\n    64-bit architectures, so the memory representation is stable across\n    different CPUs and host types.</blockquote>")))
 (idm181609954848
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>A polymorphic variant without any parameters is stored as an unboxed\n    integer and so only takes up one word of memory, just like a normal\n    variant. This integer value is determined by applying a hash function to\n    the <span><em>name</em></span> of the variant. The hash function isn't\n    exposed directly by the compiler, but the <code>type_conv</code> library from Core provides an\n    alternative implementation:</blockquote>")))
 (idm181609958144
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>Polymorphic variants are more flexible than normal variants when\n    writing code but are slightly less efficient at runtime. This is because\n    there isn't as much static compile-time information available to optimize\n    their memory layout.<a name=\"idm181609957632\"></a><a name=\"idm181609956304\"></a></blockquote>")))
 (idm181609959952
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>Due to this encoding, there is a limit around 240 variants with\n    parameters that applies to each type definition, but the only limit on the\n    number of variants without parameters is the size of the native integer\n    (either 31 or 63 bits). This limit arises because of the size of the tag\n    byte, and that some of the high-numbered tags are reserved.</blockquote>")))
 (idm181609961984
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>Some theorem provers such as Coq do output code that uses <code>Obj</code> internally, but the external module signatures never expose it. Unless you\n        too have a machine proof of correctness to accompany your use of <code>Obj</code>, stay away from it except for debugging!</blockquote>")))
 (idm181609963664
  ((file memory-representation-of-values.html)
   (html
    "<blockquote><code>Obj</code> is an undocumented module that exposes the\n        internals of the OCaml compiler and runtime. It is very useful for examining and\n        understanding how your code will behave at runtime but should <span><em>never</em></span> be\n        used for production code unless you understand the implications. The module bypasses the\n        OCaml type system, making memory corruption and segmentation faults possible.</blockquote>")))
 (idm181609971728
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>Lists are stored with a representation that is exactly the same as if the list was written\n      as a variant type with <code>Nil</code> and <code>Cons</code>. The empty list <code>[]</code> is an integer <code>0</code>, and subsequent blocks have tag <code>0</code> and two parameters: a block with the current value, and a pointer to the rest\n      of the list.<a name=\"idm181609967984\"></a><a name=\"idm181609966672\"></a><a name=\"idm181609965360\"></a></blockquote>")))
 (idm181609979616
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>In the preceding example, the <code>Apple</code> and <code>Kiwi</code> values are still stored as normal OCaml integers with values\n        <code>0</code> and <code>1</code>, respectively.\n      The <code>Orange</code> and <code>Pear</code>\n      values both have parameters and are stored as blocks whose tags ascend from <code>0</code> (and so <code>Pear</code> has a tag of\n        <code>1</code>, as the use of <code>Obj.tag</code> verifies). Finally, the parameters are fields that contain OCaml values\n      within the block, and <code>Obj.field</code> can be used to retrieve\n      them.</blockquote>")))
 (idm181609993712
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>Variants that have parameters arguments are a little more complex.\n    They are stored as blocks, with the value <span><em>tags</em></span>\n    ascending from 0 (counting from leftmost variants with parameters). The\n    parameters are stored as words in the block:</blockquote>")))
 (idm181609996736
  ((file memory-representation-of-values.html)
   (html
    "<blockquote><code>Obj.magic</code> unsafely forces a type\n    cast between any two OCaml types; in this example, the <code>int</code> type hint retrieves the runtime integer\n    value. The <code>Obj.is_block</code> confirms that\n    the value isn't a more complex block, but just an OCaml <code>int</code>.</blockquote>")))
 (idm181610011264
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>Basic variant types with no extra parameters for any of their\n    branches are simply stored as an OCaml integer, starting with <code>0</code> for the first option and in ascending\n    order:<a name=\"idm181610010176\"></a><a name=\"idm181610008864\"></a><a name=\"idm181610007552\"></a></blockquote>")))
 (idm181610012960
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>Only records and arrays can have the float array optimization, and\n      for records, every single field must be a float.</blockquote>")))
 (idm181610014016
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>The first thing we tested was that a float array has the correct unboxed float array tag\n        value (254). However, the next line tests a tuple of floating-point values instead, which\n        are <span><em>not</em></span> optimized in the same way and have the normal tuple tag value\n        (0).</blockquote>")))
 (idm181610025328
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>This tells us that float arrays have a tag value of 254. Now let's\n      test some sample values using the <code>Obj.tag</code> function to check that the allocated\n      block has the expected runtime tag, and also use <code>Obj.double_field</code> to retrieve a float from\n      within the block:</blockquote>")))
 (idm181610031520
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>First, let's check that float arrays do in fact have a different\n      tag number from normal floating-point values:</blockquote>")))
 (idm181610037488
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>Since each floating-point value is boxed in a separate memory block, it can be\n        inefficient to handle large arrays of floats in comparison to unboxed integers. OCaml\n        therefore special-cases records or arrays that contain <span><em>only</em></span>\n<code>float</code> types. These are stored in a block that contains\n        the floats packed directly in the data section, with <code>Double_array_tag</code> set to signal to the collector that the contents are not OCaml\n        values.</blockquote>")))
 (idm181610045440
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>Floating-point numbers in OCaml are always stored as full, double-precision values.\n        Individual floating-point values are stored as a block with a single field that contains the\n        number. This block has the <code>Double_tag</code> set, which signals\n        to the collector that the floating-point value is not to be scanned:<a name=\"idm181610044208\"></a></blockquote>")))
 (idm181610048256
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>The <code>Obj.repr</code> function retrieves\n    the runtime representation of any OCaml value. <code>Obj.is_block</code> checks the bottom bit to determine\n    if the value is a block header or an unboxed integer.</blockquote>")))
 (idm181610055040
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>You can check the difference between a block and a direct integer\n    yourself using the <code>Obj</code> module, which\n    exposes the internal representation of values to OCaml code:</blockquote>")))
 (idm181610061264
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>Tuples, records, and arrays are all represented identically at\n    runtime as a block with tag <code>0</code>. Tuples\n    and records have constant sizes determined at compile time, whereas arrays\n    can be of variable length. While arrays are restricted to containing a\n    single type of element in the OCaml type system, this is not required by\n    the memory representation.<a name=\"idm181610060016\"></a><a name=\"idm181610058704\"></a><a name=\"idm181610057392\"></a><a name=\"idm181610056496\"></a></blockquote>")))
 (idm181610067984
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>These basic types such as empty lists and <code>unit</code> are\n        very efficient to use, since integers are never allocated on the heap. They can be passed\n        directly in registers and not appear on the stack if you don't have too many parameters to\n        your functions. Modern architectures such as <code>x86_64</code> have\n        a lot of spare registers to further improve the efficiency of using unboxed integers.</blockquote>")))
 (idm181610075008
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>Many basic types are efficiently stored as unboxed integers at runtime. The native\n          <code>int</code> type is the most obvious, although it drops a\n        single bit of precision due to the tag bit. Other atomic types such as <code>unit</code> and the empty list <code>[]</code>\n        value are stored as constant integers. Boolean values have a value of <code>1</code> and <code>0</code> for <code>true</code> and <code>false</code>,\n          respectively.<a name=\"idm181610069920\"></a><a name=\"idm181610069024\"></a></blockquote>")))
 (idm181610105040
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>The exact representation of values inside a block depends on their static OCaml type. All\n      OCaml types are distilled down into <code>values</code>, and summarized\n      in <a href=\"memory-representation-of-values.html#table20-1_ocaml\">TableÂ 20.1, â\128\156OCaml valuesâ\128\157</a>.<a name=\"idm181610103472\"></a></blockquote>")))
 (idm181610107104
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>A block's tag byte is multipurpose, and indicates whether the data\n    array represents opaque bytes or fields. If a block's tag is greater than\n    or equal to <code>No_scan_tag</code> (251), then the\n    block's data are all opaque bytes, and are not scanned by the collector.\n    The most common such block is the <code>string</code> type, which we describe in more detail\n    later in this chapter.</blockquote>")))
 (idm181610108880
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>The 2-bit <code>color</code> field is used by the GC to keep track\n      of its state during mark-and-sweep collection. We'll come back to this field in <a href=\"understanding-the-garbage-collector.html\">ChapterÂ 21, <i>Understanding the Garbage Collector</i></a>. This tag isn't exposed to OCaml source code\n      in any case.</blockquote>")))
 (idm181610110848
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>The <code>size</code> field records the length\n    of the block in memory words. This is 22 bits on 32-bit platforms, which\n    is the reason OCaml strings are limited to 16 MB on that architecture. If\n    you need bigger strings, either switch to a 64-bit host, or use the\n    <code>Bigarray</code> module.</blockquote>")))
 (idm181610117200
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>The GC never inspects opaque bytes. If the tag indicates an array of OCaml fields are\n      present, their contents are all treated as more valid OCaml values. The GC always inspects fields and follows them as part of the\n      collection process described earlier.<a name=\"idm181610116672\"></a><a name=\"idm181610115344\"></a></blockquote>")))
 (idm181610120112
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>An OCaml <span><em>block</em></span> is the basic unit of allocation\n    on the heap. A block consists of a one-word header (either 32 or 64 bits\n    depending on the CPU architecture) followed by variable-length data that\n    is either opaque bytes or an array of <span><em>fields</em></span>. The\n    header has a multipurpose tag byte that defines whether to interpret the\n    subsequent data as opaque bytes or OCaml fields.<a name=\"idm181610118656\"></a></blockquote>")))
 (idm181610123088
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>An even more alert reader will be wondering about the\n        performance implications are for integer arithmetic using this tagged\n        representation. Since the bottom bit is set, any operation on the\n        integer has to shift the bottom bit right to recover the &quot;native&quot;\n        value. The native code OCaml compiler generates efficient x86 assembly\n        code in this case, taking advantage of modern processor instructions\n        to hide the extra shifts where possible. Addition is a single <code>LEA</code> x86 instruction, subtraction can be two\n        instructions, and multiplication is only a few more.</blockquote>")))
 (idm181610123952
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>Modern CISC processors such as the Intel x86 do support\n        unaligned memory accesses, but the chip still runs faster if accesses\n        are word-aligned. OCaml therefore simply mandates that all pointers be\n        word-aligned, which guarantees that the bottom few bits of any valid\n        pointer will be zero. Setting the bottom bit to a nonzero value is a\n        simple way to mark an integer, at the cost of losing that single bit\n        of precision.</blockquote>")))
 (idm181610125728
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>The alert reader may be wondering how OCaml can guarantee that\n        all of its pointers are word-aligned. In the old days, when RISC chips\n        such as Sparc, MIPS, and Alpha were commonplace, unaligned memory\n        accesses were forbidden by the instruction set architecture and would\n        result in a CPU exception that terminated the program. Thus, all\n        pointers were historically rounded off to the architecture word size\n        (usually 32 or 64 bits).<a name=\"idm181610124992\"></a></blockquote>")))
 (idm181610129440
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>The mechanism for this is simple, since the runtime system keeps\n      track of the heap blocks it has allocated for OCaml values. If the\n      pointer is inside a heap chunk that is marked as being managed by the\n      OCaml runtime, it is assumed to point to an OCaml value. If it points\n      outside the OCaml runtime area, it is treated as an opaque C pointer to\n      some other system resource.<a name=\"idm181610128768\"></a><a name=\"idm181610127856\"></a></blockquote>")))
 (idm181610130080
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>The only problem that remains with this memory representation is distinguishing between\n        pointers to OCaml values (which should be followed by the GC) and pointers into the system\n        heap to C values (which shouldn't be followed).</blockquote>")))
 (idm181610130704
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>A value is treated as a memory pointer if its lowest bit is zero.\n      A pointer value can still be stored unmodified despite this, since\n      pointers are guaranteed to be word-aligned (with the bottom bits always\n      being zero).</blockquote>")))
 (idm181610131408
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>This representation means that integers are unboxed runtime values\n      in OCaml so that they can be stored directly without having to allocate\n      a wrapper block. They can be passed directly to other function calls in\n      registers and are generally the cheapest and fastest values to use in\n      OCaml.</blockquote>")))
 (idm181610134160
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>OCaml values don't all have to be boxed at runtime. Instead,\n      values use a single tag bit per word to distinguish integers and\n      pointers at runtime. The value is an integer if the lowest bit of the\n      block word is nonzero, and a pointer if the lowest bit of the block word\n      is zero. Several OCaml types map onto this integer representation,\n      including <code>bool</code>, <code>int</code>, the empty list, <code>unit</code>, and variants without\n      constructors.</blockquote>")))
 (idm181610139072
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>Wrapping primitives types (such as integers) inside another data structure that records\n        extra metadata about the value is known as <span><em>boxing</em></span>. Values are boxed in\n        order to make it easier for the garbage collector (GC) to do its job, but at the expense of\n        an extra level of indirection to access the data within the boxed value.<a name=\"idm181610138064\"></a><a name=\"idm181610136496\"></a><a name=\"idm181610135584\"></a></blockquote>")))
 (idm181610144880
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>OCaml uses a uniform memory representation in which every OCaml\n    variable is stored as a <span><em>value</em></span>. An OCaml value is a\n    single memory word that is either an immediate integer or a pointer to\n    some other memory. The OCaml runtime tracks all values so that it can free\n    them when they are no longer needed. It thus needs to be able to\n    distinguish between integer and pointer values, since it scans pointers to\n    find further values but doesn't follow integers that don't point to\n    anything meaningful beyond their immediate value.<a name=\"idm181610143664\"></a><a name=\"idm181610142368\"></a><a name=\"idm181610141472\"></a></blockquote>")))
 (idm181610148160
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>The type declaration <code>t</code> doesn't\n    take up any memory at runtime, but the subsequent <code>let</code> binding allocates a new block of memory with\n    two words of available space. One word holds the <code>foo</code> field, and the other word holds the <code>bar</code> field. The OCaml compiler translates such an\n    expression into an explicit allocation for the block from OCaml's runtime\n    system.</blockquote>")))
 (idm181610155584
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>A running OCaml program uses blocks of memory (i.e., contiguous\n    sequences of words in RAM) to represent values such as tuples, records,\n    closures, or arrays. An OCaml program implicitly allocates a block of\n    memory when such a value is created:<a name=\"blck\"></a></blockquote>")))
 (idm181610159440
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>This chapter covers the precise mapping from OCaml types to runtime\n  values and walks you through them via the toplevel. We'll cover how these\n  values are managed by the runtime later on in <a href=\"understanding-the-garbage-collector.html\">ChapterÂ 21, <i>Understanding the Garbage Collector</i></a>.<a name=\"MAPocaml\"></a></blockquote>")))
 (idm181610161088
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>We'll explain this compilation pipeline in more detail in <a href=\"the-compiler-frontend-parsing-and-type-checking.html\">ChapterÂ 22, <i>The Compiler Frontend: Parsing and <span>Type\n    Checking</span></i></a> and <a href=\"the-compiler-backend-byte-code-and-native-code.html\">ChapterÂ 23, <i>The Compiler Backend: Bytecode and Native code</i></a>.</blockquote>")))
 (idm181610165088
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>Since OCaml verifies these properties at compile time, it doesn't\n    need to keep track of as much information at runtime. Thus, later stages\n    of the compiler can discard and simplify the type declarations to a much\n    more minimal subset that's actually required to distinguish polymorphic\n    values at runtime. This is a major performance win versus something like a\n    Java or .NET method call, where the runtime must look up the concrete\n    instance of the object and dispatch the method call. Those languages\n    amortize some of the cost via &quot;Just-in-Time&quot; dynamic patching, but OCaml\n    prefers runtime simplicity instead.<a name=\"idm181610164192\"></a><a name=\"idm181610163040\"></a><a name=\"idm181610162128\"></a></blockquote>")))
 (idm181610171376
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>The OCaml compiler runs through several phases during the compilation process. The first\n      phase is syntax checking, during which source files are parsed into abstract syntax trees\n      (ASTs). The next stage is a <span><em>type checking</em></span> pass over the AST. In a validly\n      typed program, a function cannot be applied with an unexpected type. For example, the <code>print_endline</code> function must receive a single <code>string</code> argument, and an <code>int</code>\n      will result in a type error.<a name=\"idm181610168336\"></a><a name=\"idm181610167440\"></a><a name=\"idm181610166528\"></a></blockquote>")))
 (idm181610174080
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>Luckily, the OCaml toolchain is very predictable. The compiler\n  minimizes the amount of optimization magic that it performs, and relies\n  instead on its straightforward execution model for good performance. With\n  some experience, you can know rather precisely where a block of\n  performance-critical OCaml code is spending its time.<a name=\"idm181610173488\"></a></blockquote>")))
 (idm181610176560
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>However, knowledge of the OCaml internals is useful beyond just\n  writing foreign function interfaces. As you build and maintain more complex\n  OCaml applications, you'll need to interface with various external system\n  tools that operate on compiled OCaml binaries. For example, profiling tools\n  report output based on the runtime memory layout, and debuggers execute\n  binaries without any knowledge of the static OCaml types. To use these tools\n  effectively, you'll need to do some translation between the OCaml and C\n  worlds.<a name=\"idm181610175760\"></a></blockquote>")))
 (idm181610180864
  ((file memory-representation-of-values.html)
   (html
    "<blockquote>The FFI interface we described in <a href=\"foreign-function-interface.html\">ChapterÂ 19, <i>Foreign Function Interface</i></a> hides the precise details of how\n  values are exchanged across C libraries and the OCaml runtime. There is a\n  simple reason for this: using this interface directly is a delicate\n  operation that requires understanding a few different moving parts before\n  you can get it right. You first need to know the mapping between OCaml types\n  and their runtime memory representation. You also need to ensure that your\n  code is interfacing correctly with OCaml runtime's memory\n  management.<a name=\"idm181610179552\"></a><a name=\"VALmemory\"></a></blockquote>")))
 (idm181613256640
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>As you can see, the relative performance of trees and maps depends a\n    great deal on the details of how they're used, and so whether to choose\n    one data structure or the other will depend on the details of the\n    application.<a name=\"idm181613256144\"></a><a name=\"idm181613255232\"></a><a name=\"idm181613254320\"></a><a name=\"idm181613253408\"></a><a name=\"idm181613252496\"></a><a name=\"idm181613251584\"></a></blockquote>")))
 (idm181613257136
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>These numbers can be made more extreme by increasing the size of the\n    tables or the length of the list.</blockquote>")))
 (idm181613266448
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>Unsurprisingly, maps perform far better than hash tables on this\n    benchmark, in this case by more than a factor of 10:</blockquote>")))
 (idm181613271712
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>Here's a benchmark that demonstrates this. In it, we create a list\n    of maps (or hash tables) that are built up by iteratively applying small\n    updates, keeping these copies around. In the map case, this is done by\n    using <code>Map.change</code> to update the map. In\n    the hash table implementation, the updates are done using <code>Hashtbl.change</code>, but we also need to call\n    <code>Hashtbl.copy</code> to take snapshots of the\n    table:</blockquote>")))
 (idm181613273024
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>Hash tables are not always the faster choice, though. In particular,\n    maps are often more performant in situations where you need to keep\n    multiple related versions of the data structure in memory at once. That's\n    because maps are immutable, and so operations like <code>Map.add</code> that modify a map do so by creating a\n    new map, leaving the original undisturbed. Moreover, the new and old maps\n    share most of their physical structure, so multiple versions can be kept\n    around efficiently.</blockquote>")))
 (idm181613273712
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>We can make the speedup smaller or larger depending on the details\n    of the test; for example, it will vary with the number of distinct keys.\n    But overall, for code that is heavy on sequences of querying and updating\n    a set of key/value pairs, hash tables will significantly outperform\n    maps.</blockquote>")))
 (idm181613283040
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>The results show the hash table version to be around four times\n    faster than the map version:</blockquote>")))
 (idm181613288368
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>The best way of answering a performance question is by running a\n    benchmark, so let's do just that. The following benchmark uses the\n    <code>core_bench</code> library, and it compares\n    maps and hash tables under a very simple workload. Here, we're keeping\n    track of a set of 1,000 different integer keys and cycling over the keys\n    and updating the values they contain. Note that we use the <code>Map.change</code> and <code>Hashtbl.change</code> functions to update the\n    respective data structures:</blockquote>")))
 (idm181613289024
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>Programming idioms aside, there are significant performance differences between maps and\n      hash tables. For code that is dominated by updates and lookups, hash tables are a clear\n      performance win, and the win is clearer the larger the amount of data.</blockquote>")))
 (idm181613293216
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>Maps and hash tables overlap enough in functionality that it's not\n    always clear when to choose one or the other. Maps, by virtue of being\n    immutable, are generally the default choice in OCaml. OCaml also has good\n    support for imperative programming, though, and when programming in an\n    imperative idiom, hash tables are often the more natural choice.<a name=\"idm181613292960\"></a><a name=\"idm181613290688\"></a></blockquote>")))
 (idm181613296304
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>There is currently no analogue of <code>comparelib</code> for autogeneration of hash\n      functions, so you do need to either write the hash function by hand, or\n      use the built-in polymorphic hash function, <code>Hashtbl.hash</code>.</blockquote>")))
 (idm181613297024
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>Note that in order to satisfy hashable, one also needs to provide\n      a comparison function. That's because Core's hash tables use an ordered\n      binary tree data structure for the hash-buckets, so that performance of\n      the table degrades gracefully in the case of pathologically bad choice\n      of hash function.</blockquote>")))
 (idm181613308640
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>Most types in Core satisfy the <code>Hashable.S</code> interface, but as with the <code>Comparable.S</code> interface, the question remains\n      of how one should satisfy this interface when writing a new module.\n      Again, the answer is to use a functor to build the necessary\n      functionality; in this case, <code>Hashable.Make</code>. Note that we use OCaml's\n      <code>lxor</code> operator for doing the &quot;logical&quot;\n      (i.e., bitwise) exclusive Or of the hashes from the component\n      values:<a name=\"idm181613305360\"></a><a name=\"idm181613304464\"></a><a name=\"idm181613303168\"></a><a name=\"idm181613302256\"></a></blockquote>")))
 (idm181613310416
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>As you can see, the hash function stops after the first 10\n      elements. The same can happen with any large data structure, including\n      records and arrays. When building hash functions over large custom data\n      structures, it is generally a good idea to write one's own hash\n      function.</blockquote>")))
 (idm181613321824
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>The bound on the traversal means that the hash function may ignore part of the data\n        structure, and this can lead to pathological <span>cases</span>\n        where every value you store has the same hash value. We'll demonstrate this below, using the\n        function <code>List.range</code> to allocate lists of integers of\n        different length:</blockquote>")))
 (idm181613324048
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>OCaml's polymorphic hash function works by walking over the data\n      structure itâ\128\153s given using a breadth-first traversal that is bounded in\n      the number of nodes itâ\128\153s willing to traverse. By default, that bound is\n      set at 10 &quot;meaningful&quot; nodes.<a name=\"idm181613323168\"></a></blockquote>")))
 (idm181613328944
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>Note that, unlike the comparators used with maps and sets, hashables\n    don't show up in the type of a <code>Hashtbl.t</code>. That's because hash tables don't have\n    operations that operate on multiple hash tables that depend on those\n    tables having the same hash function, in the way that <code>Map.symmetric_diff</code> and <code>Set.union</code> depend on their arguments using the\n    same comparison function.<a name=\"idm181613326368\"></a></blockquote>")))
 (idm181613333328
  ((file maps-and-hash-tables.html)
   (html "<blockquote>Or, equivalently:</blockquote>")))
 (idm181613338544
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>There is also a polymorphic <code>hashable</code> value, corresponding to the polymorphic\n    hash function provided by the OCaml runtime, for cases where you don't\n    have a hash function for your specific type:</blockquote>")))
 (idm181613345744
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>The <code>hashable</code> value is included as\n    part of the <code>Hashable.S</code> interface, which\n    is satisfied by most types in Core. The <code>Hashable.S</code> interface also includes a <code>Table</code> submodule which provides more convenient\n    creation functions:</blockquote>")))
 (idm181613354352
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>When creating a hash table, we need to provide a value of type\n    <span><em>hashable</em></span>, which includes among other things the\n    function for hashing the key type. This is analogous to the comparator\n    used for creating maps:</blockquote>")))
 (idm181613357664
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>The logarithmic behavior of Core's hash tables in the presence of hash collisions also\n        helps protect against some denial-of-service attacks. One well-known type of attack is to\n        send queries to a service with carefully chosen keys to cause many collisions. This, in\n        combination with the linear behavior of most hashtables, can cause the service to become\n        unresponsive due to high CPU load. Core's hash tables would be much less susceptible to such\n        an attack because the amount of degradation would be far less.<a name=\"idm181613356848\"></a><a name=\"idm181613355536\"></a></blockquote>")))
 (idm181613358560
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>Another hidden cost of hash tables has to do with the hash function you use. If you end\n        up with a pathologically bad hash function that hashes all of your data to the same number,\n        then all of your insertions will hash to the same underlying bucket, meaning you no longer\n        get constant-time access at all. Core's hash table implementation uses binary trees for the\n        hash-buckets, so this case only leads to logarithmic time, rather than linear for a\n        traditional hash table.</blockquote>")))
 (idm181613359952
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>The statement that hash tables provide constant-time access hides some complexities.\n        First of all, any hash table implementation, OCaml's included, needs to resize the table\n        when it gets too full. A resize requires allocating a new backing array for the hash table\n        and copying over all entries, and so it is quite an expensive operation. That means adding a\n        new element to the table is only <span><em>amortized</em></span> constant, which is to say,\n        it's constant on average over a long sequence of operations, but some of the individual\n        operations can be quite expensive.</blockquote>")))
 (idm181613365216
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>Hash tables differ from maps in a few key ways. First, hash tables\n    are mutable, meaning that adding a key/value pair to a hash table modifies\n    the table, rather than creating a new table with the binding added.\n    Second, hash tables generally have better time-complexity than maps,\n    providing constant-time lookup and modifications, as opposed to\n    logarithmic for maps. And finally, just as maps depend on having a\n    comparison function for creating the ordered binary tree that underlies a\n    map, hash tables depend on having a <span><em>hash function</em></span>,\n    i.e., a function for converting a key to an integer.<a name=\"idm181613364432\"></a><a name=\"idm181613363184\"></a><a name=\"idm181613362304\"></a></blockquote>")))
 (idm181613368368
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>Hash tables are the imperative cousin of maps. We walked over a\n    basic hash table implementation in <a href=\"imperative-programming-1.html\">ChapterÂ 8, <i>Imperative Programming</i></a>, so in this section we'll mostly\n    discuss the pragmatics of Core's <code>Hashtbl</code> module. We'll cover this material more\n    briefly than we did with maps because many of the concepts are\n    shared.<a name=\"idm181613366640\"></a></blockquote>")))
 (idm181613378688
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>If you feel like hanging your OCaml interpreter, you can verify\n          what happens with recursive values and structural equality for\n          yourself:</blockquote>")))
 (idm181613391232
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>It's quite easy to mix up the use of <code>=</code> and <code>==</code>,\n          so Core disables the <code>==</code> operator and\n          provides the more explicit <code>phys_equal</code>\n          function instead. You'll see a type error if you use <code>==</code> anywhere in code that opens <code>Core.Std</code>:</blockquote>")))
 (idm181613393408
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>The <code>=</code> structural equality\n          operator recursively inspects each field in the two values and tests\n          them individually for equality. Crucially, if your data structure is\n          cyclical (that is, a value recursively points back to another field\n          within the same structure), the <code>=</code>\n          operator will never terminate, and your program will hang! You therefore\n          must use the physical equality operator or write a custom comparison\n          function when comparing cyclic values.</blockquote>")))
 (idm181613394656
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>The physical equality test will match if two data structures have\n          precisely the same pointer in memory. Two data structures that have\n          identical contents but are constructed separately will not match using\n          <code>==</code>.</blockquote>")))
 (idm181613397872
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>If you come from a C/C++ background, you'll probably reflexively\n          use <code>==</code> to test two values for\n          equality. In OCaml, the <code>==</code> operator\n          tests for <span><em>physical</em></span> equality, while the <code>=</code> operator tests for\n          <span><em>structural</em></span> equality.</blockquote>")))
 (idm181613399008
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>That said, for reasons we discussed earlier, polymorphic compare\n      should be used sparingly.</blockquote>")))
 (idm181613404032
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>You can also satisfy the <code>Comparable.S</code> interface using polymorphic\n      compare:</blockquote>")))
 (idm181613405328
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>If you want your comparison function to behave in a specific way,\n      you should still write your own comparison function by hand; but if all\n      you want is a total order suitable for creating maps and sets with, then\n      <code>comparelib</code> is a good way to\n      go.</blockquote>")))
 (idm181613407872
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>The comparison function created by <code>comparelib</code> for a given type will call out to\n      the comparison functions for its component types. As a result, the\n      <code>foo</code> field will be compared using\n      <code>Int.Set.compare</code>. This is different,\n      and saner than the structural comparison done by polymorphic\n      compare.</blockquote>")))
 (idm181613413120
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>In the preceding code we wrote the comparison function by hand,\n      but this isn't strictly necessary. Core ships with a syntax extension\n      called <code>comparelib</code>, which will create\n      a comparison function from a type definition. Using it, we can rewrite\n      the previous example as follows:</blockquote>")))
 (idm181613414816
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>We don't include the full response from the toplevel because it is\n      quite lengthy, but <code>Foo_and_bar</code> does\n      satisfy <code>Comparable.S</code>.</blockquote>")))
 (idm181613420304
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>The following example shows how this all fits together, following\n      the same basic pattern for using functors described in <a href=\"functors.html#extending-modules\">the section called â\128\156Extending Modulesâ\128\157</a>:</blockquote>")))
 (idm181613422736
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>In other words, it expects a type with a comparison function, as\n      well as functions for converting to and from\n      <span><em>s-expressions</em></span>. S-expressions are a serialization\n      format used commonly in Core and are required here to enable better\n      error messages. We'll discuss s-expressions more in <a href=\"data-serialization-with-s-expressions.html\">ChapterÂ 17, <i>Data Serialization with S-Expressions</i></a>, but in the meantime,\n      we'll use the <code>with sexp</code> declaration\n      that comes from the Sexplib syntax extension. This declaration kicks off\n      the automatic generation of s-expression conversion functions for the\n      marked type.</blockquote>")))
 (idm181613427152
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>The module <code>Comparable</code> contains\n      a number of functors to help you automate this task. The simplest one of\n      these is <code>Comparable.Make</code>, which takes\n      as an input any module that satisfies the following interface:</blockquote>")))
 (idm181613428320
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote><code>Comparable.S</code> is satisfied by\n      most of the types in Core, but the question arises of how to satisfy the\n      comparable interface for a new type that you design. Certainly\n      implementing all of the required functionality from scratch would be an\n      absurd amount of work.</blockquote>")))
 (idm181613436736
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>Core's <code>Comparable.S</code> interface\n      includes a lot of useful functionality, including support for working\n      with maps and sets. In particular, <code>Comparable.S</code> requires the presence of the\n      <code>Map</code> and <code>Set</code> submodules, as well as a\n      comparator.<a name=\"idm181613433680\"></a><a name=\"idm181613432384\"></a><a name=\"idm181613431072\"></a><a name=\"idm181613429760\"></a></blockquote>")))
 (idm181613438512
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>In addition to the operators you would expect to have for maps,\n      sets support the traditional set operations, including union,\n      intersection, and set difference. And, as with maps, we can create sets\n      based on type-specific comparators or on the polymorphic\n      comparator.</blockquote>")))
 (idm181613449456
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>Sometimes, instead of keeping track of a set of key/value pairs,\n      you just want a data type for keeping track of a set of keys. You could\n      build this on top of a map by representing a set of values by a map\n      whose data type is <code>unit</code>. But a more\n      idiomatic (and efficient) solution is to use Core's set type, which is\n      similar in design and spirit to the map type, while having an API better\n      tuned to working with sets and a lower memory footprint. Here's a simple\n      example:<a name=\"idm181613448032\"></a></blockquote>")))
 (idm181613451472
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>This can cause real and quite subtle bugs. If, for example, you\n        use a map whose keys contain sets, then the map built with the\n        polymorphic comparator will behave incorrectly, separating out keys\n        that should be aggregated together. Even worse, it will work sometimes\n        and fail others; since if the sets are built in a consistent order,\n        then they will work as expected, but once the order changes, the\n        behavior will change.</blockquote>")))
 (idm181613456560
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>We can, however, use the function <code>Set.to_tree</code> to expose the underlying tree\n        without the attached comparator:</blockquote>")))
 (idm181613461776
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>Let's see what happens if we use polymorphic compare to test for\n        equality by way of the <code>=</code> operator.\n        Comparing the maps directly will fail at runtime because the\n        comparators stored within the sets contain function values:</blockquote>")))
 (idm181613462384
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>But because the elements were added in different orders, the\n        layout of the trees underlying the sets will be different. As such, a\n        structural comparison function will conclude that they're\n        different.</blockquote>")))
 (idm181613467424
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>Logically, these two sets should be equal, and that's the result\n        that you get if you call <code>Set.equal</code>\n        on them:</blockquote>")))
 (idm181613473280
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>But sometimes, a structural comparison is not what you want.\n        Sets are a great example of this. Consider the following two\n        sets:</blockquote>")))
 (idm181613475424
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>This is convenient because it provides a comparison function that works for most OCaml\n          values and largely behaves as you would expect. For example, on <code>int</code>s and <code>float</code>s, it acts as you would\n          expect a numeric comparison function to act. For simple containers like strings and lists\n          and arrays, it operates as a lexicographic comparison. And except for functions and values\n          from outside of the OCaml heap, it works on almost every OCaml type.</blockquote>")))
 (idm181613476528
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>To understand what's wrong with polymorphic compare, you need to\n        understand a bit about how it works. Polymorphic compare is\n        <span><em>structural</em></span>, in that it operates directly on the\n        runtime representation of OCaml values, walking the structure of the\n        values in question without regard for their type.</blockquote>")))
 (idm181613477216
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>Polymorphic compare is highly convenient, but it has serious\n        downsides as well and should be used with care. In particular,\n        polymorphic compare has a fixed algorithm for comparing values of any\n        type, and that algorithm can sometimes yield surprising\n        results.</blockquote>")))
 (idm181613478480
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>This is rejected for good reason: there's no guarantee that the\n      comparator associated with a given type will order things in the same\n      way that polymorphic compare does.</blockquote>")))
 (idm181613487696
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>Note that maps based on the polymorphic comparator are not\n      equivalent to those based on the type-specific comparators from the\n      point of view of the type system. Thus, the compiler rejects the\n      following:</blockquote>")))
 (idm181613492128
  ((file maps-and-hash-tables.html)
   (html "<blockquote>Or, equivalently:</blockquote>")))
 (idm181613501248
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>We don't need to generate specialized comparators for every type\n      we want to build a map on. We can instead use a comparator based on\n      OCaml's built-in polymorphic comparison function, which was discussed in\n      <a href=\"lists-and-patterns.html\">ChapterÂ 3, <i>Lists and Patterns</i></a>. This comparator is found in the\n      <code>Comparator.Poly</code> module, allowing us\n      to write:<a name=\"idm181613499504\"></a><a name=\"idm181613498192\"></a><a name=\"idm181613497280\"></a></blockquote>")))
 (idm181613510384
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>The algorithm of <code>Map.Tree.find</code>\n      depends on the fact that it's using the same comparator when looking up\n      a value as you were when you stored it. That's the invariant that the\n      phantom type is there to enforce. As you can see in the following\n      example, using the wrong comparator will lead to a type error:</blockquote>")))
 (idm181613514816
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>Since the comparator isn't included in the tree, we need to\n      provide the comparator explicitly when we, say, search for a key, as\n      shown below:</blockquote>")))
 (idm181613516624
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>Even though a <code>Map.Tree.t</code>\n      doesn't physically include a comparator, it does include the comparator\n      in its type. This is what is known as a <span><em>phantom\n      type</em></span>, because it reflects something about the logic of the\n      value in question, even though it doesn't correspond to any values\n      directly represented in the underlying physical structure of the\n      value.</blockquote>")))
 (idm181613524704
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>As we've discussed, maps carry within them the comparator that\n      they were created with. Sometimes, often for space efficiency reasons,\n      you want a version of the map data structure that doesn't include the\n      comparator. You can get such a representation with <code>Map.to_tree</code>, which returns just the tree\n      underlying the map, without the comparator:<a name=\"idm181613523440\"></a><a name=\"idm181613522144\"></a></blockquote>")))
 (idm181613533488
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>Accordingly, if we try to use <code>Map.symmetric_diff</code> on these two maps, we'll\n      get a compile-time error:</blockquote>")))
 (idm181613540288
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote><code>Map.min_elt</code> returns the key and\n      value for the smallest key in the map, which lets us see that these two\n      maps do indeed use different comparison functions:</blockquote>")))
 (idm181613550672
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>As you can see in the following code, both <code>Reverse.comparator</code> and <code>String.comparator</code> can be used to create maps\n      with a key type of <code>string</code>:</blockquote>")))
 (idm181613565936
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>We can create a new comparator using the <code>Comparator.Make</code> functor, which takes as its\n      input a module containing the type of the object to be compared, sexp\n      converter functions, and a comparison function. The sexp converters are\n      included in the comparator to make it possible for users of the\n      comparator to generate better error messages. Here's an\n      example:<a name=\"idm181613564656\"></a></blockquote>")))
 (idm181613567104
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>This constraint is important because the algorithm that <code>Map.symmetric_diff</code> uses depends for its\n      correctness on the fact that both maps have the same comparator.</blockquote>")))
 (idm181613575024
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>The type of <code>Map.symmetric_diff</code>,\n      which follows, requires that the two maps it compares have the same\n      comparator type. Each comparator has a fresh abstract type, so the type\n      of a comparator identifies the comparator uniquely:</blockquote>")))
 (idm181613585056
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>Including the comparator in the type is important because\n      operations that work on multiple maps at the same time often require\n      that the maps share their comparison function. Consider, for example,\n      <code>Map.symmetric_diff</code>, which computes a\n      summary of the differences between two maps:</blockquote>")))
 (idm181613587584
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>The type <code>Map.t</code> has three type\n      parameters: one for the key, one for the value, and one to identify the\n      comparator. Indeed, the type <code>'a\n      Int.Map.t</code> is just a type alias for <code>(int,'a,Int.comparator) Map.t</code>.</blockquote>")))
 (idm181613592176
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>The comparator is only required for operations that create maps\n      from scratch. Operations that update an existing map simply inherit the\n      comparator of the map they start with:</blockquote>")))
 (idm181613593376
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>The preceding code uses <code>Map.of_alist_exn</code>, which creates a map from an\n      association list, throwing an exception if there are duplicate keys in\n      the list.</blockquote>")))
 (idm181613606304
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>The specialized <code>Map</code> submodule\n      is convenient, but it's not the only way of creating a <code>Map.t</code>. The information required to compare\n      values of a given type is wrapped up in a value called a\n      <span><em>comparator</em></span> that can be used to create maps using\n      the <code>Map</code> module directly:<a name=\"idm181613603440\"></a><a name=\"idm181613602528\"></a><a name=\"idm181613601216\"></a></blockquote>")))
 (idm181613611904
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>But in order to get a map in the first place, you need to get your\n    hands on the comparison function somehow. For this reason, modules like\n    <code>String</code> contain a <code>Map</code> submodule that has values like <code>String.Map.empty</code> and <code>String.Map.of_alist</code> that are specialized to\n    strings, and thus have access to a string comparison function. Such a\n    <code>Map</code> submodule is included in every\n    module that satisfies the <code>Comparable.S</code>\n    interface from Core.</blockquote>")))
 (idm181613613888
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>To deal with this, a map, once created, stores the necessary\n    comparison function within the data structure. Thus, operations like\n    <code>Map.find</code> or <code>Map.add</code> that access the contents of a map or\n    create a new map from an existing one, do so by using the comparison\n    function embedded within the map.</blockquote>")))
 (idm181613615712
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>Note that in some places the preceding code refers to <code>String.Map.t</code>, and in others <code>Map.t</code>. This has to do with the fact that maps\n    are implemented as ordered binary trees, and as such, need a way of\n    comparing keys.</blockquote>")))
 (idm181613618752
  ((file maps-and-hash-tables.html)
   (html "<blockquote>Here's the implementation:</blockquote>")))
 (idm181613622128
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>The intended behavior here is straightforward. <code>Counter.empty</code> represents an empty collection of\n    frequency counts; <code>touch</code> increments the\n    frequency count of the specified string by 1; and <code>to_list</code> returns the list of nonzero\n    frequencies.</blockquote>")))
 (idm181613626288
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>Let's consider an example of how one might use a map in practice. In\n    <a href=\"files-modules-and-programs.html\">ChapterÂ 4, <i>Files, Modules, and Programs</i></a>, we showed a module <code>Counter</code> for keeping frequency counts on a set of\n    strings. Here's the interface:</blockquote>")))
 (idm181613631424
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>In this chapter, we'll talk about two more efficient alternatives to\n  association lists: <span><em>maps</em></span> and <span><em>hash\n  tables</em></span>. A map is an immutable tree-based data structure where\n  most operations take time logarithmic in the size of the map, whereas a hash\n  table is a mutable data structure where most operations have constant time\n  complexity. We'll describe both of these data structures in detail and\n  provide some advice as to how to choose between them.<a name=\"idm181613629904\"></a><a name=\"idm181613628608\"></a></blockquote>")))
 (idm181613632000
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>Association lists are simple and easy to use, but their performance is\n  not ideal, since almost every nontrivial operation on an association list\n  requires a linear-time scan of the list.</blockquote>")))
 (idm181613642080
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>We can use functions from the <code>List.Assoc</code> module to\n    manipulate this data:</blockquote>")))
 (idm181613654960
  ((file maps-and-hash-tables.html)
   (html
    "<blockquote>Lots of programming problems require dealing with data organized as\n  key/value pairs. Maybe the simplest way of representing such data in OCaml\n  is an <span><em>association list</em></span>, which is simply a list of pairs\n  of keys and values. For example, you could represent a mapping between the\n  10 digits and their English names as follows:<a name=\"idm181613653968\"></a><a name=\"idm181613653072\"></a><a name=\"idm181613651776\"></a><a name=\"idm181613650464\"></a></blockquote>")))
 (idm181619009136
  ((file lists-and-patterns.html)
   (html
    "<blockquote>As a side note, the above implementation of <code>count_some</code> is longer than necessary; even worse,\n    it is not tail recursive. In real life, you would probably just use the\n    <code>List.count</code> function from <code>Core</code>:</blockquote>")))
 (idm181619010224
  ((file lists-and-patterns.html)
   (html
    "<blockquote>The takeaway from all of this is although <code>when</code> clauses can be useful, we should prefer\n    patterns wherever they are sufficient.</blockquote>")))
 (idm181619018048
  ((file lists-and-patterns.html)
   (html
    "<blockquote>This is a little less clear, however, than the direct\n    pattern-matching solution, where the meaning of each pattern is clearer on\n    its own:</blockquote>")))
 (idm181619026496
  ((file lists-and-patterns.html)
   (html
    "<blockquote>Probably a better approach is to simply drop the second <code>when</code> clause:</blockquote>")))
 (idm181619035792
  ((file lists-and-patterns.html)
   (html
    "<blockquote>If we add another redundant case without a <code>when</code> clause, the compiler will stop complaining\n    about exhaustiveness and won't produce a warning about the\n    redundancy.</blockquote>")))
 (idm181619040096
  ((file lists-and-patterns.html)
   (html
    "<blockquote>Despite the warning, the function does work fine:</blockquote>")))
 (idm181619052736
  ((file lists-and-patterns.html)
   (html
    "<blockquote>Consider the following function, which takes a list of optional\n    values, and returns the number of those values that are <code>Some</code>. Because this implementation uses <code>when</code> clauses, the compiler can't tell that the\n    code is exhaustive:</blockquote>")))
 (idm181619054208
  ((file lists-and-patterns.html)
   (html
    "<blockquote>Note that <code>when</code> clauses have some\n    downsides. As we noted earlier, the static checks associated with pattern\n    matches rely on the fact that patterns are restricted in what they can\n    express. Once we add the ability to add an arbitrary condition to a\n    pattern, something will be lost. In particular, the ability of the\n    compiler to determine if a match is exhaustive, or if some case is\n    redundant, is compromised.</blockquote>")))
 (idm181619055504
  ((file lists-and-patterns.html)
   (html
    "<blockquote>Sometimes, however, the type-ignoring nature of polymorphic\n      compare is a problem, particularly when you have your own notion of\n      equality and ordering that you want to impose. We'll discuss this issue\n      more, as well as some of the other downsides of polymorphic compare, in\n      <a href=\"maps-and-hash-tables.html\">ChapterÂ 13, <i>Maps and Hash Tables</i></a>.</blockquote>")))
 (idm181619056160
  ((file lists-and-patterns.html)
   (html
    "<blockquote>For simple atomic types, polymorphic compare has the semantics you\n      would expect: for floating-point numbers and integers, polymorphic\n      compare corresponds to the expected numerical comparison functions. For\n      strings, it's a lexicographic comparison.</blockquote>")))
 (idm181619056736
  ((file lists-and-patterns.html)
   (html
    "<blockquote>Similarly, it will fail on values that come from outside the OCaml\n      heap, like values from C bindings. But it will work in a reasonable way\n      for other kinds of values.</blockquote>")))
 (idm181619061280
  ((file lists-and-patterns.html)
   (html
    "<blockquote>Polymorphic compare does have some limitations. For example, it\n      will fail at runtime if it encounters a function value:</blockquote>")))
 (idm181619062576
  ((file lists-and-patterns.html)
   (html
    "<blockquote>You might wonder how you could build functions like these yourself if OCaml didn't come\n        with them built in. It turns out that you <span><em>can't</em></span> build these functions\n        on your own. OCaml's polymorphic comparison functions are built into the runtime to a low\n        level. These comparisons are polymorphic on the basis of ignoring almost everything about\n        the types of the values that are being compared, paying attention only to the structure of\n        the values as they're laid out in memory.</blockquote>")))
 (idm181619067056
  ((file lists-and-patterns.html)
   (html
    "<blockquote>OCaml comes with a whole family of polymorphic comparison operators, including the\n        standard infix comparators, <code>&lt;</code>, <code>&gt;=</code>, etc., as well as the function <code>compare</code> that returns <code>-1</code>, <code>0</code>, or <code>1</code> to flag whether the\n        first operand is smaller than, equal to, or greater than the second, respectively.</blockquote>")))
 (idm181619071536
  ((file lists-and-patterns.html)
   (html
    "<blockquote>Indeed, if we look at the type of the equality operator, we'll see\n      that it is polymorphic:</blockquote>")))
 (idm181619080848
  ((file lists-and-patterns.html)
   (html
    "<blockquote>In the preceding <code>destutter</code>\n      example, we made use of the fact that OCaml lets us test equality\n      between values of any type, using the <code>=</code> operator. Thus, we can write:</blockquote>")))
 (idm181619092448
  ((file lists-and-patterns.html)
   (html
    "<blockquote>We can make the code slightly terser now by using a <code>when</code> clause. A <code>when</code> clause allows us to add an extra\n    precondition to a pattern in the form of an arbitrary OCaml expression. In\n    this case, we can use it to include the check on whether the first two\n    elements are equal:</blockquote>")))
 (idm181619100208
  ((file lists-and-patterns.html)
   (html
    "<blockquote>We can further collapse this by combining the first two cases into\n    one, using an Or pattern:</blockquote>")))
 (idm181619112624
  ((file lists-and-patterns.html)
   (html
    "<blockquote>First, let's consider efficiency. One problem with the <code>destutter</code> code above is that it in some cases\n    re-creates on the righthand side of the arrow a value that already existed\n    on the lefthand side. Thus, the pattern <code>[hd]\n    -&gt; [hd]</code> actually allocates a new list element, when really,\n    it should be able to just return the list being matched. We can reduce\n    allocation here by using an <code>as</code> pattern,\n    which allows us to declare a name for the thing matched by a pattern or\n    subpattern. While we're at it, we'll use the <code>function</code> keyword to eliminate the need for an\n    explicit match:<a name=\"idm181619109216\"></a></blockquote>")))
 (idm181619113104
  ((file lists-and-patterns.html)
   (html
    "<blockquote>We'll consider some ways of making this code more concise and more\n    efficient.</blockquote>")))
 (idm181619128224
  ((file lists-and-patterns.html)
   (html
    "<blockquote>Now that we know more about how lists and patterns work, let's\n    consider how we can improve on an example from <a href=\"a-guided-tour.html#recursive-list-functions\">the section called â\128\156Recursive list functionsâ\128\157</a>: the function <code>destutter</code>, which removes sequential duplicates\n    from a list. Here's the implementation that was described\n    earlier:<a name=\"idm181619126544\"></a><a name=\"PTTRNMAT\"></a><a name=\"idm181619124064\"></a><a name=\"idm181619122752\"></a></blockquote>")))
 (idm181619130096
  ((file lists-and-patterns.html)
   (html
    "<blockquote>Tail recursion is important for more than just lists. Ordinary nontail recursive calls are\n      reasonable when dealing with data structures like binary trees, where the depth of the tree is\n      logarithmic in the size of your data. But when dealing with situations where the depth of the\n      sequence of nested calls is on the order of the size of your data, tail recursion is usually\n      the right approach.</blockquote>")))
 (idm181619131872
  ((file lists-and-patterns.html)
   (html
    "<blockquote>So when is a call a tail call? Let's think about the situation where one function (the\n        <span><em>caller</em></span>) invokes another (the <span><em>callee</em></span>). The\n      invocation is considered a tail call when the caller doesn't do anything with the value\n      returned by the callee except to return it. The tail-call optimization makes sense because,\n      when a caller makes a tail call, the caller's stack frame need never be used again, and so you\n      don't need to keep it around. Thus, instead of allocating a new stack frame for the callee,\n      the compiler is free to reuse the caller's stack frame.</blockquote>")))
 (idm181619140752
  ((file lists-and-patterns.html)
   (html
    "<blockquote>The advantage of this approach is that the recursive call in\n    <code>length_plus_n</code> is a <span><em>tail\n    call</em></span>. We'll explain more precisely what it means to be a tail\n    call shortly, but the reason it's important is that tail calls don't\n    require the allocation of a new stack frame, due to what is called the\n    <span><em>tail-call optimization</em></span>. A recursive function is said\n    to be <span><em>tail recursive</em></span> if all of its recursive calls\n    are tail calls. <code>length_plus_n</code> is indeed\n    tail recursive, and as a result, <code>length</code>\n    can take a long list as input without blowing the stack:<a name=\"idm181619136800\"></a></blockquote>")))
 (idm181619144080
  ((file lists-and-patterns.html)
   (html
    "<blockquote>This implementation depends on a helper function, <code>length_plus_n</code>, that computes the length of a\n    given list plus a given <code>n</code>. In practice,\n    <code>n</code> acts as an accumulator in which the\n    answer is built up, step by step. As a result, we can do the additions\n    along the way rather than doing them as we unwind the nested sequence of\n    function calls, as we did in our first implementation of <code>length</code>.</blockquote>")))
 (idm181619155632
  ((file lists-and-patterns.html)
   (html
    "<blockquote>And that's the problem with our call to <code>length</code>: it tried to allocate 10 million stack\n    frames, which exhausted the available stack space. Happily, there's a way\n    around this problem. Consider the following alternative\n    implementation:</blockquote>")))
 (idm181619157920
  ((file lists-and-patterns.html)
   (html
    "<blockquote>To understand where the error in the above example comes from, you\n    need to learn a bit more about how function calls work. Typically, a\n    function call needs some space to keep track of information associated\n    with the call, such as the arguments passed to the function, or the\n    location of the code that needs to start executing when the function call\n    is complete. To allow for nested function calls, this information is\n    typically organized in a stack, where a new <span><em>stack\n    frame</em></span> is allocated for each nested function call, and then\n    deallocated when the function call is complete.<a name=\"idm181619156656\"></a></blockquote>")))
 (idm181619161696
  ((file lists-and-patterns.html)
   (html
    "<blockquote>The preceding example creates lists using <code>List.init</code>, which takes an integer <code>n</code> and a function <code>f</code> and creates a list of length <code>n</code>, where the data for each element is created by\n    calling <code>f</code> on the index of that\n    element.</blockquote>")))
 (idm181619169856
  ((file lists-and-patterns.html)
   (html
    "<blockquote>This looks simple enough, but you'll discover that this\n    implementation runs into problems on very large lists, as we'll show in\n    the following code:</blockquote>")))
 (idm181619182944
  ((file lists-and-patterns.html)
   (html
    "<blockquote>The only way to compute the length of an OCaml list is to walk the\n    list from beginning to end. As a result, computing the length of a list\n    takes time linear in the size of the list. Here's a simple function for\n    doing so:<a name=\"idm181619182448\"></a><a name=\"idm181619181152\"></a><a name=\"idm181619179872\"></a>\n<a name=\"idm181619178848\"></a>\n</blockquote>")))
 (idm181619195264
  ((file lists-and-patterns.html)
   (html
    "<blockquote>The preceding combination of <code>List.map</code> and <code>List.concat</code> is common enough that there is a\n        function <code>List.concat_map</code> that\n        combines these into one, more efficient operation:</blockquote>")))
 (idm181619197088
  ((file lists-and-patterns.html)
   (html
    "<blockquote>Note that <code>^/</code> is an infix\n        operator provided by Core for adding a new element to a string\n        representing a file path. It is equivalent to Core's <code>Filename.concat</code>.</blockquote>")))
 (idm181619207488
  ((file lists-and-patterns.html)
   (html
    "<blockquote>Here's an example of using <code>List.concat</code> along with <code>List.map</code> to compute a recursive listing of a\n        directory tree:</blockquote>")))
 (idm181619212544
  ((file lists-and-patterns.html)
   (html
    "<blockquote>In addition, there is <code>List.concat</code>, for concatenating a list of\n        lists:</blockquote>")))
 (idm181619218192
  ((file lists-and-patterns.html)
   (html
    "<blockquote>There's also <code>@</code>, an operator\n        equivalent of <code>List.append</code>:</blockquote>")))
 (idm181619225968
  ((file lists-and-patterns.html)
   (html
    "<blockquote>Another very common operation on lists is concatenation. The\n        list module actually comes with a few different ways of doing this.\n        First, there's <code>List.append</code>, for\n        concatenating a pair of lists:<a name=\"idm181619224848\"></a><a name=\"idm181619223552\"></a></blockquote>")))
 (idm181619244160
  ((file lists-and-patterns.html)
   (html
    "<blockquote>Another useful operation that's closely related to filtering is\n        partitioning. The function <code>List.partition_tf</code> takes a list and a\n        function for computing a Boolean condition on the list elements, and\n        returns two lists. The <code>tf</code> in the\n        name is a mnemonic to remind the user that <code>true</code> elements go to the first list and\n        <code>false</code> ones go to the second. Here's\n        an example:<a name=\"idm181619240912\"></a><a name=\"idm181619239584\"></a><a name=\"idm181619238272\"></a></blockquote>")))
 (idm181619246576
  ((file lists-and-patterns.html)
   (html
    "<blockquote>The preceding code is also an example of an Or pattern, which\n        allows you to have multiple subpatterns within a larger pattern. In\n        this case, <code>None | Some (&quot;&quot;,_)</code> is an\n        Or pattern. As we'll see later, Or patterns can be nested anywhere\n        within larger patterns.</blockquote>")))
 (idm181619259536
  ((file lists-and-patterns.html)
   (html
    "<blockquote>Here's an example. The following expression computes the list of\n        file extensions in the current directory, piping the results through\n        <code>List.dedup</code> to remove duplicates.\n        Note that this example also uses some functions from other modules,\n        including <code>Sys.ls_dir</code> to get a\n        directory listing, and <code>String.rsplit2</code> to split a string on the\n        rightmost appearance of a given character:<a name=\"idm181619256944\"></a><a name=\"idm181619255632\"></a></blockquote>")))
 (idm181619262768
  ((file lists-and-patterns.html)
   (html
    "<blockquote>Sometimes, you want to both transform and filter as part of the\n        same computation. In that case, <code>List.filter_map</code> is what you need. The\n        function passed to <code>List.filter_map</code>\n        returns an optional value, and <code>List.filter_map</code> drops all elements for which\n        <code>None</code> is returned.</blockquote>")))
 (idm181619264288
  ((file lists-and-patterns.html)
   (html
    "<blockquote>Note that the <code>mod</code> used above\n        is an infix operator, as described in <a href=\"variables-and-functions.html\">ChapterÂ 2, <i>Variables and Functions</i></a>.</blockquote>")))
 (idm181619273536
  ((file lists-and-patterns.html)
   (html
    "<blockquote>Very often when processing lists, you wants to restrict your attention to a subset of\n          the values on your list. The <code>List.filter</code> function is\n          one way of doing that:<a name=\"idm181619272464\"></a><a name=\"idm181619271152\"></a><a name=\"idm181619269840\"></a></blockquote>")))
 (idm181619281152
  ((file lists-and-patterns.html)
   (html
    "<blockquote>Now we can see <code>reduce</code> in action:</blockquote>")))
 (idm181619282768
  ((file lists-and-patterns.html)
   (html
    "<blockquote><code>reduce</code> returns an optional\n        result, returning <code>None</code> when the\n        input list is empty.</blockquote>")))
 (idm181619287184
  ((file lists-and-patterns.html)
   (html "<blockquote>Here's the type signature:</blockquote>")))
 (idm181619293728
  ((file lists-and-patterns.html)
   (html
    "<blockquote><code>List.fold</code>, which we described\n        earlier, is a very general and powerful function. Sometimes, however,\n        you want something simpler and easier to use. One such function is\n        <code>List.reduce</code>, which is essentially a\n        specialized version of <code>List.fold</code>\n        that doesn't require an explicit starting value, and whose accumulator\n        has to consume and produce values of the same type as the elements of\n        the list it applies to.<a name=\"idm181619291232\"></a><a name=\"idm181619289920\"></a><a name=\"idm181619288624\"></a></blockquote>")))
 (idm181619296528
  ((file lists-and-patterns.html)
   (html
    "<blockquote>The previous example we worked through touched on only three of\n      the functions in <code>List</code>. We won't cover\n      the entire interface (for that you should look at the <a href=\"http://realworldocaml.org/doc\" target=\"_top\">online docs</a>), but a few more\n      functions are useful enough to mention here.</blockquote>")))
 (idm181619306656
  ((file lists-and-patterns.html)
   (html
    "<blockquote>Now we can bring this all together in a single function that renders\n    the table:</blockquote>")))
 (idm181619315616
  ((file lists-and-patterns.html)
   (html
    "<blockquote>We can render a row of data by merging together the padded strings.\n    Again, we'll use <code>List.map2_exn</code> for\n    combining the list of data in the row with the list of widths:</blockquote>")))
 (idm181619325312
  ((file lists-and-patterns.html)
   (html
    "<blockquote>Now we need code for rendering a row with data in it. We'll first write a function called\n        <code>pad</code>, for padding out a string to a specified length plus\n      one blank space on both sides:<a name=\"idm181619324192\"></a></blockquote>")))
 (idm181619326032
  ((file lists-and-patterns.html)
   (html
    "<blockquote>allocates one string of size 7, as well as a list of length 7. At\n      these small sizes, the differences don't amount to much, but for\n      assembling large strings, it can be a serious performance issue.</blockquote>")))
 (idm181619330448
  ((file lists-and-patterns.html)
   (html
    "<blockquote>will allocate strings of length 2, 3, 4, 5, 6 and 7, whereas this\n      code</blockquote>")))
 (idm181619337088
  ((file lists-and-patterns.html)
   (html
    "<blockquote>In the preceding code weâ\128\153ve concatenated strings two different\n      ways: <code>String.concat</code>, which operates\n      on lists of strings; and <code>^</code>, which is\n      a pairwise operator. You should avoid <code>^</code> for joining long numbers of strings, since\n      it allocates a new string every time it runs. Thus, the following\n      code</blockquote>")))
 (idm181619341824
  ((file lists-and-patterns.html)
   (html
    "<blockquote>Note that we make the line of dashes two larger than the provided\n    width to provide some whitespace around each entry in the table.<a name=\"idm181619341424\"></a><a name=\"idm181619340112\"></a><a name=\"idm181619339216\"></a></blockquote>")))
 (idm181619353808
  ((file lists-and-patterns.html)
   (html
    "<blockquote>Now that we know how to compute column widths, we can write the code\n    to generate the line that separates the header from the rest of the text\n    table. We'll do this in part by mapping <code>String.make</code> over the lengths of the columns to\n    generate a string of dashes of the appropriate length. We'll then join\n    these sequences of dashes together using <code>String.concat</code>, which concatenates a list of\n    strings with an optional separator string, and <code>^</code>, which is a pairwise string concatenation\n    function, to add the delimiters on the outside:</blockquote>")))
 (idm181619357024
  ((file lists-and-patterns.html)
   (html
    "<blockquote>Using <code>List.map</code> we define the\n    function <code>lengths</code>, which converts a list\n    of strings to a list of integer lengths. <code>List.fold</code> is then used to iterate over the rows,\n    using <code>map2_exn</code> to take the max of the\n    accumulator with the lengths of the strings in each row of the table, with\n    the accumulator initialized to the lengths of the header row.</blockquote>")))
 (idm181619365584
  ((file lists-and-patterns.html)
   (html
    "<blockquote>Let's bring our three functions together to compute the maximum\n    column widths:</blockquote>")))
 (idm181619371520
  ((file lists-and-patterns.html)
   (html
    "<blockquote>This example is particularly simple because the accumulator and the\n    list elements are of the same type. But <code>fold</code> is not limited to such cases. We can for\n    example use <code>fold</code> to reverse a list, in\n    which case the accumulator is itself a list:</blockquote>")))
 (idm181619376400
  ((file lists-and-patterns.html)
   (html
    "<blockquote>We can use <code>List.fold</code> for\n    something as simple as summing up a list:</blockquote>")))
 (idm181619384272
  ((file lists-and-patterns.html)
   (html
    "<blockquote><code>List.fold</code> is the most complicated of the three, taking\n      three arguments: a list to process, an initial accumulator value, and a function for updating\n      the accumulator. <code>List.fold</code> walks over the list from left to\n      right, updating the accumulator at each step and returning the final value of the accumulator\n      when it's done. You can see some of this by looking at the type-signature for <code>fold</code>:<a name=\"idm181619381824\"></a></blockquote>")))
 (idm181619389520
  ((file lists-and-patterns.html)
   (html
    "<blockquote>The <code>_exn</code> is there because the\n    function throws an exception if the lists are of mismatched length:</blockquote>")))
 (idm181619396400
  ((file lists-and-patterns.html)
   (html
    "<blockquote><code>List.map2_exn</code> is similar to\n    <code>List.map</code>, except that it takes two\n    lists and a function for combining them. Thus, we might write:<a name=\"idm181619394864\"></a></blockquote>")))
 (idm181619402704
  ((file lists-and-patterns.html)
   (html
    "<blockquote><code>List.map</code> is the simplest to\n    explain. It takes a list and a function for transforming elements of that\n    list, and returns a new list with the transformed elements. Thus, we can\n    write:<a name=\"idm181619401744\"></a></blockquote>")))
 (idm181619406080
  ((file lists-and-patterns.html)
   (html
    "<blockquote>The first step is to write a function to compute the maximum width\n    of each column of data. We can do this by converting the header and each\n    row into a list of integer lengths, and then taking the element-wise max\n    of those lists of lengths. Writing the code for all of this directly would\n    be a bit of a chore, but we can do it quite concisely by making use of\n    three functions from the <code>List</code> module:\n    <code>map</code>, <code>map2_exn</code>, and <code>fold</code>.</blockquote>")))
 (idm181619419888
  ((file lists-and-patterns.html)
   (html
    "<blockquote>Let's work through a concrete example to see this in action. We'll\n    write a function <code>render_table</code> that,\n    given a list of column headers and a list of rows, prints them out in a\n    well-formatted text table, as follows:</blockquote>")))
 (idm181619424960
  ((file lists-and-patterns.html)
   (html
    "<blockquote>We've so far written a fair amount of list-munging code using\n    pattern matching and recursive functions. But in real life, you're usually\n    better off using the <code>List</code> module, which\n    is full of reusable functions that abstract out common patterns for\n    computing with lists.<a name=\"idm181619423760\"></a><a name=\"idm181619422832\"></a><a name=\"Llistmod\"></a></blockquote>")))
 (idm181619428112
  ((file lists-and-patterns.html)
   (html
    "<blockquote>Even for simple examples like this, exhaustiveness checks are\n      pretty useful. But as we'll see in <a href=\"variants.html\">ChapterÂ 6, <i>Variants</i></a>, they\n      become yet more valuable as you get to more complicated examples,\n      especially those involving user-defined types. In addition to catching\n      outright errors, they act as a sort of refactoring tool, guiding you to\n      the locations where you need to adapt your code to deal with changing\n      types.<a name=\"idm181619426912\"></a></blockquote>")))
 (idm181619439120
  ((file lists-and-patterns.html)
   (html
    "<blockquote>OCaml also checks <code>match</code> statements for\n      exhaustiveness. Consider what happens if we modify <code>drop_zero</code> by deleting the handler for one of\n      the cases. As you can see, the compiler will produce a warning that\n      we've missed a case, along with an example of an unmatched\n      pattern:</blockquote>")))
 (idm181619443264
  ((file lists-and-patterns.html)
   (html
    "<blockquote>The error-detecting capabilities of <code>match</code>\n      statements are if anything more important than their performance. We've\n      already seen one example of OCaml's ability to find problems in a\n      pattern match: in our broken implementation of <code>drop_value</code>, OCaml warned us that the final\n      case was redundant. There are no algorithms for determining if a\n      predicate written in a general-purpose language is redundant, but it can\n      be solved reliably in the context of patterns.<a name=\"idm181619441472\"></a><a name=\"idm181619440560\"></a></blockquote>")))
 (idm181619445072
  ((file lists-and-patterns.html)
   (html
    "<blockquote>Generally, pattern matching is more efficient than the\n      alternatives you might code by hand. One notable exception is matches\n      over strings, which are in fact tested sequentially, so matches\n      containing a long sequence of strings can be outperformed by a hash\n      table. But most of the time, pattern matching is a clear performance\n      win.</blockquote>")))
 (idm181619447568
  ((file lists-and-patterns.html)
   (html
    "<blockquote>In this case, the <code>match</code>-based\n      implementation is many times faster than the <code>if</code>-based implementation. The difference comes\n      because we need to effectively do the same work multiple times, since\n      each function we call has to reexamine the first element of the list to\n      determine whether or not it's the empty cell. With a\n      <code>match</code> statement, this work happens exactly once per\n      list element.</blockquote>")))
 (idm181619459312
  ((file lists-and-patterns.html)
   (html
    "<blockquote>Again, we can benchmark these to see the difference:</blockquote>")))
 (idm181619469824
  ((file lists-and-patterns.html)
   (html
    "<blockquote>Here's another, less artificial example. We can rewrite the\n      <code>sum</code> function we described earlier in\n      the chapter using an <code>if</code> statement\n      rather than a match. We can then use the functions <code>is_empty</code>, <code>hd_exn</code>, and <code>tl_exn</code> from the <code>List</code> module to deconstruct the list, allowing\n      us to implement the entire function without pattern matching:</blockquote>")))
 (idm181619492560
  ((file lists-and-patterns.html)
   (html
    "<blockquote>If you benchmark these functions, you'll see that <code>plus_one_if</code> is considerably slower than\n      <code>plus_one_match</code>, and the advantage\n      gets larger as the number of cases increases. Here, we'll benchmark\n      these functions using the <code>core_bench</code>\n      library, which can be installed by running <code>opam\n      install core_bench</code> from the command line:</blockquote>")))
 (idm181619493728
  ((file lists-and-patterns.html)
   (html
    "<blockquote>Note the use of <code>_</code> in the above\n      match. This is a wildcard pattern that matches any value, but without\n      binding a variable name to the value in question.</blockquote>")))
 (idm181619507456
  ((file lists-and-patterns.html)
   (html
    "<blockquote>As an example, consider the following rather silly functions for\n      incrementing an integer by one. The first is implemented with a\n      <code>match</code> statement, and the second with a sequence of\n      <code>if</code> statements:</blockquote>")))
 (idm181619508880
  ((file lists-and-patterns.html)
   (html
    "<blockquote>Naively, you might think that it would be necessary to check each\n      case in a <code>match</code> in sequence to figure\n      out which one fires. If the cases of a match were guarded by arbitrary\n      code, that would be the case. But OCaml is often able to generate\n      machine code that jumps directly to the matched case based on an\n      efficiently chosen set of runtime checks.</blockquote>")))
 (idm181619511024
  ((file lists-and-patterns.html)
   (html
    "<blockquote>You can think of patterns as a specialized sublanguage that can\n    express a limited (though still quite rich) set of conditions. The fact\n    that the pattern language is limited turns out to be a very good thing,\n    making it possible to build better support for patterns in the compiler.\n    In particular, both the efficiency of <code>match</code> statements\n    and the ability of the compiler to detect errors in matches depend on the\n    constrained nature of patterns.</blockquote>")))
 (idm181619513792
  ((file lists-and-patterns.html)
   (html
    "<blockquote>The preceding example highlights an important fact about patterns,\n    which is that they can't be used to express arbitrary conditions. Patterns\n    can characterize the layout of a data structure and can even include\n    literals, as in the <code>drop_zero</code> example,\n    but that's where they stop. A pattern can check if a list has two\n    elements, but it can't check if the first two elements are equal to each\n    other.<a name=\"idm181619512464\"></a></blockquote>")))
 (idm181619525200
  ((file lists-and-patterns.html)
   (html
    "<blockquote>Note that if we wanted to drop a particular literal value (rather\n    than a value that was passed in), we could do this using something like\n    our original implementation of <code>drop_value</code>:</blockquote>")))
 (idm181619536528
  ((file lists-and-patterns.html)
   (html
    "<blockquote>A better way to write this code is not to use pattern matching for\n    determining whether the first element is equal to <code>to_drop</code>, but to instead use an ordinary\n    <code>if</code> statement:</blockquote>")))
 (idm181619540576
  ((file lists-and-patterns.html)
   (html
    "<blockquote>The key observation is that the appearance of <code>to_drop</code> in the second case doesn't imply a check\n    that the first element is equal to the value <code>to_drop</code> passed in as an argument to <code>drop_value</code>. Instead, it just causes a new\n    variable <code>to_drop</code> to be bound to\n    whatever happens to be in the first element of the list, shadowing the\n    earlier definition of <code>to_drop</code>. The\n    third case is unused because it is essentially the same pattern as we had\n    in the second case.</blockquote>")))
 (idm181619540992
  ((file lists-and-patterns.html)
   (html "<blockquote>So, what's going on?</blockquote>")))
 (idm181619545424
  ((file lists-and-patterns.html)
   (html
    "<blockquote>Moreover, the function clearly does the wrong thing, filtering out\n    all elements of the list rather than just those equal to the provided\n    value, as you can see here:</blockquote>")))
 (idm181619555216
  ((file lists-and-patterns.html)
   (html
    "<blockquote>The fact that <code>match</code> statements can be used to\n    bind new variables can be a source of confusion. To see how, imagine we\n    wanted to write a function that filtered out from a list all elements\n    equal to a particular value. You might be tempted to write that code as\n    follows, but when you do, the compiler will immediately warn you that\n    something is wrong:</blockquote>")))
 (idm181619558416
  ((file lists-and-patterns.html)
   (html
    "<blockquote>The <code>match</code> statement in <code>sum</code> is really doing two things: first, it's\n    acting as a case-analysis tool, breaking down the possibilities into a\n    pattern-indexed list of cases. Second, it lets you name substructures\n    within the data structure being matched. In this case, the variables\n    <code>hd</code> and <code>tl</code> are bound by the pattern that defines the\n    second case of the match statement. Variables that are bound in this way\n    can be used in the expression to the right of the arrow for the pattern in\n    question.</blockquote>")))
 (idm181619560208
  ((file lists-and-patterns.html)
   (html
    "<blockquote>This code follows the convention of using <code>hd</code> to represent the first element (or head) of\n    the list, and <code>tl</code> to represent the\n    remainder (or tail).</blockquote>")))
 (idm181619575072
  ((file lists-and-patterns.html)
   (html
    "<blockquote>We can read data out of a list using a <code>match</code>\n    statement. Here's a simple example of a recursive function that computes\n    the sum of all elements of a list:<a name=\"idm181619574240\"></a><a name=\"PATMAT\"></a><a name=\"idm181619571760\"></a></blockquote>")))
 (idm181619586992
  ((file lists-and-patterns.html)
   (html
    "<blockquote>Each <code>::</code> essentially adds a new block to the proceding\n      picture. Such a block contains two things: a reference to the data in that list element, and a\n      reference to the remainder of the list. This is why <code>::</code> can\n      extend a list without modifying it; extension allocates a new list element but change any of\n      the existing ones, as you can see:<a name=\"idm181619585104\"></a></blockquote>")))
 (idm181619594384
  ((file lists-and-patterns.html)
   (html
    "<blockquote>The way in which the <code>::</code> operator\n    attaches elements to the front of a list reflects the fact that OCaml's\n    lists are in fact singly linked lists. The figure below is a\n    rough graphical representation of how the list <code>1\n    :: 2 :: 3 :: []</code> is laid out as a data structure. The final arrow\n    (from the box containing <code>3</code>) points to\n    the empty list.<a name=\"idm181619591872\"></a></blockquote>")))
 (idm181619603840
  ((file lists-and-patterns.html)
   (html
    "<blockquote>As you can see, the <code>::</code> operator\n    is right-associative, which means that we can build up lists without\n    parentheses. The empty list <code>[]</code> is used\n    to terminate a list. Note that the empty list is polymorphic, meaning it\n    can be used with elements of any type, as you can see here:</blockquote>")))
 (idm181619613232
  ((file lists-and-patterns.html)
   (html
    "<blockquote>And they can also be generated using the equivalent <code>::</code> notation:<a name=\"idm181619612272\"></a><a name=\"idm181619610976\"></a></blockquote>")))
 (idm181619618832
  ((file lists-and-patterns.html)
   (html
    "<blockquote>An OCaml list is an immutable, finite sequence of elements of the\n    same type. As we've seen, OCaml lists can be generated using a\n    bracket-and-semicolon notation:<a name=\"idm181619618400\"></a></blockquote>")))
 (idm181619620880
  ((file lists-and-patterns.html)
   (html
    "<blockquote>This chapter will focus on two common elements of programming in\n  OCaml: lists and pattern matching. Both of these were discussed in <a href=\"a-guided-tour.html\">ChapterÂ 1, <i>A Guided Tour</i></a>, but we'll go into more depth here, presenting\n  the two topics together and using one to help illustrate the other.</blockquote>")))
 (idm181615765712
  ((file imperative-programming-1.html)
   (html
    "<blockquote>The scope and sophistication of the material here is an indication\n    of the importance of OCaml's imperative features. The fact that OCaml\n    defaults to immutability shouldn't obscure the fact that imperative\n    programming is a fundamental part of building any serious application, and\n    that if you want to be an effective OCaml programmer, you need to\n    understand OCaml's approach to imperative programming.<a name=\"idm181615765024\"></a></blockquote>")))
 (idm181615766496
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Discussing how language-level issues like order of evaluation\n        and weak polymorphism interact with OCaml's imperative features</blockquote>")))
 (idm181615767312
  ((file imperative-programming-1.html)
   (html "<blockquote>Covering OCaml's API for blocking I/O</blockquote>")))
 (idm181615768160
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Discussing so-called benign effects like memoization and\n        laziness</blockquote>")))
 (idm181615769024
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Walking through the implementation of a couple of classic\n        imperative data structures</blockquote>")))
 (idm181615771744
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Discussing the building blocks of mutable data structures as\n        well as the basic imperative constructs like <code>for</code> loops, <code>while</code> loops, and the sequencing operator\n        <code>;</code></blockquote>")))
 (idm181615773984
  ((file imperative-programming-1.html)
   (html
    "<blockquote>This chapter has covered quite a lot of ground, including:<a name=\"idm181615773664\"></a></blockquote>")))
 (idm181615780784
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Now, we can apply the identity function to <code>Concat_list.empty</code> without without losing any\n      polymorphism:</blockquote>")))
 (idm181615787360
  ((file imperative-programming-1.html)
   (html
    "<blockquote>In particular, if we replace <code>type 'a\n      t</code> in the interface with <code>type +'a\n      t</code>, that will make it explicit in the interface that the data\n      structure doesn't contain any persistent references to values of type\n      <code>'a</code>, at which point, OCaml can infer\n      polymorphic types for expressions of this type that are not simple\n      values:</blockquote>")))
 (idm181615791792
  ((file imperative-programming-1.html)
   (html
    "<blockquote>The issue here is that the signature, by virtue of being abstract,\n      has obscured the fact that <code>Concat_list.t</code> is in fact an immutable data\n      type. We can resolve this in one of two ways: either by making the type\n      concrete (i.e., exposing the implementation in the <code>mli</code>), which is often not desirable; or by\n      marking the type variable in question as <span><em>covariant</em></span>.\n      We'll learn more about covariance and contravariance in <a href=\"objects.html\">ChapterÂ 11, <i>Objects</i></a>, but for now, you can think of it as an annotation\n      that can be put in the interface of a pure data structure.<a name=\"idm181615788784\"></a></blockquote>")))
 (idm181615798880
  ((file imperative-programming-1.html)
   (html
    "<blockquote>The details of the implementation don't matter so much, but it's\n      important to note that a <code>Concat_list.t</code> is unquestionably an immutable\n      value. However, when it comes to the value restriction, OCaml treats it\n      as if it were mutable:</blockquote>")))
 (idm181615822896
  ((file imperative-programming-1.html)
   (html
    "<blockquote>A more important example of this comes up when defining abstract\n      data types. Consider the following simple data structure for an\n      immutable list type that supports constant-time concatenation:</blockquote>")))
 (idm181615829120
  ((file imperative-programming-1.html)
   (html
    "<blockquote>On the other hand, if the returned type is potentially mutable,\n      then the result will be weakly polymorphic:</blockquote>")))
 (idm181615833520
  ((file imperative-programming-1.html)
   (html
    "<blockquote>But that's not always the case. When the type of the returned\n      value is immutable, then OCaml can typically infer a fully polymorphic\n      type:</blockquote>")))
 (idm181615838144
  ((file imperative-programming-1.html)
   (html
    "<blockquote>For example, we saw that a function application, even a simple\n      application of the identity function, is not a simple value and thus can\n      turn a polymorphic value into a weakly polymorphic one:</blockquote>")))
 (idm181615838720
  ((file imperative-programming-1.html)
   (html
    "<blockquote>But OCaml actually has a relaxed version of the value restriction that can make use of\n        type information to allow polymorphic types for things that are not simple values.</blockquote>")))
 (idm181615839424
  ((file imperative-programming-1.html)
   (html
    "<blockquote>OCaml is actually a little better at inferring polymorphic types\n      than was suggested previously. The value restriction as we described it\n      is basically a syntactic check: you can do a few operations that count\n      as simple values, and anything that's a simple value can be\n      generalized.</blockquote>")))
 (idm181615841392
  ((file imperative-programming-1.html)
   (html
    "<blockquote>This transformation is referred to as <span><em>eta\n      expansion</em></span> and is often useful to resolve problems that arise\n      from the value restriction.</blockquote>")))
 (idm181615864352
  ((file imperative-programming-1.html)
   (html
    "<blockquote>As you can see, we now infer a weakly polymorphic type for the\n      resulting function. That's because there's nothing that guarantees that\n      <code>List.init</code> isn't creating a persistent\n      <code>ref</code> somewhere inside of it that would\n      be shared across multiple calls to <code>list_init_10</code>. We can eliminate this\n      possibility, and at the same time get the compiler to infer a\n      polymorphic type, by avoiding partial application:</blockquote>")))
 (idm181615869552
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Imagine we wanted to create a specialized version of <code>List.init</code> that always created lists of length\n      10. We could do that using partial application, as follows:</blockquote>")))
 (idm181615876528
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Consider the <code>List.init</code>\n      function, which is used for creating lists where each element is created\n      by calling a function on the index of that element:</blockquote>")))
 (idm181615878336
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Most of the time, when the value restriction kicks in, it's for a\n      good reason, i.e., it's because the value in question can actually only\n      safely be used with a single type. But sometimes, the value restriction\n      kicks in when you don't want it. The most common such case is partially\n      applied functions. A partially applied function, like any function\n      application, is not a simple value, and as such, functions created by\n      partial application are sometimes less general than you might\n      expect.<a name=\"idm181615877536\"></a></blockquote>")))
 (idm181615880320
  ((file imperative-programming-1.html)
   (html
    "<blockquote>But a function that has a mutable cache that persists across\n      calls, like <code>memoize</code>, can only be weakly\n      polymorphic.</blockquote>")))
 (idm181615885424
  ((file imperative-programming-1.html)
   (html
    "<blockquote>The value restriction doesn't require that there is no mutable\n      state, only that there is no <span><em>persistent</em></span> mutable\n      state that could share values between uses of the same function. Thus, a\n      function that produces a fresh reference every time it's called can have\n      a fully polymorphic type:</blockquote>")))
 (idm181615886016
  ((file imperative-programming-1.html)
   (html
    "<blockquote>It would be safe to infer a fully polymorphic variable here, but\n      because OCaml's type system doesn't distinguish between pure and impure\n      functions, it can't separate those two cases.</blockquote>")))
 (idm181615890736
  ((file imperative-programming-1.html)
   (html
    "<blockquote>The memoized version of the function does in fact need to be\n      restricted to a single type because it uses mutable state behind the\n      scenes to cache values returned by previous invocations of the function.\n      But OCaml would make the same determination even if the function in\n      question did no such thing. Consider this example:</blockquote>")))
 (idm181615895344
  ((file imperative-programming-1.html)
   (html
    "<blockquote>But, if we write down an expression that isn't a simple value by\n      the preceding definition, we'll get different results. For example,\n      consider what happens if we try to memoize the function defined\n      previously.</blockquote>")))
 (idm181615899888
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Thus, the following expression is a simple value, and as a result,\n      the types of values contained within it are allowed to be\n      polymorphic:</blockquote>")))
 (idm181615906848
  ((file imperative-programming-1.html)
   (html
    "<blockquote><code>let</code> bindings of the form\n          <code>let</code> <span><em><code>var</code></em></span> <code>=</code> <span><em><code>expr1</code></em></span> <code>in</code> <span><em><code>expr2</code></em></span>, where both\n          <span><em><code>expr1</code></em></span> and\n          <span><em><code>expr2</code></em></span> are\n          simple values</blockquote>")))
 (idm181615909536
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Function declarations, i.e., expressions that begin with\n          <code>fun</code> or <code>function</code>, or the equivalent let binding,\n          <code>let f x = ...</code></blockquote>")))
 (idm181615910368
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Constructors that only contain other simple values</blockquote>")))
 (idm181615911216
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Constants (i.e., things like integer and floating-point\n          literals)</blockquote>")))
 (idm181615912736
  ((file imperative-programming-1.html)
   (html
    "<blockquote>The core of the value restriction is the observation that some\n      kinds of expressions, which we'll refer to as <span><em>simple\n      values</em></span>, by their nature can't introduce persistent mutable\n      cells, including:</blockquote>")))
 (idm181615914928
  ((file imperative-programming-1.html)
   (html
    "<blockquote>So, when does the compiler infer weakly polymorphic types? As\n      we've seen, we need weakly polymorphic types when a value of unknown\n      type is stored in a persistent mutable cell. Because the type system\n      isn't precise enough to determine all cases where this might happen,\n      OCaml uses a rough rule to flag cases that don't introduce any\n      persistent mutable cells, and to only infer polymorphic types in those\n      cases. This rule is called <span><em>the value\n      restriction</em></span>.<a name=\"idm181615913776\"></a></blockquote>")))
 (idm181615918288
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Note that the type of <code>remember</code>\n    was settled by the definition of <code>remember_three</code>, even though <code>remember_three</code> was never called!</blockquote>")))
 (idm181615927744
  ((file imperative-programming-1.html)
   (html
    "<blockquote>OCaml will convert a weakly polymorphic variable to a concrete type\n    as soon as it gets a clue as to what concrete type it is to be used\n    as:</blockquote>")))
 (idm181615932064
  ((file imperative-programming-1.html)
   (html
    "<blockquote>The underscore in the type variable <code>'_a</code> tells us that the variable is only\n    <span><em>weakly polymorphic</em></span>, which is to say that it can be\n    used with any <span><em>single</em></span> type. That makes sense because,\n    unlike <code>identity</code>, <code>remember</code> always returns the value it was passed\n    on its first invocation, which means its return value must always have the\n    same type.<a name=\"idm181615928768\"></a></blockquote>")))
 (idm181615936240
  ((file imperative-programming-1.html)
   (html
    "<blockquote>This is not what happens with <code>remember</code>, though. As you\n      can see from the above examples, the type that OCaml infers for <code>remember</code> looks almost, but not quite, like the type of the identity function.\n      Here it is again:</blockquote>")))
 (idm181615937376
  ((file imperative-programming-1.html)
   (html
    "<blockquote>As you can see, the polymorphic type of <code>identity</code> lets it operate on values with\n    different types.</blockquote>")))
 (idm181615950240
  ((file imperative-programming-1.html)
   (html
    "<blockquote>On its first call, <code>remember</code>\n    returns the same value it's passed, which means its input type and return\n    type should match. Accordingly, <code>remember</code> should have type <code>t -&gt; t</code> for some type <code>t</code>. There's nothing about <code>remember</code> that ties the choice of <code>t</code> to any particular type, so you might expect\n    OCaml to generalize, replacing <code>t</code> with a\n    polymorphic type variable. It's this kind of generalization that gives us\n    polymorphic types in the first place. The identity function, as an\n    example, gets a polymorphic type in this way:</blockquote>")))
 (idm181615951248
  ((file imperative-programming-1.html)
   (html
    "<blockquote><code>remember</code> is not a terribly useful\n    function, but it raises an interesting question: what is its type?</blockquote>")))
 (idm181615953616
  ((file imperative-programming-1.html)
   (html
    "<blockquote><code>remember</code> simply caches the first\n    value that's passed to it, returning that value on every call. That's\n    because <code>cache</code> is created and\n    initialized once and is shared across invocations of <code>remember</code>.</blockquote>")))
 (idm181615966704
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Consider the following simple, imperative function:<a name=\"idm181615966384\"></a><a name=\"idm181615965072\"></a><a name=\"idm181615964160\"></a><a name=\"IPsideweak\"></a></blockquote>")))
 (idm181615969104
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Here, you can see that the subexpression that came last was actually\n    evaluated first! This is generally the case for many different kinds of\n    expressions. If you want to make sure of the evaluation order of different\n    subexpressions, you should express them as a series of <code>let</code> bindings.</blockquote>")))
 (idm181615977888
  ((file imperative-programming-1.html)
   (html "<blockquote>Consider the following example:</blockquote>")))
 (idm181615979184
  ((file imperative-programming-1.html)
   (html
    "<blockquote>In a strict language, we know that expressions that are bound by a\n    sequence of <code>let</code> bindings will be evaluated in the order\n    that they're defined. But what about the evaluation order within a single\n    expression? Officially, the answer is that evaluation order within an\n    expression is undefined. In practice, OCaml has only one compiler, and\n    that behavior is a kind of de facto standard. Unfortunately, the\n    evaluation order in this case is often the opposite of what one might\n    expect.</blockquote>")))
 (idm181615979904
  ((file imperative-programming-1.html)
   (html
    "<blockquote>OCaml is strict by default for a good reason: lazy evaluation and\n    imperative programming generally don't mix well because laziness makes it\n    harder to reason about when a given side effect is going to occur.\n    Understanding the order of side effects is essential to reasoning about\n    the behavior of an imperative program.</blockquote>")))
 (idm181615988800
  ((file imperative-programming-1.html)
   (html
    "<blockquote>We can confirm that fact by a few well-placed <code>printf</code>s:</blockquote>")))
 (idm181615997136
  ((file imperative-programming-1.html)
   (html
    "<blockquote>It doesn't have to be this way. Using the <code>lazy</code> keyword, we can write the original\n    computation so that <code>sin 128.</code> won't ever\n    be computed:</blockquote>")))
 (idm181615999600
  ((file imperative-programming-1.html)
   (html
    "<blockquote>In some sense, we don't really need to compute the <code>sin 128.</code> because <code>sin\n    75.</code> is negative, so we could know the answer before even\n    computing <code>sin 128.</code>.</blockquote>")))
 (idm181616007376
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Consider the following simple example. Here, we have a collection of\n    angles, and we want to determine if any of them have a negative <code>sin</code>. The following snippet of code would answer\n    that question:</blockquote>")))
 (idm181616013728
  ((file imperative-programming-1.html)
   (html
    "<blockquote>The order in which expressions are evaluated is an important part of the definition of a\n      programming language, and it is particularly important when programming imperatively. Most\n      programming languages you're likely to have encountered are <span><em>strict</em></span>, and\n      OCaml is, too. In a strict language, when you bind an identifier to the result of some\n      expression, the expression is evaluated before the variable is bound. Similarly, if you call a\n      function on a set of arguments, those arguments are evaluated before they are passed to the\n        function.<a name=\"idm181616012496\"></a><a name=\"idm181616011584\"></a><a name=\"idm181616010656\"></a><a name=\"idm181616009744\"></a><a name=\"idm181616008832\"></a></blockquote>")))
 (idm181616017328
  ((file imperative-programming-1.html)
   (html
    "<blockquote>This is just a taste of the functionality of <code>In_channel</code> and <code>Out_channel</code>. To get a fuller understanding,\n      you should review the API documentation for those modules.<a name=\"idm181616015616\"></a></blockquote>")))
 (idm181616026016
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Another misfeature of our implementation of <code>sum_file</code> is that we read the entire file into\n      memory before processing it. For a large file, it's more efficient to\n      process a line at a time. You can use the <code>In_channel.fold_lines</code> function to do just\n      that:</blockquote>")))
 (idm181616035824
  ((file imperative-programming-1.html)
   (html
    "<blockquote><code>In_channel</code> has functions that\n      automate the handling of some of these details. For example, <code>In_channel.with_file</code> takes a filename and a\n      function for processing data from an <code>in_channel</code> and takes care of the bookkeeping\n      associated with opening and closing the file. We can rewrite <code>sum_file</code> using this function, as shown\n      here:</blockquote>")))
 (idm181616036432
  ((file imperative-programming-1.html)
   (html
    "<blockquote>This is really an example of a more general issue with imperative\n      programming. When programming imperatively, you need to be quite careful\n      to make sure that exceptions don't leave you in an awkward state.</blockquote>")))
 (idm181616042704
  ((file imperative-programming-1.html)
   (html
    "<blockquote>And now, the file descriptor leak is gone:</blockquote>")))
 (idm181616052352
  ((file imperative-programming-1.html)
   (html
    "<blockquote>To avoid this, we need to make sure that our code cleans up after\n      itself. We can do this using the <code>protect</code> function described in <a href=\"error-handling.html\">ChapterÂ 7, <i>Error Handling</i></a>, as follows:</blockquote>")))
 (idm181616052832
  ((file imperative-programming-1.html)
   (html
    "<blockquote>And now, you'll need to restart your toplevel if you want to open\n      any more files!</blockquote>")))
 (idm181616059232
  ((file imperative-programming-1.html)
   (html
    "<blockquote>And if we do this over and over in a loop, we'll eventually run\n      out of file descriptors:</blockquote>")))
 (idm181616063808
  ((file imperative-programming-1.html)
   (html
    "<blockquote>One problem with the preceding code is that if it throws an\n      exception in the middle of its work, it won't actually close the file.\n      If we try to read a file that doesn't actually contain numbers, we'll\n      see such an error:</blockquote>")))
 (idm181616064512
  ((file imperative-programming-1.html)
   (html
    "<blockquote>For both of these functions, we followed the same basic sequence:\n      we first create the channel, then use the channel, and finally close the\n      channel. The closing of the channel is important, since without it, we\n      won't release resources associated with the file back to the operating\n      system.</blockquote>")))
 (idm181616085088
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Another common use of <code>in_channel</code>s and <code>out_channel</code>s is for working with files. Here\n      are a couple of functionsâ\128\148one that creates a file full of numbers, and\n      the other that reads in such a file and returns the sum of those\n      numbers:<a name=\"idm181616109040\"></a><a name=\"idm181616081952\"></a></blockquote>")))
 (idm181616087280
  ((file imperative-programming-1.html)
   (html
    "<blockquote>All of this, and a good deal more, is described in the API\n      documentation for the <code>Printf</code> module\n      in the OCaml Manual.</blockquote>")))
 (idm181616088480
  ((file imperative-programming-1.html)
   (html
    "<blockquote><code>sprintf</code>, which returns a\n          formatted string</blockquote>")))
 (idm181616090320
  ((file imperative-programming-1.html)
   (html
    "<blockquote><code>fprintf</code>, which prints to an\n          arbitrary <code>out_channel</code></blockquote>")))
 (idm181616092144
  ((file imperative-programming-1.html)
   (html
    "<blockquote><code>eprintf</code>, which prints to\n          <code>stderr</code></blockquote>")))
 (idm181616097152
  ((file imperative-programming-1.html)
   (html
    "<blockquote>There are also <code>printf</code>-style\n      functions that target outputs other than <code>stdout</code>, including:<a name=\"idm181616095520\"></a><a name=\"idm181616094608\"></a><a name=\"idm181616093696\"></a></blockquote>")))
 (idm181616097824
  ((file imperative-programming-1.html)
   (html "<blockquote>Precision of float conversions</blockquote>")))
 (idm181616098672
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Whether numbers should be formatted in decimal, hex, or\n          binary</blockquote>")))
 (idm181616099472
  ((file imperative-programming-1.html)
   (html "<blockquote>Escaping rules for strings</blockquote>")))
 (idm181616100272
  ((file imperative-programming-1.html)
   (html "<blockquote>Alignment and padding</blockquote>")))
 (idm181616105520
  ((file imperative-programming-1.html)
   (html
    "<blockquote><code>printf</code>'s formatting directives\n      offer a significant amount of control, allowing you to specify things\n      like:<a name=\"idm181616104624\"></a><a name=\"idm181616103696\"></a><a name=\"idm181616102768\"></a><a name=\"idm181616101840\"></a></blockquote>")))
 (idm181616107888
  ((file imperative-programming-1.html)
   (html
    "<blockquote>In the preceding example, we've used only two formatting\n      directives: <code>%s</code>, for including a\n      string, and <code>%!</code> which causes <code>printf</code> to flush the channel.</blockquote>")))
 (idm181616112384
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Now let's see how we can rewrite our time conversion program to be\n      a little more concise using <code>printf</code>:</blockquote>")))
 (idm181616114224
  ((file imperative-programming-1.html)
   (html
    "<blockquote>If this looks different from everything else you've seen so far,\n        that's because it is. This is really a special case in the type\n        system. Most of the time, you don't need to worry about this special\n        handling of format stringsâ\128\148you can just use <code>printf</code> and not worry about the details. But\n        it's useful to keep the broad outlines of the story in the back of\n        your head.</blockquote>")))
 (idm181616119568
  ((file imperative-programming-1.html)
   (html
    "<blockquote>And accordingly, we can pass it to <code>printf</code>:</blockquote>")))
 (idm181616124976
  ((file imperative-programming-1.html)
   (html
    "<blockquote>If OCaml infers that a given string literal is a format string,\n        then it parses it at compile time as such, choosing its type in\n        accordance with the formatting directives it finds. Thus, if we add a\n        type annotation indicating that the string we're defining is actually\n        a format string, it will be interpreted as such:</blockquote>")))
 (idm181616134928
  ((file imperative-programming-1.html)
   (html
    "<blockquote>To check this, OCaml needs to analyze the contents of the format\n        string at compile time, which means the format string needs to be\n        available as a string literal at compile time. Indeed, if you try to\n        pass an ordinary string to <code>printf</code>,\n        the compiler will complain:</blockquote>")))
 (idm181616136960
  ((file imperative-programming-1.html)
   (html
    "<blockquote>The format strings used by <code>printf</code> turn out to be quite different from\n        ordinary strings. This difference ties to the fact that OCaml format\n        strings, unlike their equivalent in C, are type-safe. In particular,\n        the compiler checks that the types referred to by the format string\n        match the types of the rest of the arguments passed to <code>printf</code>.</blockquote>")))
 (idm181616144752
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Unlike C's <code>printf</code>, the <code>printf</code> in OCaml is type-safe. In particular,\n      if we provide an argument whose type doesn't match what's presented in\n      the format string, we'll get a type error:</blockquote>")))
 (idm181616158304
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Generating output with functions like <code>Out_channel.output_string</code> is simple and easy\n      to understand, but can be a bit verbose. OCaml also supports formatted\n      output using the <code>printf</code> function,\n      which is modeled after <code>printf</code> in the\n      C standard library. <code>printf</code> takes a\n      <span><em>format string</em></span> that describes what to print and how\n      to format it, as well as arguments to be printed, as determined by the\n      formatting directives embedded in the format string. So, for example, we\n      can write:<a name=\"idm181616154560\"></a><a name=\"idm181616153264\"></a><a name=\"idm181616152368\"></a><a name=\"idm181616151472\"></a></blockquote>")))
 (idm181616163488
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Note that <code>In_channel.input_line</code>\n      returns a <code>string option</code>, with\n      <code>None</code> indicating that the input stream\n      has ended (i.e., an end-of-file condition). <code>Out_channel.output_string</code> is used to print the\n      final output, and <code>Out_channel.flush</code>\n      is called to flush that output to the screen. The final flush is not\n      technically required, since the program ends after that instruction, at\n      which point all remaining output will be flushed anyway, but the\n      explicit flush is nonetheless good practice.</blockquote>")))
 (idm181616166896
  ((file imperative-programming-1.html)
   (html
    "<blockquote>We called <code>Out_channel.flush</code> on\n      <code>stdout</code> because <code>out_channel</code>s are buffered, which is to say\n      that OCaml doesn't immediately do a write every time you call <code>output_string</code>. Instead, writes are buffered\n      until either enough has been written to trigger the flushing of the\n      buffers, or until a flush is explicitly requested. This greatly\n      increases the efficiency of the writing process by reducing the number\n      of system calls.</blockquote>")))
 (idm181616170736
  ((file imperative-programming-1.html)
   (html
    "<blockquote>You can then type in the name of a time zone and hit Return, and\n      it will print out the current time in the time zone in question:</blockquote>")))
 (idm181616176816
  ((file imperative-programming-1.html)
   (html
    "<blockquote>We can build this program using <span><strong>corebuild</strong></span> and run it. You'll see that it\n      prompts you for input, as follows:</blockquote>")))
 (idm181616181888
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Let's see this in action in a simple interactive application. The\n      following program, <code>time_converter</code>,\n      prompts the user for a time zone, and then prints out the current time\n      in that time zone. Here, we use Core's <code>Zone</code> module for looking up a time zone, and\n      the <code>Time</code> module for computing the\n      current time and printing it out in the time zone in question:</blockquote>")))
 (idm181616185664
  ((file imperative-programming-1.html)
   (html
    "<blockquote>The values <code>stdin</code>, <code>stdout</code>, and <code>stderr</code> are useful enough that they are also\n      available in the global namespace directly, without having to go through\n      the <code>In_channel</code> and <code>Out_channel</code> modules.</blockquote>")))
 (idm181616187200
  ((file imperative-programming-1.html)
   (html
    "<blockquote>The &quot;standard error&quot; channel. This is similar to <code>stdout</code> but is intended for error\n            messages.</blockquote>")))
 (idm181616189904
  ((file imperative-programming-1.html)
   (html
    "<blockquote>The &quot;standard output&quot; channel. By default, output written to\n            <code>stdout</code> appears on the user\n            terminal.</blockquote>")))
 (idm181616191968
  ((file imperative-programming-1.html)
   (html
    "<blockquote>The &quot;standard input&quot; channel. By default, input comes from\n            the terminal, which handles keyboard input.</blockquote>")))
 (idm181616194144
  ((file imperative-programming-1.html)
   (html
    "<blockquote>We'll start our discussion of I/O by focusing on the terminal.\n      Following the UNIX model, communication with the terminal is organized\n      around three channels, which correspond to the three standard file\n      descriptors in Unix:</blockquote>")))
 (idm181616201664
  ((file imperative-programming-1.html)
   (html
    "<blockquote>OCaml's buffered I/O library is organized around two types:\n      <code>in_channel</code>, for channels you read\n      from, and <code>out_channel</code>, for channels\n      you write to. The <code>In_channel</code> and\n      <code>Out_channel</code> modules only have direct\n      support for channels corresponding to files and terminals; other kinds\n      of channels can be created through the <code>Unix</code> module.<a name=\"idm181616197840\"></a><a name=\"idm181616196512\"></a><a name=\"idm181616195184\"></a></blockquote>")))
 (idm181616208496
  ((file imperative-programming-1.html)
   (html
    "<blockquote>There are multiple I/O libraries in OCaml. In this section we'll discuss OCaml's buffered\n      I/O library that can be used through the <code>In_channel</code> and\n        <code>Out_channel</code> modules in Core. Other I/O primitives are\n      also available through the <code>Unix</code> module in Core as well as\n        <code>Async</code>, the asynchronous I/O library that is covered in\n        <a href=\"concurrent-programming-with-async.html\">ChapterÂ 18, <i>Concurrent Programming with Async</i></a>. Most of the functionality in Core's\n        <code>In_channel</code> and <code>Out_channel</code> (and in Core's <code>Unix</code> module)\n      derives from the standard library, but we'll use Core's interfaces here.</blockquote>")))
 (idm181616212320
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Imperative programming is about more than modifying in-memory data\n    structures. Any function that doesn't boil down to a deterministic\n    transformation from its arguments to its return value is imperative in\n    nature. That includes not only things that mutate your program's data, but\n    also operations that interact with the world outside of your program. An\n    important example of this kind of interaction is I/O, i.e., operations for\n    reading or writing data to things like files, terminal input and output,\n    and network sockets.<a name=\"idm181616211504\"></a><a name=\"IPinpout\"></a></blockquote>")))
 (idm181616214768
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Laziness is more constrained than explicit mutation, and so in\n        some cases can lead to code whose behavior is easier to think\n        about.<a name=\"idm181616214352\"></a></blockquote>")))
 (idm181616225232
  ((file imperative-programming-1.html)
   (html
    "<blockquote>But we can also create useful recursive definitions with\n        <code>lazy</code>. In particular, we can use\n        laziness to make our definition of <code>memo_rec</code> work without explicit\n        mutation:</blockquote>")))
 (idm181616230320
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Of course, actually trying to compute this will fail. OCaml's\n        <code>lazy</code> throws an exception when a\n        lazy value tries to force itself as part of its own evaluation.</blockquote>")))
 (idm181616235472
  ((file imperative-programming-1.html)
   (html
    "<blockquote>It's worth noting that these restrictions don't show up in a\n        lazy language like Haskell. Indeed, we can make something like our\n        definition of <code>x</code> work if we use\n        OCaml's laziness:</blockquote>")))
 (idm181616238144
  ((file imperative-programming-1.html)
   (html
    "<blockquote>To avoid such impossible cases, the compiler only allows three\n        possible constructs to show up on the righthand side of a <code>let rec</code>: a function definition, a\n        constructor, or the lazy keyword. This excludes some reasonable\n        things, like our definition of <code>memo_rec</code>, but it also blocks things that\n        don't make sense, like our definition of <code>x</code>.</blockquote>")))
 (idm181616241424
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Note that <code>x</code> is an ordinary\n        value, not a function. As such, it's not clear how this definition\n        should be handled by the compiler. You could imagine it compiling down\n        to an infinite loop, but <code>x</code> is of\n        type <code>int</code>, and there's no <code>int</code> that corresponds to an infinite loop. As\n        such, this construct is effectively impossible to compile.</blockquote>")))
 (idm181616244928
  ((file imperative-programming-1.html)
   (html
    "<blockquote>OCaml rejects the definition because OCaml, as a strict\n        language, has limits on what it can put on the righthand side of a\n        <code>let rec</code>. In particular, imagine how\n        the following code snippet would be compiled:</blockquote>")))
 (idm181616254976
  ((file imperative-programming-1.html)
   (html
    "<blockquote>You might wonder why we didn't tie the recursive knot in\n        <code>memo_rec</code> using <code>let rec</code>, as we did for <code>make_rec</code> earlier. Here's code that tries to\n        do just that:<a name=\"idm181616252608\"></a></blockquote>")))
 (idm181616261728
  ((file imperative-programming-1.html)
   (html
    "<blockquote>This new version of <code>edit_distance</code> is much more efficient than the\n      one we started with; the following call is many thousands of times\n      faster than it was without memoization:</blockquote>")))
 (idm181616279152
  ((file imperative-programming-1.html)
   (html
    "<blockquote>But memoization is a good approach for optimizing <code>edit_distance</code>, and we can apply the same\n      approach we used on <code>fib</code> here. We will\n      need to change <code>edit_distance</code> to take\n      a pair of strings as a single argument, since <code>memo_rec</code> only works on single-argument\n      functions. (We can always recover the original interface with a wrapper\n      function.) With just that change and the addition of the <code>memo_rec</code> call, we can get a memoized version\n      of <code>edit_distance</code>:</blockquote>")))
 (idm181616281040
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Memoization is overkill for implementing Fibonacci, and indeed,\n      the <code>fib</code> defined above is not\n      especially efficient, allocating space linear in the number passed in to\n      <code>fib</code>. It's easy enough to write a\n      Fibonacci function that takes a constant amount of space.</blockquote>")))
 (idm181616287568
  ((file imperative-programming-1.html)
   (html
    "<blockquote>We can use <code>memo_rec</code> as part of\n      a single declaration that makes this look like it's little more than a\n      special form of <code>let rec</code>:</blockquote>")))
 (idm181616293808
  ((file imperative-programming-1.html)
   (html
    "<blockquote>The memory behavior here is important. If you look back at the\n      definition of <code>memo_rec</code>, you'll see\n      that the call <code>memo_rec fib_norec</code> does\n      not trigger a call to <code>memoize</code>. Only\n      when <code>fib</code> is called and thereby the\n      final argument to <code>memo_rec</code> is\n      presented does <code>memoize</code> get called.\n      The result of that call falls out of scope when the <code>fib</code> call returns, and so calling <code>memo_rec</code> on a function does not create a\n      memory leakâ\128\148the memoization table is collected after the computation\n      completes.</blockquote>")))
 (idm181616294272
  ((file imperative-programming-1.html)
   (html
    "<blockquote>And as you can see, the exponential time complexity is now\n      gone.</blockquote>")))
 (idm181616302384
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Using <code>memo_rec</code>, we can now\n      build an efficient version of <code>fib</code>:</blockquote>")))
 (idm181616303584
  ((file imperative-programming-1.html)
   (html
    "<blockquote>We're using the reference here as a way of tying the recursive\n      knot without using a <code>let rec</code>, which\n      for reasons we'll describe later wouldn't work here.</blockquote>")))
 (idm181616305232
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Note that <code>memo_rec</code> has the same\n      signature as <code>make_rec</code>.</blockquote>")))
 (idm181616314544
  ((file imperative-programming-1.html)
   (html
    "<blockquote>This is clever enough, but all we've really done is find a new way\n      to implement the same old slow Fibonacci function. To make it faster, we\n      need a variant of <code>make_rec</code> that\n      inserts memoization when it ties the recursive knot. We'll call that\n      function <code>memo_rec</code>:</blockquote>")))
 (idm181616318528
  ((file imperative-programming-1.html)
   (html
    "<blockquote>This is a pretty strange piece of code, and it may take a few moments of thought to\n        figure out what's going on. Like <code>fib_norec</code>, the function\n          <code>f_norec</code> passed into <code>make_rec</code> is a function that isn't recursive but takes as an argument a function\n        that it will call. What <code>make_rec</code> does is to essentially\n        feed <code>f_norec</code> to itself, thus making it a true recursive\n        function.</blockquote>")))
 (idm181616329232
  ((file imperative-programming-1.html)
   (html
    "<blockquote>We can even write a polymorphic function that we'll call <code>make_rec</code> that can tie the recursive knot for\n      any function of this form:</blockquote>")))
 (idm181616335360
  ((file imperative-programming-1.html)
   (html
    "<blockquote>We can now turn this back into an ordinary Fibonacci function by\n      tying the recursive knot:</blockquote>")))
 (idm181616343296
  ((file imperative-programming-1.html)
   (html
    "<blockquote>In order to make <code>fib</code> fast, our\n      first step will be to rewrite <code>fib</code> in\n      a way that unwinds the recursion. The following version expects as its\n      first argument a function (called <code>fib</code>) that will be called in lieu of the usual\n      recursive call:</blockquote>")))
 (idm181616354704
  ((file imperative-programming-1.html)
   (html
    "<blockquote>So, how can we use memoization to make this faster? The tricky bit\n      is that we need to insert the memoization before the recursive calls\n      within <code>fib</code>. We can't just define\n      <code>fib</code> in the ordinary way and memoize\n      it after the fact and expect the first call to <code>fib</code> to be improved:</blockquote>")))
 (idm181616356464
  ((file imperative-programming-1.html)
   (html
    "<blockquote>As you can see, <code>fib 40</code> takes\n      thousands of times longer to compute than <code>fib\n      20</code>.</blockquote>")))
 (idm181616365264
  ((file imperative-programming-1.html)
   (html
    "<blockquote>This is, however, exponentially slow, for the same reason that\n      <code>edit_distance</code> was slow: we end up\n      making many redundant calls to <code>fib</code>.\n      It shows up quite dramatically in the performance:</blockquote>")))
 (idm181616375856
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Memoization would be a huge help here, but to fix the problem, we\n      need to memoize the calls that <code>edit_distance</code> makes to itself. This technique\n      is sometimes referred to as <span><em>dynamic programming</em></span>. To\n      see how to do this, let's step away from <code>edit_distance</code> and instead consider a much\n      simpler example: computing the <span><em>n</em></span>th element of the\n      Fibonacci sequence. The Fibonacci sequence by definition starts out with\n      two <code>1</code>s, with every subsequent element\n      being the sum of the previous two. The classic recursive definition of\n      Fibonacci is as follows:<a name=\"idm181616372336\"></a><a name=\"idm181616371024\"></a></blockquote>")))
 (idm181616376320
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Just those few extra characters made it thousands of times\n      slower!</blockquote>")))
 (idm181616383968
  ((file imperative-programming-1.html)
   (html
    "<blockquote>And now we can use this to try out some examples:</blockquote>")))
 (idm181616393280
  ((file imperative-programming-1.html)
   (html
    "<blockquote>As you can see, some of these calls are repeats. For example,\n      there are two different calls to <code>edit_distance\n      &quot;OCam&quot; &quot;oca&quot;</code>. The number of redundant calls grows\n      exponentially with the size of the strings, meaning that our\n      implementation of <code>edit_distance</code> is\n      brutally slow for large strings. We can see this by writing a small\n      timing function:</blockquote>")))
 (idm181616397200
  ((file imperative-programming-1.html)
   (html
    "<blockquote>And these calls will in turn dispatch other calls:</blockquote>")))
 (idm181616401824
  ((file imperative-programming-1.html)
   (html
    "<blockquote>The thing to note is that if you call <code>edit_distance &quot;OCaml&quot; &quot;ocaml&quot;</code>, then that will\n      in turn dispatch the following calls:</blockquote>")))
 (idm181616418768
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Consider the following code for computing the edit distance.\n      Understanding the algorithm isn't important here, but you should pay\n      attention to the structure of the recursive calls:<a name=\"idm181616418304\"></a></blockquote>")))
 (idm181616423440
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Memoization is also useful for efficiently implementing some recursive algorithms. One\n        good example is the algorithm for computing the <span><em>edit distance</em></span> (also\n        called the Levenshtein distance) between two strings. The edit distance is the number of\n        single-character changes (including letter switches, insertions, and deletions) required to\n          <span>convert</span> one string to the other. This kind of\n        distance metric can be useful for a variety of approximate string-matching problems, like\n          spellcheckers.<a name=\"idm181616421600\"></a><a name=\"idm181616420704\"></a><a name=\"idm181616419792\"></a></blockquote>")))
 (idm181616424160
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Memoization can be useful whenever you have a function that is\n      expensive to recompute and you don't mind caching old values\n      indefinitely. One important caution: a memoized function by its nature\n      leaks memory. As long as you hold on to the memoized function, you're\n      holding every result it has returned thus far.</blockquote>")))
 (idm181616432000
  ((file imperative-programming-1.html)
   (html
    "<blockquote>The preceding code is a bit tricky. <code>memoize</code> takes as its argument a function\n      <code>f</code> and then allocates a hash table\n      (called <code>table</code>) and returns a new\n      function as the memoized version of <code>f</code>. When called, this new function looks in\n      <code>table</code> first, and if it fails to find\n      a value, calls <code>f</code> and stashes the\n      result in <code>table</code>. Note that <code>table</code> doesn't go out of scope as long as the\n      function returned by <code>memoize</code> is in\n      scope.<a name=\"idm181616425600\"></a></blockquote>")))
 (idm181616443840
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Here's a function that takes as an argument an arbitrary\n      single-argument function and returns a memoized version of that\n      function. Here we'll use Core's <code>Hashtbl</code> module, rather than our toy <code>Dictionary</code>:</blockquote>")))
 (idm181616447696
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Another benign effect is <span><em>memoization</em></span>. A\n      memoized function remembers the result of previous invocations of the\n      function so that they can be returned without further computation when\n      the same arguments are presented again.<a name=\"idm181616446800\"></a><a name=\"BEmem\"></a></blockquote>")))
 (idm181616451216
  ((file imperative-programming-1.html)
   (html
    "<blockquote>The main user-visible difference between our implementation of\n    laziness and the built-in version is syntax. Rather than writing <code>create_lazy (fun () -&gt; sqrt 16.)</code>, we can\n    (with the built-in <code>lazy</code>) just write\n    <code>lazy (sqrt 16.)</code>.</blockquote>")))
 (idm181616458560
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Which we can use in the same way we used <code>Lazy.force</code>:</blockquote>")))
 (idm181616470784
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Now we just need a way to force a lazy value. The following function\n    does just that:</blockquote>")))
 (idm181616479040
  ((file imperative-programming-1.html)
   (html
    "<blockquote>We can create a lazy value from a thunk, i.e., a function that takes\n    a unit argument. Wrapping an expression in a thunk is another way to\n    suspend the computation of an expression:<a name=\"idm181616478592\"></a></blockquote>")))
 (idm181616486992
  ((file imperative-programming-1.html)
   (html
    "<blockquote>A <code>lazy_state</code> represents the\n    possible states of a lazy value. A lazy value is <code>Delayed</code> before it has been run, where <code>Delayed</code> holds a function for computing the value\n    in question. A lazy value is in the <code>Value</code> state when it has been forced and the\n    computation ended normally. The <code>Exn</code>\n    case is for when the lazy value has been forced, but the computation ended\n    with an exception. A lazy value is simply a <code>ref</code> containing a <code>lazy_state</code>, where the <code>ref</code> makes it possible to change from being in\n    the <code>Delayed</code> state to being in the\n    <code>Value</code> or <code>Exn</code> states.</blockquote>")))
 (idm181616494208
  ((file imperative-programming-1.html)
   (html
    "<blockquote>To better understand how laziness works, let's walk through the\n    implementation of our own lazy type. We'll start by declaring types to\n    represent a lazy value:</blockquote>")))
 (idm181616495792
  ((file imperative-programming-1.html)
   (html
    "<blockquote>You can see from the <code>print</code> statement that the\n    actual computation was performed only once, and only after <code>force</code> had been called.</blockquote>")))
 (idm181616507568
  ((file imperative-programming-1.html)
   (html
    "<blockquote>One of the simplest benign effects is <span><em>laziness</em></span>.\n    A lazy value is one that is not computed until it is actually needed. In\n    OCaml, lazy values are created using the <code>lazy</code> keyword, which can be used to convert any\n    expression of type <code>s</code> into a lazy value\n    of type <code>s Lazy.t</code>. The evaluation of\n    that expression is delayed until forced with <code>Lazy.force</code>:</blockquote>")))
 (idm181616514032
  ((file imperative-programming-1.html)
   (html
    "<blockquote>There are many instances where you basically want to program in a\n    pure style, but you want to make limited use of side effects to improve\n    the performance of your code. Such side effects are sometimes called\n    <span><em>benign effects</em></span>, and they are a useful way of\n    leveraging OCaml's imperative features while still maintaining most of the\n    benefits of pure programming.<a name=\"idm181616513008\"></a><a name=\"idm181616512112\"></a><a name=\"idm181616511216\"></a><a name=\"idm181616510320\"></a><a name=\"idm181616509024\"></a></blockquote>")))
 (idm181616517360
  ((file imperative-programming-1.html)
   (html
    "<blockquote>This completes our implementation, but there's still considerably\n      more work to be done to make a really usable doubly linked list. As\n      mentioned earlier, you're probably better off using something like\n      Core's <code>Doubly_linked</code> module that has\n      a more complete interface and has more of the tricky corner cases worked\n      out. Nonetheless, this example should serve to demonstrate some of the\n      techniques you can use to build nontrivial imperative data structure in\n      OCaml, as well as some of the pitfalls.<a name=\"idm181616515952\"></a></blockquote>")))
 (idm181616526832
  ((file imperative-programming-1.html)
   (html
    "<blockquote><code>Dlist</code> has two such iterators:\n      <code>iter</code>, the goal of which is to call a\n      <code>unit</code>-producing function on every\n      element of the list, in order; and <code>find_el</code>, which runs a provided test function\n      on each values stored in the list, returning the first <code>element</code> that passes the test. Both <code>iter</code> and <code>find_el</code> are implemented using simple recursive\n      loops that use <code>next</code> to walk from\n      element to element and <code>value</code> to\n      extract the element from a given node:</blockquote>")))
 (idm181616531584
  ((file imperative-programming-1.html)
   (html
    "<blockquote>When defining containers like lists, dictionaries, and trees,\n      you'll typically want to define a set of iteration functions like\n      <code>iter</code>, <code>map</code>, and <code>fold</code>, which let you concisely express common\n      iteration patterns.<a name=\"idm181616529184\"></a><a name=\"idm181616527872\"></a></blockquote>")))
 (idm181616537776
  ((file imperative-programming-1.html)
   (html
    "<blockquote>This shouldn't be a big surprise. Complex imperative data\n      structures can be quite tricky, considerably trickier than their pure\n      equivalents. The issues described previously can be dealt with by more\n      careful error detection, and such error correction is taken care of in\n      modules like Core's <code>Doubly_linked</code>.\n      You should use imperative data structures from a well-designed library\n      when you can. And when you can't, you should make sure to put great care\n      into your error handling.<a name=\"idm181616536560\"></a><a name=\"idm181616535248\"></a><a name=\"idm181616534336\"></a></blockquote>")))
 (idm181616539168
  ((file imperative-programming-1.html)
   (html
    "<blockquote>These functions are more fragile than they may seem. In\n      particular, misuse of the interface may lead to corrupted data. For\n      example, double-removing an element will cause the main list reference\n      to be set to <code>None</code>, thus emptying the\n      list. Similar problems arise from removing an element from a list it\n      doesn't belong to.</blockquote>")))
 (idm181616541712
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Note that the preceding code is careful to change the <code>prev</code> pointer of the following element and the\n      <code>next</code> pointer of the previous element,\n      if they exist. If there's no previous element, then the list pointer\n      itself is updated. In any case, the next and previous pointers of the\n      element itself are set to <code>None</code>.</blockquote>")))
 (idm181616545712
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Finally, we need a <code>remove</code>\n      function:</blockquote>")))
 (idm181616550992
  ((file imperative-programming-1.html)
   (html
    "<blockquote>We can use <code>insert_after</code> to\n      insert elements later in the list. <code>insert_after</code> takes as arguments both an\n      <code>element</code> after which to insert the new\n      node and a value to insert:</blockquote>")))
 (idm181616591840
  ((file imperative-programming-1.html)
   (html
    "<blockquote><code>insert_first</code> first defines a\n      new element <code>new_elt</code>, and then links\n      it into the list, finally setting the list itself to point to <code>new_elt</code>. Note that the precedence of a\n      <code>match</code> expression is very low, so to\n      separate it from the following assignment (<code>t :=\n      Some new_elt</code>), we surround the match with <code>begin ... end</code>. We could have used parentheses\n      for the same purpose. Without some kind of bracketing, the final\n      assignment would incorrectly become part of the <code>None</code> case.<a name=\"idm181616552416\"></a></blockquote>")))
 (idm181616562400
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Now, we'll start considering operations that mutate the list,\n      starting with <code>insert_first</code>, which\n      inserts an element at the front of the list:<a name=\"idm181616561344\"></a></blockquote>")))
 (idm181616563952
  ((file imperative-programming-1.html)
   (html
    "<blockquote>This approach is quite limited, however. General-purpose cyclic\n      data structures require mutation.</blockquote>")))
 (idm181616570400
  ((file imperative-programming-1.html)
   (html
    "<blockquote>There is an exception to this, though: you can construct\n      fixed-size cyclic data structures using <code>let\n      rec</code>:</blockquote>")))
 (idm181616574256
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Doubly linked lists are a cyclic data structure, meaning that it\n      is possible to follow a nontrivial sequence of pointers that closes in\n      on itself. In general, building cyclic data structures requires the use\n      of side effects. This is done by constructing the data elements first,\n      and then adding cycles using assignment afterward.<a name=\"idm181616573632\"></a><a name=\"idm181616572736\"></a><a name=\"idm181616571440\"></a></blockquote>")))
 (idm181616575392
  ((file imperative-programming-1.html)
   (html
    "<blockquote>These all follow relatively straightforwardly from our type\n    definitions.</blockquote>")))
 (idm181616578368
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Now we can define a few basic functions that operate on lists and\n    elements:</blockquote>")))
 (idm181616581472
  ((file imperative-programming-1.html)
   (html
    "<blockquote>The type of the list itself, <code>'a\n    t</code>, is a mutable reference to an optional <code>element</code>. This reference is <code>None</code> if the list is empty, and <code>Some</code> otherwise.</blockquote>")))
 (idm181616585360
  ((file imperative-programming-1.html)
   (html
    "<blockquote>An <code>'a element</code> is a record\n    containing the value to be stored in that node as well as optional (and\n    mutable) fields pointing to the previous and next elements. At the\n    beginning of the list, the <code>prev</code> field\n    is <code>None</code>, and at the end of the list,\n    the <code>next</code> field is <code>None</code>.</blockquote>")))
 (idm181616589664
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Now let's look at the implementation. We'll start by defining\n    <code>'a element</code> and <code>'a t</code>:</blockquote>")))
 (idm181616591600
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Note that there are two types defined here: <code>'a t</code>, the type of a list; and <code>'a element</code>, the type of an element. Elements act\n    as pointers to the interior of a list and allow us to navigate the list\n    and give us a point at which to apply mutating operations.</blockquote>")))
 (idm181616595104
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Here's the <code>mli</code> of the module\n    we'll build:</blockquote>")))
 (idm181616600272
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Another common imperative data structure is the doubly linked list.\n    Doubly linked lists can be traversed in both directions, and elements can\n    be added and removed from the list in constant time. Core defines a doubly\n    linked list (the module is called <code>Doubly_linked</code>), but we'll define our own linked\n    list library as an illustration.<a name=\"idm181616599024\"></a><a name=\"idm181616597712\"></a><a name=\"IPdoublink\"></a></blockquote>")))
 (idm181616603808
  ((file imperative-programming-1.html)
   (html
    "<blockquote>In the preceding example, we used <code>incr</code> and <code>decr</code>, which are built-in functions for\n    incrementing and decrementing an <code>int\n    ref</code> by one, respectively.</blockquote>")))
 (idm181616623008
  ((file imperative-programming-1.html)
   (html
    "<blockquote>OCaml also supports <code>while</code> loops,\n    which include a condition and a body. The loop first evaluates the\n    condition, and then, if it evaluates to true, evaluates the body and\n    starts the loop again. Here's a simple example of a function for reversing\n    an array in place:</blockquote>")))
 (idm181616624848
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Note that the loop variable of a <code>for</code> loop, <code>i</code>\n    in this case, is immutable in the scope of the loop and is also local to\n    the loop, i.e., it can't be referenced outside of the loop.</blockquote>")))
 (idm181616632480
  ((file imperative-programming-1.html)
   (html
    "<blockquote>As you can see, the upper and lower bounds are inclusive. We can\n    also use <code>downto</code> to iterate in the other\n    direction:</blockquote>")))
 (idm181616642704
  ((file imperative-programming-1.html)
   (html
    "<blockquote>The <code>for</code> loop is the simpler of\n    the two. Indeed, we've already seen the <code>for</code> loop in actionâ\128\148the <code>iter</code> function in <code>Dictionary</code> is built using it. Here's a simple\n    example of <code>for</code>:</blockquote>")))
 (idm181616648688
  ((file imperative-programming-1.html)
   (html
    "<blockquote>OCaml provides support for traditional imperative looping\n    constructs, in particular, <code>for</code> and\n    <code>while</code> loops. Neither of these\n    constructs is strictly necessary, since they can be simulated with\n    recursive functions. Nonetheless, explicit <code>for</code> and <code>while</code>\n    loops are both more concise and more idiomatic when programming\n    imperatively.<a name=\"idm181616645536\"></a><a name=\"idm181616644624\"></a><a name=\"idm181616643728\"></a></blockquote>")))
 (idm181616658768
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Another source of imperative operations in OCaml is resources that come from interfacing\n        with external libraries through OCaml's foreign function interface (FFI). The FFI opens\n        OCaml up to imperative constructs that are exported by system calls or other external\n        libraries. Many of these come built in, like access to the <code>write</code> system call or to the <code>clock</code>, while\n        others come from user libraries, like LAPACK bindings. OCaml's FFI is discussed in more\n        detail in <a href=\"foreign-function-interface.html\">ChapterÂ 19, <i>Foreign Function Interface</i></a>.<a name=\"idm181616656208\"></a><a name=\"idm181616654896\"></a><a name=\"idm181616653568\"></a><a name=\"idm181616652672\"></a><a name=\"idm181616651328\"></a></blockquote>")))
 (idm181616668032
  ((file imperative-programming-1.html)
   (html
    "<blockquote>The preceding are just ordinary OCaml functions, which could be\n        defined as follows:</blockquote>")))
 (idm181616677696
  ((file imperative-programming-1.html)
   (html "<blockquote>You can see these in action:</blockquote>")))
 (idm181616678512
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Replaces the contents of the reference cell.</blockquote>")))
 (idm181616680480
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Returns the contents of the reference cell.</blockquote>")))
 (idm181616683136
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Constructs a reference cell containing the value defined\n              by the expression <code>expr</code>.</blockquote>")))
 (idm181616685552
  ((file imperative-programming-1.html)
   (html
    "<blockquote>The standard library defines the following operators for working\n        with <code>ref</code>s.</blockquote>")))
 (idm181616690288
  ((file imperative-programming-1.html)
   (html
    "<blockquote>The definition for the <code>ref</code> type is as\n        follows:</blockquote>")))
 (idm181616693008
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Variables in OCaml are never mutableâ\128\148they can refer to mutable\n        data, but what the variable points to can't be changed. Sometimes,\n        though, you want to do exactly what you would do with a mutable\n        variable in another language: define a single, mutable value. In OCaml\n        this is typically achieved using a <code>ref</code>, which is essentially a container with a\n        single mutable polymorphic field.<a name=\"idm181616691312\"></a></blockquote>")))
 (idm181616696304
  ((file imperative-programming-1.html)
   (html
    "<blockquote>As we'll see in <a href=\"objects.html\">ChapterÂ 11, <i>Objects</i></a>, fields of an object\n      can similarly be declared as mutable, and can then be modified in much\n      the same way as record fields.<a name=\"idm181616695376\"></a></blockquote>")))
 (idm181616699472
  ((file imperative-programming-1.html)
   (html
    "<blockquote>As we've seen, records are immutable by default, but individual\n      record fields can be declared as mutable. These mutable fields can be\n      set using the <code>&lt;-</code> operator, i.e.,\n      <code>record.field &lt;- expr</code>.<a name=\"idm181616697712\"></a></blockquote>")))
 (idm181616707488
  ((file imperative-programming-1.html)
   (html
    "<blockquote>A <code>Bigarray.t</code> is a handle to a\n        block of memory stored outside of the OCaml heap. These are mostly\n        useful for interacting with C or Fortran libraries, and are discussed\n        in <a href=\"memory-representation-of-values.html\">ChapterÂ 20, <i>Memory Representation of Values</i></a>. Bigarrays too\n        have their own getting and setting syntax:<a name=\"idm181616705808\"></a></blockquote>")))
 (idm181616709680
  ((file imperative-programming-1.html)
   (html
    "<blockquote>And string literals are bounded by quotes. There's also a module\n        <code>String</code> where you'll find useful\n        functions for working with strings.</blockquote>")))
 (idm181616714112
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Strings also come with their own syntax for getting and setting\n        values:</blockquote>")))
 (idm181616719360
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Strings are essentially byte arrays which are often used for\n        textual data. The main advantage of using a <code>string</code> in place of a <code>Char.t array</code> (a <code>Char.t</code> is an 8-bit character) is that the\n        former is considerably more space-efficient; an array uses one wordâ\128\1488\n        bytes on a 64-bit machineâ\128\148to store a single entry, whereas strings use\n        1 byte per character.<a name=\"idm181616716448\"></a><a name=\"idm181616715552\"></a></blockquote>")))
 (idm181616722784
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Array literals are written using <code>[|</code> and <code>|]</code>\n        as delimiters. Thus, <code>[| 1; 2; 3 |]</code>\n        is a literal integer array.</blockquote>")))
 (idm181616723312
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Out-of-bounds accesses for arrays (and indeed for all the\n        array-like data structures) will lead to an exception being\n        thrown.</blockquote>")))
 (idm181616726960
  ((file imperative-programming-1.html)
   (html "<blockquote>and for setting an element in an array:</blockquote>")))
 (idm181616730368
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Arrays also come with special syntax for retrieving an element\n        from an array:</blockquote>")))
 (idm181616738944
  ((file imperative-programming-1.html)
   (html
    "<blockquote>The <code>array</code> type is used for\n        general-purpose polymorphic arrays. The <code>Array</code> module has a variety of utility\n        functions for interacting with arrays, including a number of mutating\n        operations. These include <code>Array.set</code>, for setting an individual\n        element, and <code>Array.blit</code>, for\n        efficiently copying values from one range of indices to\n        another.<a name=\"idm181616735712\"></a><a name=\"idm181616734400\"></a><a name=\"idm181616733088\"></a><a name=\"idm181616731792\"></a></blockquote>")))
 (idm181616740432
  ((file imperative-programming-1.html)
   (html
    "<blockquote>OCaml supports a number of array-like data structures; i.e.,\n      mutable integer-indexed containers that provide constant-time access to\n      their elements. We'll discuss several of them in this section.</blockquote>")))
 (idm181616747808
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Now that we've looked at a complete example, let's take a more\n    systematic look at imperative programming in OCaml. We encountered two\n    different forms of mutable data above: records with mutable fields and\n    arrays. We'll now discuss these in more detail, along with the other\n    primitive forms of mutable data that are available in OCaml.<a name=\"idm181616747200\"></a><a name=\"idm181616746304\"></a><a name=\"idm181616744992\"></a><a name=\"idm181616744096\"></a><a name=\"idm181616742784\"></a></blockquote>")))
 (idm181616750736
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Note also that we do all of the side-effecting operations at the\n    very end of each function. This is good practice because it minimizes the\n    chance that such operations will be interrupted with an exception, leaving\n    the data structure in an inconsistent state.<a name=\"idm181616750208\"></a><a name=\"idm181616749600\"></a></blockquote>")))
 (idm181616758032
  ((file imperative-programming-1.html)
   (html
    "<blockquote>When a sequence expression <code>expr1;\n    expr2</code> is evaluated, <code>expr1</code> is\n    evaluated first, and then <code>expr2</code>. The\n    expression <code>expr1</code> should have type\n    <code>unit</code> (though this is a warning rather\n    than a hard restriction. The <code>-strict-sequence</code> compiler flag makes this a hard\n    restriction, which is generally a good idea), and the value of <code>expr2</code> is returned as the value of the entire\n    sequence. For example, the sequence <code>print_string\n    &quot;hello world&quot;; 1 + 2</code> first prints the string <code>&quot;hello world&quot;</code>, then returns the integer <code>3</code>.</blockquote>")))
 (idm181616760528
  ((file imperative-programming-1.html)
   (html "<blockquote>is equivalent to</blockquote>")))
 (idm181616763552
  ((file imperative-programming-1.html)
   (html
    "<blockquote>but <code>;</code> is more concise and\n    idiomatic. More generally,</blockquote>")))
 (idm181616767760
  ((file imperative-programming-1.html)
   (html
    "<blockquote>We also use <code>;</code>, the sequencing\n    operator, to express a sequence of imperative actions. We could have done\n    the same using <code>let</code> bindings:</blockquote>")))
 (idm181616771488
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Another piece of syntax shows up in both <code>add</code> and <code>remove</code>: the use of the <code>&lt;-</code> operator to update elements of an array\n    (<code>array.(i) &lt;- expr</code>) and for updating\n    a record field (<code>record.field &lt;-\n    expression</code>).</blockquote>")))
 (idm181616773328
  ((file imperative-programming-1.html)
   (html
    "<blockquote>This preceding code is made more complicated by the fact that we\n    need to detect whether we are overwriting or removing an existing binding,\n    so we can decide whether <code>t.length</code> needs\n    to be changed. The helper function <code>bucket_has_key</code> is used for this purpose.</blockquote>")))
 (idm181616777104
  ((file imperative-programming-1.html)
   (html
    "<blockquote>The following code is for adding and removing mappings from the\n    dictionary:</blockquote>")))
 (idm181616781056
  ((file imperative-programming-1.html)
   (html
    "<blockquote>The code for <code>iter</code> uses two forms of iteration: a\n        <code>for</code> loop to walk over the array of buckets; and within\n      that loop a call to <code>List.iter</code> to walk over the values in a\n      given bucket. We could have done the outer loop with a recursive function instead of a\n        <code>for</code> loop, but <code>for</code>\n      loops are syntactically convenient, and are more familiar and idiomatic in imperative\n      contexts.</blockquote>")))
 (idm181616786624
  ((file imperative-programming-1.html)
   (html
    "<blockquote><code>iter</code> is designed to walk over all\n    the entries in the dictionary. In particular, <code>iter t ~f</code> will call <code>f</code> for each key/value pair in dictionary <code>t</code>. Note that <code>f</code> must return <code>unit</code>, since it is expected to work by side\n    effect rather than by returning a value, and the overall <code>iter</code> function returns <code>unit</code> as well.</blockquote>")))
 (idm181616790384
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Now let's look at the implementation of <code>iter</code>:</blockquote>")))
 (idm181616795280
  ((file imperative-programming-1.html)
   (html
    "<blockquote><code>List.find_map</code> iterates over the\n    elements of the list, calling <code>f</code> on each\n    one until a <code>Some</code> is returned by\n    <code>f</code>, at which point that value is\n    returned. If <code>f</code> returns <code>None</code> on all values, then <code>None</code> is returned.</blockquote>")))
 (idm181616802464
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Another important piece of imperative syntax shows up in <code>find</code>: we write <code>array.(index)</code> to grab a value from an array.\n    <code>find</code> also uses <code>List.find_map</code>, which you can see the type of by\n    typing it into the toplevel:</blockquote>")))
 (idm181616803344
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Looks for a matching key in the table and returns the\n          corresponding value if found as an option.</blockquote>")))
 (idm181616805392
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Grabs the length from the corresponding record field, thus\n          returning the number of entries stored in the dictionary.</blockquote>")))
 (idm181616807344
  ((file imperative-programming-1.html)
   (html "<blockquote>Creates an empty dictionary.</blockquote>")))
 (idm181616809312
  ((file imperative-programming-1.html)
   (html
    "<blockquote>The other functions defined above are fairly straightforward:</blockquote>")))
 (idm181616811984
  ((file imperative-programming-1.html)
   (html
    "<blockquote>The function <code>hash_bucket</code> is used\n    throughout the rest of the module to choose the position in the array that\n    a given key should be stored at. It is implemented on top of <code>Hashtbl.hash</code>, which is a hash function provided\n    by the OCaml runtime that can be applied to values of any type. Thus, its\n    own type is polymorphic: <code>'a -&gt;\n    int</code>.</blockquote>")))
 (idm181616813840
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Note that <code>num_buckets</code> is a\n    constant, which means our bucket array is of fixed length. A practical\n    implementation would need to be able to grow the array as the number of\n    elements in the dictionary increases, but we'll omit this to simplify the\n    presentation.</blockquote>")))
 (idm181616816672
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Now we'll start putting together the basic functions for\n    manipulating a dictionary:</blockquote>")))
 (idm181616819920
  ((file imperative-programming-1.html)
   (html
    "<blockquote>The first field, <code>length</code>, is\n    declared as mutable. In OCaml, records are immutable by default, but\n    individual fields are mutable when marked as such. The second field,\n    <code>buckets</code>, is immutable but contains an\n    array, which is itself a mutable data structure.<a name=\"idm181616818096\"></a></blockquote>")))
 (idm181616822752
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Our first step is to define the type of a dictionary as a record\n    with two fields:</blockquote>")))
 (idm181616823920
  ((file imperative-programming-1.html)
   (html
    "<blockquote>We'll now walk through the implementation (contained in the\n    corresponding <code>ml</code> file) piece by piece,\n    explaining different imperative constructs as they come up.</blockquote>")))
 (idm181616826240
  ((file imperative-programming-1.html)
   (html
    "<blockquote>The <code>mli</code> also includes a\n    collection of helper functions whose purpose and behavior should be\n    largely inferrable from their names and type signatures. Notice that a\n    number of the functions, in particular, ones like <code>add</code> that modify the dictionary, return\n    <code>unit</code>. This is typical of functions that act by side\n    effect.</blockquote>")))
 (idm181616832176
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Here's the interface we'll match, provided as an <code>mli</code>. The type <code>('a, 'b)\n    t</code> represents a dictionary with keys of type <code>'a</code> and data of type <code>'b</code>:</blockquote>")))
 (idm181616834176
  ((file imperative-programming-1.html)
   (html
    "<blockquote>The dictionary we'll describe now, like those in Core and the\n    standard library, will be implemented as a hash table. In particular,\n    we'll use an <span><em>open hashing</em></span> scheme, where the hash\n    table will be an array of buckets, each bucket containing a list of\n    key/value pairs that have been hashed into that bucket.<a name=\"idm181616833200\"></a></blockquote>")))
 (idm181616839520
  ((file imperative-programming-1.html)
   (html
    "<blockquote>We'll start with the implementation of a simple imperative\n    dictionary, i.e., a mutable mapping from keys to values. This is really\n    for illustration purposes; both Core and the standard library provide\n    imperative dictionaries, and for most real-world tasks, you should use one\n    of those implementations. There's more advice on using Core's\n    implementation in particular in <a href=\"maps-and-hash-tables.html\">ChapterÂ 13, <i>Maps and Hash Tables</i></a>.<a name=\"DICTimper\"></a><a name=\"idm181616837200\"></a><a name=\"IPimpdict\"></a></blockquote>")))
 (idm181616841120
  ((file imperative-programming-1.html)
   (html
    "<blockquote>OCaml offers a happy compromise here, making it easy and natural to\n  program in a pure style, but also providing great support for imperative\n  programming. This chapter will walk you through OCaml's imperative features,\n  and help you use them to their fullest.</blockquote>")))
 (idm181616842288
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Pure code is the default in OCaml, and for good reasonâ\128\148it's generally\n  easier to reason about, less error prone and more composable. But imperative\n  code is of fundamental importance to any practical programming language,\n  because real-world tasks require that you interact with the outside world,\n  which is by its nature imperative. Imperative programming can also be\n  important for performance. While pure code is quite efficient in OCaml,\n  there are many algorithms that can only be implemented efficiently using\n  imperative techniques.</blockquote>")))
 (idm181616849280
  ((file imperative-programming-1.html)
   (html
    "<blockquote>Most of the code shown so far in this book, and indeed, most OCaml\n  code in general, is <span><em>pure</em></span>. Pure code works without\n  mutating the program's internal state, performing I/O, reading the clock, or\n  in any other way interacting with changeable parts of the world. Thus, a\n  pure function behaves like a mathematical function, always returning the\n  same results when given the same inputs, and never affecting the world\n  except insofar as it returns the value of its computation.\n  <span><em>Imperative</em></span> code, on the other hand, operates by side\n  effects that modify a program's internal state or interact with the outside\n  world. An imperative function has a new effect, and potentially returns\n  different results, every time it's called.<a name=\"idm181616847488\"></a><a name=\"idm181616846176\"></a><a name=\"idm181616845280\"></a><a name=\"PROGimper\"></a></blockquote>")))
 (idm181612280256
  ((file handling-json-data.html)
   (html
    "<blockquote>Our example shells out to <code>curl</code>\n      on the command line to obtain the JSON, which is rather inefficient.\n      We'll explain how to integrate the HTTP fetch directly into your OCaml\n      application in <a href=\"concurrent-programming-with-async.html\">ChapterÂ 18, <i>Concurrent Programming with Async</i></a>.</blockquote>")))
 (idm181612284416
  ((file handling-json-data.html)
   (html
    "<blockquote>While this tool is obviously quite simple, the ability to specify\n      optional and default fields is very powerful. Take a look at the full\n      ATD specification for the GitHub API in the <a href=\"http://github.com/avsm/ocaml-github\" target=\"_top\"><code>ocaml-github</code></a> repository online, which\n      has lots of quirks typical in real-world web APIs.<a name=\"idm181612282816\"></a><a name=\"idm181612282208\"></a><a name=\"idm181612281600\"></a><a name=\"idm181612280992\"></a></blockquote>")))
 (idm181612287152
  ((file handling-json-data.html)
   (html
    "<blockquote>The JSON returned from the <code>janestreet</code> query is missing an organization\n      name, but this is explicitly reflected in the OCaml type, since the ATD\n      spec marked <code>name</code> as an optional\n      field. Our OCaml code explicitly handles this case and doesn't have to\n      worry about null-pointer exceptions. Similarly, the JSON integer for the\n      <code>id</code> is mapped into a native OCaml\n      integer via the ATD conversion.</blockquote>")))
 (idm181612293360
  ((file handling-json-data.html)
   (html
    "<blockquote>You can now run the command-line tool with a single argument to\n      specify the name of the organization, and it will dynamically fetch the\n      JSON from the web, parse it, and render the summary to your\n      console:</blockquote>")))
 (idm181612299328
  ((file handling-json-data.html)
   (html
    "<blockquote>The following is a short shell script that generates all of the\n      OCaml code and also builds the final executable:</blockquote>")))
 (idm181612303728
  ((file handling-json-data.html)
   (html
    "<blockquote>The following code calls the cURL command-line utility by using\n      the <code>Core_extended.Shell</code> interface to\n      run an external command and capture its output. You'll need to ensure\n      that you have cURL installed on your system before running the example.\n      You might also need to <code>opam install\n      core_extended</code> if you haven't installed it previously:</blockquote>")))
 (idm181612304304
  ((file handling-json-data.html)
   (html
    "<blockquote>All we need to complete our example is an OCaml program that\n      fetches the JSON and uses these modules to output a one-line summary.\n      Our following example does just that.</blockquote>")))
 (idm181612306992
  ((file handling-json-data.html)
   (html
    "<blockquote>The <code>Github_org_j</code> serializer\n      interface contains everything we need to map to and from the OCaml types\n      and JSON. The easiest way to use this interface is by using the <code>string_of_org</code> and <code>org_of_string</code> functions, but there are also\n      more advanced low-level buffer functions available if you need higher\n      performance (but we won't go into that in this tutorial).</blockquote>")))
 (idm181612334656
  ((file handling-json-data.html)
   (html
    "<blockquote>The OCaml type has an obvious mapping to the ATD spec, but we\n      still need the logic to convert JSON buffers to and from this type.\n      Calling <code>atdgen -j</code> will generate this\n      serialization code for us in a new file called <code>github_org_j.ml</code>:</blockquote>")))
 (idm181612347776
  ((file handling-json-data.html)
   (html
    "<blockquote>Let's build the OCaml type declaration first by calling <code>atdgen -t</code> on the specification file:</blockquote>")))
 (idm181612350768
  ((file handling-json-data.html)
   (html
    "<blockquote>Now create an ATD file that covers the fields we need. Any extra\n      fields present in the response will be ignored by the ATD parser, so we\n      don't need a completely exhaustive specification of every field that\n      GitHub might send back:</blockquote>")))
 (idm181612354224
  ((file handling-json-data.html)
   (html
    "<blockquote>Let's finish up with an example of some live JSON parsing from\n      GitHub and build a tool to query organization information via their API.\n      Start by looking at the online <a href=\"http://developer.github.com/v3/orgs/\" target=\"_top\">API documentation</a> for\n      GitHub to see what the JSON schema for retrieving the organization\n      information looks like.<a name=\"idm181612353088\"></a><a name=\"idm181612352192\"></a></blockquote>")))
 (idm181612357296
  ((file handling-json-data.html)
   (html
    "<blockquote>There are also several similar projects that automate the code\n      generation process. <a href=\"http://piqi.org\" target=\"_top\">Piqi</a> supports\n      conversions between XML, JSON, and the Google protobuf format; and\n      <a href=\"http://thrift.apache.org\" target=\"_top\">Thrift</a> supports many other\n      programming languages and includes OCaml bindings.</blockquote>")))
 (idm181612358608
  ((file handling-json-data.html)
   (html
    "<blockquote>The full <a href=\"http://mjambon.com/atdgen/atdgen-manual.html\" target=\"_top\">ATD\n      specification</a> is quite sophisticated and documented online. The\n      ATD compiler can also target formats other than JSON and outputs code\n      for other languages (such as Java) if you need more\n      interoperability.</blockquote>")))
 (idm181612359552
  ((file handling-json-data.html)
   (html
    "<blockquote>Always explicitly outputs a JSON value if possible. This\n            requires the default value for that field to be defined in the ATD\n            specification.</blockquote>")))
 (idm181612361600
  ((file handling-json-data.html)
   (html
    "<blockquote>Calls a custom function for every unknown field encountered,\n            instead of raising a parsing exception.</blockquote>")))
 (idm181612363760
  ((file handling-json-data.html)
   (html
    "<blockquote>Converts tuples and variants into standard JSON and refuse\n            to print NaN and infinities. You should specify this if you intend\n            to interoperate with services that aren't using ATD.</blockquote>")))
 (idm181612370896
  ((file handling-json-data.html)
   (html
    "<blockquote>This is pretty convenient! We've now written a single ATD file,\n      and all the OCaml boilerplate to convert between JSON and a strongly\n      typed record has been generated for us. You can control various aspects\n      of the serializer by passing flags to <span><strong>atdgen</strong></span>. The important ones for JSON\n      are:<a name=\"idm181612369712\"></a><a name=\"idm181612368608\"></a><a name=\"idm181612367456\"></a><a name=\"idm181612366320\"></a></blockquote>")))
 (idm181612376688
  ((file handling-json-data.html)
   (html
    "<blockquote>The <code>Github_t</code> module only\n      contains the type definitions, while <code>Github_j</code> provides serialization functions to\n      and from JSON. You can read the <code>github_j.mli</code> to see the full interface, but\n      the important functions for most uses are the conversion functions to\n      and from a string. For our preceding example, this looks like:</blockquote>")))
 (idm181612379472
  ((file handling-json-data.html)
   (html
    "<blockquote>There is an obvious correspondence to the ATD definition. Note\n      that field names in OCaml records in the same module cannot shadow one\n      another, and so we instruct ATDgen to prefix every field with a name\n      that distinguishes it from other records in the same module. For\n      example, <code>&lt;ocaml\n      field_prefix=&quot;auth_req_&quot;&gt;</code> in the ATD spec prefixes every\n      field name in the generated <code>authorization_request</code> record with <code>auth_req</code>.</blockquote>")))
 (idm181612397856
  ((file handling-json-data.html)
   (html
    "<blockquote>The <span><strong>atdgen</strong></span> command will generate some new files in\n        your current directory. <code>github_t.ml</code> and <code>github_t.mli</code> will contain an OCaml module with types defined\n        that correspond to the ATD file:</blockquote>")))
 (idm181612400496
  ((file handling-json-data.html)
   (html
    "<blockquote>The ATD specification we defined can be compiled to OCaml code\n      using the <span><strong>atdgen</strong></span> command-line tool.\n      Let's run the compiler twice to generate some OCaml type definitions and\n      a JSON serializing module that converts between input data and those\n      type definitions.<a name=\"idm181612399312\"></a></blockquote>")))
 (idm181612404688
  ((file handling-json-data.html)
   (html
    "<blockquote>The annotation <code>&lt;json\n      name=&quot;user&quot;&gt;</code> signals that the JSON value of the field is\n      <code>user</code>, but that the variable name of\n      the parsed variant in OCaml should be <code>User</code>. These annotations are often useful to\n      map JSON values to reserved keywords in OCaml (e.g., <code>type</code>).</blockquote>")))
 (idm181612406048
  ((file handling-json-data.html)
   (html
    "<blockquote>For example, the preceding GitHub <code>scope</code> field is defined as a variant type, with\n      each option starting with an uppercase letter as is conventional for\n      OCaml variants. However, the JSON values that come back from GitHub are\n      actually lowercase and so aren't exactly the same as the option\n      name.</blockquote>")))
 (idm181612407984
  ((file handling-json-data.html)
   (html
    "<blockquote>ATD does deviate from OCaml syntax due to its support for annotations within the\n        specification. The annotations can customize the code that is generated for a particular\n        target (of which the OCaml backend is of most interest to us).<a name=\"idm181612407472\"></a></blockquote>")))
 (idm181612411712
  ((file handling-json-data.html)
   (html
    "<blockquote>The ATD specification syntax is deliberately quite similar to\n      OCaml type definitions. Every JSON record is assigned a type name (e.g.,\n      <code>app</code> in the preceding example). You\n      can also define variants that are similar to OCaml's variant types\n      (e.g., <code>scope</code> in the example).</blockquote>")))
 (idm181612417376
  ((file handling-json-data.html)
   (html
    "<blockquote>Let's go straight into looking at an example of how this works, by\n      using a small portion of the GitHub API. GitHub is a popular code\n      hosting and sharing website that provides a JSON-based web <a href=\"http://developer.github.com\" target=\"_top\">API</a>. The following ATD code\n      fragment describes the GitHub authorization API (which is based on a\n      pseudostandard web protocol known as OAuth):<a name=\"idm181612416080\"></a><a name=\"idm181612415184\"></a></blockquote>")))
 (idm181612420000
  ((file handling-json-data.html)
   (html
    "<blockquote>The idea behind ATD is to specify the format of the JSON in a\n      separate file and then run a compiler (<span><strong>atdgen</strong></span>) that outputs OCaml code to construct\n      and parse JSON values. This means that you don't need to write any OCaml\n      parsing code at all, as it will all be autogenerated for you.<a name=\"idm181612418800\"></a></blockquote>")))
 (idm181612424192
  ((file handling-json-data.html)
   (html
    "<blockquote>The command-line tool will be installed within your <code>~/.opam</code> directory and should already be on\n      your <code>PATH</code> from running <span><strong>opam config env</strong></span>. See <a href=\"http://realworldocaml.org/install\" target=\"_top\">this Real World OCaml page</a> if this isn't working.</blockquote>")))
 (idm181612429616
  ((file handling-json-data.html)
   (html
    "<blockquote>ATDgen installs some OCaml libraries that interface with Yojson,\n      and also a command-line tool that generates code. It can all be\n      installed via OPAM:</blockquote>")))
 (idm181612434272
  ((file handling-json-data.html)
   (html
    "<blockquote>We'll cover an alternative JSON processing method that is better for\n    larger-scale JSON handling now, using the <a href=\"http://mjambon.com/atd-biniou-intro.html\" target=\"_top\">OCaml</a> tool. This will\n    introduce our first <span><em>Domain Specific Language</em></span> that\n    compiles JSON specifications into OCaml modules, which are then used\n    throughout your application.<a name=\"idm181612432640\"></a><a name=\"idm181612431344\"></a></blockquote>")))
 (idm181612438320
  ((file handling-json-data.html)
   (html
    "<blockquote>The combinators described previously make it easy to write functions\n    that extract fields from JSON records, but the process is still pretty\n    manual. When you implement larger specifications, it's much easier to\n    generate the mappings from JSON schemas to OCaml values more mechanically\n    than writing conversion functions individually.<a name=\"MAPjson\"></a><a name=\"JSONautomap\"></a></blockquote>")))
 (idm181612444816
  ((file handling-json-data.html)
   (html
    "<blockquote>You can convert a <code>Safe.json</code> to a\n    <code>Basic.json</code> type by using the <code>to_basic</code> function as follows:</blockquote>")))
 (idm181612445488
  ((file handling-json-data.html)
   (html
    "<blockquote>The only purpose of these extensions is to have greater control over\n    how OCaml values are represented in JSON (for instance, storing a\n    floating-point number as a JSON string). The output still obeys the same\n    standard format that can be easily exchanged with other languages.</blockquote>")))
 (idm181612447680
  ((file handling-json-data.html)
   (html
    "<blockquote>Encodes OCaml variants more explicitly, as <code>&lt;&quot;Foo&quot;&gt;</code> or <code>&lt;&quot;Bar&quot;:123&gt;</code> for a variant with\n          parameters.</blockquote>")))
 (idm181612450576
  ((file handling-json-data.html)
   (html
    "<blockquote>Stored as <code>(&quot;abc&quot;, 123)</code>\n          instead of a list.</blockquote>")))
 (idm181612454848
  ((file handling-json-data.html)
   (html
    "<blockquote>Denotes that the value is stored as a JSON string. For\n          example, a <code>Floatlit</code> will be\n          stored as <code>&quot;1.234&quot;</code> instead of\n          <code>1.234</code>.</blockquote>")))
 (idm181612460192
  ((file handling-json-data.html)
   (html
    "<blockquote>Yojson supports the following JSON extensions:<a name=\"idm181612459888\"></a><a name=\"idm181612458576\"></a><a name=\"idm181612457680\"></a></blockquote>")))
 (idm181612464864
  ((file handling-json-data.html)
   (html
    "<blockquote>The <code>Safe.json</code> type includes all\n    of the variants from <code>Basic.json</code> and\n    extends it with a few more useful ones. A standard JSON type such as a\n    <code>String</code> will type-check against both the\n    <code>Basic</code> module and also the nonstandard\n    <code>Safe</code> module. If you use the extended\n    values with the <code>Basic</code> module, however,\n    the compiler will reject your code until you make it compliant with the\n    portable subset of JSON.</blockquote>")))
 (idm181612472416
  ((file handling-json-data.html)
   (html
    "<blockquote>The standard JSON types are <span><em>really</em></span> basic, and\n    OCaml types are far more expressive. Yojson supports an extended JSON\n    format for those times when you're not interoperating with external\n    systems and just want a convenient human-readable, local format. The\n    <code>Yojson.Safe.json</code> type is a superset of\n    the <code>Basic</code> polymorphic variant and looks\n    like this:<a name=\"idm181612470112\"></a><a name=\"idm181612468800\"></a></blockquote>")))
 (idm181612474656
  ((file handling-json-data.html)
   (html
    "<blockquote>We'll discuss more techniques like this that help you interpret\n      type errors more easily in <a href=\"the-compiler-frontend-parsing-and-type-checking.html\">ChapterÂ 22, <i>The Compiler Frontend: Parsing and <span>Type\n    Checking</span></i></a>.</blockquote>")))
 (idm181612477424
  ((file handling-json-data.html)
   (html
    "<blockquote>We've annotated <code>person</code> as being\n      of type <code>Yojson.Basic.json</code>, and as a\n      result, the compiler spots that the argument to the <code>Assoc</code> variant has the incorrect type. This\n      illustrates the strengths and weaknesses of polymorphic variants:\n      they're lightweight and flexible, but the error messages can be quite\n      confusing. However, a bit of careful manual type annotation makes\n      tracking down such issues much easier.</blockquote>")))
 (idm181612484656
  ((file handling-json-data.html)
   (html
    "<blockquote>The type error is more verbose than it needs to be, which can be\n      inconvenient to wade through for larger values. You can help the\n      compiler to narrow down this error to a shorter form by adding explicit\n      type annotations as a hint about your intentions:</blockquote>")))
 (idm181612495184
  ((file handling-json-data.html)
   (html
    "<blockquote>One difficulty you will encounter is that type errors involving\n      polymorphic variants can be quite verbose. For example, suppose you\n      build an <code>Assoc</code> and mistakenly include\n      a single value instead of a list of keys:</blockquote>")))
 (idm181612503808
  ((file handling-json-data.html)
   (html
    "<blockquote>In this case, there are no problems. Our <code>person</code> value has an inferred type that is a\n    valid subtype of <code>json</code>, and so the\n    conversion to a string just works without us ever having to explicitly\n    specify a type for <code>person</code>. Type\n    inference lets you write more succinct code without sacrificing runtime\n    reliability, as all the uses of polymorphic variants are still checked at\n    compile time.<a name=\"idm181612501216\"></a><a name=\"idm181612499520\"></a><a name=\"idm181612498624\"></a><a name=\"idm181612497296\"></a></blockquote>")))
 (idm181612514688
  ((file handling-json-data.html)
   (html
    "<blockquote>The <code>pretty_to_string</code> function has\n    a more explicit signature that requires an argument of type <code>Yojson.Basic.json</code>. When <code>person</code> is applied to <code>pretty_to_string</code>, the inferred type of <code>person</code> is statically checked against the\n    structure of the <code>json</code> type to ensure\n    that they're compatible:</blockquote>")))
 (idm181612522672
  ((file handling-json-data.html)
   (html
    "<blockquote>The OCaml type system infers a type for <code>person</code> based on how you construct its value. In\n    this case, only the <code>Assoc</code> and <code>String</code> variants are used to define the record,\n    and so the inferred type only contains these fields without knowledge of\n    the other possible allowed variants in JSON records that you haven't used\n    yet (e.g. <code>Int</code> or <code>Null</code>):</blockquote>")))
 (idm181612523952
  ((file handling-json-data.html)
   (html
    "<blockquote>In the preceding example, we've constructed a simple JSON object\n    that represents a single person. We haven't actually defined the type of\n    <code>person</code> explicitly, as we're relying on\n    the magic of polymorphic variants to make this all work.</blockquote>")))
 (idm181612529856
  ((file handling-json-data.html)
   (html
    "<blockquote>We can directly build a JSON value against this type and use the\n    pretty-printing functions in the <code>Yojson.Basic</code> module to display JSON\n    output:</blockquote>")))
 (idm181612538288
  ((file handling-json-data.html)
   (html
    "<blockquote>Building and printing JSON values is pretty straightforward given\n    the <code>Yojson.Basic.json</code> type. You can\n    just construct values of type <code>json</code> and\n    call the <code>to_string</code> function on them.\n    Let's remind ourselves of the <code>Yojson.Basic.json</code> type again:<a name=\"idm181612535184\"></a><a name=\"idm181612533648\"></a></blockquote>")))
 (idm181612541216
  ((file handling-json-data.html)
   (html
    "<blockquote>This technique of using statically typed parsing functions is very powerful in combination\n      with the OCaml type system. Many errors that don't make sense at runtime (for example, mixing\n      up lists and objects) will be caught statically via a type error.<a name=\"idm181612540688\"></a><a name=\"idm181612540080\"></a></blockquote>")))
 (idm181612543104
  ((file handling-json-data.html)
   (html
    "<blockquote>This style of programming, which omits variable names and chains functions together, is\n      known as <span><em>point-free programming</em></span>. It's a succinct style but shouldn't be\n      overused due to the increased difficulty of debugging intermediate values. If an explicit\n        <span>name</span> is assigned to each stage of the transformations,\n      debuggers in particular have an easier time making the program flow simpler to represent to\n      the programmer.</blockquote>")))
 (idm181612552976
  ((file handling-json-data.html)
   (html
    "<blockquote>The final use of JSON combinators is to extract all the <code>name</code> fields from the list of authors. We first\n    construct the <code>author list</code>, and then\n    <code>map</code> it into a <code>string list</code>. Notice that the example explicitly\n    binds <code>authors</code> to a variable name. It\n    can also be written more succinctly using the pipe-forward\n    operator:</blockquote>")))
 (idm181612567376
  ((file handling-json-data.html)
   (html
    "<blockquote>The <code>is_online</code> and <code>is_translated</code> fields are optional in our JSON\n    schema, so no error should be raised if they are not present. The OCaml\n    type is a <code>bool option</code> to reflect this\n    and can be extracted via <code>to_bool_option</code>. In our example JSON, only\n    <code>is_online</code> is present and <code>is_translated</code> will be <code>None</code>:</blockquote>")))
 (idm181612579360
  ((file handling-json-data.html)
   (html
    "<blockquote>The <code>tags</code> field is similar to\n    <code>title</code>, but the field is a list of\n    strings instead of a single one. Converting this to an OCaml <code>string list</code> is a two-stage process. First, we\n    convert the JSON <code>List</code> to an OCaml list\n    of JSON values and then filter out the <code>String</code> values as an OCaml <code>string list</code>. Remember that OCaml lists must\n    contain values of the same type, so any JSON values that cannot be\n    converted to a <code>string</code> will be skipped\n    from the output of <code>filter_string</code>:</blockquote>")))
 (idm181612590000
  ((file handling-json-data.html)
   (html
    "<blockquote>The <code>member</code> function accepts a JSON object and named key\n      and returns the JSON field associated with that key, or <code>Null</code>. Since we know that the <code>title</code> value is\n      always a string in our example schema, we want to convert it to an OCaml string. The <code>to_string</code> function performs this conversion and raises an\n      exception if there is an unexpected JSON type. The <code>|&gt;</code>\n      operator provides a convenient way to chain these operations <span>together</span>:</blockquote>")))
 (idm181612596272
  ((file handling-json-data.html)
   (html
    "<blockquote>Let's start with selecting a single <code>title</code> field from the record:</blockquote>")))
 (idm181612606304
  ((file handling-json-data.html)
   (html
    "<blockquote>We'll go through each of these uses one by one now. The following\n    examples also use the <code>|&gt;</code>\n    pipe-forward operator that we explained in <a href=\"variables-and-functions.html\">ChapterÂ 2, <i>Variables and Functions</i></a>. This lets us chain together multiple\n    JSON selection functions and feed the output from one into the next one,\n    without having to create separate <code>let</code>\n    bindings for each one.<a name=\"idm181612603968\"></a><a name=\"idm181612603056\"></a><a name=\"idm181612602144\"></a><a name=\"idm181612600832\"></a><a name=\"idm181612599920\"></a><a name=\"idm181612598608\"></a><a name=\"idm181612597296\"></a></blockquote>")))
 (idm181612626400
  ((file handling-json-data.html)
   (html
    "<blockquote><code>Yojson</code> provides several\n    combinators in the <code>Yojson.Basic.Util</code>\n    module, some of which are listed in <a href=\"handling-json-data.html#table15_1\">TableÂ 15.1, â\128\156Yojson combinatorsâ\128\157</a>.<a name=\"idm181612624432\"></a><a name=\"idm181612622880\"></a></blockquote>")))
 (idm181612627712
  ((file handling-json-data.html)
   (html
    "<blockquote><code>iter</code> is a more specialized\n      combinator that is only useful when writing imperative code. The input\n      function is applied to every value, but no result is supplied. The\n      function must instead apply some side effect such as changing a mutable\n      record field or printing to the standard output.</blockquote>")))
 (idm181612633312
  ((file handling-json-data.html)
   (html
    "<blockquote><code>map</code> and <code>fold</code> are extremely common combinators that\n      transform an input list by applying a function to each value of the\n      list. The <code>map</code> combinator is simplest,\n      with the resulting list being output directly. <code>fold</code> applies each value in the input list to a\n      function that accumulates a single result, and returns that\n      instead:</blockquote>")))
 (idm181612636848
  ((file handling-json-data.html)
   (html
    "<blockquote>You've already run across several of these in the <code>List</code> module:</blockquote>")))
 (idm181612637584
  ((file handling-json-data.html)
   (html
    "<blockquote>Combinators are a design pattern that crops up quite often in\n      functional programming. John Hughes defines them as &quot;a function which\n      builds program fragments from program fragments.&quot; In a functional\n      language, this generally means higher-order functions that combine other\n      functions to apply useful transformations over values.</blockquote>")))
 (idm181612641968
  ((file handling-json-data.html)
   (html
    "<blockquote>This code introduces the <code>Yojson.Basic.Util</code> module, which contains\n    <span><em>combinator</em></span> functions that let you easily map a JSON\n    object into a more strongly typed OCaml value.<a name=\"idm181612640608\"></a><a name=\"idm181612639296\"></a></blockquote>")))
 (idm181612649888
  ((file handling-json-data.html)
   (html
    "<blockquote>Now build and run this in the same way as the previous\n    example:</blockquote>")))
 (idm181612655952
  ((file handling-json-data.html)
   (html
    "<blockquote>Now that we've figured out how to parse the example JSON into an\n    OCaml value, let's manipulate it from OCaml code and extract specific\n    fields:<a name=\"VALjson\"></a><a name=\"JSONselval\"></a></blockquote>")))
 (idm181612659648
  ((file handling-json-data.html)
   (html
    "<blockquote>The <code>from_file</code> function accepts an\n    input filename and takes care of opening and closing it for you. It's far\n    more common to use <code>from_string</code> to\n    construct JSON values though, since these strings come in via a network\n    connection (we'll see more of this in <a href=\"concurrent-programming-with-async.html\">ChapterÂ 18, <i>Concurrent Programming with Async</i></a>) or a database. Finally,\n    the example checks that the two input mechanisms actually resulted in the\n    same OCaml data structure.</blockquote>")))
 (idm181612665584
  ((file handling-json-data.html)
   (html
    "<blockquote>You can build this by running <span><strong>corebuild</strong></span>:</blockquote>")))
 (idm181612669744
  ((file handling-json-data.html)
   (html
    "<blockquote>The next example shows both the <code>string</code> and\n    <code>file</code> functions in action, assuming the JSON record is\n    stored in a file called <span><em>book.json</em></span>:</blockquote>")))
 (idm181612672784
  ((file handling-json-data.html)
   (html
    "<blockquote>The type signature for these functions with the optional elements\n    removed makes their purpose much clearer. The three ways of parsing JSON\n    are either directly from a string, from a file on a filesystem, or via a\n    buffered input channel:</blockquote>")))
 (idm181612673520
  ((file handling-json-data.html)
   (html
    "<blockquote>When first reading these interfaces, you can generally ignore the\n    optional arguments (which have the question marks in the type signature),\n    since they should have sensible defaults. In the preceding signature, the\n    optional arguments offer finer control over the memory buffer allocation\n    and error messages from parsing incorrect JSON.</blockquote>")))
 (idm181612677216
  ((file handling-json-data.html)
   (html
    "<blockquote>Let's parse the earlier JSON example into this type now. The first\n    stop is the <code>Yojson.Basic</code> documentation,\n    where we find these helpful functions:</blockquote>")))
 (idm181612679600
  ((file handling-json-data.html)
   (html
    "<blockquote>The type definition uses polymorphic variants and not normal\n        variants. This will become significant later, when we extend it with\n        custom extensions to the JSON format.<a name=\"idm181612679152\"></a></blockquote>")))
 (idm181612681184
  ((file handling-json-data.html)
   (html
    "<blockquote>The definition specifically includes a <code>Null</code> variant for empty fields. OCaml doesn't\n        allow null values by default, so this must be encoded\n        explicitly.</blockquote>")))
 (idm181612686800
  ((file handling-json-data.html)
   (html
    "<blockquote>The <code>json</code> type is\n        <span><em>recursive</em></span>, which is to say that some of the tags\n        refer back to the overall <code>json</code>\n        type. In particular, <code>Assoc</code> and\n        <code>List</code> types can contain references\n        to further JSON values of different types. This is unlike the OCaml\n        lists, whose contents must be of a uniform type.<a name=\"idm181612683232\"></a></blockquote>")))
 (idm181612687792
  ((file handling-json-data.html)
   (html
    "<blockquote>Some interesting properties should leap out at you after reading\n    this definition:</blockquote>")))
 (idm181612693952
  ((file handling-json-data.html)
   (html
    "<blockquote>The JSON specification has very few data types, and the <code>Yojson.Basic.json</code> type that follows is\n    sufficient to express any valid JSON structure:<a name=\"idm181612692896\"></a><a name=\"idm181612691584\"></a></blockquote>")))
 (idm181612718960
  ((file handling-json-data.html)
   (html
    "<blockquote>There are several JSON libraries available for OCaml. For this\n      chapter, we've picked the <a href=\"http://mjambon.com/yojson.html\" target=\"_top\">OCaml</a> library by Martin\n      Jambon. It's easiest to install via OPAM by running <code>opam install yojson</code>. See <a href=\"http://realworldocaml.org/install\" target=\"_top\">this Real World OCaml page</a> for installation instructions if you haven't\n      already got OPAM. Once installed, you can open it in the <span><strong>utop</strong></span> toplevel by:</blockquote>")))
 (idm181612725136
  ((file handling-json-data.html)
   (html
    "<blockquote>Our first task is to parse the JSON into a more structured OCaml\n    type so that we can use static typing more effectively. When manipulating\n    JSON in Python or Ruby, you might write unit tests to check that you have\n    handled unusual inputs. The OCaml model prefers compile-time static\n    checking as well as unit tests. For example, using pattern matching can\n    warn you if you've not checked that a value can be <code>Null</code> as well as contain an actual\n    value.<a name=\"idm181612723760\"></a><a name=\"idm181612722464\"></a><a name=\"idm181612721568\"></a><a name=\"idm181612720656\"></a></blockquote>")))
 (idm181612728448
  ((file handling-json-data.html)
   (html
    "<blockquote>This free-form nature of JSON types is both a blessing and a curse.\n    It's very easy to generate JSON values, but code that parses them also has\n    to handle subtle variations in how the values are represented. For\n    example, what if the preceding <code>pages</code>\n    value is actually represented as a string value of &quot;<code>450</code>&quot; instead of an integer?<a name=\"idm181612726576\"></a></blockquote>")))
 (idm181612730544
  ((file handling-json-data.html)
   (html
    "<blockquote>The outermost JSON value is usually a record (delimited by the curly\n    braces) and contains an unordered set of key/value pairs. The keys must be\n    strings, but values can be any JSON type. In the preceding example,\n    <code>tags</code> is a string list, while the\n    <code>authors</code> field contains a list of\n    records. Unlike OCaml lists, JSON lists can contain multiple different\n    JSON types within a single list.</blockquote>")))
 (idm181612736160
  ((file handling-json-data.html)
   (html
    "<blockquote>JSON consists of two basic structures: an unordered collection of\n    key/value pairs, and an ordered list of values. Values can be strings,\n    Booleans, floats, integers, or null. Let's see what a JSON record for an\n    example book description looks like:<a name=\"idm181612735632\"></a><a name=\"idm181612734096\"></a></blockquote>")))
 (idm181612738448
  ((file handling-json-data.html)
   (html
    "<blockquote>JSON is a lightweight data-interchange format often used in web\n    services and browsers. It's described in <a href=\"http://www.ietf.org/rfc/rfc4627.txt\" target=\"_top\">RFC4627</a> and is easier to\n    parse and generate than alternatives such as XML. You'll run into JSON\n    very often when working with modern web APIs, so we'll cover several\n    different ways to manipulate it in this chapter.<a name=\"idm181612737184\"></a></blockquote>")))
 (idm181612740096
  ((file handling-json-data.html)
   (html
    "<blockquote>External tools to generate boilerplate OCaml modules and\n      signatures from external specification files</blockquote>")))
 (idm181612741232
  ((file handling-json-data.html)
   (html
    "<blockquote><span><em>Functional combinators</em></span> to compose common\n      operations over data structures in a type-safe way</blockquote>")))
 (idm181612742416
  ((file handling-json-data.html)
   (html
    "<blockquote><span><em>Polymorphic variants</em></span> to write more extensible\n      libraries and protocols (but still retain the ability to extend them if\n      needed)</blockquote>")))
 (idm181612743584
  ((file handling-json-data.html)
   (html
    "<blockquote>We'll start by using the popular and simple JSON data format and then\n  look at other serialization formats later in the book. This chapter\n  introduces you to a couple of new techniques that glue together the basic\n  ideas from Part I of the book by using:</blockquote>")))
 (idm181612748864
  ((file handling-json-data.html)
   (html
    "<blockquote>Data serialization, i.e., converting data to and from a sequence of\n  bytes that's suitable for writing to disk or sending across the network, is\n  an important and common programming task. You often have to match someone\n  else's data format (such as XML), sometimes you need a highly efficient\n  format, and other times you want something that is easy for humans to edit.\n  To this end, OCaml libraries provide several techniques for data\n  serialization depending on what your problem is.<a name=\"idm181612748112\"></a><a name=\"SERjson\"></a><a name=\"DATjson\"></a></blockquote>")))
 (idm181615253616
  ((file functors.html)
   (html
    "<blockquote>All of this means that for small and simple programs, heavy use of functors is probably a\n      mistake. But as your programs get more complicated and you need more effective modular\n      architectures, functors become a highly valuable tool.</blockquote>")))
 (idm181615254432
  ((file functors.html)
   (html
    "<blockquote>We've really only covered some of the possible uses of functors. Functors are really a\n      quite powerful tool for modularizing your code. The cost is that functors are syntactically\n      heavyweight compared to the rest of the language, and that there are some tricky issues you\n      need to understand to use them effectively, with sharing constraints and destructive\n      substitution being high on that list. </blockquote>")))
 (idm181615254816
  ((file functors.html)
   (html
    "<blockquote>These functors come in handy when you want to add the same kind of\n    functionality that is commonly available in Core to your own types.</blockquote>")))
 (idm181615258656
  ((file functors.html)
   (html
    "<blockquote>For so-called monadic libraries, like those discussed in Chapters <a href=\"error-handling.html\">7</a> and <a href=\"concurrent-programming-with-async.html\">18</a>. Here, the functor is\n          used to provide a collection of standard helper functions based on\n          the <code>bind</code> and <code>return</code> operators.</blockquote>")))
 (idm181615260688
  ((file functors.html)
   (html
    "<blockquote>Adds support for hashing-based data structures including hash\n          tables, hash sets, and hash heaps.</blockquote>")))
 (idm181615262768
  ((file functors.html)
   (html
    "<blockquote>Adds support for functionality that depends on the presence of\n          a comparison function, including support for containers like maps\n          and sets.</blockquote>")))
 (idm181615265360
  ((file functors.html)
   (html
    "<blockquote>Very similar to <code>Foldable.Extend</code>.</blockquote>")))
 (idm181615271392
  ((file functors.html)
   (html
    "<blockquote>Core comes with a number of functors for extending modules that\n    follow this same basic pattern, including:<a name=\"idm181615271024\"></a><a name=\"idm181615270128\"></a><a name=\"idm181615269232\"></a><a name=\"idm181615267920\"></a></blockquote>")))
 (idm181615276704
  ((file functors.html)
   (html
    "<blockquote>In order to apply the functor, we'll put the definition of <code>Fqueue</code> in a submodule called <code>T</code>, and then call <code>Foldable.Extend</code> on <code>T</code>:</blockquote>")))
 (idm181615280656
  ((file functors.html)
   (html
    "<blockquote>Now we can apply this to <code>Fqueue</code>. We can create an\n      interface for an extended version of <code>Fqueue</code> as follows: </blockquote>")))
 (idm181615287280
  ((file functors.html)
   (html
    "<blockquote>We'll create a new module, <code>Foldable</code>, that automates the process of adding\n    helper functions to a <code>fold</code>-supporting container. As you\n    can see, <code>Foldable</code> contains a module\n    signature <code>S</code> which defines the signature\n    that is required to support folding; and a functor <code>Extend</code> that allows one to extend any module that\n    matches <code>Foldable.S</code>:</blockquote>")))
 (idm181615289056
  ((file functors.html)
   (html
    "<blockquote>As it happens, many of these helper functions can be derived mechanically from the\n        <code>fold</code> function we already implemented. Rather than write all of these\n      helper functions by hand for every new container type, we can instead use a functor to add\n      this functionality to any container that has a <code>fold</code>\n      function.</blockquote>")))
 (idm181615293200
  ((file functors.html)
   (html
    "<blockquote>One problem with <code>Fqueue</code> is that\n    the interface is quite skeletal. There are lots of useful helper functions\n    that one might want that aren't there. The <code>List</code> module, by way of contrast, has functions\n    like <code>List.iter</code>, which runs a function\n    on each element; and <code>List.for_all</code>,\n    which returns true if and only if the given predicate evaluates to\n    <code>true</code> on every element of the list. Such\n    helper functions come up for pretty much every container type, and\n    implementing them over and over is a dull and repetitive affair.</blockquote>")))
 (idm181615296784
  ((file functors.html)
   (html
    "<blockquote>We'll implement <code>Fqueue</code> the well known trick of\n      maintaining an input and an output list so that one can efficiently enqueue on the input list\n      and efficiently dequeue from the output list. If you attempt to dequeue when the output list\n      is empty, the input list is reversed and becomes the new output list. Here's the\n      implementation:</blockquote>")))
 (idm181615302368
  ((file functors.html)
   (html
    "<blockquote>The preceding <code>Fqueue.fold</code>\n    function requires some explanation. It follows the same pattern as the\n    <code>List.fold</code> function we described in\n    <a href=\"lists-and-patterns.html#using-the-list-module-effectively\">the section called â\128\156Using the List Module Effectivelyâ\128\157</a>. Essentially,\n    <code>Fqueue.fold q ~init ~f</code> walks over the\n    elements of <code>q</code> from front to back,\n    starting with an accumulator of <code>init</code>\n    and using <code>f</code> to update the accumulator\n    value as it walks over the queue, returning the final value of the\n    accumulator at the end of the computation. <code>fold</code> is a\n    quite powerful operation, as we'll see.</blockquote>")))
 (idm181615306688
  ((file functors.html)
   (html
    "<blockquote>Here's a reasonable <code>mli</code> for such\n    a module:</blockquote>")))
 (idm181615311024
  ((file functors.html)
   (html
    "<blockquote>Another common use of functors is to generate type-specific\n    functionality for a given module in a standardized way. Let's see how this\n    works in the context of a functional queue, which is just a functional\n    version of a FIFO (first-in, first-out) queue. Being functional,\n    operations on the queue return new queues, rather than modifying the\n    queues that were passed in.<a name=\"idm181615310368\"></a><a name=\"idm181615309056\"></a><a name=\"idm181615308128\"></a></blockquote>")))
 (idm181615326880
  ((file functors.html)
   (html
    "<blockquote>And now, we can use that sexp converter in the ordinary\n      way:</blockquote>")))
 (idm181615373088
  ((file functors.html)
   (html
    "<blockquote>Now we can write the functor itself. We have been careful to\n      override the sexp converter here to ensure that the data structure's\n      invariants are still maintained when reading in from an\n      s-expression:</blockquote>")))
 (idm181615388352
  ((file functors.html)
   (html
    "<blockquote>Equivalently, we can define a type <code>t</code> within our new module, and apply destructive\n      substitutions to all of the included interfaces, <code>Interval_intf</code> included, as shown in the\n      following example. This is somewhat cleaner when combining multiple\n      interfaces, since it correctly reflects that all of the signatures are\n      being handled equivalently:</blockquote>")))
 (idm181615405280
  ((file functors.html)
   (html
    "<blockquote>We can modify <code>Make_interval</code> to\n      use the <code>Sexpable</code> interface, for both\n      its input and its output. First, let's create an extended version of the\n      <code>Interval_intf</code> interface that includes\n      the functions from the <code>Sexpable</code> interface. We can do\n      this using destructive substitution on the <code>Sexpable</code> interface, to avoid having multiple\n      distinct type <code>t</code>'s clashing with each\n      other:</blockquote>")))
 (idm181615408832
  ((file functors.html)
   (html
    "<blockquote>Happily, Core comes with a built-in interface for just this\n      purpose called <code>Sexpable</code>, which is\n      defined as follows:</blockquote>")))
 (idm181615412752
  ((file functors.html)
   (html
    "<blockquote>The problem is that <code>with sexp</code>\n      adds code for defining the s-expression converters, and that code\n      assumes that <code>Endpoint</code> has the\n      appropriate sexp-conversion functions for <code>Endpoint.t</code>. But all we know about <code>Endpoint</code> is that it satisfies the <code>Comparable</code> interface, which doesn't say\n      anything about s-expressions.</blockquote>")))
 (idm181615418640
  ((file functors.html)
   (html
    "<blockquote>We'll discuss s-expressions and Sexplib in more detail in <a href=\"data-serialization-with-s-expressions.html\">ChapterÂ 17, <i>Data Serialization with S-Expressions</i></a>, but for now, let's\n      see what happens if we attach the <code>with\n      sexp</code> declaration to the definition of <code>t</code> within the functor:</blockquote>")))
 (idm181615429904
  ((file functors.html)
   (html
    "<blockquote>Core comes with a syntax extension called Sexplib which can\n      autogenerate s-expression conversion functions from a type declaration.\n      Attaching <code>with sexp</code> to a type\n      definition signals to the extension to generate the converters. Thus, we\n      can write:<a name=\"idm181615428736\"></a></blockquote>")))
 (idm181615438240
  ((file functors.html)
   (html
    "<blockquote>Another feature that we might want for our interval module is the\n      ability to <span><em>serialize</em></span>, i.e., to be able to read and\n      write intervals as a stream of bytes. In this case, we'll do this by\n      converting to and from s-expressions, which were mentioned already in\n      <a href=\"error-handling.html\">ChapterÂ 7, <i>Error Handling</i></a>. To recall, an s-expression is\n      essentially a parenthesized expression whose atoms are strings, and it\n      is a serialization format that is used commonly in Core. Here's an\n      example:<a name=\"idm181615436592\"></a><a name=\"idm181615435296\"></a></blockquote>")))
 (idm181615439920
  ((file functors.html)
   (html
    "<blockquote>It's worth noting that the name is somewhat misleading, in that\n      there's nothing destructive about destructive substitution; it's really\n      just a way of creating a new signature by transforming an existing\n      one.</blockquote>")))
 (idm181615441760
  ((file functors.html)
   (html
    "<blockquote>In addition, the <code>endpoint</code> type\n      is gone from the interface, meaning we no longer need to define the\n      <code>endpoint</code> type alias in the body of\n      the module.</blockquote>")))
 (idm181615457856
  ((file functors.html)
   (html
    "<blockquote>The interface is precisely what we want: the type <code>t</code> is abstract, and the type of the endpoint is\n      exposed; so we can create values of type <code>Int_interval.t</code> using the creation function,\n      but not directly using the constructors and thereby violating the\n      invariants of the module:</blockquote>")))
 (idm181615463408
  ((file functors.html)
   (html
    "<blockquote>There's now no <code>endpoint</code> type:\n      all of its occurrences of have been replaced by <code>int</code>. As with sharing constraints, we can also\n      use this in the context of a functor:</blockquote>")))
 (idm181615473712
  ((file functors.html)
   (html
    "<blockquote>The following shows how we could use this with <code>Make_interval</code>:</blockquote>")))
 (idm181615483680
  ((file functors.html)
   (html
    "<blockquote>Sharing constraints basically do the job, but they have some\n      downsides. In particular, we've now been stuck with the useless type\n      declaration of <code>endpoint</code> that clutters\n      up both the interface and the implementation. A better solution would be\n      to modify the <code>Interval_intf</code> signature\n      by replacing <code>endpoint</code> with <code>Endpoint.t</code> everywhere it shows up, and\n      deleting the definition of <code>endpoint</code>\n      from the signature. We can do just this using what's called\n      <span><em>destructive substitution</em></span>. Here's the basic\n      syntax:<a name=\"idm181615479280\"></a><a name=\"idm181615478368\"></a></blockquote>")))
 (idm181615500128
  ((file functors.html)
   (html
    "<blockquote>So now, the interface is as it was, except that <code>endpoint</code> is known to be equal to <code>Endpoint.t</code>.\n        As a result of that type equality, we can again do things that require that <code>endpoint</code> be exposed, like constructing intervals:</blockquote>")))
 (idm181615506544
  ((file functors.html)
   (html
    "<blockquote>In this case, we'd like to expose an equality between the type\n      <code>endpoint</code> in the new module and the\n      type <code>Endpoint.t</code>, from the module\n      <code>Endpoint</code> that is the functor\n      argument. We can do this as follows:</blockquote>")))
 (idm181615507200
  ((file functors.html)
   (html
    "<blockquote>We can also use sharing constraints in the context of a functor.\n      The most common use case is where you want to expose that some of the\n      types of the module being generated by the functor are related to the\n      types in the module fed to the functor.</blockquote>")))
 (idm181615518240
  ((file functors.html)
   (html
    "<blockquote>We can use a sharing constraint to create a specialized version of\n      <code>Interval_intf</code> for integer\n      intervals:</blockquote>")))
 (idm181615524480
  ((file functors.html)
   (html
    "<blockquote>The result of this expression is a new signature that's been modified so that it exposes\n        the fact that <span><em><code>type</code></em></span> defined inside of\n        the module type is equal to <span><em><code>type'</code></em></span>\n        whose definition is outside of it. One can also apply multiple sharing constraints to the\n        same signature:</blockquote>")))
 (idm181615531408
  ((file functors.html)
   (html
    "<blockquote>To fix this, we need to expose the fact that <code>endpoint</code> is equal to <code>Int.t</code> (or more generally, <code>Endpoint.t</code>, where <code>Endpoint</code> is the argument to the functor). One\n      way of doing this is through a <span><em>sharing constraint</em></span>,\n      which allows you to tell the compiler to expose the fact that a given\n      type is equal to some other type. The syntax for a simple sharing\n      constraint is as follows:</blockquote>")))
 (idm181615547264
  ((file functors.html)
   (html
    "<blockquote>The resulting module is abstract, but it's unfortunately too\n      abstract. In particular, we haven't exposed the type <code>endpoint</code>, which means that we can't even\n      construct an interval anymore:<a name=\"idm181615546160\"></a><a name=\"idm181615545248\"></a></blockquote>")))
 (idm181615555120
  ((file functors.html)
   (html
    "<blockquote>This interface includes the type <code>endpoint</code> to give us a way of referring to the\n      endpoint type. Given this interface, we can redo our definition of\n      <code>Make_interval</code>. Notice that we added\n      the type <code>endpoint</code> to the\n      implementation of the module to match <code>Interval_intf</code>:</blockquote>")))
 (idm181615570832
  ((file functors.html)
   (html
    "<blockquote>To make <code>Int_interval.t</code>\n      abstract, we need to restrict the output of <code>Make_interval</code> with an interface. Here's an\n      explicit interface that we can use for that purpose:</blockquote>")))
 (idm181615582288
  ((file functors.html)
   (html
    "<blockquote>There's a problem with <code>Make_interval</code>. The code we wrote depends on\n      the invariant that the upper bound of an interval is greater than its\n      lower bound, but that invariant can be violated. The invariant is\n      enforced by the <code>create</code> function, but because <code>Interval.t</code> is not abstract, we can bypass the\n      <code>create</code> function:<a name=\"idm181615579376\"></a></blockquote>")))
 (idm181615583824
  ((file functors.html)
   (html
    "<blockquote>This is important, because confusing the two kinds of intervals\n    would be a semantic error, and it's an easy one to make. The ability of\n    functors to mint new types is a useful trick that comes up a lot.</blockquote>")))
 (idm181615590960
  ((file functors.html)
   (html
    "<blockquote>Importantly, <code>Rev_int_interval.t</code>\n    is a different type than <code>Int_interval.t</code>, even though its physical\n    representation is the same. Indeed, the type system will prevent us from\n    confusing them.</blockquote>")))
 (idm181615598512
  ((file functors.html)
   (html
    "<blockquote>The behavior of <code>Rev_int_interval</code>\n    is of course different from <code>Int_interval</code>:</blockquote>")))
 (idm181615611664
  ((file functors.html)
   (html
    "<blockquote>This design gives us the freedom to use any comparison function we\n    want for comparing the endpoints. We could, for example, create a type of\n    integer interval with the order of the comparison reversed, as\n    follows:<a name=\"idm181615611168\"></a></blockquote>")))
 (idm181615620368
  ((file functors.html)
   (html
    "<blockquote>We can use the newly defined <code>Int_interval</code> module like\n      any ordinary module:</blockquote>")))
 (idm181615623024
  ((file functors.html)
   (html
    "<blockquote>This works because many modules in Core, including <code>Int</code>\n      and <code>String</code>, satisfy an extended version of the <code>Comparable</code> signature described previously. Such standardized\n      signatures are good practice, both because they make functors easier to use, and because they\n      encourage standardization that makes your codebase easier to navigate.</blockquote>")))
 (idm181615642000
  ((file functors.html)
   (html
    "<blockquote>If the input interface for your functor is aligned with the\n    standards of the libraries you use, then you don't need to construct a\n    custom module to feed to the functor. In this case, we can directly use\n    the <code>Int</code> or <code>String</code> modules provided by Core:</blockquote>")))
 (idm181615653776
  ((file functors.html)
   (html
    "<blockquote>We can instantiate the functor by applying it to a module with the\n    right signature. In the following code, rather than name the module first\n    and then call the functor, we provide the functor input as an anonymous\n    module:</blockquote>")))
 (idm181615688496
  ((file functors.html)
   (html
    "<blockquote>The functor for creating the interval module follows. We represent an interval with a\n      variant type, which is either <code>Empty</code> or <code>Interval (x,y)</code>, where <code>x</code> and\n        <code>y</code> are the bounds of the interval. In addition to the\n      type, the body of the functor contains implementations of a number of useful primitives for\n      interacting with intervals:</blockquote>")))
 (idm181615689504
  ((file functors.html)
   (html
    "<blockquote>(This idiom is a bit of a historical error. It would be better if\n        <code>compare</code> returned a variant with three cases for less than, greater than,\n      and equal. But it's a well-established idiom at this point, and unlikely to change.)</blockquote>")))
 (idm181615693888
  ((file functors.html)
   (html
    "<blockquote>The comparison function follows the standard OCaml idiom for such\n    functions, returning <code>0</code> if the two\n    elements are equal, a positive number if the first element is larger than\n    the second, and a negative number if the first element is smaller than the\n    second. Thus, we could rewrite the standard comparison functions on top of\n    <code>compare</code>.</blockquote>")))
 (idm181615701200
  ((file functors.html)
   (html
    "<blockquote>First we'll define a module type that captures the information we'll\n    need about the endpoints of the intervals. This interface, which we'll\n    call <code>Comparable</code>, contains just two\n    things: a comparison function and the type of the values to be\n    compared:</blockquote>")))
 (idm181615704672
  ((file functors.html)
   (html
    "<blockquote>Let's see how to use functors to build a generic interval library\n    that can be used with any type that supports a total ordering on the\n    underlying set over which you want to build intervals.<a name=\"idm181615704208\"></a><a name=\"FUNCTinterv\"></a></blockquote>")))
 (idm181615705520
  ((file functors.html)
   (html
    "<blockquote>Let's consider a more realistic example of how to use functors: a\n    library for computing with intervals. Intervals are a common computational\n    object, and they come up in different contexts and for different types.\n    You might need to work with intervals of floating-point values or strings\n    or times, and in each of these cases, you want similar operations: testing\n    for emptiness, checking for containment, intersecting intervals, and so\n    on.</blockquote>")))
 (idm181615708000
  ((file functors.html)
   (html
    "<blockquote>The rules for determining whether a module matches a given signature\n    are similar in spirit to the rules in an object-oriented language that\n    determine whether an object satisfies a given interface. As in an\n    object-oriented context, the extra information that doesn't match the\n    signature you're looking for (in this case, the variable <code>y</code>) is simply ignored.</blockquote>")))
 (idm181615720720
  ((file functors.html)
   (html
    "<blockquote>In this case, we applied <code>Increment</code> to a module whose signature is exactly\n    equal to <code>X_int</code>. But we can apply\n    <code>Increment</code> to any module that\n    <span><em>satisfies</em></span> the interface <code>X_int</code>, in the same way that the contents of an\n    <code>ml</code> file must satisfy the <code>mli</code>. That means that the module type can omit\n    some information available in the module, either by dropping fields or by\n    leaving some fields abstract. Here's an example:</blockquote>")))
 (idm181615729296
  ((file functors.html)
   (html
    "<blockquote>We can use <code>Increment</code> to define\n    new modules:</blockquote>")))
 (idm181615730480
  ((file functors.html)
   (html
    "<blockquote>We can see that the inferred module type of the output is now\n    written out explicitly, rather than being a reference to the named\n    signature <code>X_int</code>.</blockquote>")))
 (idm181615736288
  ((file functors.html)
   (html
    "<blockquote>The following shows what happens when we omit the module type for\n    the output of the functor:</blockquote>")))
 (idm181615737712
  ((file functors.html)
   (html
    "<blockquote>One thing that immediately jumps out is that functors are more\n    syntactically heavyweight than ordinary functions. For one thing, functors\n    require explicit (module) type annotations, which ordinary functions do\n    not. Technically, only the type on the input is mandatory, although in\n    practice, you should usually constrain the module returned by the functor,\n    just as you should use an <code>mli</code>, even\n    though it's not mandatory.</blockquote>")))
 (idm181615744208
  ((file functors.html)
   (html
    "<blockquote>Now we can define our functor. We'll use <code>X_int</code> both to constrain the argument to the\n    functor and to constrain the module returned by the functor:</blockquote>")))
 (idm181615749088
  ((file functors.html)
   (html
    "<blockquote>First, let's define a signature for a module that contains a single\n    value of type <code>int</code>:</blockquote>")))
 (idm181615752368
  ((file functors.html)
   (html
    "<blockquote>Let's create a functor that takes a module containing a single\n    integer variable <code>x</code> and returns a new\n    module with <code>x</code> incremented by one. This\n    is intended to serve as a way to walk through the basic mechanics of\n    functors, even though it's not something you'd want to do in\n    practice.<a name=\"idm181615750528\"></a></blockquote>")))
 (idm181615754016
  ((file functors.html)
   (html
    "<blockquote>These are really just some of the uses that you can put functors to.\n  We'll make no attempt to provide examples of all of the uses of functors\n  here. Instead, this chapter will try to provide examples that illuminate the\n  language features and design patterns that you need to master in order to\n  use functors effectively.</blockquote>")))
 (idm181615755072
  ((file functors.html)
   (html
    "<blockquote>Modules can contain mutable states, and that means that you'll\n          occasionally want to have multiple instantiations of a particular\n          module, each with its own separate and independent mutable state.\n          Functors let you automate the construction of such modules.</blockquote>")))
 (idm181615757072
  ((file functors.html)
   (html
    "<blockquote>Functors give you a way of extending existing modules with new\n          functionality in a standardized way. For example, you might want to\n          add a slew of comparison operators derived from a base comparison\n          function. To do this by hand would require a lot of repetitive code\n          for each type, but functors let you write this logic just once and\n          apply it to many different types.</blockquote>")))
 (idm181615758848
  ((file functors.html)
   (html
    "<blockquote>Makes the implementations of some components of a system\n          swappable. This is particularly useful when you want to mock up\n          parts of your system for testing and simulation purposes.</blockquote>")))
 (idm181615760160 ((file functors.html) (html <blockquote></blockquote>)))
 (idm181615760704
  ((file functors.html)
   (html
    "<blockquote>Functors are, roughly speaking, functions from modules to modules, and\n  they can be used to solve a variety of code-structuring problems,\n  including:</blockquote>")))
 (idm181615763136
  ((file functors.html)
   (html
    "<blockquote>Up until now, we've seen OCaml's modules play an important but limited\n  role. In particular, we've seen them as a mechanism for organizing code into\n  units with specified interfaces. But OCaml's module system can do much more\n  than that, serving as a powerful tool for building generic code and\n  structuring large-scale systems. Much of that power comes from\n  functors.<a name=\"idm181615762880\"></a></blockquote>")))
 (idm181610184656
  ((file foreign-function-interface.html)
   (html
    "<blockquote>The details of using Cstubs are available in the online <a href=\"https://ocamllabs.github.io/ocaml-ctypes\" target=\"_top\">documentation</a>,\n      along with instructions on integration with <span><strong>autoconf</strong></span> platform portability\n      instructions.<a name=\"idm181610182912\"></a></blockquote>")))
 (idm181610187648
  ((file foreign-function-interface.html)
   (html
    "<blockquote>The Cstubs subpackage of Ctypes addresses this issue. Rather than\n      simply assuming that struct definitions given by the user accurately\n      reflect the actual definitions of structs used in C libraries, Cstubs\n      generates code that uses the C library headers to discover the layout of\n      the struct. The good news is that the code that you write doesn't need\n      to change much. Cstubs provides alternative implementations of the\n      <code>field</code> and <code>seal</code> functions that you've already used to\n      describe <code>struct timeval</code>; instead of\n      computing member offsets and sizes appropriate for the platform, these\n      implementations obtain them directly from C.</blockquote>")))
 (idm181610189360
  ((file foreign-function-interface.html)
   (html
    "<blockquote>However, this approach can lead to difficulties when the fields of\n      a struct aren't fully specified in the interface of a library. The\n      interface may list the fields of a structure without specifying their\n      order, or make certain fields available only on certain platforms, or\n      insert undocumented fields into struct definitions for performance\n      reasons. For example, the <code>struct\n      timeval</code> definition used in this chapter accurately describes\n      the layout of the struct on common platforms, but implementations on\n      some more unusual architectures include additional padding members that\n      will lead to strange behavior in the examples.</blockquote>")))
 (idm181610192992
  ((file foreign-function-interface.html)
   (html
    "<blockquote>The C language gives implementations a certain amount of freedom\n      in choosing how to lay out structs in memory. There may be padding\n      between members and at the end of the struct, in order to satisfy the\n      memory alignment requirements of the host platform. Ctypes uses\n      platform-appropriate size and alignment information to replicate the\n      struct layout process. OCaml and C will have consistent views about the\n      layout of the struct as long as you declare the fields of a struct in\n      the same order and with the same types as the C library you're binding\n      to.<a name=\"idm181610192128\"></a><a name=\"idm181610190816\"></a></blockquote>")))
 (idm181610195328
  ((file foreign-function-interface.html)
   (html
    "<blockquote><a href=\"http://www.swig.org\" target=\"_top\">SWIG</a> is a tool that\n        connects programs written in C/C++ to a variety of higher-level\n        programming languages, including OCaml. The SWIG manual has examples\n        of converting library specifications into OCaml bindings.</blockquote>")))
 (idm181610197040
  ((file foreign-function-interface.html)
   (html
    "<blockquote>Florent Monnier maintains an excellent online <a href=\"http://www.linux-nantes.org/~fmonnier/ocaml/ocaml-wrapping-c.html\" target=\"_top\">OCaml</a>\n        that provides examples of how to call OCaml functions from C. This\n        covers a wide variety of OCaml data types and also more complex\n        callbacks between C and OCaml.</blockquote>")))
 (idm181610199696
  ((file foreign-function-interface.html)
   (html
    "<blockquote>The standard OCaml foreign function interface allows you to glue OCaml and C together\n          from the other side of the boundary, by writing C functions that operate on the OCaml\n          representation of values. You can find details of the standard interface in the <a href=\"http://caml.inria.fr/pub/docs/manual-ocaml-4.00/manual033.html\" target=\"_top\">OCaml\n            manual</a> and in the book <a href=\"http://caml.inria.fr/pub/docs/oreilly-book/ocaml-ora-book.pdf\" target=\"_top\"><span><em>Developing\n              Applications with Objective Caml</em></span></a>.</blockquote>")))
 (idm181610200672
  ((file foreign-function-interface.html)
   (html
    "<blockquote>You can find more information about the C interface in several\n    places:</blockquote>")))
 (idm181610201488
  ((file foreign-function-interface.html)
   (html
    "<blockquote>Ctypes gives OCaml programs access to the C representation of\n    values, shielding you from the details of the OCaml value representation,\n    and introduces an abstraction layer that hides the details of foreign\n    calls. While this covers a wide variety of situations, it's sometimes\n    necessary to look behind the abstraction to obtain finer control over the\n    details of the interaction between the two languages.</blockquote>")))
 (idm181610203216
  ((file foreign-function-interface.html)
   (html
    "<blockquote>This chapter hasn't really needed you to understand the innards of OCaml at all. Ctypes\n      does its best to make function bindings easy, but the rest of this part will also fill you in\n      about interactions with OCaml memory layout in <a href=\"memory-representation-of-values.html\">ChapterÂ 20, <i>Memory Representation of Values</i></a> and automatic memory management in <a href=\"understanding-the-garbage-collector.html\">ChapterÂ 21, <i>Understanding the Garbage Collector</i></a>.</blockquote>")))
 (idm181610203984
  ((file foreign-function-interface.html)
   (html
    "<blockquote>A comprehensive test suite that covers the complete library, and\n        can provide useful snippets for your own bindings</blockquote>")))
 (idm181610204848
  ((file foreign-function-interface.html)
   (html
    "<blockquote>A more complete Ncurses binding than the example we opened the\n        chapter with</blockquote>")))
 (idm181610206352
  ((file foreign-function-interface.html)
   (html
    "<blockquote>Bindings to the POSIX <code>fts</code>\n        API, which demonstrates C callbacks more comprehensively</blockquote>")))
 (idm181610209328
  ((file foreign-function-interface.html)
   (html
    "<blockquote>The Ctypes <a href=\"http://github.com/ocamllabs/ocaml-ctypes\" target=\"_top\">distribution</a>\n    contains a number of larger-scale examples, including:<a name=\"idm181610208320\"></a></blockquote>")))
 (idm181610212832
  ((file foreign-function-interface.html)
   (html
    "<blockquote>Functions passed to C have similar considerations regarding lifetime. On the OCaml\n          side, functions created at runtime may be collected when they become unreachable. As we've\n          seen, OCaml functions passed to C are converted to function pointers, and function\n          pointers written into the C heap have no effect on the reachability of the OCaml functions\n          they reference. With <code>qsort</code> things are straightforward,\n          since the comparison function is only used during the call to <code>qsort</code> itself. However, other C libraries may store function pointers in\n          global variables or elsewhere, in which case you'll need to take care that the OCaml\n          functions you pass to them aren't prematurely garbage-collected.</blockquote>")))
 (idm181610213680
  ((file foreign-function-interface.html)
   (html
    "<blockquote>A corollary of the preceding rule is that pointers written into the C heap don't have\n          any effect on reachability. For example, if you have a C-managed array of pointers to\n          structs, then you'll need some additional way of keeping the structs themselves around to\n          protect them from collection. You could achieve this via a global array of values on the\n          OCaml side that would keep them live until they're no longer needed.</blockquote>")))
 (idm181610214288
  ((file foreign-function-interface.html)
   (html
    "<blockquote>&quot;Derivative&quot; means a pointer that's computed from the original\n        pointer via arithmetic, so a reachable reference to an array element\n        or a structure field protects the whole object from collection.</blockquote>")))
 (idm181610214992
  ((file foreign-function-interface.html)
   (html
    "<blockquote>The definition of reachability for Ctypes values is a little\n        different from conventional OCaml values, though. The allocation\n        functions return an OCaml-managed pointer to the value, and as long as\n        some derivative pointer is still reachable by the GC, the value won't\n        be collected.</blockquote>")))
 (idm181610216992
  ((file foreign-function-interface.html)
   (html
    "<blockquote>Values allocated via Ctypes (i.e., using <code>allocate</code>,\n            <code>Array.make</code>, and so on) will not be garbage-collected\n          as long as they are reachable from OCaml values. The system memory they occupy is freed\n          when they do become unreachable, via a finalizer function registered with the garbage\n          collector (GC).</blockquote>")))
 (idm181610225232
  ((file foreign-function-interface.html)
   (html
    "<blockquote>Using <code>qsort'</code> to sort arrays is\n      straightforward. Our example code reads the standard input as a list,\n      converts it to a C array, passes it through qsort, and outputs the\n      result to the standard output. Again, remember to not confuse the\n      <code>Ctypes.Array</code> module with the <code>Core.Std.Array</code> module: the former is in scope\n      since we opened <code>Ctypes</code> at the start\n      of the file.<a name=\"idm181610222000\"></a><a name=\"idm181610220432\"></a><a name=\"idm181610219120\"></a></blockquote>")))
 (idm181610227952
  ((file foreign-function-interface.html)
   (html
    "<blockquote>The <code>qsort'</code> wrapper function has\n      a much more canonical OCaml interface than the raw binding. It accepts a\n      comparator function and a Ctypes array, and returns the same Ctypes\n      array. It's not strictly required that it returns the array, since it\n      modifies it in-place, but it makes it easier to chain the function using\n      the <code>|&gt;</code> operator (as <code>sort_stdin</code> does in the example).</blockquote>")))
 (idm181610232688
  ((file foreign-function-interface.html)
   (html
    "<blockquote>The inferred interface shows us the types of the raw <code>qsort</code> binding and also the <code>qsort'</code> wrapper function:</blockquote>")))
 (idm181610247408
  ((file foreign-function-interface.html)
   (html
    "<blockquote>Compile it in the usual way with <span><em>corebuild</em></span> and test it against some\n        input data, and also build the inferred interface so we can examine it more closely:</blockquote>")))
 (idm181610251904
  ((file foreign-function-interface.html)
   (html
    "<blockquote>The following is a command-line tool that uses the <code>qsort</code> binding to sort all of the integers\n      supplied on the standard input:<a name=\"idm181610250864\"></a></blockquote>")))
 (idm181610254112
  ((file foreign-function-interface.html)
   (html
    "<blockquote>Arrays created using Ctypes have a richer runtime structure than C\n    arrays, so we don't need to pass size information around. Furthermore, we\n    can use OCaml polymorphism in place of the unsafe <code>void ptr</code> type.</blockquote>")))
 (idm181610258144
  ((file foreign-function-interface.html)
   (html
    "<blockquote>We only use <code>compare_t</code> once (in the <code>qsort</code> definition), so you can choose to inline it in the OCaml\n      code if you prefer. As the type shows, the resulting <code>qsort</code>\n      value is a higher-order function, since the fourth argument is itself a function. As before,\n      let's define a wrapper function to make <code>qsort</code> easier to\n      use. The second and third arguments to <code>qsort</code> specify the\n      length (number of elements) of the array and the element size.</blockquote>")))
 (idm181610273808
  ((file foreign-function-interface.html)
   (html
    "<blockquote>This also happens to be a close mapping to the corresponding Ctypes\n    definition. Since type descriptions are regular values, we can just use\n    <code>let</code> in place of <code>typedef</code> and end up with working OCaml bindings\n    to <code>qsort</code>:</blockquote>")))
 (idm181610277952
  ((file foreign-function-interface.html)
   (html
    "<blockquote>C programmers often use <code>typedef</code>\n    to make type definitions involving function pointers easier to read. Using\n    a typedef, the type of <code>qsort</code> looks a\n    little more palatable:</blockquote>")))
 (idm181610284768
  ((file foreign-function-interface.html)
   (html
    "<blockquote>It's also straightforward to pass OCaml function values to C. The C standard library\n      function <code>qsort</code> sorts arrays of elements using a comparison\n      function passed in as a function pointer. The signature for <code>qsort</code> is:<a name=\"idm181610282992\"></a><a name=\"idm181610281696\"></a></blockquote>")))
 (idm181610286624
  ((file foreign-function-interface.html)
   (html
    "<blockquote>There are also other useful nonoperator functions available (see the Ctypes\n          documentation), such as pointer differencing and comparison.</blockquote>")))
 (idm181610303184
  ((file foreign-function-interface.html)
   (html
    "<blockquote>Ctypes defines a number of operators that let you manipulate\n        pointers and arrays just as you would in C. The Ctypes equivalents do\n        have the benefit of being more strongly typed, of course (see <a href=\"foreign-function-interface.html#Table19sub1\">TableÂ 19.1, â\128\156Operators for manipulating pointers and arraysâ\128\157</a>).</blockquote>")))
 (idm181610307296
  ((file foreign-function-interface.html)
   (html
    "<blockquote>Unions in C are named structures that can be mapped onto the same\n      underlying memory. They are also fully supported in Ctypes, but we won't\n      go into more detail here.<a name=\"idm181610306848\"></a><a name=\"idm181610305568\"></a></blockquote>")))
 (idm181610308672
  ((file foreign-function-interface.html)
   (html
    "<blockquote>As with standard OCaml arrays, the conversion between arrays and\n      lists requires copying the values, which can be expensive for large data\n      structures. Notice that you can also convert an array into a <code>ptr</code> pointer to the head of the underlying\n      buffer, which can be useful if you need to pass the pointer and size\n      arguments separately to a C function.</blockquote>")))
 (idm181610311104
  ((file foreign-function-interface.html)
   (html
    "<blockquote>The array functions are similar to those in the standard library\n      <code>Array</code> module except that they operate\n      on arrays stored using the flat C representation rather than the OCaml\n      representation described in <a href=\"memory-representation-of-values.html\">ChapterÂ 20, <i>Memory Representation of Values</i></a>.</blockquote>")))
 (idm181610317328
  ((file foreign-function-interface.html)
   (html
    "<blockquote>Arrays in C are contiguous blocks of the same type of value. Any\n      of the basic types defined previously can be allocated as blocks via the\n      <code>Array</code> module:<a name=\"idm181610316256\"></a><a name=\"idm181610314960\"></a></blockquote>")))
 (idm181610319920
  ((file foreign-function-interface.html)
   (html
    "<blockquote>In OCaml, of course, these types are absolutely equivalent.\n          Since the OCaml types are the same but the C semantics are quite\n          different, we need some kind of marker to distinguish the cases.\n          This is the purpose of <code>returning</code>\n          in function definitions.</blockquote>")))
 (idm181610323840
  ((file foreign-function-interface.html)
   (html
    "<blockquote>The OCaml type of <code>uncurried_C</code> when bound by Ctypes is\n          <code>int -&gt; int -&gt; int</code>: a\n          two-argument function. The OCaml type of <code>curried_C</code> when bound by <code>ctypes</code> is <code>int\n          -&gt; (int -&gt; int)</code>: a one-argument function that\n          returns a one-argument function.</blockquote>")))
 (idm181610326784
  ((file foreign-function-interface.html)
   (html
    "<blockquote>A C function that's written in curried style looks very\n          different:</blockquote>")))
 (idm181610329424
  ((file foreign-function-interface.html)
   (html
    "<blockquote>and the arguments must always be supplied together:</blockquote>")))
 (idm181610332176
  ((file foreign-function-interface.html)
   (html
    "<blockquote>and the arguments can be supplied one at a time to create a\n          closure. In contrast, C functions receive their arguments all at\n          once. The equivalent C function type is the following:</blockquote>")))
 (idm181610334992
  ((file foreign-function-interface.html)
   (html "<blockquote>but this really means:</blockquote>")))
 (idm181610337824
  ((file foreign-function-interface.html)
   (html
    "<blockquote>Secondly, OCaml functions are typically defined in a curried\n          style. The signature of a two-argument function is written as\n          follows:</blockquote>")))
 (idm181610338544
  ((file foreign-function-interface.html)
   (html
    "<blockquote>The reason involves higher types and two differences between\n          the way that functions are treated in OCaml and C. Functions are\n          first-class values in OCaml, but not in C. For example, in C it is\n          possible to return a function pointer from a function, but not to\n          return an actual function.</blockquote>")))
 (idm181610342256
  ((file foreign-function-interface.html)
   (html
    "<blockquote>The <code>returning</code> function may\n          appear superfluous here. Why couldn't we simply give the types as\n          follows?</blockquote>")))
 (idm181610345728
  ((file foreign-function-interface.html)
   (html
    "<blockquote>The alert reader may be curious about why all these function\n          definitions have to be terminated by <code>returning</code>:</blockquote>")))
 (idm181610354368
  ((file foreign-function-interface.html)
   (html
    "<blockquote>This can be compiled and run in the usual way:<a name=\"idm181610354112\"></a></blockquote>")))
 (idm181610358768
  ((file foreign-function-interface.html)
   (html
    "<blockquote>We built up a lot of bindings in the previous section, so let's\n        recap them with a complete example that ties it together with a\n        command-line frontend:<a name=\"idm181610358336\"></a></blockquote>")))
 (idm181610364944
  ((file foreign-function-interface.html)
   (html
    "<blockquote>You need to be a little careful not to get all the open modules\n      mixed up here. Both <code>Pervasives</code> and\n      <code>Ctypes</code> define different <code>float</code> functions. The <code>Ctypes</code> module we opened up earlier overrides\n      the <code>Pervasives</code> definition. As seen\n      previously though, you just need to locally open <code>Pervasives</code> again to bring the usual <code>float</code> function back in scope.</blockquote>")))
 (idm181610377296
  ((file foreign-function-interface.html)
   (html
    "<blockquote>As before, we can create a wrapper to make <code>gettimeofday</code> easier to use. The functions\n      <code>make</code>, <code>addr</code>, and <code>getf</code> create a structure value, retrieve the\n      address of a structure value, and retrieve the value of a field from a\n      structure:</blockquote>")))
 (idm181610380528
  ((file foreign-function-interface.html)
   (html
    "<blockquote>There's one other new feature here: the <code>returning_checking_errno</code> function behaves like\n      <code>returning</code>, except that it checks\n      whether the bound C function modifies the C error flag. Changes to\n      <code>errno</code> are mapped into OCaml\n      exceptions and raise a <code>Unix.Unix_error</code> exception just as the standard\n      library functions do.</blockquote>")))
 (idm181610387056
  ((file foreign-function-interface.html)
   (html
    "<blockquote>We're finally ready to bind to <code>gettimeofday</code> now:</blockquote>")))
 (idm181610389024
  ((file foreign-function-interface.html)
   (html
    "<blockquote>We don't ever need to create <code>struct\n      timezone</code> values, so we can leave this struct as incomplete\n      without adding any fields or sealing it. If you ever try to use it in a\n      situation where its concrete size needs to be known, the library will\n      raise an <code>IncompleteType</code>\n      exception.</blockquote>")))
 (idm181610397920
  ((file foreign-function-interface.html)
   (html
    "<blockquote>Since <code>gettimeofday</code> needs a\n      <code>struct timezone</code> pointer for its\n      second argument, we also need to define a second structure\n      type:<a name=\"idm181610396256\"></a></blockquote>")))
 (idm181610400352
  ((file foreign-function-interface.html)
   (html
    "<blockquote>Every field addition mutates the structure variable and records a\n      new size (the exact value of which depends on the type of the field that\n      was just added). Once we <code>seal</code> the\n      structure, we will be able to create values using it, but adding fields\n      to a sealed structure is an error.</blockquote>")))
 (idm181610402912
  ((file foreign-function-interface.html)
   (html
    "<blockquote>The <code>field</code> function appends a\n      field to the structure, as shown with <code>tv_sec</code> and <code>tv_usec</code>. Structure fields are typed accessors\n      that are associated with a particular structure, and they correspond to\n      the labels in C.</blockquote>")))
 (idm181610414992
  ((file foreign-function-interface.html)
   (html
    "<blockquote>The <code>timeval</code> structure\n      definition still doesn't have any fields, so we need to add those\n      next:<a name=\"idm181610413984\"></a><a name=\"idm181610412672\"></a></blockquote>")))
 (idm181610417936
  ((file foreign-function-interface.html)
   (html
    "<blockquote>The second command calls <code>structure</code> to create a fresh structure type. At\n      this point, the structure type is incomplete: we can add fields but\n      cannot yet use it in <code>foreign</code> calls or\n      use it to create values.</blockquote>")))
 (idm181610420400
  ((file foreign-function-interface.html)
   (html
    "<blockquote>The first command defines a new OCaml type <code>timeval</code> that we'll use to instantiate the\n      OCaml version of the struct. This is a <span><em>phantom type</em></span>\n      that exists only to distinguish the underlying C type from other pointer\n      types. The particular <code>timeval</code>\n      structure now has a distinct type from other structures we define\n      elsewhere, which helps to avoid getting them mixed up.</blockquote>")))
 (idm181610426640
  ((file foreign-function-interface.html)
   (html
    "<blockquote>Using Ctypes, we can describe this type as follows in our\n      toplevel, continuing on from the previous definitions:</blockquote>")))
 (idm181610430816
  ((file foreign-function-interface.html)
   (html
    "<blockquote>Let's improve the timer function that we wrote earlier. The POSIX\n      function <code>gettimeofday</code> retrieves the\n      time with microsecond resolution. The signature of <code>gettimeofday</code> is as follows, including the\n      structure definitions:</blockquote>")))
 (idm181610437568
  ((file foreign-function-interface.html)
   (html
    "<blockquote>The C constructs <code>struct</code> and\n    <code>union</code> make it possible to build new\n    types from existing types. Ctypes contains counterparts that work\n    similarly.<a name=\"idm181610435856\"></a><a name=\"idm181610434544\"></a><a name=\"idm181610433216\"></a></blockquote>")))
 (idm181610440832
  ((file foreign-function-interface.html)
   (html
    "<blockquote>This means that you need to be careful that OCaml strings that\n        you pass to C functions don't contain any null values, since the first\n        occurrence of a null character will be treated as the end of the C\n        string. Ctypes also defaults to a <span><em>copying</em></span>\n        interface for strings, which means that you shouldn't use them when\n        you want the library to mutate the buffer in-place. In that situation,\n        use the Ctypes <code>Bigarray</code> support to\n        pass memory by reference instead.</blockquote>")))
 (idm181610442208
  ((file foreign-function-interface.html)
   (html
    "<blockquote>OCaml strings are stored in the OCaml heap with a header that\n        explicitly defines their length. C buffers are also fixed-length, but\n        by convention, a C string is terminated by a null (a <code>\\0</code> byte) character. The C string functions\n        calculate their length by scanning the buffer until the first null\n        character is encountered.</blockquote>")))
 (idm181610442768
  ((file foreign-function-interface.html)
   (html
    "<blockquote>Although OCaml strings may look like C character buffers from an\n        interface perspective, they're very different in terms of their memory\n        representations.</blockquote>")))
 (idm181610450912
  ((file foreign-function-interface.html)
   (html
    "<blockquote>The type of this <code>string</code>\n      function is a normal <code>typ</code> with no\n      external sign of the use of the view function:</blockquote>")))
 (idm181610454128
  ((file foreign-function-interface.html)
   (html
    "<blockquote>Given these functions, the definition of the <code>Ctypes.string</code> value that uses views is quite\n      simple:</blockquote>")))
 (idm181610458064
  ((file foreign-function-interface.html)
   (html
    "<blockquote>Ctypes has some internal low-level conversion functions that map\n      between an OCaml <code>string</code> and a C\n      character buffer by copying the contents into the respective data\n      structure. They have the following type signature:</blockquote>")))
 (idm181610461696
  ((file foreign-function-interface.html)
   (html
    "<blockquote>Here is the type signature of the <code>Ctypes.view</code> function:</blockquote>")))
 (idm181610464896
  ((file foreign-function-interface.html)
   (html
    "<blockquote>We've already used one view in the definition of <code>ctime</code> earlier. The <code>string</code> view wraps the C type <code>char *</code> (written in OCaml as <code>ptr char</code>) and converts between the C and OCaml\n      string representations each time the value is written or read.</blockquote>")))
 (idm181610468144
  ((file foreign-function-interface.html)
   (html
    "<blockquote>While scalar types typically have a 1:1 representation, other C\n      types require extra work to convert them into OCaml. Views create new C\n      type descriptions that have special behavior when used to read or write\n      C values.<a name=\"idm181610467648\"></a><a name=\"idm181610466336\"></a></blockquote>")))
 (idm181610475008
  ((file foreign-function-interface.html)
   (html
    "<blockquote>The <code>allocate</code> function takes the\n      type of the memory to be allocated and the initial value and it returns\n      a suitably typed pointer. We can now call <code>ctime</code> passing the pointer as an\n      argument:</blockquote>")))
 (idm181610481440
  ((file foreign-function-interface.html)
   (html
    "<blockquote>This is because <code>ctime</code> needs a\n      pointer to the <code>time_t</code> rather than\n      passing it by value. We thus need to allocate some memory for the\n      <code>time_t</code> and obtain its memory\n      address:</blockquote>")))
 (idm181610488416
  ((file foreign-function-interface.html)
   (html
    "<blockquote>The binding is continued in the toplevel to add to our growing\n      collection. However, we can't just pass the result of <code>time</code> to <code>ctime</code>:</blockquote>")))
 (idm181610497040
  ((file foreign-function-interface.html)
   (html
    "<blockquote>Let's look at a slightly less trivial example where we pass a\n      nonnull pointer to a function. Continuing with the theme from earlier,\n      we'll bind to the <code>ctime</code> function,\n      which converts a <code>time_t</code> value to a\n      human-readable string:<a name=\"idm181610495232\"></a><a name=\"idm181610493920\"></a></blockquote>")))
 (idm181610499744
  ((file foreign-function-interface.html)
   (html
    "<blockquote>The binding to <code>difftime</code> above is\n    sufficient to compare two <code>time_t</code>\n    values.</blockquote>")))
 (idm181610511296
  ((file foreign-function-interface.html)
   (html
    "<blockquote>Since <code>time_t</code> is an abstract type,\n    we can't actually do anything useful with it directly. We need to bind a\n    second function to do anything useful with the return values from <code>time</code>. We'll move on to <code>difftime</code>; the second C function in our prototype\n    list:</blockquote>")))
 (idm181610516400
  ((file foreign-function-interface.html)
   (html
    "<blockquote>Since we're going to call <code>time</code> a\n    few times, let's create a wrapper function that passes the null pointer\n    through:</blockquote>")))
 (idm181610522192
  ((file foreign-function-interface.html)
   (html
    "<blockquote>We can now call <code>time</code> immediately\n    in the same toplevel. The argument is actually optional, so we'll just\n    pass a null pointer that has been coerced into becoming a null pointer to\n    <code>time_t</code>:</blockquote>")))
 (idm181610525360
  ((file foreign-function-interface.html)
   (html
    "<blockquote>The <code>foreign</code> function is the main\n    link between OCaml and C. It takes two arguments: the name of the C\n    function to bind, and a value describing the type of the bound function.\n    In the <code>time</code> binding, the function type\n    specifies one argument of type <code>ptr\n    time_t</code> and a return type of <code>time_t</code>.</blockquote>")))
 (idm181610536096
  ((file foreign-function-interface.html)
   (html
    "<blockquote>We can now create a binding to <code>time</code> directly from the toplevel.</blockquote>")))
 (idm181610538272
  ((file foreign-function-interface.html)
   (html
    "<blockquote>The <code>Foreign</code> module exposes\n          the <code>foreign</code> function that makes\n          it possible to invoke C functions.</blockquote>")))
 (idm181610541568
  ((file foreign-function-interface.html)
   (html
    "<blockquote>The <code>PosixTypes</code> module\n          includes some extra POSIX-specific types (such as <code>time_t</code>).</blockquote>")))
 (idm181610544224
  ((file foreign-function-interface.html)
   (html
    "<blockquote>The <code>Ctypes</code> module provides\n          functions for describing C types in OCaml.</blockquote>")))
 (idm181610546944
  ((file foreign-function-interface.html)
   (html
    "<blockquote>The <code>time</code> function returns the\n    current calendar time and is a simple start. The first step is to open\n    some of the Ctypes modules:</blockquote>")))
 (idm181610549728
  ((file foreign-function-interface.html)
   (html
    "<blockquote>We've already seen a simple use of pointers in the Ncurses example.\n    Let's start a new example by binding the following POSIX functions:</blockquote>")))
 (idm181610555216
  ((file foreign-function-interface.html)
   (html
    "<blockquote>Pointers are at the heart of C, so they are necessarily part of\n    Ctypes, which provides support for pointer arithmetic, pointer\n    conversions, reading and writing through pointers, and passing and\n    returning pointers to and from functions.<a name=\"idm181610554704\"></a><a name=\"idm181610553808\"></a><a name=\"idm181610552512\"></a><a name=\"idm181610551200\"></a></blockquote>")))
 (idm181610561040
  ((file foreign-function-interface.html)
   (html
    "<blockquote>OCaml only supports double-precision floating-point numbers, and\n        so the C <code>float</code> and <code>double</code> types both map onto the OCaml\n        <code>float</code> type, and the C <code>float complex</code> and <code>double complex</code> types both map onto the OCaml\n        double-precision <code>Complex.t</code>\n        type.</blockquote>")))
 (idm181610564000
  ((file foreign-function-interface.html)
   (html
    "<blockquote>The C <code>size_t</code> type is an alias\n        for one of the unsigned integer types. The actual size and alignment\n        requirements for <code>size_t</code> varies\n        between platforms. Ctypes provides an OCaml <code>size_t</code> type that is aliased to the\n        appropriate integer type.</blockquote>")))
 (idm181610568048
  ((file foreign-function-interface.html)
   (html
    "<blockquote>Void values appear in OCaml as the <code>unit</code> type. Using <code>void</code> in an argument or result type\n        specification produces an OCaml function that accepts or returns\n        <code>unit</code>. Dereferencing a pointer to <code>void</code> is an error, as in C, and will raise\n        the <code>IncompleteType</code>\n        exception.</blockquote>")))
 (idm181610571760
  ((file foreign-function-interface.html)
   (html
    "<blockquote>These values are all of type <code>'a\n    typ</code>, where the value name (e.g., <code>void</code>) tells you the C type and the <code>'a</code> component (e.g., <code>unit</code>) is the OCaml representation of that C\n    type. Most of the mappings are straightforward, but some of them need a\n    bit more explanation:</blockquote>")))
 (idm181610576352
  ((file foreign-function-interface.html)
   (html
    "<blockquote>Here are the definitions for most of the standard C99 scalar types,\n    including some platform-dependent ones<a name=\"idm181610575984\"></a>:</blockquote>")))
 (idm181610577072
  ((file foreign-function-interface.html)
   (html
    "<blockquote>Describing component fields of structures, unions, and\n        arrays</blockquote>")))
 (idm181610577936
  ((file foreign-function-interface.html)
   (html
    "<blockquote>Constructing pointers for reading and writing locations in\n        C-managed storage</blockquote>")))
 (idm181610578768
  ((file foreign-function-interface.html)
   (html
    "<blockquote>Constructing function types for binding native functions</blockquote>")))
 (idm181610580368
  ((file foreign-function-interface.html)
   (html
    "<blockquote>There are various other uses of <code>typ</code> values within Ctypes, such as:</blockquote>")))
 (idm181610583088
  ((file foreign-function-interface.html)
   (html
    "<blockquote>The corresponding OCaml type. The <code>'a</code> type parameter contains the OCaml type\n        such that a value of type <code>t typ</code> is\n        used to read and write OCaml values of type <code>t</code>.</blockquote>")))
 (idm181610583936
  ((file foreign-function-interface.html)
   (html
    "<blockquote>The C type used to store and pass values to the foreign\n        library.</blockquote>")))
 (idm181610586128
  ((file foreign-function-interface.html)
   (html
    "<blockquote><code>Ctypes.typ</code> is the type of values\n    that represents C types to OCaml. There are two types associated with each\n    instance of <code>typ</code>:</blockquote>")))
 (idm181610591120
  ((file foreign-function-interface.html)
   (html
    "<blockquote>First, let's look at how to define basic scalar C types. Every C\n    type is represented by an OCaml equivalent via the single type\n    definition:<a name=\"idm181610590704\"></a><a name=\"idm181610589808\"></a></blockquote>")))
 (idm181610593328
  ((file foreign-function-interface.html)
   (html
    "<blockquote>We'll go over some of these features in more detail for the\n    remainder of the chapter by using some POSIX date functions as running\n    examples.<a name=\"idm181610592912\"></a></blockquote>")))
 (idm181610594032
  ((file foreign-function-interface.html)
   (html
    "<blockquote>Ctypes wouldn't be very useful if it were limited to only defining\n    simple C types, of course. It provides full support for C pointer\n    arithmetic, pointer conversions, and reading and writing through pointers,\n    using OCaml functions as function pointers to C code, as well as struct\n    and union definitions.</blockquote>")))
 (idm181610595824
  ((file foreign-function-interface.html)
   (html
    "<blockquote>The <code>--no-as-needed</code> flag\n      disables this behavior and ensures all the specified libraries are\n      linked despite not being directly used. The flag unfortunately doesn't\n      work everywhere (notably, Mac OS X should <span><em>not</em></span> have\n      this passed to it).</blockquote>")))
 (idm181610617280
  ((file foreign-function-interface.html)
   (html
    "<blockquote>On some distributions such as Ubuntu 11.10 upwards, you'll also need to add <code>-cclib,-Xlinker,-cclib, and --no-as-needed</code> to the <span><code>-lflags</code></span> directive.\n          <code>-Xlinker</code> is interpreted by the compiler as a directive\n        for the system linker <span><strong>ld</strong></span>, to which it passes <code>--no-as-needed</code>. <span>Several</span>\n        modern OS distributions (such as Ubuntu 11.10 onwards) configure the system linker to only\n        link in libraries that directly contain symbols used by the program. However, when we use\n        Ctypes, those symbols are not referenced until runtime, which results an exception due to\n        the library not being available.</blockquote>")))
 (idm181610623936
  ((file foreign-function-interface.html)
   (html
    "<blockquote>The preceding command line includes some important extra link\n      directives. The <code>-lflags</code> instructs\n      <span><strong>ocamlbuild</strong></span> to pass the next\n      comma-separated set of arguments through to the <span><strong>ocaml</strong></span> command when linking a binary. OCaml in\n      turn uses <code>-cclib</code> to pass directives\n      through to the system compiler (normally <span><strong>gcc</strong></span> or <span><strong>clang</strong></span>). We first need to link to the <code>ncurses</code> C library to make the symbols\n      available to Ctypes, and <span><code>-cclib,</code></span><code>-lncurses</code> does that.</blockquote>")))
 (idm181610627024
  ((file foreign-function-interface.html)
   (html
    "<blockquote>Running <code>./hello.native</code> should now\n    display a Hello World in your terminal!<a name=\"idm181610626048\"></a></blockquote>")))
 (idm181610632064
  ((file foreign-function-interface.html)
   (html
    "<blockquote>The <code>hello</code> executable is compiled\n    by linking with the <code>ctypes.foreign</code>\n    OCamlfind package:</blockquote>")))
 (idm181610635008
  ((file foreign-function-interface.html)
   (html
    "<blockquote>Now compile a &quot;hello world&quot; terminal drawing program to tie this all\n    together:</blockquote>")))
 (idm181610637440
  ((file foreign-function-interface.html)
   (html
    "<blockquote>The <code>window</code> type is left abstract\n    in the signature to ensure that window pointers can only be constructed\n    via the <code>Ncurses.initscr</code> function. This\n    prevents void pointers obtained from other sources from being mistakenly\n    passed to an Ncurses library call.</blockquote>")))
 (idm181610640320
  ((file foreign-function-interface.html)
   (html
    "<blockquote>Here's the customized interface that we can safely use from other\n    libraries:</blockquote>")))
 (idm181610642336
  ((file foreign-function-interface.html)
   (html
    "<blockquote>The <code>inferred.mli</code> target instructs the compiler to\n      generate the default signature for a module file and places it in the <code>_build</code> directory as a normal output. You should normally copy it out into your\n      source directory and customize it to improve its safety for external callers by making some of\n      its internals more abstract.</blockquote>")))
 (idm181610648464
  ((file foreign-function-interface.html)
   (html
    "<blockquote>The module signature for <code>ncurses.mli</code> looks much like a normal OCaml\n    signature. You can infer it directly from the <code>ncurses.ml</code> by running a special build\n    target:</blockquote>")))
 (idm181610650496
  ((file foreign-function-interface.html)
   (html
    "<blockquote>Most of the parameters in the Ncurses example represent fairly\n    simple scalar C types, except for <code>window</code> (a pointer to the library state) and\n    <code>string</code>, which maps from OCaml strings\n    that have a specific length onto C character buffers whose length is\n    defined by a terminating null character that immediately follows the\n    string data.</blockquote>")))
 (idm181610653696
  ((file foreign-function-interface.html)
   (html
    "<blockquote>These definitions are all straightforward mappings from the C\n    declarations in the Ncurses header file. Note that the <code>string</code> and <code>int</code> values here are nothing to do with OCaml\n    type declarations; instead, they are values that come from opening the\n    <code>Ctypes</code> module at the top of the\n    file.</blockquote>")))
 (idm181610656640
  ((file foreign-function-interface.html)
   (html
    "<blockquote>The remainder of the Ncurses binding simply expands on these\n    definitions:</blockquote>")))
 (idm181610658800
  ((file foreign-function-interface.html)
   (html
    "<blockquote>A value that defines the complete set of C function arguments\n        and its return type. The <code>@-&gt;</code>\n        operator adds an argument to the C parameter list, and <code>returning</code> terminates the parameter list with\n        the return type.</blockquote>")))
 (idm181610660304
  ((file foreign-function-interface.html)
   (html
    "<blockquote>The C function call name, which is looked up using the <code>dlsym</code> POSIX function.</blockquote>")))
 (idm181610662576
  ((file foreign-function-interface.html)
   (html
    "<blockquote>That's all we need to invoke our first function call to <code>initscr</code> to initialize the terminal. The <code>foreign</code> function accepts two parameters:</blockquote>")))
 (idm181610666464
  ((file foreign-function-interface.html)
   (html
    "<blockquote>We don't know the internal representation of the window pointer, so we treat it as a C\n      void pointer. We'll improve on this later on in the chapter, but it's good enough for now. The\n      second statement defines an OCaml value that represents the <code>WINDOW</code> C pointer. This value is used later in the Ctypes function\n      definitions:</blockquote>")))
 (idm181610669856
  ((file foreign-function-interface.html)
   (html
    "<blockquote>Let's begin by defining the basic values we need, starting with the\n    <code>WINDOW</code> state pointer:</blockquote>")))
 (idm181610670560
  ((file foreign-function-interface.html)
   (html
    "<blockquote>Ctypes provides an OCaml interface that lets you map these C\n    functions to equivalent OCaml functions. The library takes care of\n    converting OCaml function calls and arguments into the C calling\n    convention, invoking the foreign call within the C library and finally\n    returning the result as an OCaml value.</blockquote>")))
 (idm181610675184
  ((file foreign-function-interface.html)
   (html
    "<blockquote>Note that there are over 200 library calls in Ncurses, so we're only\n    binding a select few for this example. The <code>initscr</code> and <code>newwin</code> create <code>WINDOW</code> pointers for the global and subwindows,\n    respectively. The <code>mvwaddrstr</code> takes a\n    window, x/y offsets, and a string and writes to the screen at that\n    location. The terminal is only updated after <code>refresh</code> or <code>wrefresh</code> are called.</blockquote>")))
 (idm181610677248
  ((file foreign-function-interface.html)
   (html
    "<blockquote>The Ncurses functions either operate on the current pseudoterminal\n    or on a window that has been created via <code>newwin</code>. The <code>WINDOW</code> structure holds the internal library\n    state and is considered abstract outside of Ncurses. Ncurses clients just\n    need to store the pointer somewhere and pass it back to Ncurses library\n    calls, which in turn dereference its contents.</blockquote>")))
 (idm181610682368
  ((file foreign-function-interface.html)
   (html
    "<blockquote>The full C interface is quite large and is explained in the online\n    <a href=\"http://www.gnu.org/software/ncurses/\" target=\"_top\">documentation</a>.\n    We'll just use the small excerpt, since we just want to demonstrate Ctypes\n    in action:<a name=\"idm181610681264\"></a></blockquote>")))
 (idm181610684544
  ((file foreign-function-interface.html)
   (html
    "<blockquote>Ncurses is a library to help build terminal-independent text\n    interfaces in a reasonably efficient way. It's used in console mail\n    clients like Mutt and Pine, and console web browsers such as\n    Lynx.<a name=\"FFItermint\"></a></blockquote>")))
 (idm181610686816
  ((file foreign-function-interface.html)
   (html
    "<blockquote>You'll also need the Ncurses library for the first example. This comes preinstalled on\n      many operating systems such as Mac OS X, and Debian Linux provides it as the <code>libncurses5-dev</code> package.</blockquote>")))
 (idm181610693312
  ((file foreign-function-interface.html)
   (html
    "<blockquote>Once that's done, Ctypes is available via OPAM as usual:</blockquote>")))
 (idm181610695248
  ((file foreign-function-interface.html)
   (html
    "<blockquote>A special note for Mac users: the version of <code>libffi</code> installed by default in Mac OS X 10.8 is\n    too old for some of the features that Ctypes needs. Use Homebrew to\n    <code>brew install libffi</code> to get the latest\n    version before installing the OCaml library.</blockquote>")))
 (idm181610696848
  ((file foreign-function-interface.html)
   (html
    "<blockquote>You'll need to install the <a href=\"https://github.com/atgreen/libffi\" target=\"_top\"><code>libffi</code></a> library as a prerequisite to\n    using Ctypes. It's a fairly popular library and should be available in\n    your OS package manager.</blockquote>")))
 (idm181610698144
  ((file foreign-function-interface.html)
   (html
    "<blockquote>Let's dive straight into a realistic example to show you how the\n  library looks. We'll create a binding to the Ncurses terminal toolkit, as\n  it's widely available on most systems and doesn't have any complex\n  dependencies.</blockquote>")))
 (idm181610701904
  ((file foreign-function-interface.html)
   (html
    "<blockquote>The simplest foreign function interface in OCaml doesn't even require\n  you to write any C code at all! The Ctypes library lets you define the C\n  interface in pure OCaml, and the library then takes care of loading the C\n  symbols and invoking the foreign function call.<a name=\"idm181610701376\"></a><a name=\"idm181610700480\"></a><a name=\"idm181610699568\"></a></blockquote>")))
 (idm181610702656
  ((file foreign-function-interface.html)
   (html
    "<blockquote>Work through some full examples for binding a terminal interface\n      and UNIX date/time functions</blockquote>")))
 (idm181610703520
  ((file foreign-function-interface.html)
   (html
    "<blockquote>Teach you how to build higher-level abstractions in OCaml from the\n      low-level C bindings</blockquote>")))
 (idm181610704368
  ((file foreign-function-interface.html)
   (html
    "<blockquote>Show how to call routines in C libraries directly from your OCaml\n      code</blockquote>")))
 (idm181610705856
  ((file foreign-function-interface.html)
   (html
    "<blockquote>The mechanism by which code in one programming language can invoke routines in a different\n    programming language is called a <span><em>foreign function interface</em></span>. This chapter\n    will:</blockquote>")))
 (idm181610710704
  ((file foreign-function-interface.html)
   (html
    "<blockquote>OCaml has several options available to interact with non-OCaml code. The compiler can link\n    with external system libraries via C code and also can produce standalone native object files\n    that can be embedded within other non-OCaml applications.<a name=\"idm181610710192\"></a><a name=\"idm181610708880\"></a><a name=\"INTERffi\"></a></blockquote>")))
 (idm181614740432
  ((file first-class-modules.html)
   (html
    "<blockquote>For an example on this scale, the preceding approach is completely\n    reasonable, and first-class modules are not really necessary. But the more\n    functionality you need to hide away behind a set of closures, and the more\n    complicated the relationships between the different types in question, the\n    more awkward this approach becomes, and the better it is to use\n    first-class modules.<a name=\"idm181614739776\"></a></blockquote>")))
 (idm181614749616
  ((file first-class-modules.html)
   (html
    "<blockquote>The idea here is that we hide the true types of the objects in\n    question behind the functions stored in the closure. Thus, we could put\n    the <code>Unique</code> query handler into this\n    framework as follows:</blockquote>")))
 (idm181614760928
  ((file first-class-modules.html)
   (html
    "<blockquote>It's worth noting that most designs that can be done with\n    first-class modules can be simulated without them, with some level of\n    awkwardness. For example, we could rewrite our query handler example\n    without first-class modules using the following types:<a name=\"idm181614760400\"></a></blockquote>")))
 (idm181614764096
  ((file first-class-modules.html)
   (html
    "<blockquote>Although we won't describe the details here, we can push this dynamism yet further\n                using OCaml's dynamic linking facilities, which allow you to compile and link in new\n                code to a running program. This can be automated using libraries like\n                    <code>ocaml_plugin</code>, which can be installed via OPAM, and which\n                automates much of the workflow around setting up dynamic linking. <a name=\"idm181614763008\"></a> </blockquote>")))
 (idm181614767888
  ((file first-class-modules.html)
   (html
    "<blockquote>Notably, the loader can't be loaded (since it's not on the list of\n      known handlers) and can't be unloaded either:</blockquote>")))
 (idm181614777104
  ((file first-class-modules.html)
   (html
    "<blockquote>But, we can load the <code>ls</code> handler\n      with a config of our choice, at which point it will be available for\n      use. And once we unload it, it will be unavailable yet again and could\n      be reloaded with a different config:</blockquote>")))
 (idm181614780816
  ((file first-class-modules.html)
   (html
    "<blockquote>Any attempt to use an inactive query handler will fail:</blockquote>")))
 (idm181614787888
  ((file first-class-modules.html)
   (html
    "<blockquote>The resulting command-line interface behaves much as you'd expect,\n      starting out with no query handlers available but giving you the ability\n      to load and unload them. Here's an example of it in action. As you can\n      see, we start out with <code>loader</code> itself\n      as the only active handler:</blockquote>")))
 (idm181614791600
  ((file first-class-modules.html)
   (html
    "<blockquote>Now build this into a command-line interface to experiment with it:</blockquote>")))
 (idm181614811776
  ((file first-class-modules.html)
   (html
    "<blockquote>Finally, we can put this all together with the command-line\n      interface. We first create an instance of the loader query handler and\n      then add that instance to the loader's active table. We can then just\n      launch the command-line interface, passing it the active table:</blockquote>")))
 (idm181614815232
  ((file first-class-modules.html)
   (html
    "<blockquote>This function ends the definition of the <code>Loader</code> module:</blockquote>")))
 (idm181614817424
  ((file first-class-modules.html)
   (html
    "<blockquote>The <code>eval</code> function itself is fairly straightforward, dispatching to\n                the appropriate functions to respond to each type of query. Note that we write\n                    <code>&lt;:sexp_of&lt;string list&gt;&gt;</code> to\n                autogenerate a function for converting a list of strings to an s-expression, as\n                described in <a href=\"data-serialization-with-s-expressions.html\">ChapterÂ 17, <i>Data Serialization with S-Expressions</i></a>.</blockquote>")))
 (idm181614821904
  ((file first-class-modules.html)
   (html
    "<blockquote>Finally, we need to implement the <code>eval</code> function,\n                which will determine the query <span>interface</span>\n                presented to the user. We'll do this by creating a variant type, and using the\n                s-expression converter generated for that type to parse the query from the\n                user:</blockquote>")))
 (idm181614826464
  ((file first-class-modules.html)
   (html
    "<blockquote>Since the <code>load</code> function will\n      refuse to <code>load</code> an already active\n      handler, we also need the ability to unload a handler. Note that the\n      handler explicitly refuses to unload itself:</blockquote>")))
 (idm181614830336
  ((file first-class-modules.html)
   (html
    "<blockquote>Now we'll start writing out the functions for manipulating the\n      table of active query handlers. We'll start with the function for\n      loading an instance. Note that it takes as an argument both the name of\n      the query handler and the configuration for instantiating that handler\n      in the form of an s-expression. These are used for creating a\n      first-class module of type <code>(module\n      Query_handler_instance)</code>, which is then added to the active\n      table:</blockquote>")))
 (idm181614834480
  ((file first-class-modules.html)
   (html
    "<blockquote>Next, we'll need a function for creating a <code>Loader.t</code>. This function requires the list of\n      known query handler modules. Note that the table of active modules\n      starts out as empty:</blockquote>")))
 (idm181614836320
  ((file first-class-modules.html)
   (html
    "<blockquote>Note that a <code>Loader.t</code> has two\n      tables: one containing the known query handler modules, and one\n      containing the active query handler instances. The <code>Loader.t</code> will be responsible for creating new\n      instances and adding them to the table, as well as for removing\n      instances, all in response to user queries.</blockquote>")))
 (idm181614840880
  ((file first-class-modules.html)
   (html
    "<blockquote>We'll do this by creating a query handler whose job is to control\n      the set of active query handlers. The module in question will be called\n      <code>Loader</code>, and its configuration is a\n      list of known <code>Query_handler</code> modules.\n      Here are the basic types:</blockquote>")))
 (idm181614842832
  ((file first-class-modules.html)
   (html
    "<blockquote>One of the advantages of first-class modules is that they afford a\n      great deal of dynamism and flexibility. For example, it's a fairly\n      simple matter to change our design to allow query handlers to be loaded\n      and unloaded at runtime.<a name=\"idm181614842320\"></a></blockquote>")))
 (idm181614847712
  ((file first-class-modules.html)
   (html
    "<blockquote>Here's an example of a session with this program:</blockquote>")))
 (idm181614850720
  ((file first-class-modules.html)
   (html
    "<blockquote>We can most effectively run this command-line interface from a\n      standalone program, which we can do by putting the above code in a file\n      along with following command to launch the interface:</blockquote>")))
 (idm181614869920
  ((file first-class-modules.html)
   (html
    "<blockquote>Now let's turn this into a complete, running example by adding a\n      command-line interface:</blockquote>")))
 (idm181614870304
  ((file first-class-modules.html)
   (html
    "<blockquote>The bundling together of the module and the value is in many ways\n      reminiscent of object-oriented languages. One key difference, is that\n      first-class modules allow you to package up more than just functions or\n      methods. As we've seen, you can also include types and even modules.\n      We've only used it in a small way here, but this extra power allows you\n      to build more sophisticated components that involve multiple\n      interdependent types and values.</blockquote>")))
 (idm181614873584
  ((file first-class-modules.html)
   (html
    "<blockquote>This function interacts with an instance by unpacking it into a\n      module <code>I</code> and then using the query\n      handler instance (<code>I.this</code>) in concert\n      with the associated module (<code>I.Query_handler</code>).<a name=\"idm181614871312\"></a></blockquote>")))
 (idm181614887536
  ((file first-class-modules.html)
   (html
    "<blockquote>Now, we need a function that dispatches to a handler using a\n      dispatch table:</blockquote>")))
 (idm181614897584
  ((file first-class-modules.html)
   (html
    "<blockquote>The first thing we'll need is a function that takes a list of\n      query handler instances and constructs a dispatch table from it:</blockquote>")))
 (idm181614899664
  ((file first-class-modules.html)
   (html
    "<blockquote>where <span><em><code>query-name</code></em></span> is the name used to\n      determine which query handler to dispatch the query to, and\n      <span><em><code>query</code></em></span> is the\n      body of the query.</blockquote>")))
 (idm181614902832
  ((file first-class-modules.html)
   (html
    "<blockquote>We can now write code that lets you dispatch queries to one of a\n      list of query handler instances. We assume that the shape of the query\n      is as follows:</blockquote>")))
 (idm181614909920
  ((file first-class-modules.html)
   (html
    "<blockquote>Using <code>build_instance</code>,\n      constructing a new instance becomes a one-liner:</blockquote>")))
 (idm181614921824
  ((file first-class-modules.html)
   (html
    "<blockquote>Constructing instances in this way is a little verbose, but we can\n      write a function that eliminates most of this boilerplate. Note that we\n      are again making use of a locally abstract type:</blockquote>")))
 (idm181614928992
  ((file first-class-modules.html)
   (html "<blockquote>We can create an instance as follows:</blockquote>")))
 (idm181614929552
  ((file first-class-modules.html)
   (html
    "<blockquote>With this signature, we can create a first-class module that\n      encompasses both an instance of the query and the matching operations\n      for working with that query.</blockquote>")))
 (idm181614938944
  ((file first-class-modules.html)
   (html
    "<blockquote>Now, what if we want to dispatch queries to any of an arbitrary\n      collection of handlers? Ideally, we'd just like to pass in the handlers\n      as a simple data structure like a list. This is awkward to do with\n      modules and functors alone, but it's quite natural with first-class\n      modules. The first thing we'll need to do is create a signature that\n      combines a <code>Query_handler</code> module with\n      an instantiated query handler:<a name=\"idm181614937600\"></a></blockquote>")))
 (idm181614948816
  ((file first-class-modules.html)
   (html
    "<blockquote>Again, we can create an instance of this query handler and\n      interact with it directly:</blockquote>")))
 (idm181614972976
  ((file first-class-modules.html)
   (html
    "<blockquote>Here's another example: a query handler that does directory\n      listings. Here, the config is the default directory that relative paths\n      are interpreted within:</blockquote>")))
 (idm181614981648
  ((file first-class-modules.html)
   (html
    "<blockquote>We can use this module to create an instance of the <code>Unique</code> query handler and interact with it\n      directly:</blockquote>")))
 (idm181615004752
  ((file first-class-modules.html)
   (html
    "<blockquote>Let's look at some examples of query handlers that satisfy the\n      <code>Query_handler</code> interface. The first\n      example is a handler that produces unique integer IDs. It works by\n      keeping an internal counter which it bumps every time it produces a new\n      value. The input to the query in this case is just the trivial\n      s-expression <code>()</code>, otherwise known as\n      <code>Sexp.unit</code>:<a name=\"idm181615002208\"></a></blockquote>")))
 (idm181615006640
  ((file first-class-modules.html)
   (html
    "<blockquote>This is all described in more detail in <a href=\"data-serialization-with-s-expressions.html\">ChapterÂ 17, <i>Data Serialization with S-Expressions</i></a>.</blockquote>")))
 (idm181615016640
  ((file first-class-modules.html)
   (html
    "<blockquote>In a module, <code>with sexp</code> adds the\n    implementation of those functions. Thus, we can write:</blockquote>")))
 (idm181615024048
  ((file first-class-modules.html)
   (html
    "<blockquote>In addition, we use the Sexplib syntax extension which extends OCaml\n    by adding the <code>with sexp</code> declaration.\n    When attached to a type in a signature, <code>with\n    sexp</code> adds declarations of s-expression converters, for\n    example:<a name=\"idm181615022288\"></a></blockquote>")))
 (idm181615027040
  ((file first-class-modules.html)
   (html
    "<blockquote>Here, we used s-expressions as the format for queries and responses, as well as the\n            configuration for the query handler. S-expressions are a simple, flexible, and\n            human-readable serialization format commonly used in Core. For now, it's enough to think\n            of them as balanced parenthetical expressions whose atomic values are strings, e.g.,\n                <code>(this (is an) (s expression))</code>.<a name=\"idm181615025728\"></a></blockquote>")))
 (idm181615050704
  ((file first-class-modules.html)
   (html
    "<blockquote>Now let's look at first-class modules in the context of a more complete and realistic\n            example. In particular, consider the following signature for a module that implements a\n            system for responding to user-generated queries.<a name=\"idm181615050192\"></a><a name=\"FCMquery\"></a></blockquote>")))
 (idm181615053008
  ((file first-class-modules.html)
   (html
    "<blockquote>This technique is useful beyond first-class modules. For example,\n      we can use the same approach to construct a local module to be fed to a\n      functor.<a name=\"idm181615052592\"></a></blockquote>")))
 (idm181615053520
  ((file first-class-modules.html)
   (html
    "<blockquote>Here, what we effectively do is capture a polymorphic type and\n      export it as a concrete type within a module.</blockquote>")))
 (idm181615069776
  ((file first-class-modules.html)
   (html
    "<blockquote>One common use of locally abstract types is to create a new type\n      that can be used in constructing a module. Here's an example of doing\n      this to create a new first-class module:</blockquote>")))
 (idm181615076160
  ((file first-class-modules.html)
   (html
    "<blockquote>If, on the other hand, we try to use the type <code>a</code> as equivalent to some concrete type, say,\n      <code>int</code>, then the compiler will\n      complain:</blockquote>")))
 (idm181615077360
  ((file first-class-modules.html)
   (html
    "<blockquote>This compiles successfully because the type <code>a</code> is used in a way that is compatible with it\n      being abstract, but the type of the function that is inferred is\n      polymorphic.</blockquote>")))
 (idm181615083520
  ((file first-class-modules.html)
   (html
    "<blockquote>One of the key properties of locally abstract types is that\n      they're dealt with as abstract types in the function they're defined\n      within, but are polymorphic from the outside. Consider the following\n      example:<a name=\"idm181615083024\"></a></blockquote>")))
 (idm181615084768
  ((file first-class-modules.html)
   (html
    "<blockquote>Polymorphic first-class modules are important because they allow you\n    to connect the types associated with a first-class module to the types of\n    other values you're working with.</blockquote>")))
 (idm181615091664
  ((file first-class-modules.html)
   (html
    "<blockquote>The resulting function is polymorphic in both the type of the list\n    element and the type <code>Bumpable.t</code>. We can\n    see this function in action:</blockquote>")))
 (idm181615097968
  ((file first-class-modules.html)
   (html
    "<blockquote>Here, we used a feature of OCaml that hasn't come up before: a <span><em>locally abstract\n                type</em></span>. For any function, you can declare a pseudoparameter of the form\n                <code>(type a)</code> for any type name <code>a</code> which introduces a fresh type. This type acts like an\n            abstract type within the context of the function. In the example above, the locally\n            abstract type was used as part of a sharing constraint that ties the type <code>B.t</code> with the type of the elements of the list passed\n                in.<a name=\"idm181615094912\"></a><a name=\"idm181615093600\"></a><a name=\"idm181615092704\"></a></blockquote>")))
 (idm181615111056
  ((file first-class-modules.html)
   (html
    "<blockquote>We can also write functions that use such first-class modules\n    polymorphically. The following function takes two arguments: a <code>Bumpable</code> module and a list of elements of the\n    same type as the type <code>t</code> of the\n    module:<a name=\"idm181615109280\"></a><a name=\"idm181615107968\"></a></blockquote>")))
 (idm181615118576
  ((file first-class-modules.html)
   (html
    "<blockquote>The sharing constraints we've added above make the resulting\n    first-class modules <span>polymorphic</span> in\n    the type <code>t</code>. As a result, we can now use\n    these values on values of the matching type:</blockquote>")))
 (idm181615125696
  ((file first-class-modules.html)
   (html
    "<blockquote>To make <code>int_bumper</code> usable, we\n    need to expose the type, which we can do as follows:</blockquote>")))
 (idm181615133424
  ((file first-class-modules.html)
   (html
    "<blockquote>But you can't do much with <code>int_bumper</code>, since <code>int_bumper</code> is fully abstract, so that we can no longer\n            recover the fact that the type in question is <code>int</code>. </blockquote>")))
 (idm181615137824
  ((file first-class-modules.html)
   (html
    "<blockquote>And we can convert these to first-class modules:</blockquote>")))
 (idm181615148048
  ((file first-class-modules.html)
   (html
    "<blockquote>We can create multiple instances of this module with different\n    underlying types:</blockquote>")))
 (idm181615155936
  ((file first-class-modules.html)
   (html
    "<blockquote>First-class modules can contain types and functions in addition to\n    simple values like <code>int</code>. Here's an\n    interface that contains a type and a corresponding <code>bump</code> operation that takes a value of the type\n    and produces a new one:</blockquote>")))
 (idm181615161152
  ((file first-class-modules.html)
   (html
    "<blockquote>There are some useful syntactic shortcuts when dealing with\n    first-class modules. One notable one is that you can do the conversion to\n    an ordinary module within a pattern match. Thus, we can rewrite the\n    <code>to_int</code> function as follows:</blockquote>")))
 (idm181615168688
  ((file first-class-modules.html)
   (html
    "<blockquote>With these functions in hand, we can now work with values of type <code>(module X_int)</code> in a more natural style, taking advantage of the concision\n            and simplicity of the core <span>language</span>:</blockquote>")))
 (idm181615182960
  ((file first-class-modules.html)
   (html
    "<blockquote>We can also write ordinary functions which consume and create\n    first-class modules. The following shows the definition of two functions:\n    <code>to_int</code>, which converts a <code>(module X_int)</code> into an <code>int</code>; and <code>plus</code>, which returns the sum of two <code>(module X_int)</code>:</blockquote>")))
 (idm181615185888
  ((file first-class-modules.html)
   (html
    "<blockquote>The way in which type equality for first-class modules is determined can be confusing.\n                One common and problematic case is that of creating an alias of a module type\n                defined elsewhere. This is often done to improve readability and can happen both\n                through an explicit declaration of a module type or implicitly through an <code>include</code> declaration. In both cases, this has the\n                unintended side effect of making first-class modules built off the alias\n                incompatible with those built off the original module type. To deal with this, we\n                should be disciplined in how we refer to signatures when constructing first-class\n                    <span>modules</span>.</blockquote>")))
 (idm181615190432
  ((file first-class-modules.html)
   (html
    "<blockquote>Even though their types as first-class modules are distinct, the\n      underlying module types are compatible (indeed, identical), so we can\n      unify the types by unpacking and repacking the module:</blockquote>")))
 (idm181615200672
  ((file first-class-modules.html)
   (html
    "<blockquote>The type of the first-class module, e.g., <code>(module X_int)</code>, is based on the fully\n      qualified name of the signature that was used to construct it. A\n      first-class module based on a signature with a different name, even if\n      it is substantively the same signature, will result in a distinct\n      type:</blockquote>")))
 (idm181615209024
  ((file first-class-modules.html)
   (html "<blockquote>And here's an example:</blockquote>")))
 (idm181615213232
  ((file first-class-modules.html)
   (html
    "<blockquote>In order to access the contents of a first-class module, you need to\n    unpack it into an ordinary module. This can be done using the <code>val</code> keyword, using this syntax:</blockquote>")))
 (idm181615217664
  ((file first-class-modules.html)
   (html
    "<blockquote>We can also create a first-class module from an anonymous\n    module:</blockquote>")))
 (idm181615224000
  ((file first-class-modules.html)
   (html
    "<blockquote>The module type doesn't need to be part of the construction of a\n    first-class module if it can be inferred. Thus, we can write:</blockquote>")))
 (idm181615229024
  ((file first-class-modules.html)
   (html
    "<blockquote>So, we can convert <code>Three</code> into a\n    first-class module as follows:</blockquote>")))
 (idm181615233168
  ((file first-class-modules.html)
   (html
    "<blockquote>A first-class module is created by packaging up a module with a\n    signature that it satisfies. This is done using the <code>module</code> keyword, using the following\n    syntax:<a name=\"idm181615232096\"></a></blockquote>")))
 (idm181615239296
  ((file first-class-modules.html)
   (html
    "<blockquote>We can also create a module that matches this signature:</blockquote>")))
 (idm181615243552
  ((file first-class-modules.html)
   (html
    "<blockquote>In that light, consider the following signature of a module with a\n    single integer variable:</blockquote>")))
 (idm181615244112
  ((file first-class-modules.html)
   (html
    "<blockquote>We'll start out by covering the basic mechanics of first-class\n    modules by working through some toy examples. We'll get to more realistic\n    examples in the next section.</blockquote>")))
 (idm181615246832
  ((file first-class-modules.html)
   (html
    "<blockquote>First-class modules are a sophisticated technique, and you'll need to get comfortable with\n        some advanced aspects of the language to use them effectively. But it's worth learning,\n        because letting modules into the core language is quite powerful, increasing the range of\n        what you can express and making it easier to build flexible and modular <span>systems</span>.</blockquote>")))
 (idm181615249376
  ((file first-class-modules.html)
   (html
    "<blockquote>OCaml provides a way around this stratification in the form of\n  <span><em>first-class modules</em></span>. First-class modules are ordinary\n  values that can be created from and converted back to regular\n  modules.<a name=\"FCMwork\"></a></blockquote>")))
 (idm181615251792
  ((file first-class-modules.html)
   (html
    "<blockquote>You can think of OCaml as being broken up into two parts: a core\n  language that is concerned with values and types, and a module language that\n  is concerned with modules and module signatures. These sublanguages are\n  stratified, in that modules can contain types and values, but ordinary\n  values can't contain modules or module types. That means you can't do things\n  like define a variable whose value is a module, or a function that takes a\n  module as an argument.<a name=\"MODfirst\"></a></blockquote>")))
 (idm181618501088
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>Of course, the design process goes in both directions. You'll often find yourself going\n        back and modifying your types in response to things you learn by working on the\n        implementation. But types and signatures provide a lightweight tool for constructing a\n        skeleton of your design in a way that helps clarify your goals and intent, before you spend\n        a lot of time and effort fleshing it out.</blockquote>")))
 (idm181618502528
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>This is a good approach both when working in the core language, where you would write\n        your type definitions before writing the logic of your computations, as well as at the\n        module level, where you would write a first draft of your <code>mli</code> before\n        working on the <code>ml</code>.</blockquote>")))
 (idm181618503184
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>OCaml's concise and flexible type language enables a type-oriented\n        approach to software design.  Such an approach involves thinking\n        through and writing out the types you're going to use before embarking\n        on the implementation itself.</blockquote>")))
 (idm181618504560
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>Core's standards may or may not fit your projects, but you can improve the usability of\n        your codebase by finding some consistent set of standards to apply.</blockquote>")))
 (idm181618506720
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>There are also standards in Core about what the type signature for specific functions\n        should be. For example, the signature for <code>map</code> is always essentially the\n        same, no matter what the underlying type it is applied to. This kind of function-by-function\n        API uniformity is achieved through the use of <span><em>signature includes</em></span>, which\n        allow for different modules to share components of their interface. This approach is\n        described in <a href=\"functors.html#using-multiple-interfaces\">the section called â\128\156Using Multiple Interfacesâ\128\157</a>. </blockquote>")))
 (idm181618509184
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>Functions that routinely throw an exception should end in <code>_exn</code>. Otherwise,\n            errors should be signaled by returning an <code>option</code> or an\n          <code>Or_error.t</code> (both of which are discussed in <a href=\"error-handling.html\">ChapterÂ 7, <i>Error Handling</i></a> ).</blockquote>")))
 (idm181618512128
  ((file files-modules-and-programs.html)
   (html
    "<blockquote><span><em>Put <code>t</code> first</em></span>. If you have a module <code>M</code>\n            whose primary type is <code>M.t</code>, the functions in <code>M</code> that\n            take a value of <code>M.t</code> should take it as their first argument.</blockquote>")))
 (idm181618513616
  ((file files-modules-and-programs.html)
   (html
    "<blockquote><span><em>A module for (almost) every type.</em></span> You should mint a module for\n            almost every type in your program, and the primary type of a given module should be\n            called <code>t</code>.</blockquote>")))
 (idm181618514656
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>Core itself is a library that works hard to create uniform interfaces. Here are some of\n        the guidelines that are used in Core.</blockquote>")))
 (idm181618515296
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>Designing the interface of a module is a task that should not be thought of in\n        isolation. The interfaces that appear in your codebase should play together harmoniously.\n        Part of achieving that is standardizing aspects of those interfaces.</blockquote>")))
 (idm181618516832
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>There is of course a tradeoff here, in that making your APIs more explicit tends to make\n        them more verbose as well. Another useful rule of thumb is that more rarely used names\n        should be longer and more explicit, since the cost of concision and the benefit of\n        explicitness become more important the more often a name is used.</blockquote>")))
 (idm181618518576
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>You can also improve readability simply by choosing good names for your functions,\n        variant tags and record fields. Good names aren't always long, to be clear. If you wanted to\n        write an anonymous function for doubling a number: <code>(fun x -&gt; x * 2)</code>, a\n        short variable name like <code>x</code> is best. A good rule of thumb is that names\n        that have a small scope should be short, whereas names that have a large scope, like the\n        name of a function in an a module interface, should be longer and more explicit.</blockquote>")))
 (idm181618519680
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>There are many ways of improving readability at the call site. One example is labeled\n        arguments (discussed in <a href=\"variables-and-functions.html#labeled-arguments\">the section called â\128\156Labeled Argumentsâ\128\157</a>), which act as documentation\n        that is available at the call site. </blockquote>")))
 (idm181618520384
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>The reason for this is that most of the time, people interacting with your API will be\n        doing so by reading and modifying code that uses the API, not by reading the interface\n        definition. By making your API as obvious as possible from that perspective, you simplify\n        the lives of your users.</blockquote>")))
 (idm181618521456
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>When writing an interface, you should think not just about how easy it is to understand\n        the interface for someone who reads your carefully documented <code>mli</code> file,\n        but more importantly, you want the call to be as obvious as possible for someone who is\n        reading it at the call site.</blockquote>")))
 (idm181618524128
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>Despite these benefits, there is a trade-off here. In particular, exposing types\n        concretely makes it possible to use pattern-matching with those types, which as we saw in\n        <span><a href=\"lists-and-patterns.html\">ChapterÂ 3, <i>Lists and Patterns</i></a> </span>is a powerful and important tool. You should generally only\n        expose the concrete implementation of your types when there's significant value in the\n        ability to pattern match, and when the invariants that you care about are already enforced\n        by the data type itself.</blockquote>")))
 (idm181618525440
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>In a similar way, abstraction allows you to enforce invariants on your types. If your\n        types are exposed, then users of the module can create new instances of that type (or if\n        mutable, modify existing instances) in any way allowed by the underlying type. That may\n        violate a desired invariant <span><em>i.e.</em></span>, a property about your type that is\n        always supposed to be true. Abstract types allow you to protect invariants by making sure\n        that you only expose functions that preserves your invariants. </blockquote>")))
 (idm181618526384
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>Abstraction enhances flexibility by restricting how users can interact with your types,\n        thus reducing the ways in which users can depend on the details of your implementation. If\n        you expose types explicitly, then users can depend on any and every detail of the types you\n        choose. If they're abstract, then only the specific operations you want to expose are\n        available. This means that you can freely change the implementation without affecting\n        clients, as long as you preserve the semantics of those operations.</blockquote>")))
 (idm181618527520
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>When designing an <code>mli</code>, one choice that you need to make is whether to\n        expose the concrete definition of your types or leave them abstract. Most of the time,\n        abstraction is the right choice, for two reasons: it enhances the flexibility of your\n        design, and it makes it possible to enforce invariants on the use of your module.</blockquote>")))
 (idm181618528784
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>The module system is a key part of how an OCaml program is structured. As such, we'll\n      close this chapter with some advice on how to think about designing that structure\n      effectively.</blockquote>")))
 (idm181618536608
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>In this case, <span><strong>ocamlbuild</strong></span> (which\n      is invoked by the <span><strong>corebuild</strong></span> script)\n      will notice the error and complain explicitly about the cycle:</blockquote>")))
 (idm181618540912
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>The problem manifests in a different way if we create cyclic\n      references between files. We could create such a situation by adding a\n      reference to <code>Freq</code> from <code>counter.ml</code>, e.g., by adding the following\n      line:</blockquote>")))
 (idm181618546448
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>we'll see this error when we try to build:</blockquote>")))
 (idm181618550704
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>The simplest example of a forbidden circular reference is a module\n      referring to its own module name. So, if we tried to add a reference to\n      <code>Counter</code> from within <code>counter.ml</code>:</blockquote>")))
 (idm181618551360
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>The same is true at the module level. By default, cyclic\n      dependencies between modules are not allowed, and cyclic dependencies\n      among files are never allowed. Recursive modules are possible but are a\n      rare case, and we won't discuss them further here.</blockquote>")))
 (idm181618559680
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>In most cases, OCaml doesn't allow cyclic dependencies, i.e., a\n      collection of definitions that all refer to one another. If you want to\n      create such definitions, you typically have to mark them specially. For\n      example, when defining a set of mutually recursive values (like the\n      definition of <code>is_even</code> and <code>is_odd</code> in <a href=\"variables-and-functions.html#recursive-functions\">the section called â\128\156Recursive Functionsâ\128\157</a>), you need to define them using\n      <code>let rec</code> rather than ordinary <code>let</code>.<a name=\"idm181618555936\"></a><a name=\"idm181618555024\"></a><a name=\"idm181618554112\"></a><a name=\"idm181618552800\"></a></blockquote>")))
 (idm181618561344
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>Order is similarly important to other type declarations, including\n      the order in which record fields are declared and the order of arguments\n      (including labeled and optional arguments) to a function.</blockquote>")))
 (idm181618571728
  ((file files-modules-and-programs.html)
   (html "<blockquote>will lead to a compilation error:</blockquote>")))
 (idm181618581200
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>Type definitions that show up in an <code>mli</code> need to match up with corresponding\n      definitions in the <code>ml</code>. Consider again\n      the example of the type <code>median</code>. The\n      order of the declaration of variants matters to the OCaml compiler, so\n      the definition of <code>median</code> in the\n      implementation listing those options in a different order:<a name=\"idm181618578064\"></a><a name=\"idm181618577152\"></a><a name=\"idm181618575824\"></a></blockquote>")))
 (idm181618582704
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>A missing type definition will lead to a similar error.</blockquote>")))
 (idm181618589680
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>Now, if we try to compile without actually adding the\n      implementation, we'll get this error:</blockquote>")))
 (idm181618596592
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>We might decide that we want a new function in <code>Counter</code> for pulling out the frequency count of\n      a given string. We can update the <code>mli</code>\n      by adding the following line:<a name=\"idm181618594880\"></a><a name=\"idm181618593568\"></a></blockquote>")))
 (idm181618605232
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>and we try to compile, we'll get the following error:</blockquote>")))
 (idm181618613120
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>The simplest kind of error is where the type specified in the signature does not match\n        the type in the implementation of the module. As an example, if we replace the <code>val</code> declaration in <code>counter.mli</code> by swapping the types of the first two arguments:<a name=\"idm181618611504\"></a><a name=\"idm181618610192\"></a><a name=\"idm181618609296\"></a></blockquote>")))
 (idm181618615840
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>When OCaml compiles a program with an <code>ml</code> and an <code>mli</code>, it will complain if it detects a mismatch\n    between the two. Here are some of the common errors you'll run\n    into.</blockquote>")))
 (idm181618620016
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>And if we then put <code>open Common</code>\n    after <code>open Core.Std</code> at the top of each\n    file in our project, then references to <code>List</code> will automatically go to <code>Ext_list</code> instead.</blockquote>")))
 (idm181618625392
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>We can now use <code>Ext_list</code> as a\n    replacement for <code>List</code>. If we want to use\n    <code>Ext_list</code> in preference to <code>List</code> in our project, we can create a file of\n    common definitions:</blockquote>")))
 (idm181618629968
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>Note that the order of declarations in the <code>mli</code> does not need to match the order of\n    declarations in the <code>ml</code>. The order of\n    declarations in the <code>ml</code> mostly matters\n    insofar as it affects which values are shadowed. If we wanted to replace a\n    function in <code>List</code> with a new function of\n    the same name, the declaration of that function in the <code>ml</code> would have to come after the <code>include List</code> declaration.</blockquote>")))
 (idm181618636016
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>Now, how do we write an interface for this new module? It turns out\n    that <code>include</code> works on signatures as\n    well, so we can pull essentially the same trick to write our <code>mli</code>. The only issues is that we need to get our\n    hands on the signature for the <code>List</code>\n    module. This can be done using <code>module type\n    of</code>, which computes a signature from a module:</blockquote>")))
 (idm181618640400
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>To consider a more realistic example, imagine you wanted to build an\n    extended version of the <code>List</code> module,\n    where you've added some functionality not present in the module as\n    distributed in Core. <code>include</code> allows us\n    to do just that:</blockquote>")))
 (idm181618654560
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>The difference between <code>include</code>\n    and <code>open</code> is that we've done more than\n    change how identifiers are searched for: we've changed what's in the\n    module. If we'd used <code>open</code>, we'd have\n    gotten a quite different result:</blockquote>")))
 (idm181618669824
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>We can use the <code>include</code> directive\n    to create a new, extended version of the <code>Interval</code> module:</blockquote>")))
 (idm181618681936
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>While opening a module affects the environment used to search for identifiers,\n        <span><em>including</em></span> a module is a way of actually adding new identifiers to a\n      module proper. Consider the following simple module for representing a range of integer\n        values:<a name=\"idm181618681200\"></a><a name=\"idm181618679904\"></a></blockquote>")))
 (idm181618685040
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>Because the module name <code>C</code>\n        only exists for a short scope, it's easy to read and remember what\n        <code>C</code> stands for. Rebinding modules to\n        very short names at the top level of your module is usually a\n        mistake.</blockquote>")))
 (idm181618688416
  ((file files-modules-and-programs.html)
   (html "<blockquote>you could write:</blockquote>")))
 (idm181618693056
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>An alternative to local <code>open</code>s that makes your\n        code terser without giving up on explicitness is to locally rebind the\n        name of a module. So, when using the <code>Counter.median</code> type, instead of\n        writing:</blockquote>")))
 (idm181618698976
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>There's another, even more lightweight syntax for local\n        <code>open</code>s, which is particularly useful for small\n        expressions:</blockquote>")))
 (idm181618700736
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>Here, <code>of_int</code> and the infix\n        operators are the ones from the <code>Int64</code> module.</blockquote>")))
 (idm181618706960
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>If you do need to do an open, it's better to do a\n        <span><em>local open</em></span>. There are two syntaxes for local\n        opens. For example, you can write:</blockquote>")))
 (idm181618709232
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>Opening modules at the toplevel of a module should be done quite\n        sparingly, and generally only with modules that have been specifically\n        designed to be opened, like <code>Core.Std</code> or <code>Option.Monad_infix</code>.</blockquote>")))
 (idm181618712336
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>Here's some general advice on how to deal with\n    <code>open</code>s:<a name=\"idm181618710768\"></a></blockquote>")))
 (idm181618713232
  ((file files-modules-and-programs.html)
   (html
    "<blockquote><code>open</code> is essential when you want\n    to modify your environment for a standard library like Core, but it's\n    generally good style to keep the opening of modules to a minimum. Opening\n    a module is basically a trade-off between terseness and explicitnessâ\128\148the\n    more modules you open, the fewer module qualifications you need, and the\n    harder it is to look at an identifier and figure out where it comes\n    from.</blockquote>")))
 (idm181618724416
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>We've encountered <code>open</code> already,\n    specifically where we've written <code>open\n    Core.Std</code> to get access to the standard definitions in the Core\n    library. In general, opening a module adds the contents of that module to\n    the environment that the compiler looks at to find the definition of\n    various identifiers. Here's an example:</blockquote>")))
 (idm181618730208
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>Most of the time, you refer to values and types within a module by\n    using the module name as an explicit qualifier. For example, you write\n    <code>List.map</code> to refer to the <code>map</code> function in the <code>List</code> module. Sometimes, though, you want to be\n    able to refer to the contents of a module without this explicit\n    qualification. That's what the <code>open</code>\n    statement is for.<a name=\"idm181618727152\"></a><a name=\"idm181618725840\"></a></blockquote>")))
 (idm181618731856
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>This is a trivial example, but confusing different kinds of\n    identifiers is a very real source of bugs, and the approach of minting\n    abstract types for different classes of identifiers is an effective way of\n    avoiding such issues.</blockquote>")))
 (idm181618738256
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>The preceding code has a bug: it compares the username in one\n    session to the host in the other session, when it should be comparing the\n    usernames in both cases. Because of how we defined our types, however, the\n    compiler will flag this bug for us:</blockquote>")))
 (idm181618741968
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>We could have written this slightly differently, by giving the\n    signature its own top-level <code>module type</code>\n    declaration, making it possible to create multiple distinct types with the\n    same underlying implementation in a lightweight way:</blockquote>")))
 (idm181618745616
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>The basic structure of a module declaration like this is:</blockquote>")))
 (idm181618747456
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>Note that the <code>to_string</code> and\n    <code>of_string</code> functions above are\n    implemented simply as the identity function, which means they have no\n    runtime effect. They are there purely as part of the discipline that they\n    enforce on the code through the type system.</blockquote>")))
 (idm181618751760
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>Here's how you might create such an abstract type, within a\n    submodule:<a name=\"idm181618751424\"></a></blockquote>")))
 (idm181618752496
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>A better approach is to mint new abstract types for each identifier,\n    where those types are under the covers just implemented as strings. That\n    way, the type system will prevent you from confusing a username with a\n    hostname, and if you do need to convert, you can do so using explicit\n    conversions to and from the string type.</blockquote>")))
 (idm181618757376
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>Up until now, we've only considered modules that correspond to\n    files, like <code>counter.ml</code>. But modules\n    (and module signatures) can be nested inside other modules. As a simple\n    example, consider a program that needs to deal with multiple identifiers\n    like usernames and hostnames. If you just represent these as strings, then\n    it becomes easy to confuse one with the other.<a name=\"idm181618756128\"></a><a name=\"idm181618754816\"></a><a name=\"idm181618753920\"></a></blockquote>")))
 (idm181618760224
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>The decision of whether a given type should be abstract or concrete\n    is an important one. Abstract types give you more control over how values\n    are created and accessed, and make it easier to enforce invariants beyond\n    what is enforced by the type itself; concrete types let you expose more\n    detail and structure to client code in a lightweight way. The right choice\n    depends very much on the context.</blockquote>")))
 (idm181618764400
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>Now, to expose this usefully in the interface, we need to expose\n    both the function and the type <code>median</code>\n    with its definition. Note that values (of which functions are an example)\n    and types have distinct namespaces, so there's no name clash here. Adding\n    the following two lines added to <code>counter.mli</code> does the trick:</blockquote>")))
 (idm181618766736
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>In the preceding implementation, we use <code>failwith</code> to throw an exception for the case of\n    the empty list. We'll discuss exceptions more in <a href=\"error-handling.html\">ChapterÂ 7, <i>Error Handling</i></a>. Note also that the function <code>fst</code> simply returns the first element of any\n    two-tuple.</blockquote>")))
 (idm181618770624
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>For example, imagine we wanted to add a function to <code>Counter</code> for returning the line with the median\n    frequency count. If the number of lines is even, then there is no precise\n    median, and the function would return the lines before and after the\n    median instead. We'll use a custom type to represent the fact that there\n    are two possible return values. Here's a possible implementation:</blockquote>")))
 (idm181618775152
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>In our frequency-count example, the module <code>Counter</code> had an abstract type <code>Counter.t</code> for representing a collection of\n    frequency counts. Sometimes, you'll want to make a type in your interface\n    <span><em>concrete</em></span>, by including the type definition in the\n    interface.<a name=\"idm181618772944\"></a><a name=\"idm181618772048\"></a></blockquote>")))
 (idm181618779984
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>Note that in the preceding example we use <code>String.Map</code> in some places and simply <code>Map</code> in others. This has to do with the fact that\n    for some operations, like creating a <code>Map.t</code>, you need access to type-specialized\n    information, and for others, like looking something up in <code>Map.t</code>, you don't. This is covered in more detail\n    in <a href=\"maps-and-hash-tables.html\">ChapterÂ 13, <i>Maps and Hash Tables</i></a>.</blockquote>")))
 (idm181618785056
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>Now we can turn to optimizing the implementation of <code>Counter</code>. Here's an alternate and far more\n    efficient implementation, based on the <code>Map</code> data structure in Core:</blockquote>")))
 (idm181618791360
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>This is because <code>freq.ml</code> depends\n    on the fact that frequency counts are represented as association lists, a\n    fact that we've just hidden. We just need to fix <code>build_counts</code> to use <code>Counter.empty</code> instead of <code>[]</code> and <code>Counter.to_list</code> to get the association list out\n    at the end for processing and printing. The resulting implementation is\n    shown below:</blockquote>")))
 (idm181618798848
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>If we now try to compile <code>freq.ml</code>,\n    we'll get the following error:</blockquote>")))
 (idm181618803168
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>Here's a rewrite of <code>counter.ml</code> to\n    match the new <code>counter.mli</code>:</blockquote>")))
 (idm181618806352
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>We also used this opportunity to document the module. The <code>mli</code> file is the place where you specify your module's interface, and as such is a\n      natural place to put documentation. We started our comments with a double asterisk to cause\n      them to be picked up by the <span><strong>ocamldoc</strong></span> tool when generating\n      API documentation. We'll discuss <span><strong>ocamldoc</strong></span> more in <a href=\"the-compiler-frontend-parsing-and-type-checking.html\">ChapterÂ 22, <i>The Compiler Frontend: Parsing and <span>Type\n    Checking</span></i></a>.</blockquote>")))
 (idm181618809376
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>Note that we needed to add <code>empty</code>\n    and <code>to_list</code> to <code>Counter</code>, since otherwise there would be no way\n    to create a <code>Counter.t</code> or get data out\n    of one.</blockquote>")))
 (idm181618813888
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>To hide the fact that frequency counts are represented as\n    association lists, we'll need to make the type of frequency counts\n    <span><em>abstract</em></span>. A type is abstract if its name is exposed\n    in the interface, but its definition is not. Here's an abstract interface\n    for <code>Counter</code>:</blockquote>")))
 (idm181618816592
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>The generated code is basically equivalent to the <code>mli</code> that we wrote by hand but is a bit uglier\n      and more verbose and, of course, has no comments. In general,\n      autogenerated <code>mli</code>s are only useful as\n      a starting point. In OCaml, the <code>mli</code>\n      is the key place where you present and document your interface, and\n      there's no replacement for careful human editing and\n      organization.</blockquote>")))
 (idm181618825200
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>If you don't want to construct an <code>mli</code> entirely\n      by hand, you can ask OCaml to autogenerate one for you from the source,\n      which you can then adjust to fit your needs. Here's how you can do that\n      using <span><em>corebuild</em></span>:<a name=\"idm181618823920\"></a></blockquote>")))
 (idm181618827648
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>Note that <span><strong>ocamlbuild</strong></span> will detect\n    the presence of the <code>mli</code> file\n    automatically and include it in the build.</blockquote>")))
 (idm181618831280
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>Using this syntax, we can write the signature of <code>counter.ml</code> as follows:</blockquote>")))
 (idm181618836496
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>For <code>counter.mli</code>, we'll start by\n    writing down an interface that describes what's currently available in\n    <code>counter.ml</code>, without hiding anything.\n    <code>val</code> declarations are used to specify\n    values in a signature. The syntax of a <code>val</code> declaration is as follows:</blockquote>")))
 (idm181618841344
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>The implementation details of a module can be hidden by attaching an\n    <span><em>interface</em></span>. (Note that in the context of OCaml, the\n    terms <span><em>interface</em></span>, <span><em>signature</em></span>, and\n    <span><em>module type</em></span> are all used interchangeably.) A module\n    defined by a file <code>filename.ml</code> can be\n    constrained by a signature placed in a file called <code>filename.mli</code>.<a name=\"idm181618837920\"></a></blockquote>")))
 (idm181618852176
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>While we've pushed some of the logic to the <code>Counter</code> module, the code in <code>freq.ml</code> can still depend on the details of the\n    implementation of <code>Counter</code>. Indeed, if\n    you look at the definition of <code>build_counts</code>, you'll see that it depends on the\n    fact that the empty set of frequency counts is represented as an empty\n    list. We'd like to prevent this kind of dependency, so we can change the\n    implementation of <code>Counter</code> without\n    needing to change client code like that in <code>freq.ml</code>.<a name=\"idm181618847600\"></a><a name=\"idm181618846704\"></a><a name=\"idm181618845408\"></a><a name=\"idm181618844112\"></a><a name=\"idm181618842784\"></a></blockquote>")))
 (idm181618859184
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>We can now rewrite <code>freq.ml</code> to use\n    <code>Counter</code>. Note that the resulting code\n    can still be built with <span><strong>ocamlbuild</strong></span>,\n    which will discover dependencies and realize that <code>counter.ml</code> needs to be compiled:</blockquote>")))
 (idm181618861984
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>The file <span><em>counter.ml</em></span> will be compiled into a\n    module named <code>Counter</code>, where the name of\n    the module is derived automatically from the filename. The module name is\n    capitalized even if the file is not. Indeed, module names are always\n    capitalized.<a name=\"idm181618860608\"></a></blockquote>")))
 (idm181618866288
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>We'll start by creating a file, <code>counter.ml</code>, that contains the logic for\n    maintaining the association list used to represent the frequency counts.\n    The key function, called <code>touch</code>, bumps\n    the frequency count of a given line by one:</blockquote>")))
 (idm181618867008
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>We can fix this problem by replacing association lists with a more\n    efficient data structure. To do that, we'll first factor out the key\n    functionality into a separate module with an explicit interface. We can\n    consider alternative (and more efficient) implementations once we have a\n    clear interface to program against.</blockquote>")))
 (idm181618869088
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>Let's consider how we can use modules to refactor the implementation\n    of <code>freq.ml</code>. Remember that the variable\n    <code>counts</code> contains an association list\n    representing the counts of the lines seen so far. But updating an\n    association list takes time linear in the length of the list, meaning that\n    the time complexity of processing a file is quadratic in the number of\n    distinct lines in the file.</blockquote>")))
 (idm181618875696
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>Source files in OCaml are tied into the module system, with each\n    file compiling down into a module whose name is derived from the name of\n    the file. We've encountered modules before, such as when we used functions\n    like <code>find</code> and <code>add</code> from the <code>List.Assoc</code> module. At its simplest, you can\n    think of a module as a collection of definitions that are stored within a\n    namespace.<a name=\"idm181618873136\"></a><a name=\"idm181618871840\"></a><a name=\"idm181618870528\"></a></blockquote>")))
 (idm181618878144
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>As a general matter, production executables should usually be\n      built using the native-code compiler, but it sometimes makes sense to\n      use bytecode for development builds. And, of course, bytecode makes\n      sense when targeting a platform not supported by the native-code\n      compiler. We'll cover both compilers in more detail in <a href=\"the-compiler-backend-byte-code-and-native-code.html\">ChapterÂ 23, <i>The Compiler Backend: Bytecode and Native code</i></a>.</blockquote>")))
 (idm181618880944
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>Aside from performance, executables generated by the two compilers\n      have nearly identical behavior. There are a few things to be aware of.\n      First, the bytecode compiler can be used on more architectures, and has\n      some tools that are not available for native code. For example, the\n      OCaml debugger only works with bytecode (although <span><strong>gdb</strong></span>, the GNU Debugger, works with OCaml\n      native-code applications). The bytecode compiler is also quicker than\n      the native-code compiler. In addition, in order to run a bytecode\n      executable, you typically need to have OCaml installed on the system in\n      question. That's not strictly required, though, since you can build a\n      bytecode executable with an embedded runtime, using the <code>-custom</code> compiler flag.</blockquote>")))
 (idm181618886304
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>OCaml ships with two compilers: the <span><strong>ocamlc</strong></span> bytecode compiler and the <span><strong>ocamlopt</strong></span> native-code compiler. Programs\n      compiled with <span><strong>ocamlc</strong></span> are interpreted\n      by a virtual machine, while programs compiled with <span><strong>ocamlopt</strong></span> are compiled to native machine code\n      to be run on a specific operating system and processor architecture.\n      With <span><strong>ocamlbuild</strong></span>, targets ending with\n      <code>.byte</code> are build as bytecode\n      executables, and those ending with <code>.native</code> are built as native code.</blockquote>")))
 (idm181618907456
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>We can run the resulting executable from the command line. The\n    following line extracts strings from the <span><strong>ocamlopt</strong></span> binary, reporting the most frequently\n    occurring ones. Note that the specific results will vary from platform to\n    platform, since the binary itself will differ between platforms:<a name=\"idm181618906256\"></a><a name=\"idm181618904960\"></a><a name=\"idm181618903392\"></a><a name=\"idm181618901824\"></a><a name=\"idm181618900528\"></a><a name=\"idm181618899232\"></a><a name=\"idm181618897920\"></a><a name=\"idm181618897312\"></a></blockquote>")))
 (idm181618909904
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>If we'd invoked <span><strong>corebuild</strong></span> with a\n    target of <code>freq.native</code> instead of\n    <code>freq.byte</code>, we would have gotten native\n    code instead.</blockquote>")))
 (idm181618917968
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>While this works well enough for a one-file project, more\n    complicated projects require a tool to orchestrate the build. One good\n    tool for this task is <span><strong>ocamlbuild</strong></span>, which\n    is shipped with the OCaml compiler. We'll talk more about <span><strong>ocamlbuild</strong></span> in <a href=\"the-compiler-frontend-parsing-and-type-checking.html\">ChapterÂ 22, <i>The Compiler Frontend: Parsing and <span>Type\n    Checking</span></i></a>, but for now,\n    we'll just use a simple wrapper around <span><strong>ocamlbuild</strong></span> called <span><strong>corebuild</strong></span> that sets build parameters\n    appropriately for building against Core and its related\n    libraries:<a name=\"idm181618914176\"></a></blockquote>")))
 (idm181618925344
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>This uses <span><strong>ocamlfind</strong></span>, a tool which\n    itself invokes other parts of the OCaml toolchain (in this case, <span><strong>ocamlc</strong></span>) with the appropriate flags to link in\n    particular libraries and packages. Here, <code>-package\n    core</code> is asking <span><strong>ocamlfind</strong></span> to\n    link in the Core library; <code>-linkpkg</code> asks\n    ocamlfind to link in the packages as is necessary for building an\n    executable, while <code>-thread</code> turns on threading support (which\n    is required for Core).<a name=\"idm181618920544\"></a><a name=\"idm181618919232\"></a></blockquote>")))
 (idm181618933072
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>But as you can see, it fails because it can't find Core. We need a\n    somewhat more complex invocation to get Core linked in:<a name=\"idm181618932688\"></a><a name=\"idm181618931392\"></a><a name=\"idm181618930096\"></a></blockquote>")))
 (idm181618938016
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>If we weren't using Core or any other external libraries, we could\n    build the executable like this:</blockquote>")))
 (idm181618941168
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>The idiom of writing <code>let () =</code>\n      may seem a bit odd, but it has a purpose. The <code>let</code>\n      binding here is a pattern-match to a value of type <code>unit</code>, which is there to ensure that the\n      expression on the righthand side returns <code>unit</code>, as is common for functions that operate\n      primarily by side effect.</blockquote>")))
 (idm181618944736
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>Unlike C, programs in OCaml do not have a unique <code>main</code> function. When an OCaml program is\n      evaluated, all the statements in the implementation files are evaluated\n      in the order in which they were linked together. These implementation\n      files can contain arbitrary expressions, not just function definitions.\n      In this example, the declaration starting with <code>let () =</code> plays the role of the <code>main</code> function, kicking off the processing. But\n      really the entire file is evaluated at startup, and so in some sense the\n      full codebase is one big <code>main</code>\n      function.</blockquote>")))
 (idm181618949984
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>With <code>build_counts</code> defined, we\n    then call the function to build the association list, sort that list by\n    frequency in descending order, grab the first 10 elements off the list,\n    and then iterate over those 10 elements and print them to the screen.\n    These operations are tied together using the <code>|&gt;</code> operator described in <a href=\"variables-and-functions.html\">ChapterÂ 2, <i>Variables and Functions</i></a>.<a name=\"idm181618947584\"></a><a name=\"idm181618946672\"></a></blockquote>")))
 (idm181618954176
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>The function <code>build_counts</code> reads\n    in lines from <code>stdin</code>, constructing from\n    those lines an association list with the frequencies of each line. It does\n    this by invoking <code>In_channel.fold_lines</code>\n    (similar to the function <code>List.fold</code>\n    described in <a href=\"lists-and-patterns.html\">ChapterÂ 3, <i>Lists and Patterns</i></a>), which reads through\n    the lines one by one, calling the provided <code>fold</code>\n    function for each line to update the accumulator. That accumulator is\n    initialized to the empty list.</blockquote>")))
 (idm181618958336
  ((file files-modules-and-programs.html)
   (html "<blockquote>Now we can write <code>freq.ml</code>:</blockquote>")))
 (idm181618959504
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>Note that <code>List.Assoc.add</code> doesn't\n    modify the original list, but instead allocates a new list with the\n    requisite key/value pair added.</blockquote>")))
 (idm181618977488
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>This implementation will use two functions from the <code>List.Assoc</code> module, which provides utility\n    functions for interacting with association lists, i.e., lists of key/value\n    pairs. In particular, we use the function <code>List.Assoc.find</code>, which looks up a key in an\n    association list; and <code>List.Assoc.add</code>,\n    which adds a new binding to an association list, as shown here:<a name=\"idm181618974944\"></a><a name=\"idm181618973632\"></a><a name=\"idm181618972320\"></a><a name=\"idm181618971008\"></a></blockquote>")))
 (idm181618982288
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>We'll start with an example: a utility that reads lines from <code>stdin</code> and computes a frequency count of the lines. At the end, the 10 lines with\n      the highest frequency counts are written out. We'll start with a simple implementation, which\n      we'll save as the file <span><em>freq.ml</em></span>.<a name=\"FILEsnglprog\"></a><a name=\"Psingfil\"></a></blockquote>")))
 (idm181618983776
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>In this chapter, we'll show you how to build an OCaml program from a\n  collection of files, as well as the basics of working with modules and\n  module signatures.</blockquote>")))
 (idm181618984560
  ((file files-modules-and-programs.html)
   (html
    "<blockquote>We've so far experienced OCaml largely through the toplevel. As you move from exercises to\n    real-world programs, you'll need to leave the toplevel behind and start building programs from\n    files. Files are more than just a convenient way to store and manage your code; in OCaml, they\n    also correspond to modules, which act as boundaries that divide your program into conceptual\n    units.</blockquote>")))
 (idm181616851056
  ((file error-handling.html)
   (html
    "<blockquote>In short, for errors that are a foreseeable and ordinary part of the\n    execution of your production code and that are not omnipresent,\n    error-aware return types are typically the right solution.</blockquote>")))
 (idm181616851792
  ((file error-handling.html)
   (html
    "<blockquote>Also, for errors that are omnipresent, error-aware return types may\n    be overkill. A good example is out-of-memory errors, which can occur\n    anywhere, and so you'd need to use error-aware return types everywhere to\n    capture those. Having every operation marked as one that might fail is no\n    more explicit than having none of them marked.</blockquote>")))
 (idm181616852416
  ((file error-handling.html)
   (html
    "<blockquote>To be clear, it doesn't make sense to avoid exceptions entirely. The\n    maxim of &quot;use exceptions for exceptional conditions&quot; applies. If an error\n    occurs sufficiently rarely, then throwing an exception is often the right\n    behavior.</blockquote>")))
 (idm181616853216
  ((file error-handling.html)
   (html
    "<blockquote>The right trade-off depends on your application. If you're writing a\n    rough-and-ready program where getting it done quickly is key and failure\n    is not that expensive, then using exceptions extensively may be the way to\n    go. If, on the other hand, you're writing production software whose\n    failure is costly, then you should probably lean in the direction of using\n    error-aware return types.</blockquote>")))
 (idm181616855344
  ((file error-handling.html)
   (html
    "<blockquote>Exceptions are more concise because they allow you to defer the job of error handling to\n      some larger scope, and because they don't clutter up your types. But this concision comes at a\n      cost: exceptions are all too easy to ignore. Error-aware return types, on the other hand, are\n      fully manifest in your type definitions, making the errors that your code might generate\n      explicit and impossible to ignore.<a name=\"idm181616854656\"></a></blockquote>")))
 (idm181616857616
  ((file error-handling.html)
   (html
    "<blockquote>Given that OCaml supports both exceptions and error-aware return\n    types, how do you choose between them? The key is to think about the\n    trade-off between concision and explicitness.<a name=\"idm181616857168\"></a></blockquote>")))
 (idm181616865024
  ((file error-handling.html)
   (html "<blockquote>And then we can reraise that exception:</blockquote>")))
 (idm181616873936
  ((file error-handling.html)
   (html
    "<blockquote>And <code>Result</code> and <code>Or_error</code> have similar <code>try_with</code> functions. So, we could write:</blockquote>")))
 (idm181616886592
  ((file error-handling.html)
   (html
    "<blockquote>Both exceptions and error-aware types are necessary parts of\n      programming in OCaml. As such, you often need to move between these two\n      worlds. Happily, Core comes with some useful helper functions to help\n      you do just that. For example, given a piece of code that can throw an\n      exception, you can capture that exception into an option as\n      follows:<a name=\"idm181616885952\"></a><a name=\"idm181616884400\"></a><a name=\"idm181616883488\"></a></blockquote>")))
 (idm181616888400
  ((file error-handling.html)
   (html
    "<blockquote>Here, the handler costs about the same, but the exception itself costs only 25, as\n        opposed to 60 additional cycles. All told, this should only matter if you're using\n        exceptions routinely as part of your flow control, which is in most cases a stylistic\n        mistake anyway.</blockquote>")))
 (idm181616914000
  ((file error-handling.html)
   (html
    "<blockquote>Here, we see that we lose something like 30 cycles to adding an exception handler, and\n        60 more to actually throwing and catching an exception. If we turn backtraces off, then the\n        results look like this:</blockquote>")))
 (idm181616924512
  ((file error-handling.html)
   (html
    "<blockquote>If we run this with stacktraces on, the benchmark results look\n      like this:</blockquote>")))
 (idm181616924896
  ((file error-handling.html)
   (html
    "<blockquote>We're testing three cases here: a simple computation with no\n      exceptions; the same computation with an exception handler but no thrown\n      exceptions; and finally the same computation where we use the exception\n      to do the control flow back to the caller.</blockquote>")))
 (idm181616928528
  ((file error-handling.html)
   (html
    "<blockquote>There is a legitimate reasons to run without backtraces: speed.\n      OCaml's exceptions are fairly fast, but they're even faster still if you\n      disable backtraces. Here's a simple benchmark that shows the effect,\n      using the <code>core_bench</code> package:</blockquote>")))
 (idm181616931040
  ((file error-handling.html)
   (html
    "<blockquote>The resulting error message is considerably less informative. You\n      can also turn backtraces off in your code by calling <code>Backtrace.Exn.set_recording false</code>.<a name=\"idm181616929984\"></a></blockquote>")))
 (idm181616937792
  ((file error-handling.html)
   (html
    "<blockquote>Even using Core and compiling with debugging symbols, you can turn\n      backtraces off by setting the <code>OCAMLRUNPARAM</code> environment variable to be\n      empty:</blockquote>")))
 (idm181616938576
  ((file error-handling.html)
   (html
    "<blockquote>This works well if you have backtraces enabled, but that isn't\n      always the case. In fact, by default, OCaml has backtraces turned off,\n      and even if you have them turned on at runtime, you can't get backtraces\n      unless you have compiled with debugging symbols. Core reverses the\n      default, so if you're linking in Core, you will have backtraces enabled\n      by default.</blockquote>")))
 (idm181616941168
  ((file error-handling.html)
   (html
    "<blockquote>You can also capture a backtrace within your program by calling\n      <code>Exn.backtrace</code>, which returns the\n      backtrace of the most recently thrown exception. This is useful for\n      reporting detailed information on errors that did not cause your program\n      to fail.<a name=\"idm181616940000\"></a></blockquote>")))
 (idm181616948560
  ((file error-handling.html)
   (html
    "<blockquote>If we build and run this program, we'll get a stack backtrace that\n      will provide some information about where the error occurred and the\n      stack of function calls that were in place at the time of the\n      error:</blockquote>")))
 (idm181616957936
  ((file error-handling.html)
   (html
    "<blockquote>A big part of the value of exceptions is that they provide useful\n      debugging information in the form of a stack backtrace. Consider the\n      following simple program<a name=\"idm181616957504\"></a><a name=\"idm181616956192\"></a><a name=\"idm181616955280\"></a>:<a name=\"idm181616954256\"></a><a name=\"idm181616952944\"></a></blockquote>")))
 (idm181616967520
  ((file error-handling.html)
   (html
    "<blockquote>At this point, it makes sense to simply use the\n      nonexception-throwing function, <code>List.Assoc.find</code>, instead:</blockquote>")))
 (idm181616977696
  ((file error-handling.html)
   (html
    "<blockquote>This kind of problem is hard to detect in advance because the type\n      system doesn't tell you what exceptions a given function might throw.\n      For this reason, it's generally better to avoid relying on the identity\n      of the exception to determine the nature of a failure. A better approach\n      is to narrow the scope of the exception handler, so that when it fires\n      it's very clear what part of the code failed:</blockquote>")))
 (idm181616984896
  ((file error-handling.html)
   (html
    "<blockquote>The use of exceptions in this code, however, presents some\n      problems. In particular, what happens if <code>compute_weight</code> throws an exception? Ideally,\n      <code>lookup_weight</code> should propagate that\n      exception on, but if the exception happens to be <code>Not_found</code>, then that's not what will\n      happen:</blockquote>")))
 (idm181616986832
  ((file error-handling.html)
   (html
    "<blockquote>As you can see from the type, <code>lookup_weight</code> takes an association list, a key\n      for looking up a corresponding value in that list, and a function for\n      computing a floating-point weight from the looked-up value. If no value\n      is found, then a weight of <code>0.</code> should\n      be returned.</blockquote>")))
 (idm181617000128
  ((file error-handling.html)
   (html
    "<blockquote>OCaml's exception-handling system allows you to tune your\n      error-recovery logic to the particular error that was thrown. For\n      example, <code>List.find_exn</code> throws\n      <code>Not_found</code> when the element in\n      question can't be found. Let's look at an example of how you could take\n      advantage of this. In particular, consider the following\n      function:<a name=\"idm181616998224\"></a><a name=\"idm181616996912\"></a></blockquote>")))
 (idm181617002848
  ((file error-handling.html)
   (html
    "<blockquote><code>In_channel.with_file</code> is built\n      on top of <code>protect</code> so that it can\n      clean up after itself in the presence of exceptions.</blockquote>")))
 (idm181617010672
  ((file error-handling.html)
   (html
    "<blockquote>This is a common enough problem that <code>In_channel</code> has a function called <code>with_file</code> that automates this pattern:</blockquote>")))
 (idm181617022112
  ((file error-handling.html)
   (html
    "<blockquote>We can fix this using Core's <code>protect</code> function, which takes two arguments: a\n      thunk <code>f</code>, which is the main body of\n      the computation to be run; and a thunk <code>finally</code>, which is to be called when <code>f</code> exits, whether it exits normally or with an\n      exception. This is similar to the <code>try/finally</code> construct available in many\n      programming languages, but it is implemented in a library, rather than\n      being a built-in primitive. Here's how it could be used to fix <code>load_reminders</code>:</blockquote>")))
 (idm181617024736
  ((file error-handling.html)
   (html
    "<blockquote>The problem with this code is that the function that loads the\n      s-expression and parses it into a list of <code>Time.t</code>/<code>string</code> pairs might throw an exception if the\n      file in question is malformed. Unfortunately, that means that the\n      <code>In_channel.t</code> that was opened will\n      never be closed, leading to a file-descriptor leak.</blockquote>")))
 (idm181617038448
  ((file error-handling.html)
   (html
    "<blockquote>One headache with exceptions is that they can terminate your\n      execution at unexpected places, leaving your program in an awkward\n      state. Consider the following function for loading a file full of\n      reminders, formatted as s-expressions:<a name=\"idm181617037936\"></a><a name=\"idm181617036624\"></a></blockquote>")))
 (idm181617040128
  ((file error-handling.html)
   (html
    "<blockquote>Otherwise, the original exception continues up the stack of\n      function calls, to be handled by the next outer exception handler. If\n      the exception is never caught, it terminates the program.</blockquote>")))
 (idm181617042144
  ((file error-handling.html)
   (html
    "<blockquote>But if the evaluation of the body throws an exception, then the\n      exception will be fed to the pattern-match statements following the\n      <code>with</code>. If the exception matches a\n      pattern, then we consider the exception caught, and the <code>try/with</code> clause evaluates to the expression on\n      the righthand side of the matching pattern.</blockquote>")))
 (idm181617044752
  ((file error-handling.html)
   (html
    "<blockquote>A <code>try/with</code> clause first evaluates its body,\n            <span><em><code>expr</code></em></span>. If no exception is thrown,\n        then the result of evaluating the body is what the entire <code>try/with</code> clause evaluates to.</blockquote>")))
 (idm181617050768
  ((file error-handling.html)
   (html
    "<blockquote>In OCaml, an exception handler is declared using a <code>try</code>/<code>with</code>\n      statement. Here's the basic syntax.</blockquote>")))
 (idm181617054416
  ((file error-handling.html)
   (html
    "<blockquote>So far, we've only seen exceptions fully terminate the execution\n      of a computation. But often, we want a program to be able to respond to\n      and recover from an exception. This is achieved through the use of\n      <span><em>exception handlers</em></span>.<a name=\"idm181617053520\"></a><a name=\"idm181617052208\"></a></blockquote>")))
 (idm181617056672
  ((file error-handling.html)
   (html
    "<blockquote>This shows what's special about <code>assert</code>: it captures the line number and\n      character offset of the source location from which the assertion was\n      made.</blockquote>")))
 (idm181617069856
  ((file error-handling.html)
   (html
    "<blockquote>In this case, the <code>assert</code> can never be triggered\n      because we have a check that makes sure that the lists are of the same\n      length before we call <code>loop</code>. If we\n      change the code so that we drop this test, then we can trigger the\n      <code>assert</code>:</blockquote>")))
 (idm181617071440
  ((file error-handling.html)
   (html
    "<blockquote>Here we use <code>assert false</code>, which\n      means that the <code>assert</code> is guaranteed to trigger. In\n      general, one can put an arbitrary condition in the assertion.</blockquote>")))
 (idm181617089344
  ((file error-handling.html)
   (html
    "<blockquote>Another important way of throwing an exception is the <code>assert</code> directive. <code>assert</code> is used for situations where a\n      violation of the condition in question indicates a bug. Consider the\n      following piece of code for zipping together two lists:<a name=\"idm181617087552\"></a></blockquote>")))
 (idm181617091136
  ((file error-handling.html)
   (html
    "<blockquote>There are several other useful functions for raising exceptions,\n      which can be found in the API documentation for the <code>Common</code> and <code>Exn</code> modules in Core.</blockquote>")))
 (idm181617098960
  ((file error-handling.html)
   (html
    "<blockquote>OCaml and Core provide a number of helper functions to simplify\n      the task of throwing exceptions. The simplest one is <code>failwith</code>, which could be defined as\n      follows:<a name=\"idm181617097888\"></a><a name=\"idm181617096576\"></a></blockquote>")))
 (idm181617101120
  ((file error-handling.html)
   (html
    "<blockquote>This is all part of the support for s-expressions provided by the\n      Sexplib library and syntax extension, which is described in more detail\n      in <a href=\"data-serialization-with-s-expressions.html\">ChapterÂ 17, <i>Data Serialization with S-Expressions</i></a>.</blockquote>")))
 (idm181617103744
  ((file error-handling.html)
   (html
    "<blockquote>The period in front of <code>Wrong_date</code> is there because the representation\n      generated by <code>with sexp</code> includes the\n      full module path of the module where the exception in question is\n      defined. In this case, the string <code>//toplevel//</code> is used to indicate that this was\n      declared at the toplevel, rather than in a module.</blockquote>")))
 (idm181617110704
  ((file error-handling.html)
   (html
    "<blockquote>But if we declare the exception using <code>with sexp</code> (and the constituent types have sexp\n      converters), we'll get something with more information:</blockquote>")))
 (idm181617116944
  ((file error-handling.html)
   (html
    "<blockquote>OCaml can't always generate a useful textual representation of an\n      exception. For example:</blockquote>")))
 (idm181617121312
  ((file error-handling.html)
   (html
    "<blockquote>This all matters because it means that the return type of <code>raise</code> can be whatever it needs to be to fit into\n    the context it is called in. Thus, the type system will let us throw an\n    exception anywhere in a program.<a name=\"idm181617120192\"></a><a name=\"idm181617119312\"></a></blockquote>")))
 (idm181617122288
  ((file error-handling.html)
   (html
    "<blockquote><code>forever</code> doesn't return a value\n    for a different reason: it's an infinite loop.</blockquote>")))
 (idm181617130256
  ((file error-handling.html)
   (html
    "<blockquote>The return type of <code>'a</code> makes it\n    look like <code>raise</code> manufactures a value to\n    return that is completely unconstrained in its type. That seems\n    impossible, and it is. Really, <code>raise</code>\n    has a return type of <code>'a</code> because it\n    never returns at all. This behavior isn't restricted to functions like\n    <code>raise</code> that terminate by throwing\n    exceptions. Here's another example of a function that doesn't return a\n    value:</blockquote>")))
 (idm181617135344
  ((file error-handling.html)
   (html
    "<blockquote>In the preceding example, <code>raise</code>\n    throws the exception, thus terminating the computation. The type of raise\n    is a bit surprising when you first see it:</blockquote>")))
 (idm181617138768
  ((file error-handling.html)
   (html
    "<blockquote>Note that we named the function <code>find_exn</code> to warn the user that the function\n    routinely throws exceptions, a convention that is used heavily in\n    Core.<a name=\"idm181617137696\"></a><a name=\"idm181617136384\"></a></blockquote>")))
 (idm181617151536
  ((file error-handling.html)
   (html
    "<blockquote>The following function uses the <code>Key_not_found</code> exception we defined above to\n    signal an error:</blockquote>")))
 (idm181617156240
  ((file error-handling.html)
   (html
    "<blockquote>Exceptions are all of the same type, <code>exn</code>. The <code>exn</code>\n    type is something of a special case in the OCaml type system. It is\n    similar to the variant types we encountered in <a href=\"variants.html\">ChapterÂ 6, <i>Variants</i></a>, except that it is <span><em>open</em></span>,\n    meaning that it's not fully defined in any one place. In particular, new\n    tags (specifically, new exceptions) can be added to it by different parts\n    of the program. This is in contrast to ordinary variants, which are\n    defined with a closed universe of available tags. One result of this is\n    that you can never have an exhaustive match on an <code>exn</code>, since the full set of possible exceptions\n    is not known.<a name=\"idm181617152560\"></a></blockquote>")))
 (idm181617163920
  ((file error-handling.html)
   (html
    "<blockquote>Exceptions are ordinary values and can be manipulated just like\n    other OCaml values:</blockquote>")))
 (idm181617170736
  ((file error-handling.html)
   (html
    "<blockquote>In addition to built-in exceptions like <code>Divide_by_zero</code>, OCaml lets you define your\n    own:</blockquote>")))
 (idm181617178496
  ((file error-handling.html)
   (html
    "<blockquote>If we put a <code>printf</code> in the middle\n    of the computation, we can see that <code>List.map</code> is interrupted partway through its\n    execution, never getting to the end of the list:</blockquote>")))
 (idm181617182896
  ((file error-handling.html)
   (html
    "<blockquote>And an exception can terminate a computation even if it happens\n    nested somewhere deep within it:</blockquote>")))
 (idm181617187248
  ((file error-handling.html)
   (html
    "<blockquote>You can trigger an exception by, for example, dividing an integer by\n    zero:</blockquote>")))
 (idm181617190560
  ((file error-handling.html)
   (html
    "<blockquote>Exceptions in OCaml are not that different from exceptions in many\n    other languages, like Java, C#, and Python. Exceptions are a way to\n    terminate a computation and report an error, while providing a mechanism\n    to catch and handle (and possibly recover from) exceptions that are\n    triggered by subcomputations.<a name=\"idm181617189968\"></a><a name=\"idm181617188672\"></a></blockquote>")))
 (idm181617195552
  ((file error-handling.html)
   (html
    "<blockquote>These error-handling functions are valuable because they let you\n      express your error handling both explicitly and concisely. We've only\n      discussed these functions in the context of the <code>Option</code> module, but more functionality of this\n      kind can be found in the <code>Result</code> and\n      <code>Or_error</code> modules.<a name=\"idm181617193056\"></a><a name=\"idm181617192448\"></a></blockquote>")))
 (idm181617206832
  ((file error-handling.html)
   (html
    "<blockquote>There are other useful idioms encoded in the functions in <code>Option</code>. One example is <code>Option.both</code>, which takes two optional values\n      and produces a new optional pair that is <code>None</code> if either of its arguments are <code>None</code>. Using <code>Option.both</code>, we can make <code>compute_bounds</code> even shorter:</blockquote>")))
 (idm181617209200
  ((file error-handling.html)
   (html
    "<blockquote>This use of <code>bind</code> isn't really\n      materially better than the one we started with, and indeed, for small\n      examples like this, direct matching of options is generally better than\n      using <code>bind</code>. But for large, complex\n      examples with many stages of error handling, the <code>bind</code>\n      idiom becomes clearer and easier to manage.</blockquote>")))
 (idm181617221968
  ((file error-handling.html)
   (html
    "<blockquote>The preceding code is a little bit hard to swallow, however, on a\n      syntactic level. We can make it easier to read and drop some of the\n      parentheses, by using the infix operator form of\n      <code>bind</code>, which we get access to by locally opening\n      <code>Option.Monad_infix</code>. The module is\n      called <code>Monad_infix</code> because the\n      <code>bind</code> operator is part of a subinterface called\n      <code>Monad</code>, which we'll see again in <a href=\"concurrent-programming-with-async.html\">ChapterÂ 18, <i>Concurrent Programming with Async</i></a>:</blockquote>")))
 (idm181617235936
  ((file error-handling.html)
   (html
    "<blockquote>As you can see, <code>bind None f</code> returns <code>None</code> without calling <code>f</code>, and\n          <code>bind (Some x) f</code> returns <code>f\n          x</code>.  <code>bind</code> can be used as a way of sequencing\n        together error-producing functions so that the first one to produce an error terminates the\n        computation. Here's a rewrite of <code>compute_bounds</code> to use a\n        nested series of <code>bind</code>s:</blockquote>")))
 (idm181617247552
  ((file error-handling.html)
   (html
    "<blockquote>As you write more error handling code in OCaml, you'll discover\n      that certain patterns start to emerge. A number of these common patterns\n      have been codified by functions in modules like <code>Option</code> and <code>Result</code>. One particularly useful pattern is\n      built around the function <code>bind</code>, which\n      is both an ordinary function and an infix operator <code>&gt;&gt;=</code>. Here's the definition of <code>bind</code> for options:<a name=\"idm181617243664\"></a></blockquote>")))
 (idm181617251056
  ((file error-handling.html)
   (html
    "<blockquote>The type <code>'a Or_error.t</code> is just\n      a shorthand for <code>('a,Error.t)\n      Result.t</code>, and it is, after <code>option</code>, the most common way of returning\n      errors in Core.</blockquote>")))
 (idm181617263888
  ((file error-handling.html)
   (html
    "<blockquote><code>Error</code> also supports operations\n      for transforming errors. For example, it's often useful to augment an\n      error with information about the context of the error or to combine\n      multiple errors together. <code>Error.tag</code>\n      and <code>Error.of_list</code> fulfill these\n      roles:<a name=\"idm181617261568\"></a><a name=\"idm181617260672\"></a><a name=\"idm181617259776\"></a></blockquote>")))
 (idm181617269632
  ((file error-handling.html)
   (html
    "<blockquote>We can use this same idiom for generating an error:</blockquote>")))
 (idm181617276800
  ((file error-handling.html)
   (html
    "<blockquote>We're not restricted to doing this kind of error reporting with\n      built-in types. This will be discussed in more detail in <a href=\"data-serialization-with-s-expressions.html\">ChapterÂ 17, <i>Data Serialization with S-Expressions</i></a>, but Sexplib comes\n      with a language extension that can autogenerate sexp converters for\n      newly generated types:</blockquote>")))
 (idm181617277296
  ((file error-handling.html)
   (html
    "<blockquote>Note that the time isn't actually serialized into an s-expression\n      until the error is printed out.</blockquote>")))
 (idm181617284576
  ((file error-handling.html)
   (html
    "<blockquote>S-expressions are supported by the Sexplib package that is\n      distributed with Core and is the most common serialization format used\n      in Core. Indeed, most types in Core come with built-in s-expression\n      converters. Here's an example of creating an error using the sexp\n      converter for times, <code>Time.sexp_of_t</code>:<a name=\"idm181617283360\"></a></blockquote>")))
 (idm181617289712
  ((file error-handling.html)
   (html
    "<blockquote>The most common way to create <code>Error.t</code>s is using\n      <span><em>s-expressions</em></span>. An s-expression is a balanced\n      parenthetical expression where the leaves of the expressions are\n      strings. Here's a simple example:<a name=\"idm181617288240\"></a></blockquote>")))
 (idm181617291552
  ((file error-handling.html)
   (html
    "<blockquote>In this case, we can benefit from the laziness of <code>Error</code>, since the thunk won't be called unless\n      the <code>Error.t</code> is converted to a\n      string.</blockquote>")))
 (idm181617299296
  ((file error-handling.html)
   (html
    "<blockquote>But you can also construct an <code>Error.t</code> from a <span><em>thunk</em></span>,\n      i.e., a function that takes a single argument of type <code>unit</code>:<a name=\"idm181617297248\"></a></blockquote>")))
 (idm181617305088
  ((file error-handling.html)
   (html
    "<blockquote><code>Error</code> gets around this issue\n      through laziness. In particular, an <code>Error.t</code> allows you to put off generation of\n      the error string until and unless you need it, which means a lot of the\n      time you never have to construct it at all. You can of course construct\n      an error directly from a string:</blockquote>")))
 (idm181617305760
  ((file error-handling.html)
   (html
    "<blockquote>It might not be obvious at first why efficiency is an issue at\n      all. But generating error messages is an expensive business. An ASCII\n      representation of a value can be quite time-consuming to construct,\n      particularly if it includes expensive-to-convert numerical data.</blockquote>")))
 (idm181617306976
  ((file error-handling.html)
   (html
    "<blockquote>Core's answer to this question is the <code>Error.t</code> type, which tries to forge a good\n      compromise between efficiency, convenience, and control over the\n      presentation of errors.</blockquote>")))
 (idm181617307520
  ((file error-handling.html)
   (html
    "<blockquote>But which type to choose? Is it better to represent errors as\n      strings? Some more structured representation like XML? Or something else\n      entirely?</blockquote>")))
 (idm181617309600
  ((file error-handling.html)
   (html
    "<blockquote><code>Result.t</code> gives you complete\n      freedom to choose the type of value you use to represent errors, but\n      it's often useful to standardize on an error type. Among other things,\n      this makes it easier to write utility functions to automate common error\n      handling patterns.<a name=\"idm181617308544\"></a></blockquote>")))
 (idm181617311728
  ((file error-handling.html)
   (html
    "<blockquote>without first opening the <code>Result</code> module.</blockquote>")))
 (idm181617320128
  ((file error-handling.html)
   (html
    "<blockquote>A <code>Result.t</code> is essentially an\n      option augmented with the ability to store other information in the\n      error case. Like <code>Some</code> and <code>None</code> for options, the constructors <code>Ok</code> and <code>Error</code> are promoted to the toplevel by <code>Core.Std</code>. As such, we can write:</blockquote>")))
 (idm181617324304
  ((file error-handling.html)
   (html
    "<blockquote><code>Result.t</code> is meant to address\n      this deficiency. The type is defined as follows:<a name=\"idm181617323456\"></a></blockquote>")))
 (idm181617325536
  ((file error-handling.html)
   (html
    "<blockquote>Options aren't always a sufficiently expressive way to report\n      errors. Specifically, when you encode an error as <code>None</code>, there's nowhere to say anything about\n      the nature of the error.</blockquote>")))
 (idm181617327296
  ((file error-handling.html)
   (html
    "<blockquote>The use of options to encode errors underlines the fact that it's\n    not clear whether a particular outcome, like not finding something on a\n    list, is an error or is just another valid outcome. This depends on the\n    larger context of your program, and thus is not something that a\n    general-purpose library can know in advance. One of the advantages of\n    error-aware return types is that they work well in both situations.</blockquote>")))
 (idm181617338000
  ((file error-handling.html)
   (html
    "<blockquote>On the other hand, in the <code>find_mismatches</code> that follows, errors encountered\n    during the computation do not propagate to the return value of the\n    function. <code>find_mismatches</code> takes two\n    hash tables as arguments and searches for keys that have different data in\n    one table than in the other. As such, the failure to find a key in one\n    table isn't a failure of any sort:</blockquote>")))
 (idm181617341488
  ((file error-handling.html)
   (html
    "<blockquote>The <code>match</code> statement is used to handle the error\n    cases, propagating a <code>None</code> in <code>hd</code> or <code>last</code>\n    into the return value of <code>compute_bounds</code>.</blockquote>")))
 (idm181617352880
  ((file error-handling.html)
   (html
    "<blockquote>Consider the <code>compute_bounds</code>\n    function. The function takes a list and a comparison function and returns\n    upper and lower bounds for the list by finding the smallest and largest\n    element on the list. <code>List.hd</code> and\n    <code>List.last</code>, which return <code>None</code> when they encounter an empty list, are used\n    to extract the largest and smallest element of the list:</blockquote>")))
 (idm181617353488
  ((file error-handling.html)
   (html
    "<blockquote>Including errors in the return values of your functions requires the\n    caller to handle the error explicitly, allowing the caller to make the\n    choice of whether to recover from the error or propagate it onward.</blockquote>")))
 (idm181617359712
  ((file error-handling.html)
   (html
    "<blockquote>The option in the return type indicates that the function may not\n    succeed in finding a suitable element:</blockquote>")))
 (idm181617365392
  ((file error-handling.html)
   (html
    "<blockquote>The best way in OCaml to signal an error is to include that error in\n    your return value. Consider the type of the <code>find</code> function in the <code>List</code> module:</blockquote>")))
 (idm181617369536
  ((file error-handling.html)
   (html
    "<blockquote>We'll start by describing the two basic approaches for reporting\n  errors in OCaml: error-aware return types and exceptions.<a name=\"erraware\"></a><a name=\"EHeraware\"></a></blockquote>")))
 (idm181617370208
  ((file error-handling.html)
   (html
    "<blockquote>Thankfully, OCaml has powerful tools for handling errors reliably and\n  with a minimum of pain. In this chapter we'll discuss some of the different\n  approaches in OCaml to handling errors, and give some advice on how to\n  design interfaces that make error handling easier.</blockquote>")))
 (idm181617370912
  ((file error-handling.html)
   (html
    "<blockquote>Nobody likes dealing with errors. It's tedious, it's easy to get wrong, and it's usually\n    just not as fun as planning out how your program is going to succeed. But error handling is\n    important, and however much you don't like thinking about it, having your software fail due to\n    poor error handling is worse.</blockquote>")))
 (idm181611550432
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>This can be very useful in designing config file formats that are\n      both reasonably terse and easy to generate and maintain. It can also be\n      useful for backwards compatibility: if you add a new field to your\n      config record, but you make that field optional, then you should still\n      be able to parse older version of your config.<a name=\"idm181611549824\"></a><a name=\"idm181611549216\"></a><a name=\"idm181611547920\"></a></blockquote>")))
 (idm181611557568
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>As you can see, the fields that are at their default values are\n      simply omitted from the s-expression. On the other hand, if we convert a\n      config with other values, then those values will be included in the\n      s-expression:</blockquote>")))
 (idm181611571856
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>We could make the generated s-expression also drop exported\n      values, by using the <code>sexp_drop_default</code> directive:</blockquote>")))
 (idm181611576384
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>If we convert the configuration back out to an s-expression,\n      you'll notice that all of the fields are present, even though they're\n      not strictly necessary:</blockquote>")))
 (idm181611582720
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>Now, if we try to convert an s-expression that specifies only the\n      <code>web_root</code>, we'll see that the other\n      values are filled in with the desired defaults:</blockquote>")))
 (idm181611591424
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>One could imagine making some of these parameters optional; in\n      particular, by default, we might want the web server to bind to port 80,\n      and to listen as localhost. We can do this as follows:</blockquote>")))
 (idm181611599904
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>Consider the following type, which represents the configuration of\n      a very simple web server:</blockquote>")))
 (idm181611603808
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>The <code>sexp_option</code> declaration is\n      really just an example of specifying a default behavior for dealing with\n      an unspecified field. In particular, <code>sexp_option</code> fills in absent fields with\n      <code>None</code>. But you might want to allow\n      other ways of filling in default values.<a name=\"idm181611601344\"></a></blockquote>")))
 (idm181611615008
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>But what if we want a field to be optional, i.e., we want to allow\n      it to be omitted from the record entirely? In that case, we can mark it\n      with <code>sexp_option</code>:</blockquote>")))
 (idm181611628976
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>Another common directive is <code>sexp_option</code>, which is used to make a record\n      field optional in the s-expression. Normally, optional values are\n      represented either as <code>()</code> for <code>None</code>, or as <code>(x)</code> for <code>Some\n      x</code>, and a record field containing an option would be rendered\n      accordingly. For example:<a name=\"idm181611625200\"></a></blockquote>")))
 (idm181611641152
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>You might prefer to make the syntax a bit less parenthesis-laden\n      by dropping the parentheses around the list. We can replace the <code>string list</code> in the type declaration with\n      <code>string sexp_list</code> to give us this\n      alternate syntax:</blockquote>")))
 (idm181611668336
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>Sometimes, sexp converters have more parentheses than one would\n      ideally like. Consider, for example, the following variant\n      type:<a name=\"idm181611667936\"></a></blockquote>")))
 (idm181611679072
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>If you really only want to generate one direction of converter,\n      one can do this by annotating the type with <code>with sexp_of</code> or <code>with\n      of_sexp</code> instead of <code>with\n      sexp</code>:</blockquote>")))
 (idm181611688912
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>This is there to allow for s-expression converters to be created\n      for types containing <code>sexp_opaque</code>\n      values. This is useful because the resulting converters won't\n      necessarily fail on all inputs. For example, if you have a record\n      containing a <code>no_converter list</code>, the\n      <code>t_of_sexp</code> function would still\n      succeed when the list is empty:</blockquote>")))
 (idm181611695296
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>Note that the <code>t_of_sexp</code>\n      function for an opaque type is generated, but will fail at runtime if it\n      is used:</blockquote>")))
 (idm181611700368
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>And if we now convert a value of this type to an s-expression,\n      we'll see the contents of field <code>a</code>\n      marked as opaque:</blockquote>")))
 (idm181611707376
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>But with <code>sexp_opaque</code>, we can\n      embed our opaque <code>no_converter</code> type\n      within the other data structure without an error.</blockquote>")))
 (idm181611714288
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>Note that the type of a component marked as opaque doesn't need to\n      have a sexp converter defined. Here, if we define a type without a sexp\n      converter and then try to use another type with a sexp converter, we'll\n      error out:</blockquote>")))
 (idm181611718224
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>The most commonly used directive is <code>sexp_opaque</code>, whose purpose is to mark a given\n      component of a type as being unconvertible. Anything marked with\n      <code>sexp_opaque</code> will be presented as the\n      atom <code>&lt;opaque&gt;</code> by the to-sexp\n      converter, and will trigger an exception from the from-sexp\n      converter.<a name=\"idm181611715712\"></a></blockquote>")))
 (idm181611720464
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>Note that the extra directives aren't part of the standard OCaml\n    syntax, but are added via the Sexplib syntax extension. However, since\n    Sexplib is used throughout Core and is part of the standard bundle\n    activated by <span><strong>corebuild</strong></span>, you can use\n    these in your own Core code without any special effort.</blockquote>")))
 (idm181611722432
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>Sexplib supports a collection of directives for modifying the\n    default behavior of the autogenerated sexp converters. These directives\n    allow you to customize the way in which types are represented as\n    s-expressions without having to write a custom converter.<a name=\"idm181611721904\"></a></blockquote>")))
 (idm181611726288
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>In the preceding error, <code>foo_broken_example.scm:2:5</code> tells us that\n    the error occurred in the file <code>&quot;foo_broken_example.scm&quot;</code> on line 2,\n    character 5. This is a much better start for figuring out what went wrong.\n    The ability to find the precise location of the error depends on the sexp\n    converter reporting errors using the function <code>of_sexp_error</code>. This is already done by\n    converters generated by Sexplib, but you should make sure to do the same\n    when you write custom converters.</blockquote>")))
 (idm181611737712
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>If we run it again, we'll see a much more specific error:</blockquote>")))
 (idm181611740672
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>But there's hope! We can make a small change to the code to improve\n    the error message greatly:</blockquote>")))
 (idm181611741344
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>If all you have is the error message and the string, it's not\n    terribly informative. In particular, you know that the parsing errored out\n    on the atom &quot;not-an-integer,&quot; but you don't know which one! In a large\n    file, this kind of bad error message can be pure misery.</blockquote>")))
 (idm181611754128
  ((file data-serialization-with-s-expressions.html)
   (html "<blockquote>you'll get the following error:</blockquote>")))
 (idm181611756864
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>If you were to run this on a malformatted file, say, this\n    one:</blockquote>")))
 (idm181611764048
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>There are two steps to deserializing a type from an s-expression:\n    first, converting the bytes in a file to an s-expression; and the second,\n    converting that s-expression into the type in question. One problem with\n    this is that it can be hard to localize errors to the right place using\n    this scheme. Consider the following example:<a name=\"idm181611763440\"></a><a name=\"idm181611762144\"></a><a name=\"idm181611760816\"></a></blockquote>")))
 (idm181611766400
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>Another important aspect of our definition is that we call the\n    function <code>of_sexp_error</code> to raise an\n    exception when the parsing process fails. This improves the error\n    reporting that Sexplib can provide when a conversion fails, as we'll see\n    in the next section.</blockquote>")))
 (idm181611769552
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>This trick of overriding an existing function definition with a new\n    one is perfectly acceptable in OCaml. Since <code>t_of_sexp</code> is defined with an ordinary <code>let</code> rather than a <code>let\n    rec</code>, the call to the <code>t_of_sexp</code> goes to the Sexplib-generated version\n    of the function, rather than being a recursive call.</blockquote>")))
 (idm181611773136
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>We can fix this problem by overriding the autogenerated function and\n    writing a custom sexp converter that wraps the autogenerated converter\n    with whatever invariant checks are necessary:</blockquote>")))
 (idm181611779296
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>One easy mistake to make when dealing with sexp converters is to\n    ignore the fact that those converters can violate the invariants of your\n    code. For example, the <code>Int_interval</code>\n    module depends for the correctness of the <code>is_empty</code> check on the fact that for any value\n    <code>Range (x,y)</code>, <code>y</code> is greater than or equal to <code>x</code>. The <code>create</code>\n    function preserves this invariant, but the <code>t_of_sexp</code> function does not.<a name=\"idm181611774176\"></a></blockquote>")))
 (idm181611785232
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>At this point, <code>test_interval.ml</code>\n    will compile again, and if we run it, we'll get the following\n    output:</blockquote>")))
 (idm181611789664
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>This isn't an ideal solution, as it makes you repeatedly expose\n    these extra functions in every signature you create where you want to\n    serialize values. Sexplib solves this by exposing the same syntax\n    extension in signature definitions so that we can just use the same\n    <code>with</code> shorthand in the <code>mli</code> file. Here's the final version of the\n    signature that does just this:</blockquote>")))
 (idm181611792784
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>We could export the types by hand in the signature, by writing the\n    signatures for the extra functions generated by Sexplib:</blockquote>")))
 (idm181611798192
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>Building this will give us the following error:</blockquote>")))
 (idm181611802960
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>But we're still missing something: we haven't created an <code>mli</code> signature for <code>Int_interval</code> yet. Note that we need to\n    explicitly export the s-expression converters that were created within the\n    <code>ml</code> file. For example, here's an\n    interface that doesn't export the s-expression functions:</blockquote>")))
 (idm181611805920
  ((file data-serialization-with-s-expressions.html)
   (html "<blockquote>We can now use this module as follows:</blockquote>")))
 (idm181611811440
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>The most important functionality provided by Sexplib is the\n    autogeneration of converters for new types. We've seen a bit of how this\n    works already, but let's walk through a complete example. Here's the\n    source for a simple library for representing integer intervals, very\n    similar to the one described in <a href=\"functors.html\">ChapterÂ 9, <i>Functors</i></a>:<a name=\"idm181611810368\"></a></blockquote>")))
 (idm181611813744
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>In the preceding example, we use <code>Exn.handle_uncaught</code> to make sure that the\n    exception gets printed out in full detail. You should generally wrap every\n    Core program in this handler to get good error messages for any unexpected\n    exceptions.</blockquote>")))
 (idm181611824240
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>If we introduce an error into our s-expression, by, say, creating a\n    file <code>broken_example.scm</code> which is\n    <code>example.scm</code>, without open-paren in\n    front of <code>bar</code>, we'll get a parse\n    error:</blockquote>")))
 (idm181611828672
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>Again, loading the file as an s-expression drops the\n    comments:</blockquote>")))
 (idm181611831376
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>The following example shows all of these in action:</blockquote>")))
 (idm181611832224
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>Comments out the first complete s-expression that\n          follows</blockquote>")))
 (idm181611834208
  ((file data-serialization-with-s-expressions.html)
   (html "<blockquote>Delimiters for commenting out a block</blockquote>")))
 (idm181611836944
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>Comments out everything to the end of line</blockquote>")))
 (idm181611838928
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>All in, the s-expression format supports three comment\n    syntaxes:</blockquote>")))
 (idm181611843216
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>can be loaded using Sexplib. As you can see, the commented data is\n    not part of the resulting s-expression:</blockquote>")))
 (idm181611848480
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>The textual representation of s-expressions is pretty\n    straightforward. An s-expression is written down as a nested parenthetical\n    expression, with whitespace-separated strings as the atoms. Quotes are\n    used for atoms that contain parentheses or spaces themselves; backslash is\n    the escape character; and semicolons are used to introduce single-line\n    comments. Thus, the following file, <code>example.scm</code>:<a name=\"idm181611847168\"></a></blockquote>")))
 (idm181611854560
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>Sexplib is part of a family of syntax extensions, including\n        Comparelib, described in <a href=\"maps-and-hash-tables.html\">ChapterÂ 13, <i>Maps and Hash Tables</i></a>, and\n        Fieldslib, described in <a href=\"records.html\">ChapterÂ 5, <i>Records</i></a>, that generate code\n        based on type declarations and are all based on a common library\n        called Type_conv. This library provides a common language for\n        annotating types (e.g., using the <code>with</code> notation) and utilities for working\n        with type definitions. If you want to build your own type-driven\n        syntax extension, you should consider basing it on\n        Type_conv.<a name=\"idm181611852112\"></a><a name=\"idm181611851200\"></a></blockquote>")))
 (idm181611858432
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>OCaml doesn't directly support generating code from type\n        definitions. Instead, it supplies a powerful syntax extension\n        mechanism known as Camlp4, which lets you extend the grammar of the\n        language. Camlp4 is well integrated into the OCaml toolchain and can\n        be activated within the toplevel and also included in compilation\n        using the <code>-pp</code> compiler\n        flag.<a name=\"idm181611857168\"></a><a name=\"idm181611856240\"></a></blockquote>")))
 (idm181611859776
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>The syntax extensions bundled with Core almost all have the same\n      basic structure: they autogenerate code based on type definitions,\n      implementing functionality that you could in theory have implemented by\n      hand, but with far less programmer effort.</blockquote>")))
 (idm181611861728
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>The declaration <code>&lt;:sexp_of&lt;int *\n      string&gt;&gt;</code> simply gets expanded to the sexp converter for\n      the type <code>int * string</code>. This is useful\n      whenever you need a sexp converter for an anonymous type.</blockquote>")))
 (idm181611871248
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>You don't always have to declare a named type to create an\n      s-expression converter. The following syntax lets you create one inline,\n      as part of a larger expression:</blockquote>")))
 (idm181611882768
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>The syntax extension can be used outside of type declarations as\n      well. As discussed in <a href=\"error-handling.html\">ChapterÂ 7, <i>Error Handling</i></a>, <code>with sexp</code> can be attached to the declaration\n      of an exception, which will improve the ability of Core to generate a\n      useful string representation:</blockquote>")))
 (idm181611894992
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>Given how mechanical the code is, you could imagine writing a program that inspected the\n        type definition and autogenerated the conversion code for you. As it turns out, Sexplib does\n        just that. <code>Sexplib</code>, which is included with Core, provides\n        both a library for manipulating s-expressions and a <span><em>syntax extension</em></span>\n        for generating such conversion functions. With that syntax extension enabled, any type that\n        has <code>with sexp</code> as an annotation will trigger the\n        generation of the functions we want:<a name=\"idm181611892528\"></a><a name=\"idm181611891216\"></a></blockquote>")))
 (idm181611896304
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>This is somewhat tiresome to write, and it gets more so when you\n      consider the parser, i.e., <code>t_of_sexp</code>,\n      which is considerably more complex. Writing this kind of parsing and\n      printing code by hand is mechanical and error prone, not to mention a\n      drag.</blockquote>")))
 (idm181611907696
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>But what if you want a function to convert a brand new type to an\n      s-expression? You can of course write it yourself manually. Here's an\n      example:<a name=\"idm181611907280\"></a></blockquote>")))
 (idm181611910688
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>The <code>core.top</code> package (which you\n      should have loaded by default in your <code>.ocamlinit</code> file) loads in printers for the\n      Core extensions already, so you don't need to do anything special to use\n      the s-expression printer.</blockquote>")))
 (idm181611920800
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>This is due to OCaml's facility for installing custom\n      <span><em>top-level printers</em></span> that can rewrite some values\n      into more top-level-friendly equivalents. They are generally installed\n      as <span><strong>ocamlfind</strong></span> packages ending in\n      <code>top</code>:</blockquote>")))
 (idm181611923584
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>The values of the s-expressions that we created were printed\n      properly as s-expressions in the toplevel, instead of as the tree of\n      <code>Atom</code> and <code>List</code> variants that they're actually made\n      of.<a name=\"idm181611921840\"></a></blockquote>")))
 (idm181611934384
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>The functions that go in the other direction, <span><em>i.e.</em></span>, reconstruct an\n      OCaml value from an s-expression, use essentially the same trick for handling polymorphic\n      types, as shown in the following example. Note that these functions will fail with an\n      exception when presented with an s-expression that doesn't match the structure of the OCaml\n      type in question.</blockquote>")))
 (idm181611935664
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>Notice that <code>List.sexp_of_t</code> is\n    polymorphic and takes as its first argument another conversion function to\n    handle the elements of the list to be converted. Core uses this scheme\n    more generally for defining sexp converters for polymorphic types.</blockquote>")))
 (idm181611941952
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>It's also possible to convert more complex types such as lists or\n    arrays that are polymorphic across the types that they can contain:</blockquote>")))
 (idm181611950624
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>In addition to providing the <code>Sexp</code>\n    module, most of the base types in Core support conversion to and from\n    s-expressions. For example, we can use the conversion functions defined in\n    the respective modules for integers, strings, and exceptions:</blockquote>")))
 (idm181611958368
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>This prints out nicely because Core registers a pretty printer with\n    the toplevel. This pretty printer is based on the functions in <code>Sexp</code> for converting s-expressions to and from\n    strings:<a name=\"idm181611957264\"></a></blockquote>")))
 (idm181611966192
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>An s-expression can be thought of as a tree where each node contains\n    a list of its children, and where the leaves of the tree are strings. Core\n    provides good support for s-expressions in its <code>Sexp</code> module, including functions for converting\n    s-expressions to and from strings. Let's rewrite our example s-expression\n    in terms of this type:</blockquote>")))
 (idm181611970208
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>The type used to represent an s-expression is quite\n    simple:<a name=\"idm181611969888\"></a></blockquote>")))
 (idm181611971616
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>We'll tie this together at the end of the chapter with a simple s-expression formatted\n    configuration file for a web server</blockquote>")))
 (idm181611972432
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>How to integrate s-expressions into your interfaces, in particular how to add\n        s-expression converters to a module without breaking abstraction boundaries</blockquote>")))
 (idm181611973312
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>How to use custom type annotations to control the exact printing\n      behavior for s-expression converters</blockquote>")))
 (idm181611974144
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>How to generate s-expressions from arbitrary OCaml types</blockquote>")))
 (idm181611975056
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>The details of the s-expression format, including how to parse it while generating good\n        error messages for debugging malformed inputs</blockquote>")))
 (idm181611976048
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>This chapter will go into s-expressions in more depth. In particular,\n  we'll discuss:</blockquote>")))
 (idm181611978160
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>S-expressions play a major role in Core, effectively acting as the\n  default serialization format. Indeed, we've encountered s-expressions\n  multiple times already, including in <a href=\"error-handling.html\">ChapterÂ 7, <i>Error Handling</i></a>,\n  <a href=\"functors.html\">ChapterÂ 9, <i>Functors</i></a>, and <a href=\"first-class-modules.html\">ChapterÂ 10, <i>First-Class Modules</i></a>.</blockquote>")))
 (idm181611981568
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>There's a full definition of s-expressions available <a href=\"http://people.csail.mit.edu/rivest/Sexp.txt\" target=\"_top\">online</a>. An example\n  s-expression might look like this:</blockquote>")))
 (idm181611986672
  ((file data-serialization-with-s-expressions.html)
   (html
    "<blockquote>S-expressions are nested parenthetical expressions whose atomic values\n  are strings. They were first popularized by the Lisp programming language in\n  the 1960s. They have remained one of the simplest and most effective ways to\n  encode structured data in a human-readable and editable form.<a name=\"SERFORMsexp\"></a><a name=\"idm181611984560\"></a><a name=\"idm181611983264\"></a></blockquote>")))
 (idm181610719120
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>It is possible to safely use threads in ways that violate these\n      constraints. In particular, foreign threads can acquire the Async lock\n      using calls from the <code>Thread_safe</code>\n      module in Async, and thereby run Async computations safely. This is a\n      very flexible way of connecting threads to the Async world, but it's a\n      complex use case that is beyond the scope of this chapter.<a name=\"idm181610717824\"></a><a name=\"idm181610717216\"></a></blockquote>")))
 (idm181610720496
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>The computations executed by <code>In_thread.run</code> do not\n            make any calls to the Async library.</blockquote>")))
 (idm181610721344
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>There is no shared mutable state between the various threads involved.</blockquote>")))
 (idm181610722352
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Overall, combining Async and threads is quite tricky, but it can be done safely if the\n        following hold:</blockquote>")))
 (idm181610725760
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>There are two commonly available mutex packages for OCaml: the\n      <code>Mutex</code> module that's part of the\n      standard library, which is just a wrapper over OS-level mutexes and\n      <code>Nano_mutex</code>, a more efficient\n      alternative that takes advantage of some of the locking done by the\n      OCaml runtime to avoid needing to create an OS-level mutex much of the\n      time. As a result, creating a <code>Nano_mutex.t</code> is 20 times faster than creating\n      a <code>Mutex.t</code>, and acquiring the mutex is\n      about 40 percent faster.</blockquote>")))
 (idm181610731200
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Once you start working with system threads, you'll need to be\n      careful about mutable data structures. Most mutable OCaml data\n      structures do not have well-defined semantics when accessed concurrently\n      by multiple threads. The issues you can run into range from runtime\n      exceptions to corrupted data structures to, in some rare cases,\n      segfaults. That means you should always use mutexes when sharing mutable\n      data between different systems threads. Even data structures that seem\n      like they should be safe but are mutable under the covers, like lazy\n      values, can have undefined behavior when accessed from multiple\n      threads.<a name=\"idm181610730272\"></a><a name=\"idm181610729376\"></a><a name=\"idm181610728480\"></a><a name=\"idm181610727184\"></a></blockquote>")))
 (idm181610732720
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>The takeaway from these examples is that predicting thread\n    interleavings is a subtle business. Staying within the bounds of Async has\n    its limitations, but it leads to more predictable behavior.</blockquote>")))
 (idm181610739152
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>But if we compile this to a native-code executable, then the nonallocating busy loop will\n      block anything else from running:</blockquote>")))
 (idm181610744912
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Another tricky aspect of dealing with OCaml threads has to do with allocation. When\n      compiling to native code, OCaml's threads only get a chance to give up the runtime lock when\n      they interact with the allocator, so if there's a piece of code that doesn't allocate at all,\n      then it will never allow another OCaml thread to run. Bytecode doesn't have this behavior, so\n      if we run a nonallocating loop in bytecode, our timer process will get to run:</blockquote>")))
 (idm181610746288
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Now <code>log_delays</code> does get a chance to run, but not nearly\n      as often as every 100 milliseconds. The reason is that now that we're using system threads, we\n      are at the mercy of the operating system to decide when each thread gets scheduled. The\n      behavior of threads is very much dependent on the operating system and how it is\n      configured.</blockquote>")))
 (idm181610750848
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>If, on the other hand, we use <code>In_thread.run</code> to offload this to a different\n    system thread, the behavior will be different:</blockquote>")))
 (idm181610752576
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>As you can see, instead of waking up 10 times a second, <code>log_delays</code> is blocked out entirely while\n    <code>busy_loop</code> churns away.</blockquote>")))
 (idm181610757840
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Now see what happens if, instead of waiting on a clock event, we wait for a busy loop to\n      finish running:</blockquote>")))
 (idm181610761648
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>If we feed this function a simple timeout deferred, it works as you\n    might expect, waking up roughly every 100 milliseconds:</blockquote>")))
 (idm181610773168
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Interoperability between Async and system threads can be quite\n    tricky. Consider the following function for testing how responsive Async\n    is. The function takes a deferred-returning thunk, and it first runs that\n    thunk, and then uses <code>Clock.every</code> to\n    wake up every 100 milliseconds and print out a timestamp, until the\n    returned deferred becomes determined, at which point it prints out one\n    last timestamp:</blockquote>")))
 (idm181610774400
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>to cause <code>List.range 1 10</code> to be\n    run on one of Async's worker threads. When the computation is complete,\n    the result is placed in the deferred, where it can be used in the ordinary\n    way from Async.</blockquote>")))
 (idm181610783216
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>One way of dealing with this is to explicitly break up the\n    calculation into smaller pieces that are separated by binds. But sometimes\n    this explicit yielding is impractical, since it may involve intrusive\n    changes to an existing codebase. Another solution is to run the code in\n    question in a separate thread. Async's <code>In_thread</code> module provides multiple facilities\n    for doing just this, <code>In_thread.run</code>\n    being the simplest. We can simply write:<a name=\"idm181610781232\"></a></blockquote>")))
 (idm181610785152
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Another occasional use for system threads is to better interoperate with compute-intensive\n      OCaml code. In Async, if you have a long-running computation that never calls <code>bind</code> or <code>map</code>, then that\n      computation will block out the Async runtime until it completes.</blockquote>")))
 (idm181610786416
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Another reason to have multiple threads is to deal with non-OCaml\n    libraries that have their own event loop or for another reason need their\n    own threads. In that case, it's sometimes useful to run some OCaml code on\n    the foreign thread as part of the communication to your main program.\n    OCaml's foreign function interface is discussed in more detail in <a href=\"foreign-function-interface.html\">ChapterÂ 19, <i>Foreign Function Interface</i></a>.</blockquote>")))
 (idm181610788544
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>The most common reason for using system threads is that there are\n    some operating system calls that have no nonblocking alternative, which\n    means that you can't run them directly in a system like Async without\n    blocking your entire program. For this reason, Async maintains a thread\n    pool for running such calls. Most of the time, as a user of Async you\n    don't need to think about this, but it is happening under the\n    covers.<a name=\"idm181610787840\"></a></blockquote>")))
 (idm181610789024
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Given that threads don't provide physical parallelism, why are they\n    useful at all?</blockquote>")))
 (idm181610789648
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>The most surprising aspect of OCaml's system threads is that they\n    don't afford you any access to physical parallelism. That's because\n    OCaml's runtime has a single runtime lock that at most one thread can be\n    holding at a time.</blockquote>")))
 (idm181610796240
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Although we haven't worked with them yet, OCaml does have built-in\n    support for true system threads, i.e., kernel-level threads whose\n    interleaving is controlled by the operating system. We discussed in the\n    beginning of the chapter why Async is generally a better choice than\n    system threads, but even if you mostly use Async, OCaml's system threads\n    are sometimes necessary, and it's worth understanding them.<a name=\"idm181610795552\"></a><a name=\"idm181610794688\"></a><a name=\"idm181610793776\"></a><a name=\"systhrd\"></a><a name=\"ALsysthr\"></a></blockquote>")))
 (idm181610811632
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Now, if we run this with a suitably small timeout, we'll see that\n    one query succeeds and the other fails reporting a timeout:</blockquote>")))
 (idm181610815984
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>In the following example, we use <code>choose</code> to ensure that\n      the <code>interrupt</code> deferred becomes determined if and only if\n      the timeout deferred is chosen. Here's the code:</blockquote>")))
 (idm181610818464
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Note that there's no guarantee that the winning deferred will be the\n    one that becomes determined first. But <code>choose</code> does guarantee that only one <code>choice</code> will be chosen, and only the chosen\n    <code>choice</code> will execute the attached\n    function.</blockquote>")))
 (idm181610828288
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>We can get more precise handling of timeouts using Async's <code>choose</code> function. <code>choose</code> lets you pick among a\n      collection of different deferreds, reacting to exactly one of them. Each deferred is paired,\n      using the function <code>choice</code>, with a function that is called\n      if and only if that deferred is chosen. Here's the type signature of <code>choice</code> and <code>choose</code>:</blockquote>")))
 (idm181610835376
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>This will work and will cause the connection to shutdown cleanly\n    when we time out; but our code no longer explicitly knows whether or not\n    the timeout has kicked in. In particular, the error message on a timeout\n    will now be <code>&quot;Unexpected failure&quot;</code> rather\n    than <code>&quot;Timed out&quot;</code>, which it was in our\n    previous implementation.</blockquote>")))
 (idm181610834688
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Next, we'll modify <code>get_definition_with_timeout</code> to create a deferred\n    to pass in to <code>get_definition</code>, which\n    will become determined when our timeout expires:</blockquote>")))
 (idm181610840160
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>The following code shows how you can change <code>get_definition</code> and <code>get_definition_with_timeout</code> to cancel the\n    <code>get</code> call if the timeout expires:</blockquote>")))
 (idm181610844160
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>A problem with this code is that the HTTP query kicked off by <code>get_definition</code> is not actually shut down when the timeout fires. As such,\n        <code>get_definition_with_timeout</code> can leak an open connection.\n      Happily, Cohttp does provide a way of shutting down a client. You can pass a deferred under\n      the label <code>interrupt</code> to <code>Cohttp_async.Client.get</code>. Once <code>interrupt</code> is\n      determined, the client connection will be shut down.</blockquote>")))
 (idm181610845904
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>We use <code>&gt;&gt;|</code> above to\n    transform the deferred values we're waiting for so that <code>Deferred.any</code> can choose between values of the\n    same type.</blockquote>")))
 (idm181610850832
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Let's use this to add timeouts to our DuckDuckGo searches. The\n    following code is a wrapper for <code>get_definition</code> that takes a timeout (in the form\n    of a <code>Time.Span.t</code>) and returns either\n    the definition, or, if that takes too long, an error:</blockquote>")))
 (idm181610856832
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Sometimes, however, we want to wait only for the first of multiple\n    events to occur. This happens particularly when dealing with timeouts. In\n    that case, we can use the call <code>Deferred.any</code>, which, given a list of deferreds,\n    returns a single deferred that will become determined once any of the\n    values on the list is determined:</blockquote>")))
 (idm181610872896
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>In a concurrent program, one often needs to combine results from\n    multiple, distinct concurrent subcomputations going on in the same\n    program. We already saw this in our DuckDuckGo example, where we used\n    <code>Deferred.all</code> and <code>Deferred.all_unit</code> to wait for a list of\n    deferreds to become determined. Another useful primitive is <code>Deferred.both</code>, which lets you wait until two\n    deferreds of different types have returned, returning both values as a\n    tuple. Here, we use the function <code>sec</code>,\n    which is shorthand for creating a time-span equal to a given number of\n    seconds:<a name=\"idm181610869488\"></a><a name=\"idm181610868176\"></a><a name=\"idm181610867280\"></a><a name=\"idm181610866384\"></a><a name=\"idm181610865488\"></a></blockquote>")))
 (idm181610877872
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Note that in this code, we're relying on the fact that <code>Cohttp_async.Client.get</code> will clean up after\n      itself after an exception, in particular by closing its file\n      descriptors. If you need to implement such functionality directly, you\n      may want to use the <code>Monitor.protect</code>\n      call, which is analogous to the <code>protect</code> call described in <a href=\"error-handling.html#cleaning-up-in-the-presence-of-exceptions\">the section called â\128\156Cleaning Up in the Presence of Exceptionsâ\128\157</a>.<a name=\"idm181610874848\"></a></blockquote>")))
 (idm181610878864
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Now, only the query that went to <code>localhost</code> failed.</blockquote>")))
 (idm181610894432
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Now, if we run that same query, we'll get individualized handling\n      of the connection failures:</blockquote>")))
 (idm181610898080
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Now we just need to change the code for <code>print_result</code> so that it can handle the new\n      type:</blockquote>")))
 (idm181610899744
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Here, we first use <code>try_with</code> to\n      capture the exception, and then use map (the <code>&gt;&gt;|</code> operator) to convert the error into\n      the form we want: a pair whose first element is the word being searched\n      for, and the second element is the (possibly erroneous) result.</blockquote>")))
 (idm181610904800
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>As you can see, we got a &quot;Connection refused&quot; failure, which ends the entire program,\n        even though one of the two queries would have gone through successfully on its own. We can\n        handle the failures of individual connections separately by using the <code>try_with</code> function within each call to <code>get_definition</code>, as follows:</blockquote>")))
 (idm181610921392
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>In addition, we'll make the necessary changes to get the list of servers on the\n        command-line, and to distribute the search qeuries round-robin across the list of servers.\n        Now, let's see what happens if we rebuild the application and run it giving it a list of\n        servers, some of which won't respond to the query:</blockquote>")))
 (idm181610925120
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>First we'll need to change <code>query_uri</code> to take an argument specifying the\n      server to connect to:</blockquote>")))
 (idm181610925824
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>The search code as it is fails rarely, so let's make a change that\n      allows us to trigger failures more predictably. We'll do this by making\n      it possible to distribute the requests over multiple servers. Then,\n      we'll handle the errors that occur when one of those servers is\n      misspecified.</blockquote>")))
 (idm181610929072
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Let's now go back and improve the exception handling of our DuckDuckGo client. In\n        particular, we'll change it so that any query that fails is reported without preventing\n        other queries from completing.<a name=\"idm181610928592\"></a><a name=\"idm181610927280\"></a></blockquote>")))
 (idm181610933040
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>In practice, you should rarely use monitors directly, and instead use functions like\n          <code>try_with</code> and <code>Monitor.protect</code> that are built on top of monitors. One example of a library\n        that uses monitors directly is <code>Tcp.Server.create</code>, which\n        tracks both exceptions thrown by the logic that handles the network connection and by the\n        callback for responding to an individual request, in either case responding to an exception\n        by closing the connection. It is for building this kind of custom error handling that\n        monitors can be helpful.</blockquote>")))
 (idm181610937184
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>If instead we use <code>Ignore_me</code>, the exception will be ignorred, and the deferred never becomes determined:</blockquote>")))
 (idm181610949040
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>If we pass in an exception other than <code>Ignore_me</code>, like, say, the built-in exception\n      <code>Not_found</code>, then the exception will be\n      passed to the parent monitor and delivered as usual:</blockquote>")))
 (idm181610950304
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Note that we use <code>Monitor.extract_exn</code> to grab the underlying\n      exception that was thrown. Async wraps exceptions it catches with extra\n      information, including the monitor trace, so you need to grab the\n      underlying exception to match on it.</blockquote>")))
 (idm181610965104
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Here's an example of a monitor that passes some exceptions through to the parent and\n        handles others. Exceptions are sent to the parent using <code>Monitor.send_exn</code>, with <code>Monitor.current</code> being\n        called to find the current monitor, which is the parent of the newly created monitor:</blockquote>")))
 (idm181610967472
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>The message &quot;an error happened&quot; is printed out, but the deferred\n      returned by <code>swallow_error</code> is never\n      determined. This makes sense, since the calculation never actually\n      completes, so there's no value to return. You can break out of this in\n      <span><strong>utop</strong></span> by hitting <strong><code>Control+C</code></strong>\n        .</blockquote>")))
 (idm181610974192
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Monitors can do more than just augment the error-trace of an exception. You can also use\n        a monitor to explicitly handle errors delivered to that monitor. The <code>Monitor.errors</code> call is a particularly important one. It detaches\n        the monitor from its parent, handing back the stream of errors that would otherwise have\n        been delivered to the parent monitor. This allows one to do custom handling of errors, which\n        may include reraising errors to the parent. Here is a very simple example of a function that\n        captures and ignores errors in the processes it spawns:</blockquote>")))
 (idm181610975456
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>In addition to the ordinary stack-trace, the exception displays\n      the trace of monitors through which the exception traveled, starting at\n      the one we created, called &quot;blow up monitor.&quot; The other monitors you see\n      come from <span><strong>utop</strong></span>'s special handling of\n      deferreds.</blockquote>")))
 (idm181610993888
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Monitors are arranged in a treeâ\128\148when a new monitor is created\n      (say, using <code>Monitor.create</code>), it is a\n      child of the current monitor. You can explicitly run jobs within a\n      monitor using <code>within</code>, which takes a\n      thunk that returns a nondeferred value, or <code>within'</code>, which takes a thunk that returns a\n      deferred. Here's an example:</blockquote>")))
 (idm181610995936
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>In Async, a monitor is a context that determines what to do when\n      there is an unhandled exception. Every Async job runs within the context\n      of some monitor, which, when the job is running, is referred to as the\n      current monitor. When a new Async job is scheduled, say, using <code>bind</code> or <code>map</code>, it inherits the current monitor of the\n      job that spawned it.</blockquote>")))
 (idm181610999216
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote><code>try_with</code> is a great way of\n      handling exceptions in Async, but it's not the whole story. All of\n      Async's exception-handling mechanisms, <code>try_with</code> included, are built on top of Async's\n      system of <span><em>monitors</em></span>, which are inspired by the\n      error-handling mechanism in Erlang of the same name. Monitors are fairly\n      low-level and are only occasionally used directly, but it's nonetheless\n      worth understanding how they work.<a name=\"idm181610996960\"></a></blockquote>")))
 (idm181611004400
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote><code>try_with f</code> takes as its argument\n    a deferred-returning thunk <code>f</code> and\n    returns a deferred that becomes determined either as <code>Ok</code> of whatever <code>f</code> returned, or <code>Error\n    exn</code> if <code>f</code> threw an exception\n    before its return value became determined.</blockquote>")))
 (idm181611017696
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>We can capture this kind of asynchronous error using the <code>try_with</code> function provided by Async:<a name=\"idm181611016704\"></a></blockquote>")))
 (idm181611019616
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>This didn't work because <code>try/with</code>\n    only captures exceptions that are thrown in the code directly executed\n    within it, while <code>maybe_raise</code> schedules\n    an Async job to run in the future, and it's that job that throws an\n    exception.</blockquote>")))
 (idm181611036416
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>So, how could we capture and handle such an exception? You might try\n    to do this using OCaml's built-in <code>try/with</code> statement, but as you can see that\n    doesn't quite do the trick:</blockquote>")))
 (idm181611038272
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>In <span><strong>utop</strong></span>, the exception thrown by\n    <code>maybe_raise ()</code> terminates the\n    evaluation of just that expression, but in a standalone program, an\n    uncaught exception would bring down the entire process.</blockquote>")))
 (idm181611058176
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Let's get a better sense of how exceptions work in Async by creating an asynchronous\n      computation that (sometimes) fails with an exception. The function <code>maybe_raise</code> <span>blocks for half a second,</span> and then either throws an exception or\n      returns <code>unit</code>, alternating between the two behaviors on subsequent\n      calls:</blockquote>")))
 (idm181611063328
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>When programming with external resources, errors are everywhere:\n    everything from a flaky server to a network outage to exhausting of local\n    resources can lead to a runtime error. When programming in OCaml, some of\n    these errors will show up explicitly in a function's return type, and some\n    of them will show up as exceptions. We covered exception handling in OCaml\n    in <a href=\"error-handling.html#exceptions\">the section called â\128\156Exceptionsâ\128\157</a>, but as we'll see, exception handling in a\n    concurrent program presents some new challenges.<a name=\"idm181611062080\"></a><a name=\"idm181611060768\"></a><a name=\"ALexcept\"></a></blockquote>")))
 (idm181611079184
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>And that's all we need for a simple but usable definition\n      searcher:<a name=\"idm181611078848\"></a></blockquote>")))
 (idm181611082992
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Finally, we create a command-line interface using <code>Command.async_basic</code>:</blockquote>")))
 (idm181611090800
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>The difference is that we both dispatch the query and print out\n      the result in the closure passed to <code>map</code>, rather than wait for all of the results\n      to get back and then print them out together. We use <code>Deferred.all_unit</code>, which takes a list of\n      <code>unit</code> deferreds and returns a single\n      <code>unit</code> deferred that becomes determined\n      when every deferred on the input list is determined. We can see the type\n      of this function in <span><strong>utop</strong></span>:</blockquote>")))
 (idm181611094944
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Note that the list returned by <code>Deferred.all</code> reflects\n        the order of the deferreds passed to it. As such, the definitions will be printed out in the\n        same order that the search words are passed in, no matter what order the queries return in.\n        We could rewrite this code to print out the results as they're received (and thus\n        potentially out of order) as follows:</blockquote>")))
 (idm181611101968
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>We used <code>List.map</code> to call\n      <code>get_definition</code> on each word, and\n      <code>Deferred.all</code> to wait for all the\n      results. Here's the type of <code>Deferred.all</code>:</blockquote>")))
 (idm181611105152
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>The next function dispatches the searches in parallel, waits for\n      the results, and then prints:</blockquote>")))
 (idm181611110640
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>We use the <code>Wrapper</code> module from\n      the <code>textwrap</code> package to do the line\n      wrapping. It may not be obvious that this routine is using Async, but it\n      does: the version of <code>printf</code> that's\n      called here is actually Async's specialized <code>printf</code> that goes through the Async scheduler\n      rather than printing directly. The original definition of <code>printf</code> is shadowed by this new one when you\n      open <code>Async.Std</code>. An important side\n      effect of this is that if you write an Async program and forget to start\n      the scheduler, calls like <code>printf</code>\n      won't actually generate any output!</blockquote>")))
 (idm181611114112
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Running a single search isn't that interesting from a concurrency\n      perspective, so let's write code for dispatching multiple searches in\n      parallel. First, we need code for formatting and printing out the search\n      result:</blockquote>")))
 (idm181611116048
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>In this case, the HTTP body probably isn't very large, so we call\n      <code>Pipe.to_list</code> to collect the strings\n      from the pipe as a single deferred list of strings. We then join those\n      strings using <code>String.concat</code> and pass\n      the result through our parsing function.</blockquote>")))
 (idm181611117904
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>The <code>get</code> call takes as a\n      required argument a URI and returns a deferred value containing a\n      <code>Cohttp.Response.t</code> (which we ignore)\n      and a pipe reader to which the body of the request will be\n      written.</blockquote>")))
 (idm181611126560
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>To better understand what's going on, it's useful to look at the\n      type for <code>Cohttp_async.Client.get</code>,\n      which we can do in <span><strong>utop</strong></span>:</blockquote>")))
 (idm181611134608
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Now let's look at the code for dispatching the search queries over\n      HTTP, using the Cohttp library:<a name=\"idm181611134240\"></a><a name=\"idm181611132944\"></a><a name=\"idm181611132048\"></a><a name=\"idm181611131136\"></a></blockquote>")))
 (idm181611140544
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>We expect the response from DuckDuckGo to come across as a JSON\n      record, which is represented by the <code>Assoc</code> tag in Yojson's JSON variant. We expect\n      the definition itself to come across under either the key &quot;Abstract&quot; or\n      &quot;Definition,&quot; and so the following code looks under both keys, returning\n      the first one for which a nonempty value is defined:</blockquote>")))
 (idm181611145872
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>The HTTP response from DuckDuckGo is in JSON, a common (and\n      thankfully simple) format that is specified in <a href=\"http://www.ietf.org/rfc/rfc4627.txt\" target=\"_top\">RFC4627</a>. We'll parse\n      the JSON data using the Yojson library, which was introduced in <a href=\"handling-json-data.html\">ChapterÂ 15, <i>Handling JSON Data</i></a>.<a name=\"idm181611144208\"></a><a name=\"idm181611142896\"></a><a name=\"idm181611141568\"></a></blockquote>")))
 (idm181611149456
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>A <code>Uri.t</code> is constructed from the\n      <code>Uri.of_string</code> function, and a query\n      parameter <code>q</code> is added with the desired\n      search query. The library takes care of encoding the URI correctly when\n      outputting it in the network protocol.</blockquote>")))
 (idm181611152384
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>We'll need a function for generating the URIs that we're going to\n      use to query the DuckDuckGo servers:</blockquote>")))
 (idm181611157568
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>HTTP URLs, which identify endpoints across the Web, are actually part of a more general\n        family known as Uniform Resource Identifiers (URIs). The full URI specification is defined\n        in <a href=\"http://tools.ietf.org/html/rfc3986\" target=\"_top\">RFC3986</a> and is rather\n        complicated. Luckily, the <code>uri</code> library provides a strongly\n        typed interface that takes care of much of the hassle.<a name=\"idm181611155648\"></a><a name=\"idm181611154752\"></a><a name=\"idm181611153824\"></a></blockquote>")))
 (idm181611158896
  ((file concurrent-programming-with-async.html)
   (html "<blockquote>Now let's dive into the implementation.</blockquote>")))
 (idm181611160432
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>A library for creating HTTP clients and servers. We need Async\n          support, which comes with the <code>cohttp.async</code> package.</blockquote>")))
 (idm181611162912
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>A JSON parsing library that was described in <a href=\"handling-json-data.html\">ChapterÂ 15, <i>Handling JSON Data</i></a>.</blockquote>")))
 (idm181611164944
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>A library for handling URIs, or &quot;Uniform Resource Identifiers,&quot; of which HTTP URLs\n            are an example.</blockquote>")))
 (idm181611166944
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>A library for wrapping long lines. We'll use this for printing\n          out our results.</blockquote>")))
 (idm181611171328
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Our code is going to rely on a number of other libraries, all of\n      which can be installed using OPAM. Refer to <a href=\"http://realworldocaml.org/install\" target=\"_top\">this Real World OCaml page</a>\n    if you need help on the installation. Here's the list of libraries we'll\n    need:<a name=\"ALduckduck\"></a></blockquote>")))
 (idm181611176880
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>DuckDuckGo is a search engine with a freely available search\n    interface. In this section, we'll use Async to write a small command-line\n    utility for querying DuckDuckGo to extract definitions for a collection of\n    terms.<a name=\"idm181611176384\"></a><a name=\"idm181611175488\"></a><a name=\"idm181611174592\"></a><a name=\"idm181611173680\"></a><a name=\"idm181611172352\"></a></blockquote>")))
 (idm181611182448
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>This differs from the ordinary <code>Command.basic</code> call in\n        that the main function must return a <code>Deferred.t</code>, and that\n        the running of the command (using <code>Command.run</code>)\n        automatically starts the Async scheduler, without requiring an explicit call to <code>Scheduler.go</code>.<a name=\"idm181611179392\"></a><a name=\"idm181611178784\"></a></blockquote>")))
 (idm181611191552
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>The command-line parsing for this program is based on the Command library that we\n        introduced in <a href=\"command-line-parsing.html\">ChapterÂ 14, <i>Command-Line Parsing</i></a>. Opening <code>Async.Std</code>, shadows the <code>Command</code> module with\n        an extended version that contains the <code>async_basic</code>\n        call:</blockquote>")))
 (idm181611192896
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Importantly, the deferred returned by <code>Pipe.transfer</code> becomes determined once the\n      reader has been closed and the last element is transferred from the\n      reader to the writer. Once that deferred becomes determined, the server\n      will shut down that client connection. So, when a client disconnects,\n      the rest of the shutdown happens transparently.</blockquote>")))
 (idm181611194896
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>The two pipes being connected are generated by the <code>Reader.pipe</code> and <code>Writer.pipe</code> call respectively. Note that\n      pushback is preserved throughout the process, so that if the writer gets\n      blocked, the writer's pipe will stop pulling data from the reader's\n      pipe, which will prevent the reader from reading in more data.</blockquote>")))
 (idm181611202752
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>In the function <code>run</code>, we're\n      taking advantage of one of the many utility functions provided for pipes\n      in the <code>Pipe</code> module. In particular,\n      we're using <code>Pipe.transfer</code> to set up a\n      process that takes data from a reader-pipe and moves it to a\n      writer-pipe. Here's the type of <code>Pipe.transfer</code>:</blockquote>")))
 (idm181611213456
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>The deferred returned by write completes on its own once the value\n      written into the pipe has been read out:</blockquote>")))
 (idm181611218288
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>If we just try and write to the writer, we'll see that we block indefinitely in <span><strong>utop</strong></span>. You can break out of the wait by hitting\n          <strong><code>Control-C</code></strong>:</blockquote>")))
 (idm181611221792
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote><code>r</code> and <code>w</code> are really\n        just read and write handles to the same underlying object. Note that <code>r</code> and <code>w</code> have weakly\n        polymorphic types, as discussed in <a href=\"a-guided-tour.html#imperative-programming\">the section called â\128\156Imperative Programmingâ\128\157</a>, and so can only\n        contain values of a single, yet-to-be-determined type.</blockquote>")))
 (idm181611226752
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Pipes are created in connected read/write pairs:</blockquote>")))
 (idm181611229824
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>The biggest change in the preceding code is the use of Async's\n      <code>Pipe</code>. A <code>Pipe</code> is an asynchronous communication channel\n      that's used for connecting different parts of your program. You can\n      think of it as a consumer/producer queue that uses deferreds for\n      communicating when the pipe is ready to be read from or written to. Our\n      use of pipes is fairly minimal here, but they are an important part of\n      Async, so it's worth discussing them in some detail.<a name=\"idm181611227776\"></a></blockquote>")))
 (idm181611233264
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Note the use of <code>Deferred.never</code>\n      in the <code>run</code> function. As you might\n      guess from the name, <code>Deferred.never</code>\n      returns a deferred that is never determined. In this case, that\n      indicates that the echo server doesn't ever shut down.<a name=\"idm181611230848\"></a></blockquote>")))
 (idm181611236080
  ((file concurrent-programming-with-async.html)
   (html "<blockquote>The following code does all of this:</blockquote>")))
 (idm181611237424
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Simplify the code using Async's <code>Pipe</code> interface</blockquote>")))
 (idm181611238352
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Add a flag to specify the port to listen on and a flag to make\n          the server echo back the capitalized version of whatever was sent to\n          it</blockquote>")))
 (idm181611239680
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Add a proper command-line interface with <code>Command</code></blockquote>")))
 (idm181611240704
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Let's try to go a little bit farther with our echo server by\n      walking through a few improvements. In particular, we will:</blockquote>")))
 (idm181611242880
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Thus, we got the compilation to go through by explicitly marking\n      in the source that the call to <code>loop_forever</code> never returns.</blockquote>")))
 (idm181611252416
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>We can resolve the error by calling the function <code>never_returns</code>:</blockquote>")))
 (idm181611263552
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>The type <code>never_returns</code> is uninhabited, so a function\n        can't return a value of type <code>never_returns</code>, which means\n        only a function that never returns can have <code>never_returns</code>\n        as its return type! Now, if we rewrite our <code>do_stuff</code>\n        function, we'll get a helpful type error:</blockquote>")))
 (idm181611270768
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>With a name like <code>loop_forever</code>,\n      the meaning is clear enough. But with something like <code>Scheduler.go</code>, the fact that it never returns\n      is less clear, and so we use the type system to make it more explicit by\n      giving it a return type of <code>never_returns</code>. Let's do the same trick with\n      <code>loop_forever</code>:</blockquote>")))
 (idm181611278304
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>This can be surprising when you call a function like this expecting it to return\n          <code>unit</code>. The type-checker won't necessarily complain in such a\n        case:</blockquote>")))
 (idm181611290672
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>You might wonder what's going on with the call to <code>never_returns</code>. <code>never_returns</code> is an idiom\n        that comes from Core that is used to mark functions that don't return. Typically, a function\n        that doesn't return is inferred as having return type <code>'a</code>:<a name=\"idm181611288256\"></a><a name=\"idm181611287360\"></a><a name=\"idm181611286464\"></a><a name=\"idm181611285568\"></a></blockquote>")))
 (idm181611299152
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Now that we have the echo server, we can connect to the echo server\n    using the netcat tool, which is invoked as <code>nc</code>:</blockquote>")))
 (idm181611299744
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>It's worth noting that even though we didn't spend much explicit\n    effort on thinking about multiple clients, this server is able to handle\n    many concurrent clients without further modification.</blockquote>")))
 (idm181611301024
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>One of the most common newbie errors with Async is to forget to run\n    the scheduler. It can be a bewildering mistake, because without the\n    scheduler, your program won't do anything at all; even calls to <code>printf</code> won't reach the terminal.</blockquote>")))
 (idm181611303936
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Finally, we need to initiate the server and start the Async\n    scheduler:</blockquote>")))
 (idm181611305344
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>The most important argument to <code>Tcp.Server.create</code> is the final one, which is the\n    client connection handler. Notably, the preceding code does nothing\n    explicit to close down the client connections when the communication is\n    done. That's because the server will automatically shut down the\n    connection once the deferred returned by the handler becomes\n    determined.</blockquote>")))
 (idm181611309184
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>The result of calling <code>Tcp.Server.create</code> is a <code>Tcp.Server.t</code>, which is a handle to the server that lets you shut\n      the server down. We don't use that functionality here, so we explicitly ignore <code>server</code> to suppress the unused-variables error. We put in a type\n      annotation around the ignored value to make the nature of the value we're ignoring <span>explicit</span>.</blockquote>")))
 (idm181611314880
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote><code>copy_blocks</code> provides the logic\n    for handling a client connection, but we still need to set up a server to\n    receive such connections and dispatch to <code>copy_blocks</code>. For this, we'll use Async's\n    <code>Tcp</code> module, which has a collection of\n    utilities for creating TCP clients and servers:<a name=\"idm181611312560\"></a></blockquote>")))
 (idm181611317488
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>You might also be concerned that the chain of deferreds that is\n    built up as you go through the loop would lead to a memory leak. After\n    all, this code constructs an ever-growing chain of binds, each of which\n    creates a deferred. In this case, however, all of the deferreds should\n    become determined precisely when the final deferred in the chain is\n    determined, in this case, when the <code>Eof</code>\n    condition is hit. Because of this, we could safely replace all of these\n    deferreds with a single deferred. Async has logic to do just this, and so\n    there's no memory leak after all. This is essentially a form of tail-call\n    optimization, lifted to the Async monad.<a name=\"idm181611315904\"></a></blockquote>")))
 (idm181611319568
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>One important aspect of how this is written is that it uses\n    <span><em>pushback</em></span>, which is to say that if the writer can't\n    make progress writing, the reader will stop reading. If you don't\n    implement pushback in your servers, then a stopped client can cause your\n    program to leak memory, since you'll need to allocate space for the data\n    that's been read in but not yet written out.<a name=\"idm181611318512\"></a></blockquote>")))
 (idm181611323312
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Bind is used in the code to sequence the operations: first, we call\n    <code>Reader.read</code> to get a block of input.\n    Then, when that's complete and if a new block was returned, we write that\n    block to the writer. Finally, we wait until the writer's buffers are\n    flushed, waiting on the deferred returned by <code>Writer.flushed</code>, at which point we recurse. If we\n    hit an end-of-file condition, the loop is ended. The deferred returned by\n    a call to <code>copy_blocks</code> becomes\n    determined only once the end-of-file condition is hit.<a name=\"idm181611320608\"></a></blockquote>")))
 (idm181611331088
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>The first step is to create a function that can copy data from an input to an output.\n      Here, we'll use Async's <code>Reader</code> and <code>Writer</code> modules, which provide a convenient abstraction for working with input and\n      output channels:<a name=\"idm181611329296\"></a><a name=\"idm181611328400\"></a><a name=\"idm181611327504\"></a></blockquote>")))
 (idm181611334416
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Now that we have the basics of Async under our belt, let's look at a\n    small standalone Async program. In particular, we'll write an echo server,\n    i.e., a program that accepts connections from clients and spits back\n    whatever is sent to it.<a name=\"echo\"></a><a name=\"ALecho\"></a></blockquote>")))
 (idm181611338336
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>This code isn't particularly long, but it is subtle. In\n      particular, note how the queue of thunks is used to ensure that the\n      enqueued actions are run in order, even if the thunks scheduled by\n      <code>upon</code> are run out of order. This kind\n      of subtlety is typical of code that involves ivars and <code>upon</code>, and because of this, you should stick to\n      the simpler map/bind/return style of working with deferreds when you\n      can.<a name=\"idm181611336336\"></a></blockquote>")))
 (idm181611354656
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Our delayer implementation is organized around a queue of thunks,\n      where every call to <code>schedule</code> adds a\n      thunk to the queue and also schedules a job in the future to grab a\n      thunk off the queue and run it. The waiting will be done using the\n      function <code>after</code>, which takes a time\n      span and returns a deferred which becomes determined after that time\n      span elapses:</blockquote>")))
 (idm181611357152
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Like <code>bind</code> and <code>return</code>, <code>upon</code> schedules a callback to be executed when\n      the deferred it is passed is determined; but unlike those calls, it\n      doesn't create a new deferred for this callback to fill.</blockquote>")))
 (idm181611365376
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>An action is handed to <code>schedule</code>\n      in the form of a deferred-returning thunk (a thunk is a function whose\n      argument is of type <code>unit</code>). A deferred\n      is handed back to the caller of <code>schedule</code> that will eventually be filled with\n      the contents of the deferred value returned by the thunk. To implement\n      this, we'll use an operator called <code>upon</code>, which has the following\n      signature:<a name=\"idm181611362224\"></a></blockquote>")))
 (idm181611376176
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>As an example, imagine we wanted a way of scheduling a sequence of\n      actions that would run after a fixed delay. In addition, we'd like to\n      guarantee that these delayed actions are executed in the same order they\n      were scheduled in. Here's a reasonable signature that captures this\n      idea:</blockquote>")))
 (idm181611378016
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Ivars are something of a low-level feature; operators like <code>map</code>,\n          <code>bind</code> and <code>return</code> are typically easier to use and\n        think about. But ivars can be useful when you want to build a synchronization pattern that\n        isn't already well supported.</blockquote>")))
 (idm181611391888
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>There are three fundamental operations for working with an ivar:\n      you can create one, using <code>Ivar.create</code>; you can read off the deferred\n      that corresponds to the ivar in question, using <code>Ivar.read</code>; and you can fill an ivar, thus\n      causing the corresponding deferred to become determined, using <code>Ivar.fill</code>. These operations are\n      illustrated below:</blockquote>")))
 (idm181611397168
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Deferreds are usually built using combinations of <code>bind</code>, <code>map</code> and <code>return</code>, but sometimes you want to construct a deferred that you can determine\n        explicitly with usercode. This is done using an <span><em>ivar</em></span>. (The term ivar\n        dates back to a language called Concurrent ML that was developed by John Reppy in the early\n        '90s. The &quot;i&quot; in ivar stands for incremental.)<a name=\"idm181611394208\"></a><a name=\"idm181611393312\"></a></blockquote>")))
 (idm181611399888
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Note that <code>count_lines</code> returns a\n    deferred, but <span><strong>utop</strong></span> waits for that\n    deferred to become determined, and shows us the contents of the deferred\n    instead.</blockquote>")))
 (idm181611409952
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>and comes with its own infix equivalent, <code>&gt;&gt;|</code>. Using it, we can rewrite <code>count_lines</code> again a bit more succinctly:</blockquote>")))
 (idm181611416464
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Calling <code>bind</code> and <code>return</code> together is a fairly common pattern, and\n    as such there is a standard shortcut for it called <code>Deferred.map</code>, which has the following\n    signature:</blockquote>")))
 (idm181611420192
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Together, <code>bind</code> and <code>return</code> form a design pattern in functional\n    programming known as a <span><em>monad</em></span>. You'll run across this\n    signature in many applications beyond just threads. Indeed, we already ran\n    across monads in <a href=\"error-handling.html#bind-and-other-error-handling-idioms\">the section called â\128\156bind and Other Error Handling Idiomsâ\128\157</a>.<a name=\"idm181611417488\"></a></blockquote>")))
 (idm181611428512
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Using <code>return</code>, we can make\n    <code>count_lines</code> compile:</blockquote>")))
 (idm181611438832
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>This looks reasonable enough, but as you can see, the compiler is unhappy. The issue here\n      is that <code>bind</code> expects a function that returns a deferred, but we've provided\n      it a function that returns the nondeferred result directly. To make these signatures match, we\n      need a function for taking an ordinary value and wrapping it in a deferred. This function is a\n      standard part of Async and is called <code>return</code>:<a name=\"idm181611437104\"></a></blockquote>")))
 (idm181611447632
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Now let's look at another potential use of <code>bind</code>. In this case, we'll\n      write a function that counts the number of lines in a file:</blockquote>")))
 (idm181611449568
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>In the preceding code, we've dropped the parentheses around the function on the righthand\n      side of the bind, and we didn't add a level of indentation for the contents of that function.\n      This is standard practice for using the <code>bind</code> operator.<a name=\"idm181611448656\"></a></blockquote>")))
 (idm181611459328
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Writing out <code>Deferred.bind</code>\n    explicitly can be rather verbose, and so <code>Async.Std</code> includes an infix operator for it:\n    <code>&gt;&gt;=</code>. Using this operator, we can\n    rewrite <code>uppercase_file</code> as\n    follows:</blockquote>")))
 (idm181611470496
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Here's a simple use of <code>bind</code> for a function that replaces a file with an\n      uppercase version of its contents:</blockquote>")))
 (idm181611474096
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>At a more concrete level, the call to <code>Deferred.bind</code> returns a new deferred that\n    becomes determined when the deferred returned by <code>f</code> is determined. It also implicitly registers\n    with the scheduler an <span><em>Async job</em></span> that is responsible\n    for running <code>f</code> once <code>d</code> is determined.</blockquote>")))
 (idm181611479952
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote><code>Deferred.bind d f</code> takes a\n    deferred value <code>d</code> and a function\n    <code>f</code> that is to be run with the value of\n    <code>d</code> once it's determined. You can think\n    of <code>Deferred.bind</code> as a kind of\n    sequencing operator, and what we're doing is essentially taking an\n    asynchronous computation <code>d</code> and tacking\n    on another stage comprised by the actions of the function <code>f</code>.<a name=\"idm181611475120\"></a></blockquote>")))
 (idm181611485648
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>In order to do real work with deferreds, we need a way of waiting for a deferred\n      computation to finish, which we do using <code>Deferred.bind</code>.\n      First, let's consider the type-signature of <code>bind</code>:</blockquote>")))
 (idm181611490656
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>If we peek again, we'll see that the value of <code>contents</code> has been determined:</blockquote>")))
 (idm181611498048
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>The value in <code>contents</code> isn't yet determined partly\n      because nothing running could do the necessary I/O. When using Async, processing of I/O and\n      other events is handled by the Async scheduler. When writing a standalone program, you need to\n      start the scheduler explicitly, but <span><strong>utop</strong></span> knows about Async\n      and can start the scheduler automatically. More than that, <span><strong>utop</strong></span> knows about deferred values, and when you type in an expression of type\n        <code>Deferred.t</code>, it will make sure the scheduler is running\n      and block until the deferred is determined. Thus, we can write:</blockquote>")))
 (idm181611506688
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>A deferred is essentially a handle to a value that may be computed\n    in the future. As such, if we call <code>Reader.file_contents</code>, the resulting deferred\n    will initially be empty, as you can see by calling <code>Deferred.peek</code> on the resulting\n    deferred:<a name=\"idm181611504896\"></a></blockquote>")))
 (idm181611509952
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>We first load the Async package in the toplevel using <code>#require</code>, and then open <code>Async.Std</code>, which adds a number of new\n    identifiers and modules into our environment that make using Async more\n    convenient. Opening <code>Async.Std</code> is\n    standard practice for writing programs using Async, much like opening\n    <code>Core.Std</code> is for using Core.</blockquote>")))
 (idm181611519104
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>In Async, well-behaved functions never block. Instead, they return a\n    value of type <code>Deferred.t</code> that acts as a\n    placeholder that will eventually be filled in with the result. As an\n    example, consider the signature of the Async equivalent of <code>In_channel.read_all</code>:<a name=\"idm181611517296\"></a></blockquote>")))
 (idm181611521344
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>From the type of <code>In_channel.read_all</code>, you can see that it must be\n    a blocking operation. In particular, the fact that it returns a concrete\n    string means it can't return until the read has completed. The blocking\n    nature of the call means that no progress can be made on anything else\n    until the read is completed.<a name=\"idm181611520128\"></a></blockquote>")))
 (idm181611530960
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Recall how I/O is typically done in Core. Here's a simple\n    example:<a name=\"ALbas\"></a></blockquote>")))
 (idm181611533840
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>This chapter covers the Async library, which offers a hybrid model\n  that aims to provide the best of both worlds, avoiding the performance\n  compromises and synchronization woes of preemptive threads without the\n  confusing inversion of control that usually comes with event-driven\n  systems.<a name=\"idm181611533280\"></a></blockquote>")))
 (idm181611534624
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Single-threaded event-driven systems, on the other hand, execute a\n  single task at a time and do not require the same kind of complex\n  synchronization that preemptive threads do. However, the inverted control\n  structure of an event-driven program often means that your own control flow\n  has to be threaded awkwardly through the system's event loop, leading to a\n  maze of event callbacks.</blockquote>")))
 (idm181611535360
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Each of these mechanisms has its own trade-offs. System threads\n  require significant memory and other resources per thread. Also, the\n  operating system can arbitrarily interleave the execution of system threads,\n  requiring the programmer to carefully protect shared resources with locks\n  and condition variables, which is exceedingly error-prone.</blockquote>")))
 (idm181611538720
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>Another approach is to have a single-threaded program, where that single thread runs an\n      <span><em>event loop</em></span> whose job is to react to external events like timeouts or\n    mouse clicks by invoking a callback function that has been registered for that purpose. This\n    approach shows up in languages like JavaScript that have single-threaded runtimes, as well as in\n    many GUI toolkits.<a name=\"idm181611537680\"></a><a name=\"idm181611536784\"></a></blockquote>")))
 (idm181611540736
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>One approach to concurrency is to use preemptive system threads, which\n  is the dominant approach in languages like Java or C#. In this model, each\n  task that may require simultaneous waiting is given an operating system\n  thread of its own so it can block without stopping the entire\n  program.<a name=\"idm181611540176\"></a></blockquote>")))
 (idm181611545536
  ((file concurrent-programming-with-async.html)
   (html
    "<blockquote>The logic of building programs that interact with the outside world is often dominated by\n    waiting: waiting for the click of a mouse, or for data to be fetched from disk, or for space to\n    be available on an outgoing network buffer. Even mildly sophisticated interactive applications\n    are typically <span><em>concurrent</em></span>: needing to wait for multiple different events at\n    the same time, responding immediately to whatever event happens first.<a name=\"idm181611544432\"></a><a name=\"idm181611543104\"></a><a name=\"idm181611542192\"></a></blockquote>")))
 (idm181612751824
  ((file command-line-parsing.html)
   (html
    "<blockquote>Cmdliner is a mix between the Command and Getopt libraries. It\n          allows for the declarative definition of command-line interfaces but\n          exposes a more <code>getopt</code>-like\n          interface. It also automates the generation of UNIX man pages as\n          part of the specification. Cmdliner is the parser used by OPAM to\n          manage its command line.</blockquote>")))
 (idm181612755808
  ((file command-line-parsing.html)
   (html
    "<blockquote><code>ocaml-getopt</code> provides the general\n          command-line syntax of GNU <code>getopt</code>\n          and <code>getopt_long</code>. The GNU conventions are\n          widely used in the open source world, and this library lets your\n          OCaml programs obey the same rules.</blockquote>")))
 (idm181612758672
  ((file command-line-parsing.html)
   (html
    "<blockquote>You can use the <code>Command.Spec.flags_of_args_exn</code> function to\n          convert Arg specifications into ones compatible with Command. This\n          is quite often used to help port older non-Core code into the Core\n          standard library world.</blockquote>")))
 (idm181612760512
  ((file command-line-parsing.html)
   (html
    "<blockquote>The<code> Arg</code> module is from the OCaml standard\n          library, which is used by the compiler itself to handle its\n          command-line interface. Command is generally more featureful than\n          Arg (mainly via support for subcommands, the <code>step</code> combinator to transform inputs, and\n          help generation), but there's absolutely nothing wrong with using\n          Arg either.</blockquote>")))
 (idm181612768256
  ((file command-line-parsing.html)
   (html
    "<blockquote>This rounds up our tour of the Command library. This isn't the only\n    way to parse command-line arguments of course; there are several\n    alternatives available on OPAM. Three of the most prominent ones\n    follow:<a name=\"idm181612767776\"></a><a name=\"idm181612766880\"></a><a name=\"idm181612765584\"></a><a name=\"idm181612764688\"></a><a name=\"idm181612763360\"></a></blockquote>")))
 (idm181612770144
  ((file command-line-parsing.html)
   (html
    "<blockquote>It will help to check out how other applications install\n        tab-completion scripts and follow their lead, as the details are very\n        OS-specific.</blockquote>")))
 (idm181612771472
  ((file command-line-parsing.html)
   (html
    "<blockquote>Sadly, <span><strong>bash</strong></span> doesn't support\n        installing a generic handler for all Command-based applications. This\n        means you have to install the completion script for every application,\n        but you should be able to automate this in the build and packaging\n        system for your application.</blockquote>")))
 (idm181612774352
  ((file command-line-parsing.html)
   (html
    "<blockquote>Command completion support works for flags and grouped commands\n      and is very useful when building larger command-line interfaces. Don't\n      forget to install the shell fragment into your global <code>bash_completion.d</code> directory if you want it to\n      be loaded in all of your login shells.<a name=\"idm181612773200\"></a></blockquote>")))
 (idm181612781088
  ((file command-line-parsing.html)
   (html
    "<blockquote>You don't need to worry about what the preceding output script\n      actually does (unless you have an unhealthy fascination with shell\n      scripting internals, that is). Instead, redirect the output to a file in\n      your current directory and source it into your current shell:</blockquote>")))
 (idm181612783392
  ((file command-line-parsing.html)
   (html
    "<blockquote>Recall that we used the <code>Arg_type.file</code> to specify the argument type.\n      This also supplies the completion logic so that you can just press Tab\n      to complete files in your current directory.</blockquote>")))
 (idm181612791712
  ((file command-line-parsing.html)
   (html
    "<blockquote>For example, let's try it on our MD5 example from earlier,\n      assuming that the binary is called <span><strong>basic_md5_with_flags</strong></span> in the current\n      directory:</blockquote>")))
 (idm181612792896
  ((file command-line-parsing.html)
   (html
    "<blockquote>The Command library has a declarative description of all the\n      possible valid options, and it can use this information to generate a\n      shell script that provides completion support for that command. To\n      generate the fragment, just run the command with the\n      <code>COMMAND_OUTPUT_INSTALLATION_BASH</code> environment variable set\n      to any value.</blockquote>")))
 (idm181612796528
  ((file command-line-parsing.html)
   (html
    "<blockquote>One last bit of information you'll need to find is the location of\n    the <code>bash_completion.d</code> directory. This\n    is where all the shell fragments that contain the completion logic are\n    held. On Linux, this is often in <code>/etc/bash_completion.d</code>, and in Homebrew on Mac\n    OS X, it would be <code>/usr/local/etc/bash_completion.d</code> by\n    default.</blockquote>")))
 (idm181612798784
  ((file command-line-parsing.html)
   (html
    "<blockquote>Once <span><em>bash</em></span> completion is installed and\n    configured, check that it works by typing the <code>ssh</code> command and pressing the Tab key. This\n    should show you the list of known hosts from your\n    <span><em>~/.ssh/known_hosts</em></span> file. If it lists some hosts that\n    you've recently connected to, you can continue on. If it lists the files\n    in your current directory instead, then check your OS documentation to\n    configure completion correctly.</blockquote>")))
 (idm181612810416
  ((file command-line-parsing.html)
   (html
    "<blockquote>Bash autocompletion isn't always installed by default, so check your\n    OS package manager to see if you have it available.</blockquote>")))
 (idm181612813376
  ((file command-line-parsing.html)
   (html
    "<blockquote>The precise mechanism for autocompletion varies depending on what\n    shell you are using, but we'll assume you are using the most common one:\n    <span><strong>bash</strong></span>. This is the default interactive\n    shell on most Linux distributions and Mac OS X, but you may need to switch\n    to it on *BSD or Windows (when using Cygwin). The rest of this section\n    assumes that you're using <span><strong>bash</strong></span>.<a name=\"idm181612811456\"></a></blockquote>")))
 (idm181612817696
  ((file command-line-parsing.html)
   (html
    "<blockquote>Modern UNIX shells usually have a tab-completion feature to\n    interactively help you figure out how to build a command line. These work\n    by pressing the Tab key in the middle of typing a command, and seeing the\n    options that pop up. You've probably used this most often to find the\n    files in the current directory, but it can actually be extended for other\n    parts of the command, too.<a name=\"idm181612817440\"></a><a name=\"idm181612815728\"></a><a name=\"idm181612814832\"></a></blockquote>")))
 (idm181612821440
  ((file command-line-parsing.html)
   (html
    "<blockquote>Labeled arguments are more verbose but can also help prevent\n      errors with command-line arguments with similar types but different\n      names and purposes. It's good form to use labels when you have a lot of\n      otherwise anonymous <code>int</code> and <code>string</code> arguments.<a name=\"idm181612819648\"></a></blockquote>")))
 (idm181612825872
  ((file command-line-parsing.html)
   (html
    "<blockquote>This <code>cal_add_labels</code> example goes back to our\n        noninteractive calendar addition program, but the <code>add_days</code> main function now expects labeled arguments. The <code>step</code>\n<span>function</span> in the specification simply converts the\n        default <code>base</code> and <code>days</code>\n        arguments into a labeled function.</blockquote>")))
 (idm181612833376
  ((file command-line-parsing.html)
   (html
    "<blockquote>The <code>step</code> chaining lets you\n      control the types of your callbacks very easily. This can help you match\n      existing interfaces or make things more explicit by adding labeled\n      arguments:<a name=\"idm181612832288\"></a><a name=\"idm181612831408\"></a><a name=\"idm181612830096\"></a></blockquote>")))
 (idm181612837024
  ((file command-line-parsing.html)
   (html
    "<blockquote>The first half of the <code>Spec.t</code>\n      shows that the callback type is <code>Date.t -&gt;\n      int</code>, whereas the resulting value expected from the next\n      specification in the chain is a <code>Date.t -&gt;\n      int option</code>.</blockquote>")))
 (idm181612850656
  ((file command-line-parsing.html)
   (html
    "<blockquote>The transformation means that the <code>add_days</code> callback can just keep its original\n      definition of <code>Date.t -&gt; int -&gt;\n      unit</code>. The <code>step</code> function\n      transformed the <code>int option</code> argument\n      from the parsing into an <code>int</code> suitable\n      for <code>add_days</code>. This transformation is\n      explicitly represented in the type of the <code>step</code> return value:</blockquote>")))
 (idm181612860800
  ((file command-line-parsing.html)
   (html
    "<blockquote>The first <code>m</code> argument to the\n      <code>step</code> callback is the next callback\n      function in the chain. The transformation is completed by calling\n      <code>m base days</code> to continue processing\n      with the new values we've just calculated. The <code>days</code> value that is passed onto the next\n      callback now has a nonoptional <code>int</code>\n      type:</blockquote>")))
 (idm181612863952
  ((file command-line-parsing.html)
   (html
    "<blockquote>The <code>days</code> anonymous argument is\n      now an optional integer in the spec, and we want to transform it into a\n      nonoptional value before calling our <code>add_days</code> callback. The <code>step</code> combinator lets us perform this\n      transformation by applying its supplied callback function first. In the\n      example, the callback first checks if <code>days</code> is defined. If it's undefined, then it\n      interactively reads an integer from the standard input.</blockquote>")))
 (idm181612870720
  ((file command-line-parsing.html)
   (html
    "<blockquote>This program requires you to specify both the <code>base</code> date and the number of <code>days</code> to add onto it. If <code>days</code> isn't supplied on the command line, an\n      error is output. Now let's modify it to interactively prompt for a\n      number of days if only the <code>base</code> date\n      is supplied:</blockquote>")))
 (idm181612875712
  ((file command-line-parsing.html)
   (html
    "<blockquote>The <code>step</code> combinator lets you\n      control the normal course of parsing by supplying a function that maps\n      callback arguments to a new set of values. For instance, let's revisit\n      our first calendar application that added a number of days onto a\n      supplied base date:<a name=\"idm181612874512\"></a></blockquote>")))
 (idm181612878848
  ((file command-line-parsing.html)
   (html
    "<blockquote>While this does look scary, the key line to scan is the last one,\n      where it's telling you that you have supplied too many arguments in the\n      callback function (<code>unit -&gt; unit</code>\n      versus <code>unit</code>). If you started with a\n      working program and made this single change, you typically don't even\n      need to read the type error, as the filename and location information is\n      sufficient to make the obvious fix.</blockquote>")))
 (idm181612888048
  ((file command-line-parsing.html)
   (html
    "<blockquote>For example, if we remove the <code>verbose</code> flag and recompile, we'll get this\n      impressively long type error:</blockquote>")))
 (idm181612893808
  ((file command-line-parsing.html)
   (html
    "<blockquote>Both of these flags will now be applied and passed to all the\n      callback functions. This makes code refactoring a breeze by using the\n      compiler to spot places where you use commands. Just add a parameter to\n      the common definition, run the compiler, and fix type errors until\n      everything works again.<a name=\"idm181612889040\"></a></blockquote>")))
 (idm181612893536
  ((file command-line-parsing.html)
   (html
    "<blockquote>The definitions of the specifications are very similar to the\n      earlier example, except that they append a <code>common</code> parameter after each specification. We\n      can supply these flags when defining the groups.</blockquote>")))
 (idm181612897136
  ((file command-line-parsing.html)
   (html
    "<blockquote>If you want to factor out common command-line operations, the\n      <code>++</code> operator will append two\n      specifications together. Let's add some dummy verbosity and debug flags\n      to our calendar application to illustrate this.</blockquote>")))
 (idm181612903360
  ((file command-line-parsing.html)
   (html
    "<blockquote>The parameters to <code>Spec.t</code> are important here. They\n        show that the callback function for a spec should consume identical arguments to the\n        supplied <code>main</code> function, except for an additional <code>unit</code> argument. This final <code>unit</code> is there to make sure the callback is evaluated as a function, since if\n        zero command-line arguments are specified (i.e., <span><code>Spec.empty</code></span>), the callback would otherwise have no\n        arguments and be evaluated immediately. That's why you have to supply an additional <code>()</code> to the callback function in all the previous examples.</blockquote>")))
 (idm181612910320
  ((file command-line-parsing.html)
   (html
    "<blockquote>The type of <code>Command.basic</code>\n      should make more sense now:</blockquote>")))
 (idm181612914992
  ((file command-line-parsing.html)
   (html
    "<blockquote>The empty specification is simple, as it doesn't add any\n      parameters to the callback type. The second example adds an <code>int</code> anonymous parameter that is reflected in\n      the inferred type. One forms a command by combining a spec of type\n      <code>('main, unit) Spec.t</code> with a function\n      of type <code>'main</code>. The combinators we've\n      shown so far incrementally build the type of <code>'main</code> according to the command-line parameters\n      it expects, so the resulting type of <code>'main</code> is something like <code>arg1 -&gt; ... -&gt; argN -&gt; unit</code>.</blockquote>")))
 (idm181612922768
  ((file command-line-parsing.html)
   (html
    "<blockquote>Such a value transforms a main function of type <code>arg1 -&gt; ... -&gt; argN -&gt; 'r</code> by\n      supplying all the argument values, leaving a main function that returns\n      a value of type <code>'r</code>. Let's look at\n      some examples of specs, and their types:</blockquote>")))
 (idm181612925920
  ((file command-line-parsing.html)
   (html
    "<blockquote>The type of a specification transforms a <code>'a</code> to a <code>'b</code>\n      value. For instance, a value of <code>Spec.t</code> might have type <code>(arg1 -&gt; ... -&gt; argN -&gt; 'r, 'r)\n      Spec.t</code>.</blockquote>")))
 (idm181612926608
  ((file command-line-parsing.html)
   (html
    "<blockquote>How to autocomplete a partial command line</blockquote>")))
 (idm181612927424
  ((file command-line-parsing.html)
   (html "<blockquote>What the command does and how to call it</blockquote>")))
 (idm181612928224
  ((file command-line-parsing.html)
   (html "<blockquote>How to parse the command line</blockquote>")))
 (idm181612931872
  ((file command-line-parsing.html)
   (html
    "<blockquote>The <code>Command.Spec.t</code> type looks\n      deceptively simple: <code>('a, 'b) t</code>. You\n      can think of <code>('a, 'b) t</code> here as a\n      function of type <code>'a -&gt; 'b</code>, but\n      embellished with information about:</blockquote>")))
 (idm181612935808
  ((file command-line-parsing.html)
   (html
    "<blockquote>The Command module's safety relies on the specification's output\n      values precisely matching the callback function which invokes the main\n      program. In order to prevent any such mismatches, Command uses some\n      interesting type machinery to guarantee they remain in sync. You don't\n      have to understand this section to use the more advanced combinators,\n      but it'll help you debug type errors as you use Command more.<a name=\"idm181612935104\"></a><a name=\"idm181612934192\"></a><a name=\"idm181612932896\"></a></blockquote>")))
 (idm181612937312
  ((file command-line-parsing.html)
   (html
    "<blockquote>In the following sections we'll explain the logic behind the\n    combinators we've already described and show you some new combinators that\n    let you use Command even more effectively.</blockquote>")))
 (idm181612938160
  ((file command-line-parsing.html)
   (html
    "<blockquote>Understanding the details of how these specifications fit together\n    becomes more useful as your command-line interfaces get more complex. In\n    particular, you may want to factor out common functionality between\n    specifications or interrupt the parsing to perform special processing,\n    such as requesting an interactive passphrase from the user before\n    proceeding. All of this is helped by a deeper understanding of the Command\n    library.</blockquote>")))
 (idm181612940352
  ((file command-line-parsing.html)
   (html
    "<blockquote>The functions for generating a specification may seem like magic. In\n    particular, even if you know how to use them, it's not entirely clear how\n    they work, and in particular, why the types work out the way they\n    do.<a name=\"CLPadv\"></a></blockquote>")))
 (idm181612947504
  ((file command-line-parsing.html)
   (html
    "<blockquote>We can invoke the two commands we just defined to verify that they\n    work and see the date parsing in action:</blockquote>")))
 (idm181612963840
  ((file command-line-parsing.html)
   (html
    "<blockquote>And that's all you really need to add subcommand support! Let's\n    build the example first in the usual way and inspect the help output,\n    which now reflects the subcommands we just added.</blockquote>")))
 (idm181612963568
  ((file command-line-parsing.html)
   (html
    "<blockquote>Everything in this command should be familiar to you by now. Once\n    you've tested it and made sure it works, we can define another new command\n    that takes the difference of two dates. However, instead of creating a new\n    binary, we group both operations as subcommands using <code>Command.group</code>:</blockquote>")))
 (idm181612966528
  ((file command-line-parsing.html)
   (html
    "<blockquote>Let's build the outline of a calendar tool that does a few\n    operations over dates from the command line. We first need to define a\n    command that adds days to an input date and prints the resulting\n    date:</blockquote>")))
 (idm181612968384
  ((file command-line-parsing.html)
   (html
    "<blockquote>The <code>group</code> signature accepts a\n    list of basic <code>Command.t</code> values and\n    their corresponding names. When executed, it looks for the appropriate\n    subcommand from the name list, and dispatches it to the right command\n    handler.</blockquote>")))
 (idm181612980192
  ((file command-line-parsing.html)
   (html
    "<blockquote>This usually only becomes a concern when your application\n    organically grows features. Luckily, it's simple to extend your\n    application to do this in Command: just swap the <code>Command.basic</code> for <code>Command.group</code>, which takes an association list\n    of specifications and handles the subcommand parsing and help output for\n    you:<a name=\"idm181612978320\"></a></blockquote>")))
 (idm181612984560
  ((file command-line-parsing.html)
   (html
    "<blockquote>The <code>config</code>, <code>remote</code>, and <code>install</code> keywords form a logical grouping of\n    commands that factor out a set of flags and arguments. This lets you\n    prevent flags that are specific to a particular subcommand from leaking\n    into the general configuration space.<a name=\"idm181612982112\"></a><a name=\"idm181612981216\"></a></blockquote>")))
 (idm181612991696
  ((file command-line-parsing.html)
   (html
    "<blockquote>You'll have run across this style already when using the OPAM\n    package manager (or, in the non-OCaml world, the Git or Mercurial\n    commands). OPAM exposes commands in this form:</blockquote>")))
 (idm181612995600
  ((file command-line-parsing.html)
   (html
    "<blockquote>You can get pretty far by using flags and anonymous arguments to\n    assemble complex, command-line interfaces. After a while, though, too many\n    options can make the program very confusing for newcomers to your\n    application. One way to solve this is by grouping common operations\n    together and adding some hierarchy to the command-line\n    interface.<a name=\"idm181612994976\"></a><a name=\"idm181612994064\"></a><a name=\"idm181612993152\"></a></blockquote>")))
 (idm181612997296
  ((file command-line-parsing.html)
   (html
    "<blockquote>The flags affect the type of the callback function in exactly the\n    same way as anonymous arguments do. This lets you change the specification\n    and ensure that all the callback functions are updated appropriately,\n    without runtime errors.</blockquote>")))
 (idm181613018128
  ((file command-line-parsing.html)
   (html
    "<blockquote>The <code>-s</code> flag in our specification\n    requires a <code>string</code> argument and isn't\n    optional. The Command parser outputs an error message if the flag isn't\n    supplied, as with the anonymous arguments in earlier examples. <a href=\"command-line-parsing.html#table14-2\">TableÂ 14.2, â\128\156Flag functionsâ\128\157</a> contains a list of some of the functions that you\n    can wrap flags in to control how they are parsed.<a name=\"idm181613015760\"></a></blockquote>")))
 (idm181613035104
  ((file command-line-parsing.html)
   (html
    "<blockquote>The specification now uses the <code>flag</code> function to define the two new labeled,\n    command-line arguments. The <code>doc</code> string\n    is formatted so that the first word is the short name that appears in the\n    usage text, with the remainder being the full help text. Notice that the\n    <code>-t</code> flag has no\n    argument, and so we prepend its <code>doc</code>\n    text with a blank space. The help text for the preceding code looks like\n    this:</blockquote>")))
 (idm181613040384
  ((file command-line-parsing.html)
   (html
    "<blockquote>Let's add two arguments to our <code>md5</code> command that mimics the Mac OS X version. A\n    <code>-s</code> flag specifies\n    the string to be hashed directly on the command line and <code>-t</code> runs a self-test. The complete example\n    follows:</blockquote>")))
 (idm181613043472
  ((file command-line-parsing.html)
   (html
    "<blockquote>You aren't just limited to anonymous arguments on the command line.\n    A <span><em>flag</em></span> is a named field that can be followed by an\n    optional argument. These flags can appear in any order on the command\n    line, or multiple times, depending on how they're declared in the\n    specification.<a name=\"idm181613042736\"></a><a name=\"idm181613041840\"></a></blockquote>")))
 (idm181613048544
  ((file command-line-parsing.html)
   (html
    "<blockquote>The callback function is a little more complex now, to handle the\n      extra options. The <code>files</code> are now a\n      <code>string list</code>, and an empty list\n      reverts to using standard input, just as our previous <code>maybe</code> and <code>maybe_with_default</code> examples did. If the list\n      of files isn't empty, then it opens up each file and runs them through\n      <code>do_hash</code> sequentially.</blockquote>")))
 (idm181613053712
  ((file command-line-parsing.html)
   (html
    "<blockquote>One last transformation that's useful is to obtain lists of\n      anonymous arguments rather than a single one. As an example, let's\n      modify our MD5 code to take a collection of files to process on the\n      command line:<a name=\"idm181613053216\"></a></blockquote>")))
 (idm181613060880
  ((file command-line-parsing.html)
   (html
    "<blockquote>Building and running both against a system file confirms that they\n      have the same behavior:</blockquote>")))
 (idm181613064960
  ((file command-line-parsing.html)
   (html
    "<blockquote>The following example behaves exactly the same as the previous\n      example, but replaces <code>maybe</code> with\n      <code>maybe_with_default</code>:</blockquote>")))
 (idm181613066304
  ((file command-line-parsing.html)
   (html
    "<blockquote>Another possible way to handle this would be to supply a dash as\n      the default filename if one isn't specified. The <code>maybe_with_default</code> function can do just this,\n      with the benefit of not having to change the callback parameter type\n      (which may be a problem in more complex applications).</blockquote>")))
 (idm181613069456
  ((file command-line-parsing.html)
   (html
    "<blockquote>The <code>filename</code> parameter to\n      <code>do_hash</code> is now a <code>string option</code> type. This is resolved into an\n      input channel via <code>get_inchan</code> to\n      determine whether to open the standard input or a file, and then the\n      rest of the command is similar to our previous examples.</blockquote>")))
 (idm181613073696
  ((file command-line-parsing.html)
   (html
    "<blockquote>This is because changing the argument type has also changed the\n      type of the callback function. It now wants a <code>string option</code> instead of a <code>string</code>, since the value has become optional.\n      We can adapt our example to use the new information and read from\n      standard input if no file is specified:</blockquote>")))
 (idm181613081920
  ((file command-line-parsing.html)
   (html
    "<blockquote>This just wraps the <code>filename</code>\n      argument declaration in the <code>maybe</code>\n      function to mark it as an optional argument. However, building this\n      results in a compile-time error:</blockquote>")))
 (idm181613091408
  ((file command-line-parsing.html)
   (html
    "<blockquote>A more realistic MD5 binary could also read from the standard\n      input if a <code>filename</code> isn't\n      specified:<a name=\"idm181613090400\"></a><a name=\"idm181613089088\"></a><a name=\"idm181613088176\"></a><a name=\"idm181613086608\"></a></blockquote>")))
 (idm181613100544
  ((file command-line-parsing.html)
   (html
    "<blockquote>The <code>regular_file</code> function\n      transforms a <code>filename</code> string\n      parameter into the same string but first checks that the file exists and\n      is a regular file type. When you build and run this code, you will see\n      the new error messages if you try to open a special device such as\n      <code>/dev/null</code>:</blockquote>")))
 (idm181613105488
  ((file command-line-parsing.html)
   (html
    "<blockquote>We can also define our own argument types if the predefined ones\n      aren't sufficient. For instance, let's make a <code>regular_file</code> argument type that ensures that\n      the input file isn't a character device or some other odd UNIX file type\n      that can't be fully read:<a name=\"idm181613104320\"></a></blockquote>")))
 (idm181613114720
  ((file command-line-parsing.html)
   (html
    "<blockquote>Running this with a nonexistent filename will now output an error if\n    the file doesn't exist. As a bonus, it also enables interactive\n    command-line completion to work on the filename argument (explained later\n    in the chapter):</blockquote>")))
 (idm181613119120
  ((file command-line-parsing.html)
   (html
    "<blockquote>We can tighten up the specification of the command to <code>file</code> to reflect that the argument must be a\n    valid filename, and not just any string:</blockquote>")))
 (idm181613147904
  ((file command-line-parsing.html)
   (html
    "<blockquote>You aren't just limited to parsing command lines as strings, of\n    course. <code>Command.Spec</code> defines several\n    other conversion functions (shown in <a href=\"command-line-parsing.html#table14_1\">TableÂ 14.1, â\128\156Conversion functions defined by\n      <code>Command.spec</code>â\128\157</a>) that\n    validate and parse input into various types.<a name=\"idm181613146352\"></a><a name=\"idm181613145072\"></a></blockquote>")))
 (idm181613150560
  ((file command-line-parsing.html)
   (html
    "<blockquote>Now that we have the basics in place, the rest of the chapter will\n      examine some of the more advanced features of Command.</blockquote>")))
 (idm181613153616
  ((file command-line-parsing.html)
   (html
    "<blockquote>And that's all it took to build our little MD5 utility! Here's a\n      complete version of the example we just walked through, made slightly\n      more succinct by removing intermediate variables:</blockquote>")))
 (idm181613159248
  ((file command-line-parsing.html)
   (html
    "<blockquote>If you do supply the <code>filename</code>\n      argument, then <code>do_hash</code> is called with\n      the argument and the MD5 output is displayed to the standard\n      output:</blockquote>")))
 (idm181613160512
  ((file command-line-parsing.html)
   (html
    "<blockquote>When we invoke this binary without any arguments, it helpfully\n      displays all of the command-line options available, along with a message\n      to the standard error that informs you that a required argument <code>filename</code> is missing.</blockquote>")))
 (idm181613174768
  ((file command-line-parsing.html)
   (html
    "<blockquote>The versions that you see in the output were defined via the\n      optional arguments to <code>Command.run</code>.\n      You can leave these blank in your own programs or get your build system\n      to generate them directly from your version control system (e.g., by\n      running <code>hg id</code> to generate a build\n      revision number, in the case of Mercurial):</blockquote>")))
 (idm181613180768
  ((file command-line-parsing.html)
   (html
    "<blockquote>You can now query the version information for the binary you just\n      compiled:</blockquote>")))
 (idm181613185888
  ((file command-line-parsing.html)
   (html
    "<blockquote><code>Command.run</code> takes a couple of\n      optional arguments that are useful to identify which version of the\n      binary you are running in production. You'll need to install Cryptokit\n      via <code>opam install cryptokit</code> before\n      building this example. Once that's completed, run the following to\n      compile the binary:</blockquote>")))
 (idm181613188784
  ((file command-line-parsing.html)
   (html
    "<blockquote>Once we've defined the basic command, running it is just one\n      function call away:</blockquote>")))
 (idm181613191200
  ((file command-line-parsing.html)
   (html
    "<blockquote>Every OCaml function needs at least one argument, so the final\n        <code>unit</code> guarantees that it will not be\n        evaluated immediately as a value if there are no other\n        arguments.</blockquote>")))
 (idm181613193712
  ((file command-line-parsing.html)
   (html
    "<blockquote>The preceding callback needs an extra <code>unit</code> argument after <code>filename</code>. This is to ensure that\n        specifications can work even when they are empty (i.e. the <code>Command.Spec.empty</code> value).</blockquote>")))
 (idm181613198944
  ((file command-line-parsing.html)
   (html
    "<blockquote>The callback function is where all the work happens after the\n      command-line parsing is complete. This function is applied with the\n      arguments containing the parsed command-line values, and it takes over\n      as the main thread of the application. The callback's arguments are\n      passed in the same order as they were bound in the specification (using\n      the <code>+&gt;</code> operator).<a name=\"idm181613197648\"></a><a name=\"idm181613196336\"></a><a name=\"idm181613195440\"></a></blockquote>")))
 (idm181613199424
  ((file command-line-parsing.html)
   (html
    "<blockquote>The specification and the callback function follow as nonlabeled\n      arguments.</blockquote>")))
 (idm181613201568
  ((file command-line-parsing.html)
   (html
    "<blockquote>For longer help text when the command is called with\n            <code>-help</code>. The <code>readme</code> argument is a function that is\n            only evaluated when the help text is actually needed.</blockquote>")))
 (idm181613203584
  ((file command-line-parsing.html)
   (html
    "<blockquote>A required one-line description to go at the top of the\n            command help screen.</blockquote>")))
 (idm181613206176
  ((file command-line-parsing.html)
   (html
    "<blockquote><code>Command.basic</code> defines a\n      complete command-line interface that takes the following extra\n      arguments, in addition to the ones defined in the specification:</blockquote>")))
 (idm181613210992
  ((file command-line-parsing.html)
   (html
    "<blockquote>Once we've defined a specification, we need to put it to work on\n      real input. The simplest way is to directly create a command-line\n      interface via the <code>Command.basic</code>\n      module:<a name=\"idm181613209904\"></a></blockquote>")))
 (idm181613215568
  ((file command-line-parsing.html)
   (html
    "<blockquote>In this case, we defined a single anonymous argument called\n      <code>filename</code>, which takes a value of type\n      <code>string</code>. Anonymous parameters are\n      created using the <code>%:</code> operator, which\n      binds a textual name (used in the help text to identify the parameter)\n      to an OCaml conversion function that parses the command-line string\n      fragments into a higher-level OCaml data type. In the preceding example,\n      this is just <code>Command.Spec.string</code>, but\n      we'll see more complex conversion options later in the chapter.</blockquote>")))
 (idm181613218672
  ((file command-line-parsing.html)
   (html
    "<blockquote>The <code>Command.Spec</code> module defines\n      the tools you'll need to build up a command-line specification. We start\n      with the <code>empty</code> value and add\n      parameters to that using the <code>+&gt;</code>\n      combinator. (Both of these values come from <code>Command.Spec</code>.)</blockquote>")))
 (idm181613224240
  ((file command-line-parsing.html)
   (html
    "<blockquote>Let's build the specification for a single argument that is passed\n      directly on the command line. This is known as an\n      <span><em>anonymous</em></span> argument:<a name=\"idm181613223424\"></a><a name=\"idm181613222112\"></a></blockquote>")))
 (idm181613228240
  ((file command-line-parsing.html)
   (html
    "<blockquote>The <code>do_hash</code> function accepts a\n    <code>filename</code> parameter and prints the\n    human-readable MD5 string to the console standard output. The first step\n    toward turning this function into a command-line program is to declare all\n    the possible command-line arguments in a\n    <span><em>specification</em></span>. <code>Command.Spec</code> defines combinators that can be\n    chained together to define optional flags and positional arguments, what\n    types they should map to, and whether to take special actions (such as\n    pausing for interactive input) if certain inputs are encountered.</blockquote>")))
 (idm181613234976
  ((file command-line-parsing.html)
   (html
    "<blockquote>Let's start by working through a clone of the <span><em>md5sum</em></span> command that is\n      present on most Linux installations (the equivalent command on Mac OS X is simply <code>md5</code>). The following function defined below reads in the contents\n      of a file, applies the MD5 one-way cryptographic hash function to the data, and outputs an\n      ASCII hex representation of the result:<a name=\"idm181613233328\"></a><a name=\"idm181613232400\"></a></blockquote>")))
 (idm181613238416
  ((file command-line-parsing.html)
   (html
    "<blockquote>Demonstrate how <span><em>functional combinators</em></span> can be\n      used to declare complex command-line interfaces in a type-safe and\n      elegant way<a name=\"idm181613237600\"></a></blockquote>")))
 (idm181613240544
  ((file command-line-parsing.html)
   (html
    "<blockquote>We will build simple equivalents to the cryptographic <code>md5</code> and <code>shasum</code> utilities</blockquote>")))
 (idm181613241408
  ((file command-line-parsing.html)
   (html
    "<blockquote>Learn how to use Command to construct basic and grouped\n      command-line interfaces</blockquote>")))
 (idm181613242336
  ((file command-line-parsing.html)
   (html "<blockquote>In this chapter, we'll:</blockquote>")))
 (idm181613243104
  ((file command-line-parsing.html)
   (html
    "<blockquote>Command is simple to use for simple applications but also scales well\n  as your needs grow more complex. In particular, Command provides a\n  sophisticated subcommand mode that groups related commands together as the\n  complexity of your user interface grows. You may already be familiar with\n  this command-line style from the Git or Mercurial version control\n  systems.</blockquote>")))
 (idm181613245120
  ((file command-line-parsing.html)
   (html
    "<blockquote>It's tedious and error-prone to code all of this manually for every\n  program you write. Core provides the Command library, which simplifies all\n  of this by letting you declare all your command-line options in one place\n  and by deriving all of the above functionality from these\n  declarations.<a name=\"idm181613244560\"></a></blockquote>")))
 (idm181613245792
  ((file command-line-parsing.html)
   (html "<blockquote>Interactive autocompletion</blockquote>")))
 (idm181613246608
  ((file command-line-parsing.html)
   (html "<blockquote>Help for all the available options</blockquote>")))
 (idm181613247456
  ((file command-line-parsing.html)
   (html
    "<blockquote>Generation of error messages in response to incorrect\n      inputs</blockquote>")))
 (idm181613248272
  ((file command-line-parsing.html)
   (html "<blockquote>Parsing of command-line arguments</blockquote>")))
 (idm181613249360
  ((file command-line-parsing.html)
   (html
    "<blockquote>Many of the OCaml programs that you'll write will end up as binaries\n  that need to be run from a command prompt. Any nontrivial command line\n  should support a collection of basic features:</blockquote>")))
 (idm181608264768
  ((file colophon.html)
   (html
    "<blockquote>The cover image is from <span><em>Meyers Kleines Lexicon</em></span>. The cover fonts are URW\n    Typewriter and Guardian Sans. The text font is Adobe Minion Pro; the heading font is Adobe\n    Myriad Condensed; and the code font is Dalton Maag's Ubuntu Mono.</blockquote>")))
 (idm181608265456
  ((file colophon.html)
   (html
    "<blockquote>Humans have domesticated the Bactrian camel for travel purposes because of its great natural\n    resiliency. For example, the Bactrian camel can thrive in habitats of both extreme cold and\n    heat. It can also go without water for months and when water is available it can consume up to\n    55 litres. </blockquote>")))
 (idm181608266240
  ((file colophon.html)
   (html
    "<blockquote>The Bactrian camel is a large animal at 6 to 7.5 feet in height and 7.4 to 11.5 feet in\n    length. An adult will typically weigh between 660 and 2,200 pounds. The Bactrian camel is\n    distinctive for its two large humps on their back, hefty wooly coat, and dark brown color. It is\n    a herbivore that will eat all kinds of vegetation, though they have been known to feed on dead\n    animals. </blockquote>")))
 (idm181608267792
  ((file colophon.html)
   (html
    "<blockquote>The animal on the cover of <span><em>Real World OCaml</em></span> is the Bactrian camel\n      (<span><em>Camelus bactrianus</em></span>). The Bactrian camel, one of two species of camel, is\n    native to Central Asia and has been used domestically in the area for thousands of years. Even\n    though there are over two million domesticated Bactrian camels, only about a thousand are\n    considered wild.</blockquote>")))
 (idm181613661344
  ((file classes.html)
   (html
    "<blockquote>Compiles OCaml code to JavaScript and has bindings to WebGL.\n            This is the emerging standard for 3D rendering in web\n            browsers.</blockquote>")))
 (idm181613663296
  ((file classes.html)
   (html
    "<blockquote>An interface between OCaml and OpenGL, a widely supported\n            standard for 3D rendering.</blockquote>")))
 (idm181613665312
  ((file classes.html)
   (html
    "<blockquote>A strongly typed interface to the GTK widget library.</blockquote>")))
 (idm181613673984
  ((file classes.html)
   (html
    "<blockquote>The graphics library described here is the one built into OCaml\n      and is more useful as a learning tool than anything else. There are\n      several third-party libraries that provide more sophisticated bindings\n      to various graphics subsystems:<a name=\"idm181613673472\"></a><a name=\"idm181613672560\"></a><a name=\"idm181613671664\"></a><a name=\"idm181613670768\"></a><a name=\"idm181613669856\"></a><a name=\"idm181613668560\"></a></blockquote>")))
 (idm181613674656
  ((file classes.html)
   (html
    "<blockquote>When you run the binary, a new graphical window should appear (on\n      Mac OS X, you will need to install the X11 package first, which you will\n      be prompted for). Try clicking on the various widgets, and gasp in awe\n      at the sophisticated animations that unfold as a result.</blockquote>")))
 (idm181613679040
  ((file classes.html)
   (html
    "<blockquote>Finally, build the binary by linking against the <code>async_graphics</code> package, which will pull in all\n      the other dependencies:</blockquote>")))
 (idm181613682496
  ((file classes.html)
   (html
    "<blockquote>Our <code>main</code> function creates a\n      list of shapes to be displayed and defines a <code>repaint</code> function that actually draws them on\n      the display. We then open a graphical display and ask Async to run\n      <code>repaint</code> at regular intervals.</blockquote>")))
 (idm181613688736
  ((file classes.html)
   (html
    "<blockquote>We finish our shapes module by creating a <code>main</code> function to draw some shapes on the\n      graphical display and running that function using the Async\n      scheduler:<a name=\"idm181613687664\"></a><a name=\"idm181613686352\"></a></blockquote>")))
 (idm181613695040
  ((file classes.html)
   (html
    "<blockquote>Since the <code>linear</code> and <code>harmonic</code> mixins are only used for their side\n      effects, they can be inherited multiple times within the same object to\n      produce a variety of different animations:<a name=\"idm181613693472\"></a></blockquote>")))
 (idm181613697984
  ((file classes.html)
   (html
    "<blockquote>These initializers can also be added using mixins:</blockquote>")))
 (idm181613701088
  ((file classes.html)
   (html
    "<blockquote>We use initializers to add functions to this update list. For\n      example, this class will produce circles that move to the right for a\n      second when clicked:</blockquote>")))
 (idm181613706064
  ((file classes.html)
   (html
    "<blockquote>We can also use mixins to create animated shapes. Each animated\n      shape has a list of update functions to be called during animation. We\n      create an <code>animated</code> mixin to provide\n      this update list and ensure that the functions in it are called regular\n      intervals when the shape is animated:<a name=\"idm181613704864\"></a></blockquote>")))
 (idm181613708832
  ((file classes.html)
   (html
    "<blockquote>This allows us to create draggable shapes using multiple\n      inheritance:</blockquote>")))
 (idm181613714064
  ((file classes.html)
   (html
    "<blockquote>That's too abstract, so let's give some examples based on our\n      interactive shapes. We may wish to allow a shape to be dragged by the\n      mouse. We can define this functionality for any object that has mutable\n      <code>x</code> and <code>y</code> fields and an <code>on_mousedown</code> method for adding event\n      handlers:</blockquote>")))
 (idm181613718080
  ((file classes.html)
   (html
    "<blockquote>In any case, if you're programming with objects, there's one\n      general pattern for multiple inheritance that is both useful and\n      reasonably simple: the <span><em>mixin</em></span> pattern. Generically,\n      a <span><em>mixin</em></span> is just a virtual class that implements a\n      feature based on another one. If you have a class that implements\n      methods <span><em>A</em></span>, and you have a mixin\n      <span><em>M</em></span> that provides methods <span><em>B</em></span> from\n      <span><em>A</em></span>, then you can inherit from\n      <span><em>M</em></span>â\128\148&quot;mixing&quot; it inâ\128\148to get features\n      <span><em>B</em></span>.</blockquote>")))
 (idm181613721152
  ((file classes.html)
   (html
    "<blockquote>When should you use multiple inheritance? If you ask multiple\n      people, you're likely to get multiple (perhaps heated) answers. Some\n      will argue that multiple inheritance is overly complicated; others will\n      argue that inheritance is problematic in general, and one should use\n      object composition instead. But regardless of who you talk to, you will\n      rarely hear that multiple inheritance is great and that you should use\n      it widely.<a name=\"idm181613720432\"></a><a name=\"idm181613719536\"></a></blockquote>")))
 (idm181613723552
  ((file classes.html)
   (html
    "<blockquote>To reiterate, to understand what inheritance means, replace each\n      <code>inherit</code> directive with its\n      definition, and take the last definition of each method or field. Note\n      that the methods and fields added by an inheritance are those listed in\n      its class type, so private methods that are hidden by the type will not\n      be included.</blockquote>")))
 (idm181613726672
  ((file classes.html)
   (html
    "<blockquote>Here the <code>inherit</code> declaration\n      comes after the method definition, so the <code>draw</code> method from <code>square</code> will override the other definition, and\n      the square will be drawn using <code>fill_rect</code>.</blockquote>")))
 (idm181613732336
  ((file classes.html)
   (html
    "<blockquote>Since the <code>inherit</code> declaration\n      comes before the method definition, the new <code>draw</code> method overrides the old one, and the\n      square is drawn using <code>draw_rect</code>. But,\n      what if we had defined <code>square_outline</code>\n      as follows?</blockquote>")))
 (idm181613737744
  ((file classes.html)
   (html
    "<blockquote>For example, consider this class, which inherits from <code>square</code> and defines a new <code>draw</code> method that uses <code>draw_rect</code> instead of <code>fill_rect</code> to draw the square:</blockquote>")))
 (idm181613738336
  ((file classes.html)
   (html
    "<blockquote>If there is one thing to remember about inheritance in OCaml, it\n      is this: inheritance is like textual inclusion. If there is more than\n      one definition for a name, the last definition wins.</blockquote>")))
 (idm181613739120
  ((file classes.html)
   (html
    "<blockquote>The main trickiness of multiple inheritance is due to namingâ\128\148what\n      happens when a method or field with some name is defined in more than\n      one class?</blockquote>")))
 (idm181613744768
  ((file classes.html)
   (html
    "<blockquote>When a class inherits from more than one superclass, it is using\n    <span><em>multiple inheritance</em></span>. Multiple inheritance extends\n    the variety of ways that classes can be combined, and it can be quite\n    useful, particularly with virtual classes. However, it can be tricky to\n    use, particularly when the inheritance hierarchy is a graph rather than a\n    tree, so it should be used with care.<a name=\"idm181613743712\"></a><a name=\"idm181613742384\"></a><a name=\"idm181613741488\"></a></blockquote>")))
 (idm181613767232
  ((file classes.html)
   (html
    "<blockquote>For example, suppose we wanted to extend our previous shapes module\n    with a <code>growing_circle</code> class for circles\n    that expand when clicked. We could inherit from <code>circle</code> and used the inherited <code>on_click</code> to add a handler for click\n    events:</blockquote>")))
 (idm181613767968
  ((file classes.html)
   (html
    "<blockquote>However, these expressions are executed before the object has been\n    created and cannot refer to the methods of the object. If you need to use\n    an object's methods during instantiation, you can use an initializer. An\n    initializer is an expression that will be executed during instantiation\n    but after the object has been created.</blockquote>")))
 (idm181613780272
  ((file classes.html)
   (html
    "<blockquote>You can execute expressions during the instantiation of a class by\n    placing them before the object expression or in the initial value of a\n    field:<a name=\"idm181613779856\"></a><a name=\"idm181613778992\"></a></blockquote>")))
 (idm181613782880
  ((file classes.html)
   (html
    "<blockquote>One way to view a <code>virtual</code> class\n      is that it is like a functor, where the &quot;inputs&quot; are the declaredâ\128\148but\n      not definedâ\128\148virtual methods and fields. The functor application is\n      implemented through inheritance, when virtual methods are given concrete\n      implementations.</blockquote>")))
 (idm181613787584
  ((file classes.html)
   (html
    "<blockquote>Now we can define <code>square</code> and\n      <code>circle</code> by inheriting from <code>shape</code>:</blockquote>")))
 (idm181613793264
  ((file classes.html)
   (html
    "<blockquote>Here is the more succinct definition, starting with a virtual\n      <code>shape</code> class that implements <code>on_click</code> and <code>on_mousedown</code>:</blockquote>")))
 (idm181613798464
  ((file classes.html)
   (html
    "<blockquote>These classes have a lot in common, and it would be useful to\n      factor out this common functionality into a superclass. We can easily\n      move the definitions of <code>x</code> and\n      <code>y</code> into a superclass, but what about\n      <code>on_click</code>? Its definition depends on\n      <code>contains</code>, which has a different\n      definition in each class. The solution is to create a\n      <span><em>virtual</em></span> class. This class will declare a <code>contains</code> method but leave its definition to\n      the subclasses.</blockquote>")))
 (idm181613803120
  ((file classes.html)
   (html
    "<blockquote>The <code>square</code> class is pretty\n      straightforward, and the <code>circle</code> class\n      below also looks very similar:</blockquote>")))
 (idm181613807472
  ((file classes.html)
   (html
    "<blockquote>Now let's add classes for making squares and circles. We include\n      an <code>on_click</code> method for adding event\n      handlers to the shapes:<a name=\"idm181613806512\"></a></blockquote>")))
 (idm181613812592
  ((file classes.html)
   (html
    "<blockquote>We will give each shape a <code>draw</code>\n    method that describes how to draw the shape on the <code>Async_graphics</code> display:</blockquote>")))
 (idm181613815296
  ((file classes.html)
   (html
    "<blockquote>To explore this, let's extend our shapes examples to simple,\n    interactive graphics. We will use the Async concurrency library and the\n    <a href=\"http://github.com/lpw25/async_graphics/\" target=\"_top\">Async_graphics</a>\n    library, which provides an asynchronous interface to OCaml's built-in\n    Graphics library. Concurrent programming with Async will be explored later\n    in <a href=\"concurrent-programming-with-async.html\">ChapterÂ 18, <i>Concurrent Programming with Async</i></a>; for now you can\n    safely ignore the details. You just need to run <code>opam install async_graphics</code> to get the library\n    installed on your system.</blockquote>")))
 (idm181613826832
  ((file classes.html)
   (html
    "<blockquote>A <span><em>virtual</em></span> class is a class where some methods\n    or fields are declared but not implemented. This should not be confused\n    with the word <code>virtual</code> as it is used in\n    C++. A <code>virtual</code> method in C++ uses\n    dynamic dispatch, while regular, nonvirtual methods are statically\n    dispatched. In OCaml, <span><em>all</em></span> methods use dynamic\n    dispatch, but the keyword <code>virtual</code> means\n    that the method or field is not implemented. A class containing virtual\n    methods must also be flagged <code>virtual</code>\n    and cannot be directly instantiated (i.e., no object of this class can be\n    created).<a name=\"idm181613822784\"></a><a name=\"idm181613821872\"></a><a name=\"idm181613820976\"></a><a name=\"idm181613820064\"></a><a name=\"idm181613819168\"></a><a name=\"idm181613817616\"></a><a name=\"idm181613816720\"></a></blockquote>")))
 (idm181613828432
  ((file classes.html)
   (html
    "<blockquote>In this case, there is no one-to-one correspondence between the\n    objects and their sizes, and we can still easily define new kinds of\n    shape.</blockquote>")))
 (idm181613831680
  ((file classes.html)
   (html
    "<blockquote>However, equality is quite an extreme instance of a binary method:\n    it needs access to all the information of the other object. Many other\n    binary methods need only partial information about the object. For\n    instance, a method that compares shapes by their sizes:</blockquote>")))
 (idm181613833792
  ((file classes.html)
   (html
    "<blockquote>Note that this solution prevents us from adding new kinds of shapes\n    without adding new constructors to the <code>shape_repr</code> type, which is quite restrictive. The\n    objects created by these classes are also in one-to-one correspondence\n    with members of the representation type, making the objects seem somewhat\n    redundant.</blockquote>")))
 (idm181613838624
  ((file classes.html)
   (html
    "<blockquote>The binary method <code>equals</code> is now\n    implemented in terms of the concrete type <code>shape_repr</code>. When using this pattern, you will\n    not be able to hide the <code>repr</code> method,\n    but you can hide the type definition using the module system:</blockquote>")))
 (idm181613858176
  ((file classes.html)
   (html
    "<blockquote>If we want to define equality for shapes in general, the remaining\n    solution is to use the same approach as we described for narrowing. That\n    is, introduce a <span><em>representation</em></span> type implemented using\n    variants, and implement the comparison based on the representation\n    type:<a name=\"idm181613857232\"></a></blockquote>")))
 (idm181613858832
  ((file classes.html)
   (html
    "<blockquote>The problem here is that two objects are considered equal by the\n    built-in polymorphic equality if and only if they are physically equal.\n    There are other reasons not to use the built-in polymorphic equality, but\n    these false negatives are a showstopper.</blockquote>")))
 (idm181613864064
  ((file classes.html)
   (html
    "<blockquote>Since the problematic method is equality, one proposal we could\n    consider is to just drop it from the base type <code>shape</code> and use polymorphic equality instead.\n    However, the built-in polymorphic equality has very poor behavior when\n    applied to objects:</blockquote>")))
 (idm181613871040
  ((file classes.html)
   (html
    "<blockquote>The problem is that a <code>square</code>\n    expects to be compared with a <code>square</code>,\n    not an arbitrary shape; likewise for <code>circle</code>. This problem is fundamental. Many\n    languages solve it either with narrowing (with dynamic type checking), or\n    by method overloading. Since OCaml has neither of these, what can we\n    do?<a name=\"idm181613868624\"></a><a name=\"idm181613867312\"></a><a name=\"idm181613866400\"></a><a name=\"idm181613865504\"></a></blockquote>")))
 (idm181613883984
  ((file classes.html)
   (html
    "<blockquote>This works, but there is a problem lurking here. The method <code>equals</code> takes an object of the exact type\n    <code>square</code> or <code>circle</code>. Because of this, we can't define a\n    common base class <code>shape</code> that also\n    includes an equality method:</blockquote>")))
 (idm181613890832
  ((file classes.html)
   (html
    "<blockquote>We can now test different object instances for equality by using the\n    <code>equals</code> binary method:</blockquote>")))
 (idm181613891952
  ((file classes.html)
   (html
    "<blockquote>Note how we can use the type annotation <code>(self: 'self)</code> to obtain the type of the current\n    object.</blockquote>")))
 (idm181613915504
  ((file classes.html)
   (html
    "<blockquote>A <span><em>binary method</em></span> is a method that takes an\n    object of <code>self</code> type. One common example\n    is defining a method for equality:<a name=\"idm181613914144\"></a><a name=\"idm181613912848\"></a><a name=\"idm181613911536\"></a></blockquote>")))
 (idm181613922272
  ((file classes.html)
   (html
    "<blockquote>The key property of private methods is that they are visible to\n    subclasses, but not anywhere else. If you want the stronger guarantee that\n    a method is <span><em>really</em></span> private, not even accessible in\n    subclasses, you can use an explicit class type that omits the method. In\n    the following code, the private methods are explicitly omitted from the\n    class type of <code>counter_with_sig</code> and\n    can't be invoked in subclasses of <code>counter_with_sig</code>:</blockquote>")))
 (idm181613927360
  ((file classes.html)
   (html
    "<blockquote>To be precise, the private methods are part of the class type, but\n    not part of the object type. This means, for example, that the object\n    <code>f</code> has no method <code>bold</code>. However, the private methods are available\n    to subclasses: we can use them to simplify our <code>counter</code> class:</blockquote>")))
 (idm181613929072
  ((file classes.html)
   (html
    "<blockquote>The final statement that builds the value <code>f</code> shows how the instantiation of a <code>folder2</code> object has a type that hides the private\n    methods.</blockquote>")))
 (idm181613934752
  ((file classes.html)
   (html
    "<blockquote>For example, we may want to include methods in our <code>folder</code> class for handling each of the different\n    cases in <code>doc</code> and <code>text_item</code>. However, we may not want to force\n    subclasses of <code>folder</code> to expose these\n    methods, as they probably shouldn't be called directly:</blockquote>")))
 (idm181613940528
  ((file classes.html)
   (html
    "<blockquote>Methods can be declared <span><em>private</em></span>, which means\n    that they may be called by subclasses, but they are not visible otherwise\n    (similar to a <span><em>protected</em></span> method in C++).<a name=\"idm181613939296\"></a><a name=\"idm181613938000\"></a><a name=\"idm181613937088\"></a><a name=\"idm181613936192\"></a></blockquote>")))
 (idm181613945296
  ((file classes.html)
   (html
    "<blockquote>Note how the <code>super</code> special object\n    is used in <code>text_item</code> to call the\n    <code>[int] folder</code> class's <code>text_item</code> method to fold over the children of\n    the <code>text_item</code> node.</blockquote>")))
 (idm181613949248
  ((file classes.html)
   (html
    "<blockquote>By inheriting from this class, we can create functions that fold\n    over the document data. For example, the <code>count_doc</code> function counts the number of bold\n    tags in the document that are not within a list:</blockquote>")))
 (idm181613952896
  ((file classes.html)
   (html
    "<blockquote>The <code>object (self)</code> syntax binds\n    <code>self</code> to the current object, allowing\n    the <code>doc</code>, <code>list_item</code>, and <code>text_item</code> methods to call each other.</blockquote>")))
 (idm181613956064
  ((file classes.html)
   (html
    "<blockquote>The simplest way is to use classes and open recursion. For example,\n    the following class defines objects that fold over the document\n    data:</blockquote>")))
 (idm181613956720
  ((file classes.html)
   (html
    "<blockquote>It is quite easy to write a function that operates by recursively\n    traversing this data. However, what if you need to write many similar\n    recursive functions? How can you factor out the common parts of these\n    functions to avoid repetitive boilerplate?</blockquote>")))
 (idm181613959760
  ((file classes.html)
   (html
    "<blockquote>For example, consider writing recursive functions over a simple\n    document format. This format is represented as a tree with three different\n    types of node:</blockquote>")))
 (idm181613960352
  ((file classes.html)
   (html
    "<blockquote>This ability to define mutually recursive methods from separate\n    components is a key feature of classes: achieving similar functionality\n    with data types or modules is much more cumbersome and verbose.</blockquote>")))
 (idm181613964576
  ((file classes.html)
   (html
    "<blockquote>Open recursion allows an object's methods to invoke other methods on\n    the same object. These calls are looked up dynamically, allowing a method\n    in one class to call a method from another class, if both classes are\n    inherited by the same object. This allows mutually recursive parts of an\n    object to be defined separately.<a name=\"idm181613963984\"></a><a name=\"idm181613962688\"></a><a name=\"idm181613961792\"></a></blockquote>")))
 (idm181613967312
  ((file classes.html)
   (html
    "<blockquote>In this signature, we've chosen to make everything visible. The\n    class type for <code>stack</code> specifies the\n    types of the field <code>v</code>, as well as the\n    types of each of the methods.</blockquote>")))
 (idm181613970864
  ((file classes.html)
   (html
    "<blockquote>Class types do not appear in mainstream object-oriented programming\n    languages, so you may not be familiar with them, but the concept is pretty\n    simple. A class type specifies the type of each of the visible parts of\n    the class, including both fields and methods. Just as with module types,\n    you don't have to give a type for everything; anything you omit will be\n    hidden:</blockquote>")))
 (idm181613971888
  ((file classes.html)
   (html
    "<blockquote>The abstract signature is simple because we ignore the classes. But\n    what if we want to include them in the signature so that other modules can\n    inherit from the class definitions? For this, we need to specify types for\n    the classes, called <span><em>class types</em></span>.</blockquote>")))
 (idm181613975216
  ((file classes.html)
   (html
    "<blockquote>We have multiple choices in defining the module type, depending on\n    how much of the implementation we want to expose. At one extreme, a\n    maximally abstract signature would completely hide the class\n    definitions:</blockquote>")))
 (idm181613980160
  ((file classes.html)
   (html
    "<blockquote>As an example, let's wrap up our <code>stack</code> class in an explicit module (we'll use\n    explicit modules for illustration, but the process is similar when we want\n    to define a <code>.mli</code> file). In keeping with\n    the usual style for modules, we define a type <code>'a\n    t</code> to represent the type of our stacks:</blockquote>")))
 (idm181613982000
  ((file classes.html)
   (html
    "<blockquote>To allow code in a different file or module to inherit from a class,\n    we must expose it and give it a class type. What is the class\n    type?<a name=\"idm181613981584\"></a></blockquote>")))
 (idm181613985520
  ((file classes.html)
   (html
    "<blockquote>The preceding <code>as super</code> statement\n    creates a special object called <code>super</code>\n    which can be used to call superclass methods. Note that <code>super</code> is not a real object and can only be used\n    to call methods.</blockquote>")))
 (idm181613997056
  ((file classes.html)
   (html
    "<blockquote>A class can override methods from classes it inherits. For example,\n    this class creates stacks of integers that double the integers before they\n    are pushed onto the stack:</blockquote>")))
 (idm181614012528
  ((file classes.html)
   (html
    "<blockquote>Inheritance uses an existing class to define a new one. For example,\n    the following class definition inherits from our <code>stack</code>\n    class for strings and adds a new method <code>print</code> that prints all the strings on the\n    stack:<a name=\"idm181614011008\"></a><a name=\"idm181614010112\"></a></blockquote>")))
 (idm181614017232
  ((file classes.html)
   (html
    "<blockquote>The type quantifier <code>'b.</code> can be\n      read as &quot;for all <code>'b</code>.â\128\157 Type\n      quantifiers can only be used <span><em>directly after</em></span> the\n      method name, which means that method parameters must be expressed using\n      a <code>fun</code> or <code>function</code> expression.</blockquote>")))
 (idm181614038416
  ((file classes.html)
   (html
    "<blockquote>For example, a <code>fold</code> method for\n      our <code>['a] stack</code> class should have type\n      <code>('b -&gt; 'a -&gt; 'b) -&gt; 'b -&gt;\n      'b</code>, where the <code>'b</code> is\n      polymorphic. To express a polymorphic method type like this, we must use\n      a type quantifier, as shown in the following example:</blockquote>")))
 (idm181614040256
  ((file classes.html)
   (html
    "<blockquote>What about functional operations like <code>map</code> and <code>fold</code>? In general, these methods take a\n      function that produces a value of some other type than the elements of\n      the set.</blockquote>")))
 (idm181614060720
  ((file classes.html)
   (html
    "<blockquote>In practice, most OCaml programmers avoid iterator objects in\n      favor of functional-style techniques. For example, the alternative\n      <code>stack</code> class that follows takes a function <code>f</code> and applies it to each of the elements on\n      the stack:<a name=\"idm181614059184\"></a></blockquote>")))
 (idm181614080288
  ((file classes.html)
   (html
    "<blockquote>Now we can build a new stack, push some values to it, and iterate\n    over them:</blockquote>")))
 (idm181614100656
  ((file classes.html)
   (html
    "<blockquote>Finally, we add a method <code>iterator</code>\n    to the <code>stack</code> class to produce an\n    iterator. To do so, we construct a <code>list_iterator</code> that refers to the current\n    contents of the stack:</blockquote>")))
 (idm181614118512
  ((file classes.html)
   (html
    "<blockquote>Next, we'll define an actual iterator for lists. We can use this to\n    iterate over the contents of our stack:</blockquote>")))
 (idm181614123632
  ((file classes.html)
   (html
    "<blockquote>First, we'll define an object type <code>iterator</code> that specifies the methods in an\n    iterator:</blockquote>")))
 (idm181614124752
  ((file classes.html)
   (html
    "<blockquote>OCaml supports both styles. In fact, OCaml is more flexible than\n    these approaches because an object type can be implemented by any object\n    with the appropriate methods; it does not have to be specified by the\n    object's class <span><em>a priori</em></span>. We'll leave abstract classes\n    for later. Let's demonstrate the technique using object types.</blockquote>")))
 (idm181614128496
  ((file classes.html)
   (html
    "<blockquote>In languages without interfaces, like C++, the specification would\n    normally use <span><em>abstract</em></span> classes to specify the methods\n    without implementing them (C++ uses the &quot;= 0&quot; definition to mean &quot;not\n    implemented&quot;):</blockquote>")))
 (idm181614131712
  ((file classes.html)
   (html
    "<blockquote>There are two common styles for defining abstract interfaces like\n    this. In Java, an iterator would normally be specified with an interface,\n    which specifies a set of method types:</blockquote>")))
 (idm181614139152
  ((file classes.html)
   (html
    "<blockquote>We may wish to traverse the elements on our stack. One common style\n    for doing this in object-oriented languages is to define a class for an\n    <code>iterator</code> object. An iterator provides a\n    generic mechanism to inspect and traverse the elements of a\n    collection.<a name=\"idm181614137984\"></a><a name=\"idm181614136656\"></a><a name=\"idm181614135760\"></a><a name=\"idm181614134448\"></a><a name=\"idm181614133152\"></a></blockquote>")))
 (idm181614141056
  ((file classes.html)
   (html
    "<blockquote>In general, we need to provide enough constraints so that the\n    compiler will infer the correct type. We can add type constraints to the\n    parameters, to the fields, and to the methods. It is a matter of\n    preference how many constraints to add. You can add type constraints in\n    all three places, but the extra text may not help clarity. A convenient\n    middle ground is to annotate the fields and/or class parameters, and add\n    constraints to methods only if necessary.</blockquote>")))
 (idm181614161248
  ((file classes.html)
   (html
    "<blockquote>The type annotation on the declaration of <code>v</code> is used to constrain type inference. If we\n    omit this annotation, the type inferred for the class will be &quot;too\n    polymorphic&quot;: <code>init</code> could have some type\n    <code>'b list</code>:</blockquote>")))
 (idm181614162448
  ((file classes.html)
   (html
    "<blockquote>Note that the type parameter <code>['a]</code>\n    in the definition uses square brackets, but for other uses of the type\n    they are omitted (or replaced with parentheses if there is more than one\n    type parameter).</blockquote>")))
 (idm181614179680
  ((file classes.html)
   (html
    "<blockquote>Let's implement a variant of the <code>istack</code> class that can hold any values, not just\n    integers. When defining the class, the type parameters are placed in\n    square brackets before the class name in the class definition. We also add\n    a parameter <code>init</code> for the initial\n    contents of the stack:</blockquote>")))
 (idm181614183888
  ((file classes.html)
   (html
    "<blockquote>A class definition serves as the <span><em>constructor</em></span>\n    for the class. In general, a class definition may have parameters that\n    must be provided as arguments when the object is created with <code>new</code>.<a name=\"idm181614182416\"></a><a name=\"idm181614181136\"></a></blockquote>")))
 (idm181614186848
  ((file classes.html)
   (html
    "<blockquote>Note that this type represents any object with these methods:\n    objects created using the <code>istack</code> class\n    will have this type, but objects with this type may not have been created\n    by the <code>istack</code> class.</blockquote>")))
 (idm181614195168
  ((file classes.html)
   (html
    "<blockquote>You may have noticed that the object <code>s</code> has been given the type <code>istack</code>. But wait, we've stressed\n    <span><em>classes are not types</em></span>, so what's up with that? In\n    fact, what we've said is entirely true: classes and class names\n    <span><em>are not</em></span> types. However, for convenience, the\n    definition of the class <code>istack</code> also\n    defines an object type <code>istack</code> with the\n    same methods as the class. This type definition is equivalent to:</blockquote>")))
 (idm181614205520
  ((file classes.html)
   (html
    "<blockquote>To produce an object, classes are instantiated with the keyword\n    <code>new</code>:</blockquote>")))
 (idm181614215872
  ((file classes.html)
   (html
    "<blockquote>The <code>class istack : object ... end</code> result shows that we\n      have created a class <code>istack</code> with\n        <span><em>class type</em></span>\n<code>object ... end</code>. Like module types, class types are\n      completely separate from regular OCaml types (e.g., <code>int</code>,\n        <code>string</code>, and <code>list</code>) and,\n      in particular, should not be confused with object types (e.g., <code>&lt;\n        get : int; .. &gt;</code>). The class type describes the class itself rather than the\n      objects that the class creates. This particular class type specifies that the <code>istack</code> class defines a mutable field <code>v</code>, a method <code>pop</code> that returns an\n          <span><code>int option</code></span>, and a\n      method <code>push</code> with type <code>int -&gt;\n        unit</code>.</blockquote>")))
 (idm181614232928
  ((file classes.html)
   (html
    "<blockquote>In OCaml, class definitions must be defined as toplevel statements\n    in a module. The syntax for a class definition uses the keyword <code>class</code>:<a name=\"idm181614231888\"></a></blockquote>")))
 (idm181614236352
  ((file classes.html)
   (html
    "<blockquote>Programming with objects directly is great for encapsulation, but one\n  of the main goals of object-oriented programming is code reuse through\n  inheritance. For inheritance, we need to introduce\n  <span><em>classes</em></span>. In object-oriented programming, a class is a\n  &quot;recipe&quot; for creating objects. The recipe can be changed by adding new\n  methods and fields, or it can be changed by modifying existing\n  methods.<a name=\"idm181614235280\"></a></blockquote>")))
 (idm181620422976
  ((file a-guided-tour.html)
   (html
    "<blockquote>That's it for the guided tour! There are plenty of features left and\n    lots of details to explain, but we hope that you now have a sense of what\n    to expect from OCaml, and that you'll be more comfortable reading the rest\n    of the book as a result.</blockquote>")))
 (idm181620425248
  ((file a-guided-tour.html)
   (html
    "<blockquote>More work is needed to make a really usable command-line program,\n      including a proper command-line parsing interface and better error\n      handling, all of which is covered in <a href=\"command-line-parsing.html\">ChapterÂ 14, <i>Command-Line Parsing</i></a>.</blockquote>")))
 (idm181620434416
  ((file a-guided-tour.html)
   (html
    "<blockquote>The <code>.native</code> suffix indicates that we're building a\n        native-code executable, which we'll discuss more in <a href=\"files-modules-and-programs.html\">ChapterÂ 4, <i>Files, Modules, and Programs</i></a>. Once the build completes, we can use the resulting\n        program like any command-line utility. We can feed input to <code>sum.native</code> by typing in a sequence of numbers, one per line, hitting\n          <strong><code>Ctrl-D</code></strong> when we're done:</blockquote>")))
 (idm181620441152
  ((file a-guided-tour.html)
   (html
    "<blockquote>We'll compile our program using <span><strong>corebuild</strong></span>, a small\n        wrapper on top of <span><strong>ocamlbuild</strong></span>, a build tool that ships\n        with the OCaml compiler. The <span><strong>corebuild</strong></span> script is\n        installed along with Core, and its purpose is to pass in the flags required for building a\n        program with Core.<a name=\"idm181620438672\"></a></blockquote>")))
 (idm181620446832
  ((file a-guided-tour.html)
   (html
    "<blockquote>After <code>read_and_accumulate</code>\n    returns, the total needs to be printed. This is done using the <code>printf</code> command, which provides support for\n    type-safe format strings, similar to what you'll find in a variety of\n    languages. The format string is parsed by the compiler and used to\n    determine the number and type of the remaining arguments that are\n    <span>required</span>. In this case, there is a single formatting directive, <code>%F</code>, so <code>printf</code>\n    expects one additional argument of type <code>float</code>.</blockquote>")))
 (idm181620450032
  ((file a-guided-tour.html)
   (html
    "<blockquote>This is our first use of OCaml's input and output routines. The\n    function <code>read_and_accumulate</code> is a\n    recursive function that uses <code>In_channel.input_line</code> to read in lines one by\n    one from the standard input, invoking itself at each iteration with its\n    updated accumulated sum. Note that <code>input_line</code> returns an optional value, with\n    <code>None</code> indicating the end of the input\n    stream.</blockquote>")))
 (idm181620454240
  ((file a-guided-tour.html)
   (html
    "<blockquote>Here's the code, which you can save in a file called\n    <code>sum.ml</code>. Note that we don't terminate expressions with\n    <code>;;</code> here, since it's not required\n    outside the toplevel:</blockquote>")))
 (idm181620456832
  ((file a-guided-tour.html)
   (html
    "<blockquote>So far, we've played with the basic features of the language via\n    <span><strong>utop</strong></span>. Now we'll show how to create a\n    simple standalone program. In particular, we'll create a program that sums\n    up a list of numbers read in from the standard input.<a name=\"idm181620455680\"></a></blockquote>")))
 (idm181620459776
  ((file a-guided-tour.html)
   (html
    "<blockquote>The Or operator, <code>||</code>,\n      short-circuits in a similar way to <code>&amp;&amp;</code>.</blockquote>")))
 (idm181620477600
  ((file a-guided-tour.html)
   (html
    "<blockquote>As a side note, the preceding code takes advantage of the fact\n      that <code>&amp;&amp;</code>, OCaml's And\n      operator, short-circuits. In particular, in an expression of the form\n      <span><em><code>expr1</code></em></span> <code>&amp;&amp;</code> <span><em><code>expr2</code></em></span>, <span><em><code>expr2</code></em></span> will only be evaluated if\n      <span><em><code>expr1</code></em></span> evaluated\n      to true. Were it not for that, then the preceding function would result\n      in an out-of-bounds error. Indeed, we can trigger that out-of-bounds\n      error by rewriting the function to avoid the short-circuiting:</blockquote>")))
 (idm181620491488
  ((file a-guided-tour.html)
   (html
    "<blockquote>OCaml also supports <code>while</code> loops, as shown in\n      the following function for finding the position of the first negative\n      entry in an array. Note that <code>while</code>\n      (like <code>for</code>) is also a keyword:</blockquote>")))
 (idm181620500864
  ((file a-guided-tour.html)
   (html "<blockquote>Here's an example run of this code:</blockquote>")))
 (idm181620504288
  ((file a-guided-tour.html)
   (html
    "<blockquote>From a syntactic perspective, you should note the keywords that\n      distinguish a <code>for</code> loop: <code>for</code>, <code>to</code>,\n      <code>do</code>, and <code>done</code>.</blockquote>")))
 (idm181620522368
  ((file a-guided-tour.html)
   (html
    "<blockquote>OCaml also supports traditional imperative control-flow constructs\n      like <code>for and while</code> loops. Here, for example, is some\n      code for permuting an array that uses a <code>for</code> loop. We\n      use the <code>Random</code> module as our source\n      of randomness. <code>Random</code> starts with a\n      default seed, but you can call <code>Random.self_init</code> to choose a new seed at\n      random:<a name=\"idm181620519024\"></a><a name=\"idm181620518128\"></a><a name=\"idm181620517232\"></a><a name=\"idm181620516336\"></a></blockquote>")))
 (idm181620524304
  ((file a-guided-tour.html)
   (html
    "<blockquote>This isn't the most idiomatic way to sum up a list, but it shows how you can use a\n          <code>ref</code> in place of a mutable variable.</blockquote>")))
 (idm181620533296
  ((file a-guided-tour.html)
   (html
    "<blockquote>Even though a <code>ref</code> is just\n      another record type, it's important because it is the standard way of\n      simulating the traditional mutable variables you'll find in most\n      languages. For example, we can sum over the elements of a list\n      imperatively by calling <code>List.iter</code> to\n      call a simple function on every element of a list, using a\n      <code>ref</code> to accumulate the results:</blockquote>")))
 (idm181620537808
  ((file a-guided-tour.html)
   (html
    "<blockquote>The <code>'a</code> before the\n      <code>ref</code> indicates that the <code>ref</code> type is polymorphic, in the same way that\n      lists are polymorphic, meaning it can contain values of any type. The\n      parentheses around <code>!</code> and <code>:=</code> are needed because these are operators,\n      rather than ordinary functions.<a name=\"idm181620534336\"></a></blockquote>")))
 (idm181620548064
  ((file a-guided-tour.html)
   (html
    "<blockquote>There's nothing magical with these operators either. You can\n      completely reimplement the <code>ref</code> type\n      and all of these operators in just a few lines of code:</blockquote>")))
 (idm181620558720
  ((file a-guided-tour.html)
   (html
    "<blockquote>There are a handful of useful functions and operators defined for\n      <code>ref</code>s to make them more convenient to\n      work with:</blockquote>")))
 (idm181620571376
  ((file a-guided-tour.html)
   (html
    "<blockquote>We can create a single mutable value by using a <code>ref</code>. The <code>ref</code> type comes predefined in the standard\n      library, but there's nothing really special about it. It's just a record\n      type with a single mutable field called <code>contents</code>:<a name=\"idm181620568976\"></a><a name=\"idm181620567680\"></a></blockquote>")))
 (idm181620573824
  ((file a-guided-tour.html)
   (html
    "<blockquote>It's worth noting that the preceding algorithm is numerically\n      naive and has poor precision in the presence of cancellation. You can\n      look at this Wikipedia <a href=\"http://en.wikipedia.org/wiki/Algorithms_for_calculating_variance\" target=\"_top\">article\n      on algorithms for calculating variance</a> for more details, paying\n      particular attention to the weighted incremental and parallel\n      algorithms.</blockquote>")))
 (idm181620586384
  ((file a-guided-tour.html)
   (html
    "<blockquote>Here's an example of <code>create</code> and\n      <code>update</code> in action. Note that this code\n      uses <code>List.iter</code>, which calls the\n      function <code>~f</code> on each element of the\n      provided list:</blockquote>")))
 (idm181620586976
  ((file a-guided-tour.html)
   (html
    "<blockquote>Note the use of single semicolons to sequence operations. When we were working purely\n        functionally, this wasn't necessary, but you start needing it when you're writing imperative\n        code.</blockquote>")))
 (idm181620590640
  ((file a-guided-tour.html)
   (html
    "<blockquote><code>create</code> returns a <code>running_sum</code> corresponding to the empty set, and <code>update\n          rsum x</code> changes <code>rsum</code> to reflect the addition\n        of <code>x</code> to its set of samples by updating the number of\n        samples, the sum, and the sum of squares.</blockquote>")))
 (idm181620599792
  ((file a-guided-tour.html)
   (html
    "<blockquote>We also need functions to create and update <code>running_sum</code>s:</blockquote>")))
 (idm181620602208
  ((file a-guided-tour.html)
   (html
    "<blockquote>We use the function <code>float</code> above, which is a\n        convenient equivalent of <code>Float.of_int</code> provided by the\n          <code>Pervasives</code> library.</blockquote>")))
 (idm181620611136
  ((file a-guided-tour.html)
   (html
    "<blockquote>The fields in <code>running_sum</code> are\n      designed to be easy to extend incrementally, and sufficient to compute\n      means and standard deviations, as shown in the following example. Note\n      that there are two <code>let</code> bindings in a row without a\n      double semicolon between them. That's because the double semicolon is\n      required only to tell <span><em>utop</em></span> to process the input,\n      not to separate two declarations:</blockquote>")))
 (idm181620625184
  ((file a-guided-tour.html)
   (html
    "<blockquote>The array is an important mutable data structure, but it's not the only one. Records,\n        which are immutable by default, can have some of their fields explicitly declared as\n        mutable. Here's a small example of a data structure for storing a running statistical\n        summary of a collection of numbers. <a name=\"idm181620624608\"></a><a name=\"idm181620623280\"></a><a name=\"idm181620622368\"></a></blockquote>")))
 (idm181620630416
  ((file a-guided-tour.html)
   (html
    "<blockquote>The <code>unit</code> type that we see in the preceding code is\n        interesting in that it has only one possible value, written <code>()</code>. This means that a value of type <code>unit</code>\n        doesn't convey any information, and so is generally used as a placeholder. Thus, we use\n          <code>unit</code> for the return value of an operation like setting\n        a mutable field that communicates by side effect rather than by returning a value. It's also\n        used as the argument to functions that don't require an input value. This is similar to the\n        role that <code>void</code> plays in languages like C and Java.</blockquote>")))
 (idm181620633456
  ((file a-guided-tour.html)
   (html
    "<blockquote>The <code>.(i)</code> syntax is used to\n      refer to an element of an array, and the <code>&lt;-</code> syntax is for modification. Because the\n      elements of the array are counted starting at zero, element <span><code>.(2)</code> is</span>\n      the third element.</blockquote>")))
 (idm181620645696
  ((file a-guided-tour.html)
   (html
    "<blockquote>Perhaps the simplest mutable data structure in OCaml is the array.\n      Arrays in OCaml are very similar to arrays in other languages like C:\n      indexing starts at 0, and accessing or modifying an array element is a\n      constant-time operation. Arrays are more compact in terms of memory\n      utilization than most other data structures in OCaml, including lists.\n      Here's an example:<a name=\"idm181620645040\"></a><a name=\"idm181620643744\"></a><a name=\"idm181620642432\"></a></blockquote>")))
 (idm181620648080
  ((file a-guided-tour.html)
   (html
    "<blockquote>Functional code is the default in OCaml, with variable bindings and\n    most data structures being immutable. But OCaml also has excellent support\n    for imperative programming, including mutable data structures like arrays\n    and hash tables, and control-flow constructs like <code>for</code>\n    and <code>while</code> loops.</blockquote>")))
 (idm181620655024
  ((file a-guided-tour.html)
   (html
    "<blockquote>The code we've written so far has been almost entirely\n    <span><em>pure</em></span> or <span><em>functional</em></span>, which\n    roughly speaking means that the code in question doesn't modify variables\n    or values as part of its execution. Indeed, almost all of the data\n    structures we've encountered are <span><em>immutable</em></span>, meaning\n    there's no way in the language to modify them at all. This is a quite\n    different style from <span><em>imperative</em></span> programming, where\n    computations are structured as sequences of instructions that operate by\n    making modifications to the state of the program.<a name=\"idm181620652608\"></a><a name=\"idm181620651712\"></a><a name=\"idm181620650816\"></a><a name=\"idm181620649520\"></a></blockquote>")))
 (idm181620658576
  ((file a-guided-tour.html)
   (html
    "<blockquote>The purpose of <code>List.exists</code> is to\n    check if there are any elements of the list in question on which the\n    provided function evaluates to <code>true</code>. In\n    this case, we're using <code>List.exists</code> to\n    check if there is a scene element within which our point resides.</blockquote>")))
 (idm181620663792
  ((file a-guided-tour.html)
   (html
    "<blockquote>We also made our first use of an <span><em>anonymous\n    function</em></span> in the call to <code>List.exists</code>. Anonymous functions are declared\n    using the <code>fun</code> keyword, and don't need\n    to be explicitly named. Such functions are common in OCaml, particularly\n    when using iteration functions like <code>List.exists</code>.<a name=\"idm181620660928\"></a><a name=\"idm181620660016\"></a></blockquote>")))
 (idm181620668384
  ((file a-guided-tour.html)
   (html
    "<blockquote>You might at this point notice that the use of <code>match</code> here is reminiscent of how we used\n    <code>match</code> with <code>option</code> and <code>list</code>. This is no accident: <code>option</code> and <code>list</code> are really just examples of variant types\n    that happen to be important enough to be defined in the standard library\n    (and in the case of lists, to have some special syntax).</blockquote>")))
 (idm181620688256
  ((file a-guided-tour.html)
   (html
    "<blockquote>Here's how we might write a function for testing whether a point is\n    in the interior of some element of a list of <code>scene_element</code>s:</blockquote>")))
 (idm181620692032
  ((file a-guided-tour.html)
   (html
    "<blockquote>The <code>|</code> character separates the\n    different cases of the variant (the first <code>|</code> is optional), and each case has a capitalized\n    tag, like <code>Circle</code>, <code>Rect</code> or <code>Segment</code>, to distinguish that case from the\n    others.</blockquote>")))
 (idm181620704192
  ((file a-guided-tour.html)
   (html
    "<blockquote>Now, imagine that you want to combine multiple objects of these\n    types together as a description of a multiobject scene. You need some\n    unified way of representing these objects together in a single type. One\n    way of doing this is using a <span><em>variant</em></span> type:<a name=\"idm181620703264\"></a><a name=\"idm181620701968\"></a></blockquote>")))
 (idm181620712176
  ((file a-guided-tour.html)
   (html
    "<blockquote>And we can of course include our newly defined types as components\n    in larger types. Here, for example, are some types for modeling different\n    geometric objects that contain values of type <code>point2d</code>:</blockquote>")))
 (idm181620717264
  ((file a-guided-tour.html)
   (html
    "<blockquote>Alternatively, we can use dot notation for accessing record fields:</blockquote>")))
 (idm181620723632
  ((file a-guided-tour.html)
   (html
    "<blockquote>We can write this more tersely using what's called <span><em>field punning</em></span>. In\n      particular, when the name of the field and the name of the variable it is bound to coincide,\n      we don't have to write them both down. Using this, our magnitude function can be rewritten as\n        follows:<a name=\"idm181620722688\"></a></blockquote>")))
 (idm181620726672
  ((file a-guided-tour.html)
   (html
    "<blockquote>The pattern match here binds the variable <code>x_pos</code> to the value contained in the <code>x</code> field, and the variable <code>y_pos</code> to the value in the <code>y</code> field.</blockquote>")))
 (idm181620731808
  ((file a-guided-tour.html)
   (html
    "<blockquote>And we can get access to the contents of these types using pattern\n    matching:</blockquote>")))
 (idm181620739808
  ((file a-guided-tour.html)
   (html
    "<blockquote><code>point2d</code> is a\n    <span><em>record</em></span> type, which you can think of as a tuple where\n    the individual fields are named, rather than being defined positionally.\n    Record types are easy enough to construct:<a name=\"idm181620738448\"></a><a name=\"idm181620737152\"></a></blockquote>")))
 (idm181620745680
  ((file a-guided-tour.html)
   (html
    "<blockquote>So far, we've only looked at data structures that were predefined in\n    the language, like lists and tuples. But OCaml also allows us to define\n    new data types. Here's a toy example of a data type representing a point\n    in two-dimensional space:<a name=\"idm181620745168\"></a></blockquote>")))
 (idm181620750160
  ((file a-guided-tour.html)
   (html
    "<blockquote>In OCaml, however, missing values are explicit. A value of type <code>string * string</code> always contains two well-defined values of type <code>string</code>. If you want to allow, say, the first of those to be\n        absent, then you need to change the type to <code>string option *\n          string</code>. As we'll see in <a href=\"error-handling.html\">ChapterÂ 7, <i>Error Handling</i></a>, this explicitness\n        allows the compiler to provide a great deal of help in making sure you're correctly handling\n        the possibility of missing data.</blockquote>")))
 (idm181620753376
  ((file a-guided-tour.html)
   (html
    "<blockquote>Options are important because they are the standard way in OCaml\n      to encode a value that might not be there; there's no such thing as a\n      <code>NullPointerException</code> in OCaml. This\n      is different from most other languages, including Java and C#, where\n      most if not all data types are <span><em>nullable</em></span>, meaning\n      that, whatever their type is, any given value also contains the\n      possibility of being a null value. In such languages, null is lurking\n      everywhere.<a name=\"idm181620751584\"></a></blockquote>")))
 (idm181620755104
  ((file a-guided-tour.html)
   (html
    "<blockquote>This kind of nested <code>let</code> binding is a common\n        way of building up a complex expression, with each <code>let</code> naming some component, before combining\n        them in one final expression.</blockquote>")))
 (idm181620761840
  ((file a-guided-tour.html)
   (html
    "<blockquote>We can also have multiple <code>let</code> statements in a\n        row, each one adding a new variable binding to what came\n        before:</blockquote>")))
 (idm181620767920
  ((file a-guided-tour.html)
   (html
    "<blockquote>Note that the scope of the <code>let</code> binding is\n        terminated by the double-semicolon, so the value of <code>x</code> is no longer available:</blockquote>")))
 (idm181620778000
  ((file a-guided-tour.html)
   (html
    "<blockquote><code>log_entry</code> was our first use of <code>let</code> to define a new variable within the body of a function. A\n            <code>let</code> paired with an <code>in</code> can be used to introduce a new binding within any local scope, including a\n          function body. The <code>in</code> marks the beginning of the scope\n          within which the new variable can be used. Thus, we could write:<a name=\"idm181620774368\"></a></blockquote>")))
 (idm181620781216
  ((file a-guided-tour.html)
   (html
    "<blockquote>This example uses Core's <code>Time</code>\n      module for dealing with time, as well as the <code>^</code> operator for concatenating strings. The\n      concatenation operator is provided as part of the <code>Pervasives</code> module, which is automatically\n      opened in every OCaml program.</blockquote>")))
 (idm181620794896
  ((file a-guided-tour.html)
   (html
    "<blockquote>To examine the contents of an option, we use pattern matching, as\n      we did with tuples and lists. Consider the following function for\n      creating a log entry string given an optional time and a message. If no\n      time is provided (i.e., if the time is <code>None</code>), the current time is computed and used\n      in its place:</blockquote>")))
 (idm181620799056
  ((file a-guided-tour.html)
   (html
    "<blockquote>The function <code>divide</code> either returns <code>None</code> if the divisor is zero, or <code>Some</code> of the result of the division otherwise. <code>Some</code> and\n          <code>None</code> are constructors that let you build optional values, just as\n          <code>::</code> and <code>[]</code> let you build lists. You can think of an\n        option as a specialized list that can only have zero or one elements.</blockquote>")))
 (idm181620806544
  ((file a-guided-tour.html)
   (html
    "<blockquote>Another common data structure in OCaml is the option. An option is\n      used to express that a value might or might not be present. For\n      example:<a name=\"idm181620806128\"></a><a name=\"idm181620805232\"></a></blockquote>")))
 (idm181620809696
  ((file a-guided-tour.html)
   (html
    "<blockquote>In the last few examples, our list processing code involved a\n        lot of recursive functions. In practice, this isn't usually necessary.\n        Most of the time, you'll find yourself happy to use the iteration\n        functions found in the <code>List</code> module.\n        But it's good to know how to use recursion when you need to do\n        something new.<a name=\"idm181620808432\"></a></blockquote>")))
 (idm181620813600
  ((file a-guided-tour.html)
   (html
    "<blockquote>Note that this code used another variant of the list pattern,\n        <code>[hd]</code>, to match a list with a single\n        element. We can do this to match a list with any fixed number of\n        elements; for example, <code>[x;y;z]</code> will\n        match any list with exactly three elements and will bind those\n        elements to the variables <code>x</code>,\n        <code>y</code>, and <code>z</code>.</blockquote>")))
 (idm181620824736
  ((file a-guided-tour.html)
   (html
    "<blockquote>Again, the first arm of the match is the base case, and the\n        second is the inductive. Unfortunately, this code has a problem, as is\n        indicated by the warning message. In particular, we don't handle\n        one-element lists. We can fix this warning by adding another case to\n        the match:</blockquote>")))
 (idm181620835888
  ((file a-guided-tour.html)
   (html
    "<blockquote>We can introduce more complicated list patterns as well. Here's\n        a function for removing sequential duplicates:</blockquote>")))
 (idm181620836400
  ((file a-guided-tour.html)
   (html
    "<blockquote>This suggests a reasonable mental model for what OCaml is\n        actually doing to evaluate a recursive function.</blockquote>")))
 (idm181620840112
  ((file a-guided-tour.html)
   (html
    "<blockquote>Logically, you can think of the evaluation of a simple recursive\n        function like <code>sum</code> almost as if it\n        were a mathematical equation whose meaning you were unfolding step by\n        step:</blockquote>")))
 (idm181620843280
  ((file a-guided-tour.html)
   (html
    "<blockquote>Following the common OCaml idiom, we use <code>hd</code> to refer to the head of the list and\n        <code>tl</code> to refer to the tail. Note that\n        we had to use the <code>rec</code> keyword to\n        allow <code>sum</code> to refer to itself. As\n        you might imagine, the base case and inductive case are different arms\n        of the match.</blockquote>")))
 (idm181620852448
  ((file a-guided-tour.html)
   (html
    "<blockquote>When writing recursive list functions, this separation between\n        the base cases and the inductive cases is often done using pattern\n        matching. Here's a simple example of a function that sums the elements\n        of a list:</blockquote>")))
 (idm181620856720
  ((file a-guided-tour.html)
   (html
    "<blockquote>Recursive functions, or functions that call themselves, are an\n        important technique in OCaml and in any functional language. The\n        typical approach to designing a recursive function is to separate the\n        logic into a set of <span><em>base cases</em></span> that can be solved\n        directly and a set of <span><em>inductive cases</em></span>, where the\n        function breaks the problem down into smaller pieces and then calls\n        itself to solve those smaller problems.<a name=\"idm181620855200\"></a><a name=\"idm181620853888\"></a></blockquote>")))
 (idm181620861088
  ((file a-guided-tour.html)
   (html
    "<blockquote>The first pattern, <code>first ::\n        the_rest</code>, covers the case where <code>languages</code> has at least one element, since\n        every list except for the empty list can be written down with one or\n        more <code>::</code>'s. The second pattern,\n        <code>[]</code>, matches only the empty list.\n        These cases are exhaustive, since every list is either empty or has at\n        least one element, a fact that is verified by the compiler.</blockquote>")))
 (idm181620863616
  ((file a-guided-tour.html)
   (html
    "<blockquote>The preceding code also includes our first comment. OCaml\n        comments are bounded by <code>(*</code> and\n        <code>*)</code> and can be nested arbitrarily\n        and cover multiple lines. There's no equivalent of C++-style\n        single-line comments that are prefixed by <code>//</code>.</blockquote>")))
 (idm181620875808
  ((file a-guided-tour.html)
   (html
    "<blockquote>Here's a new version of <code>my_favorite_language</code> that uses <code>match</code> and doesn't trigger a compiler\n        warning:</blockquote>")))
 (idm181620877712
  ((file a-guided-tour.html)
   (html
    "<blockquote>A <code>match</code> statement is a kind\n        of juiced-up version of the <code>switch</code> statement found\n        in C and Java. It essentially lets you list a sequence of patterns,\n        separated by pipe characters (|). (The one before the first case is\n        optional.) The compiler then dispatches to the code following the\n        first matching pattern. As we've already seen, the pattern can mint\n        new variables that correspond to substructures of the value being\n        matched.</blockquote>")))
 (idm181620878928
  ((file a-guided-tour.html)
   (html
    "<blockquote>You can avoid these warnings, and more importantly make sure\n        that your code actually handles all of the possible cases, by using a\n        <code>match</code> statement instead.</blockquote>")))
 (idm181620886896
  ((file a-guided-tour.html)
   (html
    "<blockquote>As you can see, however, the toplevel did not like this\n        definition and spit out a warning indicating that the pattern is not\n        exhaustive. This means that there are values of the type in question\n        that won't be captured by the pattern. The warning even gives an\n        example of a value that doesn't match the provided pattern, in\n        particular, <code>[]</code>, the empty list. If\n        we try to run <code>my_favorite_language</code>,\n        we'll see that it works on nonempty list and fails on empty\n        ones:</blockquote>")))
 (idm181620890784
  ((file a-guided-tour.html)
   (html
    "<blockquote>By pattern matching using <code>::</code>,\n        we've isolated and named the first element of the list (<code>my_favorite</code>) and the remainder of the list\n        (<code>the_rest</code>). If you know Lisp or\n        Scheme, what we've done is the equivalent of using the functions\n        <code>car</code> and <code>cdr</code> to isolate the first element of a list\n        and the remainder of that list.</blockquote>")))
 (idm181620903456
  ((file a-guided-tour.html)
   (html
    "<blockquote>The elements of a list can be accessed through pattern matching.\n        List patterns are based on the two list constructors, <code>[]</code> and <code>::</code>. Here's a simple example:<a name=\"idm181620901776\"></a><a name=\"idm181620900224\"></a></blockquote>")))
 (idm181620905712
  ((file a-guided-tour.html)
   (html
    "<blockquote>It's important to remember that, unlike <code>::</code>, this is not a constant-time operation.\n        Concatenating two lists takes time proportional to the length of the\n        first list.</blockquote>")))
 (idm181620912128
  ((file a-guided-tour.html)
   (html
    "<blockquote>The <code>::</code> operator can only be\n        used for adding one element to the front of the list, with the list\n        terminating at <code>[]</code>, the empty list.\n        There's also a list concatenation operator, <code>@</code>, which can concatenate two lists:</blockquote>")))
 (idm181620922160
  ((file a-guided-tour.html)
   (html
    "<blockquote>The bracket notation for lists is really just syntactic sugar\n        for <code>::</code>. Thus, the following\n        declarations are all equivalent. Note that <code>[]</code> is used to represent the empty list and\n        that <code>::</code> is\n        right-associative:</blockquote>")))
 (idm181620922784
  ((file a-guided-tour.html)
   (html
    "<blockquote>to allocate a tuple of integers. This is generally considered\n          poor style and should be avoided.</blockquote>")))
 (idm181620927184
  ((file a-guided-tour.html)
   (html
    "<blockquote>This example uncovers the fact that commas create a tuple,\n          even if there are no surrounding parens. So, we can write:</blockquote>")))
 (idm181620927712
  ((file a-guided-tour.html)
   (html
    "<blockquote>In particular, rather than a list of three strings, what we\n          have is a singleton list containing a three-tuple of strings.</blockquote>")))
 (idm181620934272
  ((file a-guided-tour.html)
   (html
    "<blockquote>Unlike many other languages, OCaml uses semicolons to separate\n          list elements in lists rather than commas. Commas, instead, are used\n          for separating elements in a tuple. If you try to use commas in a\n          list, you'll see that your code compiles but doesn't do quite what\n          you might expect:<a name=\"idm181620933680\"></a><a name=\"idm181620932688\"></a></blockquote>")))
 (idm181620939360
  ((file a-guided-tour.html)
   (html
    "<blockquote>Here, we're creating a new and extended list, not changing the list we started with,\n          as you can see below:</blockquote>")))
 (idm181620947104
  ((file a-guided-tour.html)
   (html
    "<blockquote>In addition to constructing lists using brackets, we can use the\n        operator <code>::</code> for adding elements to\n        the front of a list:<a name=\"idm181620946032\"></a><a name=\"idm181620944736\"></a></blockquote>")))
 (idm181620949136
  ((file a-guided-tour.html)
   (html
    "<blockquote>We'll learn more about labeled arguments and why they're\n        important in <a href=\"variables-and-functions.html\">ChapterÂ 2, <i>Variables and Functions</i></a>.</blockquote>")))
 (idm181620957664
  ((file a-guided-tour.html)
   (html
    "<blockquote>Notably, the function passed to <code>List.map</code> is passed under a <span><em>labeled\n        argument</em></span> <code>~f</code>. Labeled\n        arguments are specified by name rather than by position, and thus\n        allow you to change the order in which arguments are presented to a\n        function without changing its behavior, as you can see here:<a name=\"idm181620955408\"></a><a name=\"idm181620954096\"></a></blockquote>")))
 (idm181620958768
  ((file a-guided-tour.html)
   (html
    "<blockquote><code>List.map</code> takes two arguments:\n        a list and a function for transforming the elements of that list. It\n        returns a new list with the transformed elements and does not modify\n        the original list.</blockquote>")))
 (idm181620963200
  ((file a-guided-tour.html)
   (html
    "<blockquote>Here's something a little more complicated. We can compute the\n        list of the lengths of each language as follows:</blockquote>")))
 (idm181620968368
  ((file a-guided-tour.html)
   (html
    "<blockquote>Core comes with a <code>List</code> module\n        that has a rich collection of functions for working with lists. We can\n        access values from within a module by using dot notation. For example,\n        this is how we compute the length of a list:</blockquote>")))
 (idm181620974992
  ((file a-guided-tour.html)
   (html
    "<blockquote>Note that you can't mix elements of different types in the same\n      list, unlike tuples:</blockquote>")))
 (idm181620981024
  ((file a-guided-tour.html)
   (html
    "<blockquote>Where tuples let you combine a fixed number of items, potentially\n      of different types, lists let you hold any number of items of the same\n      type. Consider the following example:<a name=\"DSlists\"></a></blockquote>")))
 (idm181620982592
  ((file a-guided-tour.html)
   (html
    "<blockquote>This is just a first taste of pattern matching. Pattern matching\n      is a pervasive tool in OCaml, and as you'll see, it has surprising\n      power.</blockquote>")))
 (idm181620983696
  ((file a-guided-tour.html)
   (html
    "<blockquote>The <code>**</code> operator used above is\n      for raising a floating-point number to a power.</blockquote>")))
 (idm181620990304
  ((file a-guided-tour.html)
   (html
    "<blockquote>Pattern matching can also show up in function arguments. Here's a\n      function for computing the distance between two points on the plane,\n      where each point is represented as a pair of <code>float</code>s. The pattern-matching syntax lets us\n      get at the values we need with a minimum of fuss:</blockquote>")))
 (idm181620990800
  ((file a-guided-tour.html)
   (html
    "<blockquote>Note that the same syntax is used both for constructing and for\n      pattern matching on tuples.</blockquote>")))
 (idm181620997552
  ((file a-guided-tour.html)
   (html
    "<blockquote>Here, the <code>(x,y)</code> on the lefthand side of the <code>let</code> binding is the pattern. This pattern lets us mint the new\n        variables <code>x</code> and <code>y</code>,\n        each bound to different components of the value being matched. These can now be used in\n        subsequent expressions:</blockquote>")))
 (idm181621002336
  ((file a-guided-tour.html)
   (html
    "<blockquote>You can extract the components of a tuple using OCaml's\n      pattern-matching syntax, as shown below:</blockquote>")))
 (idm181621005392
  ((file a-guided-tour.html)
   (html
    "<blockquote>(For the mathematically inclined, the <code>*</code> character is used because the set of all\n      pairs of type <code>t * s</code> corresponds to\n      the Cartesian product of the set of elements of type <code>t</code> and the set of elements of type <code>s</code>.)</blockquote>")))
 (idm181621016272
  ((file a-guided-tour.html)
   (html
    "<blockquote>So far we've encountered a handful of basic types like <code>int</code>, <code>float</code>,\n      and <code>string</code>, as well as function types\n      like <code>string -&gt; int</code>. But we haven't\n      yet talked about any data structures. We'll start by looking at a\n      particularly simple data structure, the tuple. A tuple is an ordered\n      collection of values that can each be of a different type. You can\n      create a tuple by joining values together with a comma:<a name=\"idm181621013168\"></a><a name=\"idm181621012304\"></a></blockquote>")))
 (idm181621020368
  ((file a-guided-tour.html)
   (html
    "<blockquote>The distinction here is that type errors will stop you whether\n        or not the offending code is ever actually executed. Merely defining\n        <code>add_potato</code> is an error, whereas\n        <code>is_a_multiple</code> only fails when it's\n        called, and then, only when it's called with an input that triggers\n        the exception.</blockquote>")))
 (idm181621029952
  ((file a-guided-tour.html)
   (html
    "<blockquote>are compile-time errors (because <code>+</code> requires that both its arguments be of\n        type <code>int</code>), whereas errors that\n        can't be caught by the type system, like division by zero, lead to\n        runtime exceptions:</blockquote>")))
 (idm181621036112
  ((file a-guided-tour.html)
   (html
    "<blockquote>Working in the toplevel somewhat obscures the difference between\n        runtime and compile-time errors, but that difference is still there.\n        Generally, type errors like this one:</blockquote>")))
 (idm181621041072
  ((file a-guided-tour.html)
   (html
    "<blockquote>There's a big difference in OCaml (and really in any compiled\n        language) between errors that are caught at compile time and those\n        that are caught at runtime. It's better to catch errors as early as\n        possible in the development process, and compilation time is best of\n        all.<a name=\"idm181621040512\"></a><a name=\"idm181621039600\"></a><a name=\"idm181621038352\"></a><a name=\"idm181621037104\"></a></blockquote>")))
 (idm181621046416
  ((file a-guided-tour.html)
   (html
    "<blockquote>In this example, <code>big_number</code>\n      requires that <code>'a</code> be instantiated as\n      <code>int</code>, whereas <code>&quot;short&quot;</code> and <code>&quot;loooooong&quot;</code> require that <code>'a</code> be instantiated as <code>string</code>, and they can't both be right at the\n      same time.</blockquote>")))
 (idm181621055104
  ((file a-guided-tour.html)
   (html
    "<blockquote>Both <code>long_string</code> and <code>big_number</code> are functions, and each is passed\n      to <code>first_if_true</code> with two other\n      arguments of the appropriate type (strings in the first example, and\n      integers in the second). But we can't mix and match two different\n      concrete types for <code>'a</code> in the same use\n      of <code>first_if_true</code>:</blockquote>")))
 (idm181621060960
  ((file a-guided-tour.html)
   (html "<blockquote>As well as this:</blockquote>")))
 (idm181621067520
  ((file a-guided-tour.html)
   (html
    "<blockquote>The generic type of <code>first_if_true</code> allows us to write this:</blockquote>")))
 (idm181621077248
  ((file a-guided-tour.html)
   (html
    "<blockquote>Indeed, if we look at the type returned by the toplevel, we see that rather than choose\n        a single concrete type, OCaml has introduced a <span><em>type variable</em></span>\n<code>'a</code> to express that the type is generic. (You can tell\n        it's a type variable by the leading single quote mark.) In particular, the type of the\n          <code>test</code> argument is <code>('a -&gt;\n          bool)</code>, which means that <code>test</code> is a\n        one-argument function whose return value is <code>bool</code> and\n        whose argument could be of any type <code>'a</code>. But, whatever\n        type <code>'a</code> is, it has to be the same as the type of the\n        other two arguments, <code>x</code> and <code>y</code>, and of the return value of <code>first_if_true</code>.\n        This kind of genericity is called <span><em>parametric polymorphism</em></span> because it\n        works by parameterizing the type in question with a type variable. It is very similar to\n        generics in C# and Java.<a name=\"idm181621069376\"></a><a name=\"idm181621068512\"></a></blockquote>")))
 (idm181621084960
  ((file a-guided-tour.html)
   (html
    "<blockquote><code>first_if_true</code> takes as its\n      arguments a function <code>test</code>, and two\n      values, <code>x</code> and <code>y</code>, where <code>x</code>\n      is to be returned if <code>test x</code> evaluates\n      to <code>true</code>, and <code>y</code> otherwise. So what's the type of <code>first_if_true</code>? There are no obvious clues such\n      as arithmetic operators or literals to tell you what the type of\n      <code>x</code> and <code>y</code> are. That makes it seem like one could use\n      <code>first_if_true</code> on values of any\n      type.</blockquote>")))
 (idm181621108032
  ((file a-guided-tour.html)
   (html
    "<blockquote>Sometimes, there isn't enough information to fully determine the\n      concrete type of a given value. Consider this function.<a name=\"idm181621107648\"></a></blockquote>")))
 (idm181621109648
  ((file a-guided-tour.html)
   (html
    "<blockquote>In the above, we've marked every argument to the function with its\n      type, with the final annotation indicating the type of the return value.\n      Such type annotations can be placed on any expression in an OCaml\n      program:</blockquote>")))
 (idm181621116576
  ((file a-guided-tour.html)
   (html
    "<blockquote>Here's an annotated version of <code>sum_if_true</code>:</blockquote>")))
 (idm181621116960
  ((file a-guided-tour.html)
   (html
    "<blockquote>Over time, you'll build a rough intuition for how the OCaml\n      inference engine works, which makes it easier to reason through your\n      programs. You can make it easier to understand the types of a given\n      expression by adding explicit type annotations. These annotations don't\n      change the behavior of an OCaml program, but they can serve as useful\n      documentation, as well as catch unintended type changes. They can also\n      be helpful in figuring out why a given piece of code fails to\n      compile.</blockquote>")))
 (idm181621118064
  ((file a-guided-tour.html)
   (html
    "<blockquote>Together, that nails down the types of all the variables, which\n      determines the overall type of <code>sum_if_true</code>.</blockquote>")))
 (idm181621120576
  ((file a-guided-tour.html)
   (html
    "<blockquote>The fact that <code>+</code> returns\n          <code>int</code> implies that the return value\n          of <code>sum_if_true</code> must be\n          int.</blockquote>")))
 (idm181621123744
  ((file a-guided-tour.html)
   (html
    "<blockquote><code>test first</code> is used as the\n          condition in an <code>if</code> statement, so\n          the return type of <code>test</code> must be\n          <code>bool</code>.</blockquote>")))
 (idm181621128032
  ((file a-guided-tour.html)
   (html
    "<blockquote><code>test</code> is passed <code>first</code> as an argument. Since <code>first</code> has type <code>int</code>, the input type of <code>test</code> must be <code>int</code>.</blockquote>")))
 (idm181621134528
  ((file a-guided-tour.html)
   (html
    "<blockquote>OCaml requires that both branches of an <code>if</code> statement have the same type, so the\n          expression <code>if test first then first else\n          0</code> requires that <code>first</code>\n          must be the same type as <code>0</code>, and\n          so <code>first</code> must be of type <code>int</code>. Similarly, from <code>if test second then second else 0</code> we can\n          infer that <code>second</code> has type\n          <code>int</code>.</blockquote>")))
 (idm181621136112
  ((file a-guided-tour.html)
   (html
    "<blockquote>As an example, let's walk through the process of inferring the\n      type of <code>sum_if_true</code>:</blockquote>")))
 (idm181621137104
  ((file a-guided-tour.html)
   (html
    "<blockquote>OCaml determines the type of an expression using a technique called <span><em>type\n          inference</em></span>, by which the type of an expression is inferred from the available\n        type information about the components of that expression.</blockquote>")))
 (idm181621138928
  ((file a-guided-tour.html)
   (html
    "<blockquote>As the types we encounter get more complicated, you might ask\n      yourself how OCaml is able to figure them out, given that we didn't\n      write down any explicit type information.<a name=\"idm181621138480\"></a></blockquote>")))
 (idm181621143216
  ((file a-guided-tour.html)
   (html
    "<blockquote>Note that in the definition of <code>even</code>, we used <code>=</code> in two different ways: once as the part of the\n    <code>let</code> binding that separates the thing being defined from\n    its definition; and once as an equality test, when comparing <code>x mod 2</code> to <code>0</code>.\n    These are very different operations despite the fact that they share some\n    syntax.</blockquote>")))
 (idm181621151584
  ((file a-guided-tour.html)
   (html
    "<blockquote>If we look at the inferred type signature in detail, we see that the\n    first argument is a function that takes an integer and returns a boolean,\n    and that the remaining two arguments are integers. Here's an example of\n    this function in action:</blockquote>")))
 (idm181621158064
  ((file a-guided-tour.html)
   (html
    "<blockquote>We can also write functions that take other functions as arguments.\n    Here's an example of a function that takes three arguments: a test\n    function and two integer arguments. The function returns the sum of the\n    integers that pass the test:</blockquote>")))
 (idm181621161184
  ((file a-guided-tour.html)
   (html
    "<blockquote>The notation for the type-signature of a multiargument function may\n    be a little surprising at first, but we'll explain where it comes from\n    when we get to function currying in <a href=\"variables-and-functions.html#multi-argument-functions\">the section called â\128\156Multiargument functionsâ\128\157</a>. For the moment, think of the arrows\n    as separating different arguments of the function, with the type after the\n    final arrow being the return value. Thus, <code>int\n    -&gt; int -&gt; float</code> describes a function that takes two\n    <code>int</code> arguments and returns a <code>float</code>.</blockquote>")))
 (idm181621163712
  ((file a-guided-tour.html)
   (html
    "<blockquote>The preceding example also happens to be our first use of modules.\n    Here, <code>Float.of_int</code> refers to the\n    <code>of_int</code> function contained in the\n    <code>Float</code> module. This is different from\n    what you might expect from an object-oriented language, where dot-notation\n    is typically used for accessing a method of an object. Note that module\n    names always start with a capital letter.</blockquote>")))
 (idm181621175824
  ((file a-guided-tour.html)
   (html
    "<blockquote>Now that we're creating more interesting values like functions, the\n    types have gotten more interesting too. <code>int -&gt;\n    int</code> is a function type, in this case indicating a function that\n    takes an <code>int</code> and returns an <code>int</code>. We can also write functions that take\n    multiple arguments. (Note that the following example will not work if you\n    haven't opened <code>Core.Std</code> as was\n    suggested earlier.)<a name=\"idm181621172736\"></a><a name=\"idm181621171872\"></a></blockquote>")))
 (idm181621179712
  ((file a-guided-tour.html)
   (html
    "<blockquote>Functions in OCaml are values like any other, which is why we use\n    the <code>let</code> keyword to bind a function to a\n    variable name, just as we use <code>let</code> to\n    bind a simple value like an integer to a variable name. When using\n    <code>let</code> to define a function, the first\n    identifier after the <code>let</code> is the\n    function name, and each subsequent identifier is a different argument to\n    the function. Thus, <code>square</code> is a\n    function with a single argument.</blockquote>")))
 (idm181621190384
  ((file a-guided-tour.html)
   (html
    "<blockquote>The <code>let</code> syntax can also be used\n    to define a function:<a name=\"idm181621189456\"></a><a name=\"idm181621188208\"></a></blockquote>")))
 (idm181621191888
  ((file a-guided-tour.html)
   (html
    "<blockquote>The error messages here are a little confusing, but they'll make\n    more sense as you learn more about the language.</blockquote>")))
 (idm181621202032
  ((file a-guided-tour.html)
   (html
    "<blockquote>The following examples, however, are not legal:</blockquote>")))
 (idm181621203104
  ((file a-guided-tour.html)
   (html
    "<blockquote>Note that by default, <span><strong>utop</strong></span>\n    doesn't bother to print out variables starting with an underscore.</blockquote>")))
 (idm181621214816
  ((file a-guided-tour.html)
   (html
    "<blockquote>Note that there are some constraints on what identifiers can be used\n    for variable names. Punctuation is excluded, except for <code>_</code> and <code>'</code>, and\n    variables must start with a lowercase letter or an underscore. Thus, these\n    are legal:</blockquote>")))
 (idm181621218336
  ((file a-guided-tour.html)
   (html
    "<blockquote>After a new variable is created, the toplevel tells us the name of\n    the variable (<code>x</code> or <code>y</code>), in addition to its type (<code>int</code>) and value (<code>7</code> or <code>14</code>).</blockquote>")))
 (idm181621225232
  ((file a-guided-tour.html)
   (html
    "<blockquote>We can also create a variable to name the value of a given\n    expression, using the <code>let</code> keyword. This\n    is known as a <span><em>let binding</em></span>:</blockquote>")))
 (idm181621232608
  ((file a-guided-tour.html)
   (html
    "<blockquote>OCaml carefully distinguishes between <code>float</code>, the\n          type for floating-point numbers, and <code>int</code>, the type for\n          integers. The types have different literals (<code>6.</code> instead\n          of <code>6</code>) and different infix operators (<code>+.</code> instead of <code>+</code>), and OCaml\n          doesn't automatically cast between these types. This can be a bit of a nuisance, but it\n          has its benefits, since it prevents some kinds of bugs that arise in other languages due\n          to unexpected differences between the behavior of <code>int</code>\n          and <code>float</code>. For example, in many languages, <code>1 / 3</code> is zero, but <code>1 / 3.0</code>\n          is a third. OCaml requires you to be explicit about which operation you're doing.</blockquote>")))
 (idm181621233584
  ((file a-guided-tour.html)
   (html
    "<blockquote>OCaml allows you to place underscores in the middle of numeric literals to improve\n          readability. Note that underscores can be placed anywhere within a number, not just every\n          three digits.</blockquote>")))
 (idm181621234560
  ((file a-guided-tour.html)
   (html
    "<blockquote>Function arguments are separated by spaces instead of by\n        parentheses and commas, which is more like the UNIX shell than it is\n        like traditional programming languages such as C or Java.</blockquote>")))
 (idm181621235456
  ((file a-guided-tour.html)
   (html
    "<blockquote>After evaluating an expression, the toplevel first prints the type of the result, and\n          then prints the result itself.</blockquote>")))
 (idm181621237808
  ((file a-guided-tour.html)
   (html
    "<blockquote>We needed to type <code>;;</code> in order\n        to tell the toplevel that it should evaluate an expression. This is a\n        peculiarity of the toplevel that is not required in standalone\n        programs (though it is sometimes helpful to include <code>;;</code> to improve OCaml's error reporting, by\n        making it more explicit where a given top-level declaration was\n        intended to end).</blockquote>")))
 (idm181621238848
  ((file a-guided-tour.html)
   (html
    "<blockquote>By and large, this is pretty similar to what you'd find in any\n    programming language, but a few things jump right out at you:</blockquote>")))
 (idm181621249760
  ((file a-guided-tour.html)
   (html
    "<blockquote>Now let's try a few simple numerical calculations:</blockquote>")))
 (idm181621250288
  ((file a-guided-tour.html)
   (html
    "<blockquote>This makes the definitions in Core available and is required for\n    many of the examples in the tour and in the remainder of the book.</blockquote>")))
 (idm181621257968
  ((file a-guided-tour.html)
   (html
    "<blockquote>The first thing you need to do when using Core is to open<a name=\"idm181621257712\"></a><a name=\"idm181621256464\"></a><a name=\"idm181621255600\"></a> <code>Core.Std</code>:</blockquote>")))
 (idm181621259360
  ((file a-guided-tour.html)
   (html
    "<blockquote>Before getting started, make sure you have a working OCaml installation so you can try out\n    the examples as you read through the chapter. </blockquote>")))
 (idm181621262368
  ((file a-guided-tour.html)
   (html
    "<blockquote>Throughout the book we're going to use Core, a more full-featured and capable replacement\n    for OCaml's standard library. We'll also use <span><strong>utop</strong></span>, a shell\n    that lets you type in expressions and evaluate them interactively. <span><strong>utop</strong></span> is an easier-to-use version of OCaml's standard toplevel (which you can start\n    by typing <span><em>ocaml</em></span> at the command line). These instructions will assume you're\n    using <span><strong>utop</strong></span> specifically.</blockquote>")))
 (idm181621263008
  ((file a-guided-tour.html)
   (html
    "<blockquote>This chapter gives an overview of OCaml by walking through a series of\n  small examples that cover most of the major features of the language. This\n  should provide a sense of what OCaml can do, without getting too deep into\n  any one topic.</blockquote>"))))
